<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenuVerity - AI-Powered Fact Checking</title>
    <meta name="description" content="GenuVerity is an AI-powered fact-checking tool that verifies claims using verified sources and professional fact-checker databases.">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0a0a12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        /* === CORE VARIABLES === */
        :root {
            --bg-primary: #0a0a12;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161e;
            --border-color: #2a2a3a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6b7280;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-teal: #14b8a6;
            --verdict-true: #10b981;
            --verdict-false: #ef4444;
            --verdict-mixed: #f59e0b;
            --verdict-mostly-true: #34d399;
            --verdict-mostly-false: #f97316;
        }

        /* === RESET & BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* === NAVBAR === */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(10, 10, 18, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .navbar-logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .navbar-links {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .nav-link.active {
            color: var(--accent-blue);
        }

        .nav-cta {
            padding: 8px 18px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            text-decoration: none;
            margin-left: 8px;
        }

        /* === USER MENU === */
        .user-menu-container {
            position: relative;
            margin-left: 12px;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .user-menu-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .user-menu-btn.signed-in {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .user-menu-btn .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .user-menu-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 200px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 1001;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .user-menu-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .user-menu-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .user-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 8px 0;
        }

        .user-menu-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
        }

        .user-menu-header-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .user-menu-header-email {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Sign In Modal */
        .signin-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .signin-modal.open {
            opacity: 1;
            visibility: visible;
        }

        .signin-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .signin-modal.open .signin-modal-content {
            transform: scale(1);
        }

        .signin-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
        }

        .signin-modal-subtitle {
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 24px;
            font-size: 0.9rem;
        }

        .signin-form-group {
            margin-bottom: 16px;
        }

        .signin-form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .signin-form-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .signin-form-group input:focus {
            border-color: var(--accent-blue);
        }

        .signin-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 8px;
            display: none;
        }

        .signin-error.show {
            display: block;
        }

        .signin-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: opacity 0.2s;
        }

        .signin-btn:hover {
            opacity: 0.9;
        }

        .signin-cancel {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .signin-cancel:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* === LAYOUT === */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            padding-top: 84px;
            min-height: 100vh;
            display: flex;
            gap: 24px;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        /* === RIGHT SIDEBAR === */
        .right-sidebar {
            width: 380px;
            flex-shrink: 0;
            position: sticky;
            top: 84px;
            height: calc(100vh - 104px);
            overflow-y: auto;
            display: none;
        }

        .right-sidebar.open {
            display: block;
        }

        .sidebar-toggle-btn {
            position: fixed;
            right: 24px;
            bottom: 24px;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            z-index: 999;
            transition: all 0.2s;
        }

        .sidebar-toggle-btn:hover {
            transform: scale(1.1);
        }

        .sidebar-toggle-btn.sidebar-open {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            box-shadow: none;
        }

        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .sidebar-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .sidebar-card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-card-badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .sidebar-card-body {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .sidebar-card-body.collapsed {
            display: none;
        }

        .sidebar-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-item:hover {
            background: var(--bg-tertiary);
        }

        .sidebar-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sidebar-item-icon.verdict-true { background: rgba(16, 185, 129, 0.15); color: var(--verdict-true); }
        .sidebar-item-icon.verdict-false { background: rgba(239, 68, 68, 0.15); color: var(--verdict-false); }
        .sidebar-item-icon.verdict-mixed { background: rgba(245, 158, 11, 0.15); color: var(--verdict-mixed); }

        .sidebar-item-content {
            flex: 1;
            min-width: 0;
        }

        .sidebar-item-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .sidebar-item-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .sidebar-subtabs {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-subtab {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-subtab:hover {
            color: var(--text-primary);
        }

        .sidebar-subtab.active {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
        }

        .sidebar-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .sidebar-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* === HERO SECTION === */
        .hero {
            text-align: center;
            padding: 60px 20px 40px;
            position: relative;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--accent-blue);
            margin-bottom: 20px;
        }

        .hero-badge-dot {
            width: 6px;
            height: 6px;
            background: var(--verdict-true);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 16px;
            line-height: 1.1;
        }

        .hero-title-genu { color: #ffffff; }
        .hero-title-verity {
            color: var(--accent-blue);
        }

        .hero-subtitle {
            color: var(--text-secondary);
            font-size: 1.25rem;
            max-width: 600px;
            margin: 0 auto 16px;
        }

        .hero-features {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .hero-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .hero-feature i {
            color: var(--accent-cyan);
        }

        /* === HEADER (legacy, keep for result view) === */
        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .logo-genu { color: #ffffff; }
        .logo-verity { color: var(--accent-blue); }

        .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* === SEARCH BOX === */
        .search-container {
            max-width: 800px;
            margin: 0 auto 40px;
        }

        .search-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .search-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px 20px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        .search-textarea:focus {
            border-color: var(--accent-blue);
        }

        .search-textarea::placeholder {
            color: var(--text-muted);
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent-blue);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-actions {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .media-upload-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .upload-btn input[type="file"] {
            display: none;
        }

        .url-input-wrapper {
            display: none;
            flex: 1;
            min-width: 200px;
        }

        .url-input-wrapper.active {
            display: flex;
        }

        .url-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
        }

        .url-input:focus {
            border-color: var(--accent-blue);
        }

        .url-submit-btn {
            padding: 10px 14px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            margin-left: 8px;
            transition: background 0.2s;
        }

        .url-submit-btn:hover {
            background: var(--accent-cyan);
        }

        .media-upload-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .media-preview-thumb {
            width: 60px;
            height: 45px;
            border-radius: 6px;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .media-preview-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview-thumb i {
            color: var(--text-muted);
        }

        .media-preview-name {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .media-preview-type {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .search-hints {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .search-hint {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Example Prompts */
        .example-prompts {
            margin-top: 16px;
        }

        .example-prompts-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .example-prompts-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .example-prompt {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .example-prompt:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-blue);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .example-prompt:active {
            transform: translateY(0) scale(0.98);
        }

        .media-preview {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-top: 8px;
        }

        .media-preview.active {
            display: flex;
        }

        .media-preview img {
            max-width: 80px;
            max-height: 60px;
            border-radius: 6px;
            object-fit: cover;
        }

        .media-preview-info {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .media-preview-remove {
            padding: 4px 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        .media-preview-remove:hover {
            color: var(--verdict-false);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* === RECENT FACT CHECKS === */
        .recent-section {
            margin-top: 50px;
            text-align: center;
        }

        .dashboard-tabs {
            justify-content: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fact-checks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }

        .fact-check-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid var(--border-color);
        }

        .fact-check-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        .fact-check-card.verdict-true { border-left-color: var(--verdict-true); }
        .fact-check-card.verdict-false { border-left-color: var(--verdict-false); }
        .fact-check-card.verdict-mixed { border-left-color: var(--verdict-mixed); }
        .fact-check-card.verdict-mostly-true { border-left-color: var(--verdict-mostly-true); }
        .fact-check-card.verdict-mostly-false { border-left-color: var(--verdict-mostly-false); }

        .card-verdict {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .verdict-true .card-verdict { background: rgba(16, 185, 129, 0.15); color: var(--verdict-true); }
        .verdict-false .card-verdict { background: rgba(239, 68, 68, 0.15); color: var(--verdict-false); }
        .verdict-mixed .card-verdict { background: rgba(245, 158, 11, 0.15); color: var(--verdict-mixed); }
        .verdict-mostly-true .card-verdict { background: rgba(52, 211, 153, 0.15); color: var(--verdict-mostly-true); }
        .verdict-mostly-false .card-verdict { background: rgba(249, 115, 22, 0.15); color: var(--verdict-mostly-false); }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .card-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* === HOT ON X SECTION === */
        .section-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .x-topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .x-topic-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .x-topic-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #1d9bf0, #0a7bc4);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .x-topic-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(29, 155, 240, 0.15);
            border-color: rgba(29, 155, 240, 0.3);
        }

        .x-topic-card:hover::before {
            opacity: 1;
        }

        .x-topic-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .x-topic-icon {
            width: 20px;
            height: 20px;
            color: #1d9bf0;
        }

        .x-topic-source {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .x-topic-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .x-topic-snippet {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .x-topic-action {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--accent-blue);
            margin-top: auto;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .x-topic-card:hover .x-topic-action {
            opacity: 1;
        }

        .x-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .loading-spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .x-empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .x-empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* === SOCIAL SUBTABS === */
        .social-subtabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .social-subtab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .social-subtab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .social-subtab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .social-subtab.warning {
            border-color: rgba(245, 158, 11, 0.3);
        }

        .social-subtab.warning:hover {
            border-color: rgba(245, 158, 11, 0.6);
            background: rgba(245, 158, 11, 0.1);
        }

        .social-subtab.warning.active {
            background: rgba(245, 158, 11, 0.9);
            border-color: rgba(245, 158, 11, 1);
        }

        /* Misinfo Warning Banner */
        .misinfo-warning {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            margin-bottom: 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .misinfo-warning i {
            color: #f59e0b;
            flex-shrink: 0;
        }

        /* Source type badges on cards */
        .x-topic-card.source-reddit::before {
            background: linear-gradient(180deg, #ff4500, #cc3700);
        }

        .x-topic-card.source-4chan::before {
            background: linear-gradient(180deg, #789922, #5d7a1a);
        }

        .x-topic-card.source-infowars::before,
        .x-topic-card.source-breitbart::before,
        .x-topic-card.source-misinfo::before,
        .x-topic-card.source-far_right::before {
            background: linear-gradient(180deg, #f59e0b, #d97706);
        }

        .x-topic-card.source-factchecker::before {
            background: linear-gradient(180deg, #10b981, #059669);
        }

        /* Health misinformation - red */
        .x-topic-card.source-health::before {
            background: linear-gradient(180deg, #ef4444, #dc2626);
        }

        /* QAnon / conspiracy platforms - purple */
        .x-topic-card.source-qanon::before {
            background: linear-gradient(180deg, #8b5cf6, #7c3aed);
        }

        /* Russian propaganda - dark red */
        .x-topic-card.source-russian::before {
            background: linear-gradient(180deg, #b91c1c, #991b1b);
        }

        /* ZeroHedge financial conspiracy - gray */
        .x-topic-card.source-zerohedge::before {
            background: linear-gradient(180deg, #6b7280, #4b5563);
        }

        /* Gateway Pundit - orange-red */
        .x-topic-card.source-gateway::before {
            background: linear-gradient(180deg, #ea580c, #c2410c);
        }

        /* Telegram - blue */
        .x-topic-card.source-telegram::before {
            background: linear-gradient(180deg, #0088cc, #006699);
        }

        /* Generic fringe - muted amber */
        .x-topic-card.source-fringe::before {
            background: linear-gradient(180deg, #d97706, #b45309);
        }

        /* === RESULT VIEW === */
        .result-container {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        .result-container.active {
            display: block;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 0.95rem;
            background: none;
            border: none;
        }

        .back-button:hover {
            color: var(--text-primary);
        }

        /* === VERDICT BANNER === */
        .verdict-banner {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .verdict-banner.verdict-true { border-color: var(--verdict-true); background: rgba(16, 185, 129, 0.05); }
        .verdict-banner.verdict-false { border-color: var(--verdict-false); background: rgba(239, 68, 68, 0.05); }
        .verdict-banner.verdict-mixed { border-color: var(--verdict-mixed); background: rgba(245, 158, 11, 0.05); }
        .verdict-banner.verdict-mostly-true { border-color: var(--verdict-mostly-true); background: rgba(52, 211, 153, 0.05); }
        .verdict-banner.verdict-mostly-false { border-color: var(--verdict-mostly-false); background: rgba(249, 115, 22, 0.05); }

        .verdict-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .verdict-label {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .verdict-banner.verdict-true .verdict-label { color: var(--verdict-true); }
        .verdict-banner.verdict-false .verdict-label { color: var(--verdict-false); }
        .verdict-banner.verdict-mixed .verdict-label { color: var(--verdict-mixed); }
        .verdict-banner.verdict-mostly-true .verdict-label { color: var(--verdict-mostly-true); }
        .verdict-banner.verdict-mostly-false .verdict-label { color: var(--verdict-mostly-false); }

        .verdict-summary {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 700px;
            margin: 0 auto;
        }

        /* === SOURCES FIRST (COLLAPSIBLE) === */
        .sources-first-section {
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .sources-first-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.05));
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .sources-first-header:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.1));
        }

        .sources-first-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-blue);
        }

        .sources-count {
            font-weight: 400;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .sources-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            transition: transform 0.3s ease;
        }

        .sources-first-section.collapsed .sources-toggle-btn {
            transform: rotate(180deg);
        }

        .sources-first-body {
            padding: 20px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            max-height: 600px;
            opacity: 1;
        }

        .sources-first-section.collapsed .sources-first-body {
            max-height: 0;
            padding: 0 20px;
            opacity: 0;
            overflow: hidden;
        }

        .sources-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .source-tab {
            padding: 8px 16px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .source-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .source-tab:hover:not(.active) {
            background: var(--bg-secondary);
        }

        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .source-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .source-score {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .score-high { background: rgba(16, 185, 129, 0.15); color: var(--verdict-true); }
        .score-medium { background: rgba(245, 158, 11, 0.15); color: var(--verdict-mixed); }
        .score-low { background: rgba(239, 68, 68, 0.15); color: var(--verdict-false); }

        .source-info {
            flex: 1;
            min-width: 0;
        }

        .source-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .source-name a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        .source-name a:hover {
            text-decoration: underline;
        }

        .source-domain {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* === CONTENT === */
        .content-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }

        .prose-text {
            color: var(--text-primary);
            line-height: 1.8;
            margin-bottom: 16px;
        }

        .prose-h2 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 30px 0 15px;
            color: var(--text-primary);
        }

        .prose-h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 10px;
            color: var(--text-primary);
        }

        /* === FACT CHECK TABS === */
        .fact-check-tabs {
            display: flex;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .fact-check-tab {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .fact-check-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .fact-check-tab-content {
            display: none;
            padding: 20px 0;
        }

        .fact-check-tab-content.active {
            display: block;
        }

        /* === EVIDENCE GRID === */
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .evidence-column {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .evidence-column h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .evidence-column.supporting h4 { color: var(--verdict-true); }
        .evidence-column.contradicting h4 { color: var(--verdict-false); }

        .evidence-column ul {
            list-style: none;
            padding: 0;
        }

        .evidence-column li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .evidence-column li:last-child {
            border-bottom: none;
        }

        /* === CLAIM CARDS === */
        .claim-card {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }

        .claim-verdict {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: inline-block;
        }

        .claim-verdict.true { background: rgba(16, 185, 129, 0.15); color: var(--verdict-true); }
        .claim-verdict.false { background: rgba(239, 68, 68, 0.15); color: var(--verdict-false); }
        .claim-verdict.mixed { background: rgba(245, 158, 11, 0.15); color: var(--verdict-mixed); }

        .claim-text {
            font-weight: 500;
            margin-bottom: 8px;
        }

        .claim-evidence {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* === CLAIM QUOTE === */
        .claim-quote {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-blue);
            padding: 20px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* === PRIOR FACT CHECKS === */
        .prior-fact-checks {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .prior-fact-checks h4 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .prior-check {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .prior-check:last-child {
            border-bottom: none;
        }

        .check-verdict {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
        }

        .check-publisher {
            flex: 1;
            color: var(--text-secondary);
        }

        .check-link {
            color: var(--accent-cyan);
            text-decoration: none;
            font-size: 0.9rem;
        }

        /* === LOADING === */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 18, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .loading-progress {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--accent-cyan);
        }

        /* === CITATION SPADE === */
        .citation-spade {
            color: var(--accent-cyan);
            cursor: pointer;
            font-weight: bold;
        }

        .citation-spade:hover {
            color: var(--accent-blue);
        }

        /* === DISINFO TAB STYLES === */
        .disinfo-origin, .disinfo-spread {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .amplifier-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .amplifier-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .amplifier-type {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            text-transform: uppercase;
        }

        .amplifier-name {
            flex: 1;
            font-weight: 500;
        }

        .amplifier-reach {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .mutation-timeline {
            margin-top: 15px;
        }

        .mutation-item {
            position: relative;
            padding: 15px 20px;
            padding-left: 30px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-cyan);
        }

        .mutation-date {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
            display: block;
        }

        .mutation-text {
            font-style: italic;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .mutation-type {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(245, 158, 11, 0.15);
            color: var(--verdict-mixed);
        }

        /* === DASHBOARD TABS === */
        .dashboard-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .dashboard-tab {
            padding: 10px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-tab.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .dashboard-tab:hover:not(.active) {
            background: var(--bg-secondary);
        }

        .history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .history-empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* === NETWORK GRAPH === */
        .network-graph-container {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .network-graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .network-graph-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .network-graph-legend {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.claim { background: var(--accent-cyan); }
        .legend-dot.source { background: var(--verdict-true); }
        .legend-dot.amplifier { background: var(--verdict-mixed); }
        .legend-dot.mutation { background: var(--accent-blue); }

        #network-graph {
            width: 100%;
            height: 400px;
            cursor: grab;
        }

        #network-graph:active {
            cursor: grabbing;
        }

        .graph-node {
            cursor: pointer;
            transition: filter 0.2s;
        }

        .graph-node:hover {
            filter: brightness(1.3);
        }

        .graph-node-label {
            font-size: 10px;
            fill: var(--text-secondary);
            pointer-events: none;
        }

        .graph-link {
            stroke: var(--border-color);
            stroke-opacity: 0.6;
            fill: none;
        }

        .graph-link.amplified { stroke: var(--verdict-mixed); stroke-dasharray: 5,5; }
        .graph-link.cited { stroke: var(--verdict-true); }
        .graph-link.mutated { stroke: var(--accent-cyan); stroke-dasharray: 3,3; }

        .graph-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.85rem;
            pointer-events: none;
            z-index: 100;
            max-width: 250px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .graph-tooltip-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .graph-tooltip-type {
            font-size: 0.7rem;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .graph-tooltip-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* === TIMELINE VISUALIZATION === */
        .spread-timeline {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .timeline-header {
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-track {
            position: relative;
            padding: 20px 0;
            min-height: 100px;
        }

        .timeline-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
            transform: translateY(-50%);
        }

        .timeline-point {
            position: absolute;
            transform: translate(-50%, -50%);
            top: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .timeline-point:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .timeline-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-cyan);
            border: 3px solid var(--bg-tertiary);
        }

        .timeline-dot.origin { background: var(--verdict-false); }
        .timeline-dot.mutation { background: var(--verdict-mixed); }
        .timeline-dot.peak { background: var(--accent-blue); }
        .timeline-dot.current { background: var(--verdict-true); }

        .timeline-label {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 8px;
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            text-align: center;
        }

        .timeline-label-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .spread-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .spread-stat {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .spread-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }

        .spread-stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* === RESPONSIVE === */
        @media (max-width: 1200px) {
            .right-sidebar {
                width: 320px;
            }
        }

        @media (max-width: 1024px) {
            .app-container {
                flex-direction: column;
            }

            .right-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                height: auto;
                max-height: none;
            }

            .sidebar-toggle-btn {
                display: flex;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 16px;
            }

            .navbar-links .nav-link span,
            .nav-link i + span {
                display: none;
            }

            .nav-link {
                padding: 8px 12px;
            }

            .user-menu-btn span {
                display: none;
            }

            .user-menu-container {
                margin-left: 8px;
            }

            .app-container {
                padding: 15px;
                padding-top: 80px;
                flex-direction: column;
            }

            .right-sidebar {
                display: none !important;
            }

            .sidebar-toggle-btn {
                display: flex;
            }

            .hero {
                padding: 40px 15px 30px;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                font-size: 1rem;
            }

            .hero-features {
                gap: 16px;
            }

            .hero-feature {
                font-size: 0.8rem;
            }

            .header {
                padding: 30px 15px;
            }

            .logo {
                font-size: 2rem;
            }

            .fact-checks-grid {
                grid-template-columns: 1fr;
            }

            .search-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .sources-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .evidence-grid {
                grid-template-columns: 1fr;
            }

            .network-graph-header {
                flex-direction: column;
                gap: 10px;
            }

            .network-graph-legend {
                flex-wrap: wrap;
                gap: 8px;
            }

            #network-graph {
                height: 300px;
            }
        }

        /* === HIDDEN UTILITY === */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <a href="#" class="navbar-brand" onclick="showSearch(); return false;">
            <span class="navbar-logo">
                <span class="logo-genu">Genu</span><span class="logo-verity">Verity</span>
            </span>
        </a>
        <div class="navbar-links">
            <a href="#" class="nav-link active" onclick="showSearch(); return false;">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                Fact Check
            </a>
            <a href="methods.html" class="nav-link">
                <i data-lucide="book-open" style="width: 16px; height: 16px;"></i>
                Methods
            </a>
            <a href="#" class="nav-link" onclick="toggleRightSidebar(); return false;">
                <i data-lucide="layout-panel-right" style="width: 16px; height: 16px;"></i>
                <span>Feed</span>
            </a>

            <!-- User Menu -->
            <div class="user-menu-container">
                <button class="user-menu-btn" id="user-menu-btn" onclick="toggleUserMenu()">
                    <i data-lucide="user" style="width: 18px; height: 18px;" id="user-icon-guest"></i>
                    <div class="user-avatar" id="user-avatar" style="display: none;">U</div>
                    <span id="user-menu-label">Sign In</span>
                    <i data-lucide="chevron-down" style="width: 14px; height: 14px;"></i>
                </button>
                <div class="user-menu-dropdown" id="user-menu-dropdown">
                    <!-- Signed Out State -->
                    <div id="user-menu-signed-out">
                        <button class="user-menu-item" onclick="openSignInModal()">
                            <i data-lucide="log-in" style="width: 16px; height: 16px;"></i>
                            Sign In
                        </button>
                        <button class="user-menu-item" onclick="openSignInModal()">
                            <i data-lucide="user-plus" style="width: 16px; height: 16px;"></i>
                            Create Account
                        </button>
                    </div>
                    <!-- Signed In State -->
                    <div id="user-menu-signed-in" style="display: none;">
                        <div class="user-menu-header">
                            <div class="user-menu-header-name" id="user-display-name">User</div>
                            <div class="user-menu-header-email" id="user-display-email">user@example.com</div>
                        </div>
                        <button class="user-menu-item" onclick="toggleRightSidebar(); closeUserMenu();">
                            <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                            View History
                        </button>
                        <button class="user-menu-item" onclick="closeUserMenu();">
                            <i data-lucide="bookmark" style="width: 16px; height: 16px;"></i>
                            Saved Fact Checks
                        </button>
                        <button class="user-menu-item" onclick="closeUserMenu();">
                            <i data-lucide="settings" style="width: 16px; height: 16px;"></i>
                            Settings
                        </button>
                        <div class="user-menu-divider"></div>
                        <button class="user-menu-item danger" onclick="signOut()">
                            <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sign In Modal -->
    <div class="signin-modal" id="signin-modal" onclick="closeSignInModalOnBackdrop(event)">
        <div class="signin-modal-content" onclick="event.stopPropagation()">
            <h2 class="signin-modal-title">Welcome Back</h2>
            <p class="signin-modal-subtitle">Sign in to save your fact checks and history</p>
            <div class="signin-form-group">
                <label for="signin-email">Email</label>
                <input type="email" id="signin-email" placeholder="you@example.com" value="user@genuverity.com">
            </div>
            <div class="signin-form-group">
                <label for="signin-password">Password</label>
                <input type="password" id="signin-password" placeholder="Enter password" onkeypress="if(event.key==='Enter')attemptSignIn()">
            </div>
            <div class="signin-error" id="signin-error">Incorrect password. Try: 1234</div>
            <button class="signin-btn" onclick="attemptSignIn()">Sign In</button>
            <button class="signin-cancel" onclick="closeSignInModal()">Cancel</button>
        </div>
    </div>

    <div class="app-container">
        <!-- MAIN CONTENT AREA -->
        <div class="main-content">
            <!-- SEARCH VIEW -->
            <div id="view-search">
            <!-- Hero Section -->
            <section class="hero">
                <h1 class="hero-title">
                    <span class="hero-title-genu">Genu</span><span class="hero-title-verity">Verity</span>
                </h1>
                <p class="hero-subtitle">
                    Before you share, verify. We'll find the facts.
                </p>
            </section>

            <!-- Search Box -->
            <div class="search-container">
                <div class="search-box">
                    <textarea
                        id="claim-input"
                        class="search-textarea"
                        placeholder="Enter a claim, quote, headline, or paste a TikTok/YouTube URL to fact-check..."
                        rows="4"
                    ></textarea>

                    <!-- Media Upload Section -->
                    <div class="media-upload-section">
                        <div class="media-upload-group">
                            <label class="upload-btn" title="Upload image or screenshot">
                                <i data-lucide="image"></i>
                                <span>Upload Image</span>
                                <input type="file" id="media-file-input" accept="image/*,video/*" onchange="handleMediaUpload(event)">
                            </label>
                            <button class="upload-btn" onclick="toggleUrlInput()" title="Paste TikTok or YouTube link">
                                <i data-lucide="link"></i>
                                <span>Paste Link</span>
                            </button>
                        </div>

                        <!-- URL Input (hidden by default) -->
                        <div class="url-input-wrapper" id="url-input-wrapper">
                            <input
                                type="text"
                                id="media-url-input"
                                class="url-input"
                                placeholder="Paste TikTok, YouTube, or image URL..."
                                onkeypress="if(event.key==='Enter')handleUrlPaste()"
                            >
                            <button class="url-submit-btn" onclick="handleUrlPaste()">
                                <i data-lucide="check"></i>
                            </button>
                        </div>

                        <!-- Media Preview -->
                        <div class="media-preview" id="media-preview">
                            <div class="media-preview-thumb" id="media-preview-thumb"></div>
                            <div class="media-preview-info">
                                <span class="media-preview-name" id="media-preview-name">filename.jpg</span>
                                <span class="media-preview-type" id="media-preview-type">Image</span>
                            </div>
                            <button class="media-preview-remove" onclick="removeMedia()">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                    </div>

                    <div class="search-actions">
                        <button class="btn btn-primary" id="fact-check-btn" onclick="factCheck()">
                            <i data-lucide="search"></i>
                            Fact Check
                        </button>
                    </div>

                    <!-- Example Prompts -->
                    <div class="example-prompts">
                        <div class="example-prompts-label">
                            <i data-lucide="lightbulb" style="width:14px;height:14px;"></i>
                            Try an example:
                        </div>
                        <div class="example-prompts-list">
                            <button class="example-prompt" onclick="useExample('Did the Pentagon confirm UFO footage is real?')">
                                Did the Pentagon confirm UFO footage?
                            </button>
                            <button class="example-prompt" onclick="useExample('Is it true that eating carrots improves night vision?')">
                                Do carrots improve night vision?
                            </button>
                            <button class="example-prompt" onclick="useExample('Did Elon Musk buy TikTok?')">
                                Did Elon Musk buy TikTok?
                            </button>
                            <button class="example-prompt" onclick="useExample('Are microwave ovens dangerous to your health?')">
                                Are microwaves dangerous?
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <section class="recent-section">
                <div class="dashboard-tabs">
                    <button class="dashboard-tab active" onclick="switchDashboardTab('trending')" id="tab-trending">
                        <i data-lucide="trending-up"></i>
                        Trending
                    </button>
                    <button class="dashboard-tab" onclick="switchDashboardTab('hot-social')" id="tab-hot-social">
                        <i data-lucide="flame"></i>
                        Hot on Socials
                    </button>
                    <button class="dashboard-tab" onclick="switchDashboardTab('history')" id="tab-history">
                        <i data-lucide="clock"></i>
                        Your History
                    </button>
                </div>

                <!-- Trending Fact Checks -->
                <div id="dashboard-trending">
                    <h2 class="section-title">
                        <i data-lucide="flame"></i>
                        Recent Fact Checks
                    </h2>
                    <div class="fact-checks-grid" id="trending-fact-checks">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Hot on Socials -->
                <div id="dashboard-hot-social" class="hidden">
                    <!-- Sub-tabs for different sources -->
                    <div class="social-subtabs">
                        <button class="social-subtab active" onclick="switchSocialSubtab('all')" id="subtab-all">All</button>
                        <button class="social-subtab" onclick="switchSocialSubtab('x')" id="subtab-x">X / Twitter</button>
                        <button class="social-subtab" onclick="switchSocialSubtab('reddit')" id="subtab-reddit">Reddit</button>
                        <button class="social-subtab warning" onclick="switchSocialSubtab('misinfo')" id="subtab-misinfo">
                            <i data-lucide="alert-triangle" style="width:12px;height:12px;"></i>
                            Misinfo Sources
                        </button>
                    </div>

                    <div id="social-content-all">
                        <p class="section-subtitle">Claims and discussions across social platforms - click to fact-check</p>
                        <div class="x-topics-grid" id="social-topics-grid">
                            <div class="x-loading">
                                <div class="loading-spinner-small"></div>
                                <span>Loading trending topics...</span>
                            </div>
                        </div>
                    </div>

                    <div id="social-content-misinfo" class="hidden">
                        <div class="misinfo-warning">
                            <i data-lucide="alert-triangle"></i>
                            <span>These claims originate from known misinformation sources. Fact-check them before they spread!</span>
                        </div>
                        <div class="x-topics-grid" id="misinfo-topics-grid">
                            <div class="x-loading">
                                <div class="loading-spinner-small"></div>
                                <span>Scanning misinformation sources...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User History -->
                <div id="dashboard-history" class="hidden">
                    <h2 class="section-title">
                        <i data-lucide="user"></i>
                        Your Fact Check History
                    </h2>
                    <div class="fact-checks-grid" id="user-history">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </section>
        </div>

        <!-- RESULT VIEW -->
        <div id="view-result" class="result-container">
            <button class="back-button" onclick="showSearch()">
                <i data-lucide="arrow-left"></i>
                Back to search
            </button>

            <!-- Sources First Section (Collapsible) -->
            <div class="sources-first-section" id="sources-first-section">
                <div class="sources-first-header" onclick="toggleSourcesFirst()">
                    <div class="sources-first-title">
                        <i data-lucide="shield-check"></i>
                        <span>Sources First</span>
                        <span class="sources-count" id="sources-count">(0)</span>
                    </div>
                    <button class="sources-toggle-btn" id="sources-toggle-btn">
                        <i data-lucide="chevron-up" id="sources-toggle-icon"></i>
                    </button>
                </div>
                <div class="sources-first-body" id="sources-first-body">
                    <div class="sources-tabs" id="sources-tabs">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="sources-list" id="sources-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="content-section" id="article-content">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        </div><!-- End main-content -->

        <!-- RIGHT SIDEBAR -->
        <aside class="right-sidebar" id="right-sidebar">
            <!-- Trending Card -->
            <div class="sidebar-card">
                <div class="sidebar-card-header" onclick="toggleSidebarCard('sidebar-trending')">
                    <div class="sidebar-card-title">
                        <i data-lucide="trending-up" style="width:18px;height:18px;color:var(--accent-cyan);"></i>
                        Trending
                        <span class="sidebar-card-badge" id="sidebar-trending-count">0</span>
                    </div>
                    <i data-lucide="chevron-down" style="width:16px;height:16px;color:var(--text-muted);"></i>
                </div>
                <div class="sidebar-card-body" id="sidebar-trending">
                    <div class="sidebar-loading">
                        <div class="loading-spinner-small"></div>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Hot on Socials Card -->
            <div class="sidebar-card">
                <div class="sidebar-card-header" onclick="toggleSidebarCard('sidebar-socials')">
                    <div class="sidebar-card-title">
                        <i data-lucide="flame" style="width:18px;height:18px;color:var(--verdict-mixed);"></i>
                        Hot on Socials
                    </div>
                    <i data-lucide="chevron-down" style="width:16px;height:16px;color:var(--text-muted);"></i>
                </div>
                <div class="sidebar-subtabs">
                    <button class="sidebar-subtab active" onclick="switchSidebarSocialTab('all')" id="sidebar-subtab-all">All</button>
                    <button class="sidebar-subtab" onclick="switchSidebarSocialTab('x')" id="sidebar-subtab-x">X</button>
                    <button class="sidebar-subtab" onclick="switchSidebarSocialTab('reddit')" id="sidebar-subtab-reddit">Reddit</button>
                </div>
                <div class="sidebar-card-body" id="sidebar-socials">
                    <div class="sidebar-loading">
                        <div class="loading-spinner-small"></div>
                        <span>Loading socials...</span>
                    </div>
                </div>
            </div>

            <!-- Your History Card -->
            <div class="sidebar-card">
                <div class="sidebar-card-header" onclick="toggleSidebarCard('sidebar-history')">
                    <div class="sidebar-card-title">
                        <i data-lucide="clock" style="width:18px;height:18px;color:var(--accent-blue);"></i>
                        Your History
                        <span class="sidebar-card-badge" id="sidebar-history-count">0</span>
                    </div>
                    <i data-lucide="chevron-down" style="width:16px;height:16px;color:var(--text-muted);"></i>
                </div>
                <div class="sidebar-card-body" id="sidebar-history">
                    <div class="sidebar-empty">
                        <i data-lucide="clock" style="width:24px;height:24px;margin-bottom:8px;opacity:0.5;"></i>
                        <div>No history yet</div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle-btn" id="sidebar-toggle-btn" onclick="toggleRightSidebar()" title="Toggle Feed Panel">
        <i data-lucide="layout-panel-right" style="width:20px;height:20px;" id="sidebar-toggle-icon"></i>
    </button>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loading-text">Fact-checking claim...</div>
        <div class="loading-progress" id="loading-progress"></div>
    </div>

    <script>
        // === STATE ===
        let currentArticle = null;
        const USER_HISTORY_KEY = 'genuverity_history';
        const MAX_HISTORY_ITEMS = 50;
        const USER_SESSION_KEY = 'genuverity_user_session';
        const SIDEBAR_STATE_KEY = 'genuverity_sidebar_open';

        // === USER AUTHENTICATION (Mock) ===
        function isSignedIn() {
            return localStorage.getItem(USER_SESSION_KEY) !== null;
        }

        function getCurrentUser() {
            const session = localStorage.getItem(USER_SESSION_KEY);
            return session ? JSON.parse(session) : null;
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-menu-dropdown');
            dropdown.classList.toggle('open');

            // Close when clicking outside
            if (dropdown.classList.contains('open')) {
                setTimeout(() => {
                    document.addEventListener('click', closeUserMenuOnOutsideClick);
                }, 10);
            }
        }

        function closeUserMenu() {
            document.getElementById('user-menu-dropdown').classList.remove('open');
            document.removeEventListener('click', closeUserMenuOnOutsideClick);
        }

        function closeUserMenuOnOutsideClick(e) {
            const container = document.querySelector('.user-menu-container');
            if (!container.contains(e.target)) {
                closeUserMenu();
            }
        }

        function openSignInModal() {
            closeUserMenu();
            document.getElementById('signin-modal').classList.add('open');
            document.getElementById('signin-password').value = '';
            document.getElementById('signin-error').classList.remove('show');
            setTimeout(() => document.getElementById('signin-password').focus(), 100);
        }

        function closeSignInModal() {
            document.getElementById('signin-modal').classList.remove('open');
        }

        function closeSignInModalOnBackdrop(e) {
            if (e.target === document.getElementById('signin-modal')) {
                closeSignInModal();
            }
        }

        function attemptSignIn() {
            const password = document.getElementById('signin-password').value;
            const email = document.getElementById('signin-email').value;

            // Mock password check - password is "1234"
            if (password === '1234') {
                const user = {
                    email: email,
                    name: email.split('@')[0].charAt(0).toUpperCase() + email.split('@')[0].slice(1),
                    signedInAt: new Date().toISOString()
                };
                localStorage.setItem(USER_SESSION_KEY, JSON.stringify(user));
                closeSignInModal();
                updateUserMenuUI();
                loadSidebarHistory();
            } else {
                document.getElementById('signin-error').classList.add('show');
            }
        }

        function signOut() {
            localStorage.removeItem(USER_SESSION_KEY);
            closeUserMenu();
            updateUserMenuUI();
        }

        function updateUserMenuUI() {
            const user = getCurrentUser();
            const btn = document.getElementById('user-menu-btn');
            const guestIcon = document.getElementById('user-icon-guest');
            const avatar = document.getElementById('user-avatar');
            const label = document.getElementById('user-menu-label');
            const signedOutMenu = document.getElementById('user-menu-signed-out');
            const signedInMenu = document.getElementById('user-menu-signed-in');
            const displayName = document.getElementById('user-display-name');
            const displayEmail = document.getElementById('user-display-email');

            if (user) {
                btn.classList.add('signed-in');
                guestIcon.style.display = 'none';
                avatar.style.display = 'flex';
                avatar.textContent = user.name.charAt(0).toUpperCase();
                label.textContent = user.name;
                signedOutMenu.style.display = 'none';
                signedInMenu.style.display = 'block';
                displayName.textContent = user.name;
                displayEmail.textContent = user.email;
            } else {
                btn.classList.remove('signed-in');
                guestIcon.style.display = 'block';
                avatar.style.display = 'none';
                label.textContent = 'Sign In';
                signedOutMenu.style.display = 'block';
                signedInMenu.style.display = 'none';
            }
            lucide.createIcons();
        }

        // === RIGHT SIDEBAR ===
        function toggleRightSidebar() {
            const sidebar = document.getElementById('right-sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            const isOpen = sidebar.classList.toggle('open');
            toggleBtn.classList.toggle('sidebar-open', isOpen);
            localStorage.setItem(SIDEBAR_STATE_KEY, isOpen ? 'open' : 'closed');

            if (isOpen) {
                loadSidebarContent();
            }
        }

        function initSidebarState() {
            const savedState = localStorage.getItem(SIDEBAR_STATE_KEY);
            if (savedState === 'open') {
                document.getElementById('right-sidebar').classList.add('open');
                document.getElementById('sidebar-toggle-btn').classList.add('sidebar-open');
                loadSidebarContent();
            }
        }

        function toggleSidebarCard(cardId) {
            const body = document.getElementById(cardId);
            body.classList.toggle('collapsed');
        }

        function loadSidebarContent() {
            loadSidebarTrending();
            loadSidebarSocials();
            loadSidebarHistory();
        }

        async function loadSidebarTrending() {
            const container = document.getElementById('sidebar-trending');
            const countBadge = document.getElementById('sidebar-trending-count');

            try {
                const response = await fetch('/api/cache/list');
                const data = await response.json();
                const articles = data.articles || [];

                countBadge.textContent = articles.length;

                if (articles.length === 0) {
                    container.innerHTML = '<div class="sidebar-empty">No trending fact checks</div>';
                    return;
                }

                container.innerHTML = articles.slice(0, 8).map(article => `
                    <div class="sidebar-item" onclick="loadArticle('${article.key}')">
                        <div class="sidebar-item-icon ${getVerdictClass(article.verdict)}">
                            ${getVerdictIcon(article.verdict)}
                        </div>
                        <div class="sidebar-item-content">
                            <div class="sidebar-item-title">${escapeHtml(article.title || article.key)}</div>
                            <div class="sidebar-item-meta">${article.verdict || 'Pending'}</div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (e) {
                container.innerHTML = '<div class="sidebar-empty">Failed to load</div>';
            }
        }

        async function loadSidebarSocials() {
            const container = document.getElementById('sidebar-socials');

            try {
                const response = await fetch('/api/trending/x');
                const data = await response.json();
                const topics = data.topics || [];

                if (topics.length === 0) {
                    container.innerHTML = '<div class="sidebar-empty">No trending social topics</div>';
                    return;
                }

                container.innerHTML = topics.slice(0, 6).map(topic => `
                    <div class="sidebar-item" onclick="useExample('${escapeHtml(topic.title)}')">
                        <div class="sidebar-item-icon">
                            <i data-lucide="message-circle" style="width:16px;height:16px;"></i>
                        </div>
                        <div class="sidebar-item-content">
                            <div class="sidebar-item-title">${escapeHtml(topic.title)}</div>
                            <div class="sidebar-item-meta">${topic.source || 'Social'}</div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            } catch (e) {
                container.innerHTML = '<div class="sidebar-empty">No trending topics available</div>';
            }
        }

        function loadSidebarHistory() {
            const container = document.getElementById('sidebar-history');
            const countBadge = document.getElementById('sidebar-history-count');
            const history = getUserHistory();

            countBadge.textContent = history.length;

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="sidebar-empty">
                        <i data-lucide="clock" style="width:24px;height:24px;margin-bottom:8px;opacity:0.5;"></i>
                        <div>No history yet</div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = history.slice(0, 10).map(item => `
                <div class="sidebar-item" onclick="loadArticle('${item.key}')">
                    <div class="sidebar-item-icon ${getVerdictClass(item.verdict)}">
                        ${getVerdictIcon(item.verdict)}
                    </div>
                    <div class="sidebar-item-content">
                        <div class="sidebar-item-title">${escapeHtml(item.title)}</div>
                        <div class="sidebar-item-meta">${formatTimeAgo(item.viewedAt)}</div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function switchSidebarSocialTab(tab) {
            document.querySelectorAll('.sidebar-subtab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`sidebar-subtab-${tab}`).classList.add('active');
            // Could filter content based on tab here
        }

        function getVerdictClass(verdict) {
            if (!verdict) return '';
            const v = verdict.toUpperCase();
            if (v.includes('TRUE') && !v.includes('FALSE')) return 'verdict-true';
            if (v.includes('FALSE')) return 'verdict-false';
            return 'verdict-mixed';
        }

        function getVerdictIcon(verdict) {
            if (!verdict) return '<i data-lucide="help-circle" style="width:16px;height:16px;"></i>';
            const v = verdict.toUpperCase();
            if (v.includes('TRUE') && !v.includes('FALSE')) return '<i data-lucide="check" style="width:16px;height:16px;"></i>';
            if (v.includes('FALSE')) return '<i data-lucide="x" style="width:16px;height:16px;"></i>';
            return '<i data-lucide="alert-triangle" style="width:16px;height:16px;"></i>';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === USER HISTORY MANAGEMENT ===
        function getUserHistory() {
            try {
                const history = localStorage.getItem(USER_HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }

        function addToUserHistory(article) {
            const history = getUserHistory();
            // Remove if already exists (to move to top)
            const filtered = history.filter(item => item.key !== article.key);
            // Add to front
            filtered.unshift({
                key: article.key,
                title: article.title,
                verdict: article.verdict,
                viewedAt: new Date().toISOString()
            });
            // Limit to max items
            const trimmed = filtered.slice(0, MAX_HISTORY_ITEMS);
            localStorage.setItem(USER_HISTORY_KEY, JSON.stringify(trimmed));
        }

        function clearUserHistory() {
            localStorage.removeItem(USER_HISTORY_KEY);
            loadUserHistory();
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadTrendingFactChecks();
            loadUserHistory();
            updateUserMenuUI();
            initSidebarState();

            // Ctrl+Enter or Cmd+Enter to search (allow plain Enter for newlines in textarea)
            document.getElementById('claim-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    factCheck();
                }
            });

            // Check URL hash for direct article link
            checkUrlHash();
        });

        // === URL HASH HANDLING ===
        function checkUrlHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#article/')) {
                const slug = hash.replace('#article/', '');
                loadArticle(slug);
            }
        }

        window.addEventListener('hashchange', checkUrlHash);

        // === MEDIA UPLOAD HANDLING ===
        let currentMedia = null; // {type: 'file'|'url', data: File|string, preview: string}

        function toggleUrlInput() {
            const wrapper = document.getElementById('url-input-wrapper');
            wrapper.classList.toggle('active');
            if (wrapper.classList.contains('active')) {
                document.getElementById('media-url-input').focus();
            }
        }

        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                alert('Please upload an image or video file');
                return;
            }

            // Create preview
            const reader = new FileReader();
            reader.onload = (e) => {
                currentMedia = {
                    type: 'file',
                    data: file,
                    preview: e.target.result,
                    mimeType: file.type
                };
                showMediaPreview(file.name, file.type.startsWith('image/') ? 'Image' : 'Video', e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function handleUrlPaste() {
            const url = document.getElementById('media-url-input').value.trim();
            if (!url) return;

            // Detect URL type
            let mediaType = 'Link';
            let thumbHtml = '<i data-lucide="link"></i>';

            if (url.includes('tiktok.com')) {
                mediaType = 'TikTok';
                thumbHtml = '<i data-lucide="video"></i>';
            } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                mediaType = 'YouTube';
                // Extract video ID for thumbnail
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    thumbHtml = `<img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="Video thumbnail">`;
                } else {
                    thumbHtml = '<i data-lucide="video"></i>';
                }
            } else if (url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                mediaType = 'Image URL';
                thumbHtml = `<img src="${url}" alt="Image preview">`;
            }

            currentMedia = {
                type: 'url',
                data: url,
                mediaType: mediaType
            };

            showMediaPreview(truncateUrl(url), mediaType, null, thumbHtml);
            document.getElementById('url-input-wrapper').classList.remove('active');
            document.getElementById('media-url-input').value = '';
        }

        function extractYouTubeId(url) {
            const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([^&\s?]+)/);
            return match ? match[1] : null;
        }

        function truncateUrl(url) {
            if (url.length > 40) {
                return url.substring(0, 37) + '...';
            }
            return url;
        }

        function showMediaPreview(name, type, imageSrc, customThumbHtml) {
            const preview = document.getElementById('media-preview');
            const thumb = document.getElementById('media-preview-thumb');
            const nameEl = document.getElementById('media-preview-name');
            const typeEl = document.getElementById('media-preview-type');

            nameEl.textContent = name;
            typeEl.textContent = type;

            if (customThumbHtml) {
                thumb.innerHTML = customThumbHtml;
            } else if (imageSrc) {
                thumb.innerHTML = `<img src="${imageSrc}" alt="Preview">`;
            } else {
                thumb.innerHTML = '<i data-lucide="file"></i>';
            }

            preview.classList.add('active');
            lucide.createIcons();
        }

        function removeMedia() {
            currentMedia = null;
            document.getElementById('media-preview').classList.remove('active');
            document.getElementById('media-file-input').value = '';
            document.getElementById('media-url-input').value = '';
        }

        function useExample(claim) {
            document.getElementById('claim-input').value = claim;
            document.getElementById('claim-input').focus();
        }

        // === SOURCES FIRST TOGGLE ===
        function toggleSourcesFirst() {
            const section = document.getElementById('sources-first-section');
            section.classList.toggle('collapsed');
        }

        // === VIEWS ===
        function showSearch() {
            document.getElementById('view-search').classList.remove('hidden');
            document.getElementById('view-result').classList.remove('active');
            window.location.hash = '';
        }

        function showResult() {
            document.getElementById('view-search').classList.add('hidden');
            document.getElementById('view-result').classList.add('active');
        }

        // === LOADING ===
        function showLoading(text = 'Fact-checking claim...') {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-progress').textContent = '';
        }

        function updateLoading(message, percent) {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-progress').textContent = `${percent}%`;
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // === DASHBOARD TAB SWITCHING ===
        function switchDashboardTab(tab) {
            // Update tab buttons
            document.getElementById('tab-trending').classList.toggle('active', tab === 'trending');
            document.getElementById('tab-hot-social').classList.toggle('active', tab === 'hot-social');
            document.getElementById('tab-history').classList.toggle('active', tab === 'history');

            // Update content visibility
            document.getElementById('dashboard-trending').classList.toggle('hidden', tab !== 'trending');
            document.getElementById('dashboard-hot-social').classList.toggle('hidden', tab !== 'hot-social');
            document.getElementById('dashboard-history').classList.toggle('hidden', tab !== 'history');

            // Load social topics when tab is clicked
            if (tab === 'hot-social') {
                loadSocialTopics();
            }

            lucide.createIcons();
        }

        // === TRENDING FACT CHECKS ===
        async function loadTrendingFactChecks() {
            try {
                const response = await fetch('/api/cache/list');
                const data = await response.json();

                const container = document.getElementById('trending-fact-checks');

                if (!data.articles || data.articles.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No fact checks yet. Enter a claim above to get started.</p>';
                    return;
                }

                // Filter to fact checks only and take recent 12
                const factChecks = data.articles
                    .filter(a => a.article_type === 'fact_check' || a.verdict)
                    .slice(0, 12);

                container.innerHTML = factChecks.map(article => {
                    const verdictClass = getVerdictClass(article.verdict);
                    const date = article.cached_at ? new Date(article.cached_at).toLocaleDateString() : '';

                    return `
                        <div class="fact-check-card ${verdictClass}" onclick="loadArticle('${article.key}')">
                            ${article.verdict ? `<span class="card-verdict">${article.verdict.replace('_', ' ')}</span>` : ''}
                            <h3 class="card-title">${escapeHtml(article.title)}</h3>
                            ${date ? `<span class="card-date">${date}</span>` : ''}
                        </div>
                    `;
                }).join('');

                lucide.createIcons();

            } catch (error) {
                console.error('Failed to load trending fact checks:', error);
            }
        }

        // === HOT ON SOCIAL ===
        let socialCache = {
            all: null,
            x: null,
            reddit: null,
            misinfo: null,
            timestamp: 0
        };
        let currentSocialSubtab = 'all';

        function switchSocialSubtab(subtab) {
            currentSocialSubtab = subtab;

            // Update subtab buttons
            document.querySelectorAll('.social-subtab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`subtab-${subtab}`).classList.add('active');

            // Show/hide content sections
            document.getElementById('social-content-all').classList.toggle('hidden', subtab === 'misinfo');
            document.getElementById('social-content-misinfo').classList.toggle('hidden', subtab !== 'misinfo');

            // Load appropriate content
            if (subtab === 'misinfo') {
                loadMisinfoSources();
            } else {
                loadSocialTopics(subtab);
            }

            lucide.createIcons();
        }

        async function loadSocialTopics(filter = 'all') {
            const container = document.getElementById('social-topics-grid');
            const cacheAge = Date.now() - socialCache.timestamp;

            // Use cache if fresh (5 minutes)
            if (socialCache.all && cacheAge < 300000) {
                renderSocialTopics(socialCache.all, filter);
                return;
            }

            container.innerHTML = `
                <div class="x-loading">
                    <div class="loading-spinner-small"></div>
                    <span>Finding trending topics...</span>
                </div>
            `;

            try {
                // Fetch from multiple sources in parallel
                const [xResponse, redditResponse, factCheckResponse] = await Promise.all([
                    fetch('/api/trending/x'),
                    fetch('/api/trending/reddit'),
                    fetch('/api/trending/factchecks')
                ]);

                const xData = await xResponse.json();
                const redditData = await redditResponse.json();
                const factCheckData = await factCheckResponse.json();

                let allTopics = [];

                // X/Twitter topics
                if (xData.topics && xData.topics.length > 0) {
                    allTopics.push(...xData.topics.map(t => ({ ...t, sourceType: 'x', platform: 'X / Twitter' })));
                }

                // Reddit topics
                const redditPosts = redditData.posts || [];
                if (redditPosts.length > 0) {
                    allTopics.push(...redditPosts.map(t => ({
                        ...t,
                        sourceType: 'reddit',
                        platform: t.subreddit || 'Reddit'
                    })));
                }

                // Fact-checker topics
                const factChecks = factCheckData.topics || factCheckData.factchecks || [];
                if (factChecks.length > 0) {
                    allTopics.push(...factChecks.map(t => ({ ...t, sourceType: 'factchecker', platform: 'Fact Checker' })));
                }

                // Cache results
                socialCache = {
                    all: allTopics,
                    timestamp: Date.now()
                };

                renderSocialTopics(allTopics, filter);

            } catch (error) {
                console.error('Failed to load social topics:', error);
                container.innerHTML = `
                    <div class="x-empty-state">
                        <i data-lucide="alert-circle"></i>
                        <p>Unable to load trending topics. Please try again later.</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        async function loadMisinfoSources() {
            const container = document.getElementById('misinfo-topics-grid');

            // Use cache if fresh
            if (socialCache.misinfo && (Date.now() - socialCache.timestamp < 300000)) {
                renderMisinfoTopics(socialCache.misinfo);
                return;
            }

            container.innerHTML = `
                <div class="x-loading">
                    <div class="loading-spinner-small"></div>
                    <span>Scanning misinformation sources...</span>
                </div>
            `;

            try {
                const response = await fetch('/api/trending/misinfo-sources');
                const data = await response.json();

                socialCache.misinfo = data.claims || [];
                renderMisinfoTopics(socialCache.misinfo);

            } catch (error) {
                console.error('Failed to load misinfo sources:', error);
                container.innerHTML = `
                    <div class="x-empty-state">
                        <i data-lucide="alert-triangle"></i>
                        <p>Unable to scan misinformation sources.</p>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function renderSocialTopics(topics, filter = 'all') {
            const container = document.getElementById('social-topics-grid');

            // Apply filter
            let filtered = topics;
            if (filter === 'x') {
                filtered = topics.filter(t => t.sourceType === 'x');
            } else if (filter === 'reddit') {
                filtered = topics.filter(t => t.sourceType === 'reddit');
            }

            if (!filtered || filtered.length === 0) {
                container.innerHTML = `
                    <div class="x-empty-state">
                        <i data-lucide="message-circle"></i>
                        <p>No trending topics found for this filter.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = filtered.slice(0, 10).map(topic => {
                const icon = getSourceIcon(topic.sourceType);
                const sourceClass = `source-${topic.sourceType}`;

                return `
                    <div class="x-topic-card ${sourceClass}" onclick="useSocialTopic('${escapeHtml(topic.title.replace(/'/g, "\\'"))}')">
                        <div class="x-topic-header">
                            <i data-lucide="${icon}" class="x-topic-icon"></i>
                            <span class="x-topic-source">${escapeHtml(topic.platform || topic.source)}</span>
                        </div>
                        <div class="x-topic-title">${escapeHtml(topic.title)}</div>
                        ${topic.snippet ? `<div class="x-topic-snippet">${escapeHtml(topic.snippet)}</div>` : ''}
                        <div class="x-topic-action">
                            <i data-lucide="search" style="width:14px;height:14px;"></i>
                            <span>Fact check this</span>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function renderMisinfoTopics(claims) {
            const container = document.getElementById('misinfo-topics-grid');

            if (!claims || claims.length === 0) {
                container.innerHTML = `
                    <div class="x-empty-state">
                        <i data-lucide="shield-check"></i>
                        <p>No new claims detected from misinformation sources.</p>
                        <p style="font-size: 0.85rem; margin-top: 8px;">Check back later for updates.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = claims.slice(0, 10).map(claim => {
                const sourceClass = `source-${claim.sourceType || 'misinfo'}`;
                const icon = getSourceIcon(claim.sourceType || 'misinfo');
                // Use full title for click, displayTitle for showing
                const fullTitle = claim.title || '';
                const displayTitle = claim.displayTitle || claim.title || '';

                return `
                    <div class="x-topic-card ${sourceClass}" onclick="useSocialTopic('${escapeHtml(fullTitle.replace(/'/g, "\\'"))}')">
                        <div class="x-topic-header">
                            <i data-lucide="${icon}" class="x-topic-icon"></i>
                            <span class="x-topic-source">${escapeHtml(claim.source)}</span>
                        </div>
                        <div class="x-topic-title">${escapeHtml(displayTitle)}</div>
                        ${claim.snippet ? `<div class="x-topic-snippet">${escapeHtml(claim.snippet)}</div>` : ''}
                        <div class="x-topic-action">
                            <i data-lucide="alert-triangle" style="width:14px;height:14px;color:#f59e0b;"></i>
                            <span>Fact check before it spreads</span>
                        </div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function getSourceIcon(sourceType) {
            const icons = {
                'x': 'twitter',
                'reddit': 'message-circle',
                'factchecker': 'shield-check',
                '4chan': 'hash',
                'infowars': 'alert-triangle',
                'breitbart': 'newspaper',
                'zerohedge': 'trending-down',
                'gateway': 'alert-octagon',
                'telegram': 'send',
                'misinfo': 'alert-triangle',
                'fringe': 'alert-circle',
                // New source types for expanded 50+ sources
                'far_right': 'flag',
                'health': 'heart-pulse',
                'qanon': 'eye',
                'russian': 'globe',
                'alt_platform': 'radio'
            };
            return icons[sourceType] || 'globe';
        }

        function useSocialTopic(title) {
            const cleanTitle = title
                .replace(/^\[.*?\]\s*/, '')
                .replace(/^RT:\s*/i, '')
                .replace(/https?:\/\/\S+/g, '')
                .replace(/\s*\|.*$/, '') // Remove "| Site Name" suffixes
                .trim();

            document.getElementById('claim-input').value = cleanTitle;
            showSearch();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('claim-input').focus();
        }

        // === USER HISTORY ===
        function loadUserHistory() {
            const history = getUserHistory();
            const container = document.getElementById('user-history');

            if (history.length === 0) {
                container.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon"></div>
                        <p>No fact checks in your history yet.</p>
                        <p style="font-size: 0.9rem; margin-top: 8px;">Your viewed fact checks will appear here.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = history.map(item => {
                const verdictClass = getVerdictClass(item.verdict);
                const date = item.viewedAt ? new Date(item.viewedAt).toLocaleDateString() : '';

                return `
                    <div class="fact-check-card ${verdictClass}" onclick="loadArticle('${item.key}')">
                        ${item.verdict ? `<span class="card-verdict">${item.verdict.replace('_', ' ')}</span>` : ''}
                        <h3 class="card-title">${escapeHtml(item.title)}</h3>
                        ${date ? `<span class="card-date">Viewed ${date}</span>` : ''}
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        // === FACT CHECK ===
        async function factCheck() {
            const claim = document.getElementById('claim-input').value.trim();
            if (!claim && !currentMedia) {
                alert('Please enter a claim or upload media to fact-check');
                return;
            }

            showLoading('Preparing fact check...');

            try {
                // Build request body
                let requestBody = { claim: claim || '' };

                // Add media if present
                if (currentMedia) {
                    if (currentMedia.type === 'file') {
                        requestBody.mediaType = currentMedia.mimeType.startsWith('image/') ? 'image' : 'video';
                        requestBody.mediaData = currentMedia.preview; // Base64 data URL
                    } else if (currentMedia.type === 'url') {
                        requestBody.mediaUrl = currentMedia.data;
                        requestBody.mediaType = currentMedia.mediaType.toLowerCase();
                    }
                }

                // First check cache (using claim text only for cache key)
                const cacheCheck = await fetch('/api/cache/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: claim || currentMedia?.data || '' })
                });
                const cacheData = await cacheCheck.json();

                if (cacheData.cached && cacheData.article) {
                    hideLoading();
                    removeMedia(); // Clear media after use
                    displayArticle(cacheData.article);
                    return;
                }

                // Generate new fact check with SSE
                const response = await fetch('/api/fact-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            const eventType = line.substring(7);
                            continue;
                        }
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));

                            if (data.stage && data.percent !== undefined) {
                                updateLoading(data.message || 'Processing...', data.percent);
                            } else if (data.title || data.verdict) {
                                // This is the final article data
                                hideLoading();
                                displayArticle(data);
                                loadTrendingFactChecks(); // Refresh trending list
                            }
                        }
                    }
                }

                hideLoading();

            } catch (error) {
                console.error('Fact check error:', error);
                hideLoading();
                alert('Failed to fact-check claim. Please try again.');
            }
        }

        // === LOAD EXISTING ARTICLE ===
        async function loadArticle(slug) {
            showLoading('Loading fact check...');

            try {
                const response = await fetch(`/api/article/${slug}`);
                if (!response.ok) throw new Error('Article not found');

                const article = await response.json();
                hideLoading();
                displayArticle(article);

            } catch (error) {
                console.error('Failed to load article:', error);
                hideLoading();
                alert('Failed to load fact check.');
            }
        }

        // === DISPLAY ARTICLE ===
        function displayArticle(article) {
            currentArticle = article;
            window.location.hash = `article/${article.key}`;

            // Clear media after displaying
            removeMedia();

            // Add to user history
            addToUserHistory(article);
            loadUserHistory(); // Refresh history tab
            loadSidebarHistory(); // Refresh sidebar history

            // Update sources count and render
            const sources = article.sources || [];
            document.getElementById('sources-count').textContent = `(${sources.length})`;
            renderSources(sources);

            // Ensure sources section is expanded by default
            document.getElementById('sources-first-section').classList.remove('collapsed');

            // Update content
            const contentEl = document.getElementById('article-content');
            contentEl.innerHTML = article.content || '<p class="prose-text">No content available.</p>';

            // Initialize tab functionality
            initFactCheckTabs();

            showResult();
            lucide.createIcons();
        }

        // === SOURCES ===
        function renderSources(sources) {
            if (!sources || sources.length === 0) {
                document.getElementById('sources-list').innerHTML = '<p style="color: var(--text-muted);">No sources available.</p>';
                document.getElementById('sources-tabs').innerHTML = '';
                return;
            }

            // Sort by score and categorize
            const sorted = [...sources].sort((a, b) => (b.score || 0) - (a.score || 0));
            const primary = sorted.filter(s => (s.score || 0) >= 85);
            const secondary = sorted.filter(s => (s.score || 0) >= 70 && (s.score || 0) < 85);
            const tertiary = sorted.filter(s => (s.score || 0) < 70);

            // Render tabs
            const tabs = [];
            if (primary.length) tabs.push({ id: 'primary', label: `Primary (${primary.length})`, sources: primary });
            if (secondary.length) tabs.push({ id: 'secondary', label: `Secondary (${secondary.length})`, sources: secondary });
            if (tertiary.length) tabs.push({ id: 'tertiary', label: `Other (${tertiary.length})`, sources: tertiary });

            if (tabs.length === 0) tabs.push({ id: 'all', label: 'All', sources: sorted });

            document.getElementById('sources-tabs').innerHTML = tabs.map((tab, i) =>
                `<button class="source-tab ${i === 0 ? 'active' : ''}" onclick="switchSourceTab('${tab.id}')" data-sources='${JSON.stringify(tab.sources)}'>${tab.label}</button>`
            ).join('');

            // Show first tab sources
            renderSourcesList(tabs[0].sources);
        }

        function switchSourceTab(tabId) {
            const tabs = document.querySelectorAll('.source-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(tabId) ||
                    (tabId === 'primary' && tab.textContent.includes('Primary')) ||
                    (tabId === 'secondary' && tab.textContent.includes('Secondary')) ||
                    (tabId === 'tertiary' && tab.textContent.includes('Other')) ||
                    (tabId === 'all' && tab.textContent.includes('All'))) {
                    tab.classList.add('active');
                    const sources = JSON.parse(tab.dataset.sources || '[]');
                    renderSourcesList(sources);
                }
            });
        }

        function renderSourcesList(sources) {
            const container = document.getElementById('sources-list');
            container.innerHTML = sources.map(source => {
                const score = source.score || 50;
                const scoreClass = score >= 85 ? 'score-high' : score >= 70 ? 'score-medium' : 'score-low';
                const domain = source.url ? new URL(source.url).hostname : 'Unknown';

                return `
                    <div class="source-item">
                        <div class="source-score ${scoreClass}">${score}</div>
                        <div class="source-info">
                            <div class="source-name">
                                <a href="${source.url || '#'}" target="_blank" rel="noopener">${escapeHtml(source.name || domain)}</a>
                            </div>
                            <div class="source-domain">${domain}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === FACT CHECK TABS ===
        function initFactCheckTabs() {
            const tabs = document.querySelectorAll('.fact-check-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => switchFactCheckTab(e, tab.getAttribute('onclick')?.match(/'([^']+)'/)?.[1]));
            });
        }

        function switchFactCheckTab(event, tabId) {
            if (!tabId) return;

            // Update tab buttons
            document.querySelectorAll('.fact-check-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.fact-check-tab-content').forEach(content => content.classList.remove('active'));
            const targetContent = document.getElementById(tabId);
            if (targetContent) targetContent.classList.add('active');
        }

        // === UTILITIES ===
        function getVerdictClass(verdict) {
            if (!verdict) return '';
            const v = verdict.toLowerCase().replace('_', '-');
            return `verdict-${v}`;
        }

        function getVerdictIcon(verdict) {
            switch(verdict?.toUpperCase()) {
                case 'TRUE': return '';
                case 'MOSTLY_TRUE': return '';
                case 'FALSE': return '';
                case 'MOSTLY_FALSE': return '';
                case 'MIXED': return '';
                default: return '?';
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === NETWORK GRAPH VISUALIZATION ===
        function renderNetworkGraph(article) {
            const container = document.getElementById('network-graph');
            if (!container || !article) return;

            // Clear previous
            container.innerHTML = '';

            // Extract data from article
            const disinfo = article.disinfoAnalysis || {};
            const sources = article.sources || [];
            const amplifiers = disinfo.amplificationPattern?.topAmplifiers || [];
            const mutations = disinfo.narrativeMutations || [];

            // Build nodes and links
            const nodes = [];
            const links = [];

            // Central claim node
            nodes.push({
                id: 'claim',
                type: 'claim',
                label: (article.title || 'Claim').substring(0, 30) + '...',
                fullLabel: article.title,
                size: 25
            });

            // Source nodes
            sources.slice(0, 8).forEach((src, i) => {
                const nodeId = `source_${i}`;
                nodes.push({
                    id: nodeId,
                    type: 'source',
                    label: (src.name || 'Source').substring(0, 20),
                    fullLabel: src.name,
                    url: src.url,
                    score: src.score,
                    size: 12 + (src.score || 50) / 10
                });
                links.push({ source: nodeId, target: 'claim', type: 'cited' });
            });

            // Amplifier nodes
            amplifiers.slice(0, 6).forEach((amp, i) => {
                const nodeId = `amp_${i}`;
                nodes.push({
                    id: nodeId,
                    type: 'amplifier',
                    label: (amp.name || 'Amplifier').substring(0, 20),
                    fullLabel: amp.name,
                    ampType: amp.type,
                    reach: amp.reach,
                    platform: amp.platform,
                    size: 10 + Math.min(Math.log10(amp.reach || 1000), 15)
                });
                links.push({ source: 'claim', target: nodeId, type: 'amplified' });
            });

            // Mutation nodes
            mutations.slice(0, 4).forEach((mut, i) => {
                const nodeId = `mutation_${i}`;
                nodes.push({
                    id: nodeId,
                    type: 'mutation',
                    label: (mut.variant || 'Mutation').substring(0, 25),
                    fullLabel: mut.variant,
                    date: mut.firstSeen,
                    changeType: mut.changeType,
                    size: 14
                });
                links.push({ source: 'claim', target: nodeId, type: 'mutated' });
            });

            if (nodes.length <= 1) {
                container.innerHTML = '<div style="text-align: center; padding: 80px 20px; color: var(--text-muted);">No spread data available for this claim.</div>';
                return;
            }

            // D3 Force Simulation
            const width = container.clientWidth || 600;
            const height = 400;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height]);

            // Color scale
            const colorScale = {
                claim: '#06b6d4',      // cyan
                source: '#10b981',      // green
                amplifier: '#f59e0b',   // amber
                mutation: '#3b82f6'     // blue
            };

            // Simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.size + 10));

            // Links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', d => `graph-link ${d.type}`)
                .attr('stroke-width', 1.5);

            // Nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('class', 'graph-node')
                .attr('r', d => d.size)
                .attr('fill', d => colorScale[d.type])
                .call(drag(simulation));

            // Labels
            const labels = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('class', 'graph-node-label')
                .attr('dy', d => d.size + 12)
                .attr('text-anchor', 'middle')
                .text(d => d.label);

            // Tooltip
            const tooltip = d3.select(container.parentElement)
                .append('div')
                .attr('class', 'graph-tooltip')
                .style('display', 'none');

            node.on('mouseover', (event, d) => {
                let meta = '';
                if (d.type === 'source') meta = `Trust: ${d.score || 'N/A'}`;
                if (d.type === 'amplifier') meta = `Reach: ${formatNumber(d.reach)} | ${d.platform || 'Unknown'}`;
                if (d.type === 'mutation') meta = d.date || '';

                tooltip.style('display', 'block')
                    .html(`
                        <div class="graph-tooltip-type">${d.type}</div>
                        <div class="graph-tooltip-title">${escapeHtml(d.fullLabel || d.label)}</div>
                        ${meta ? `<div class="graph-tooltip-meta">${meta}</div>` : ''}
                    `)
                    .style('left', (event.offsetX + 15) + 'px')
                    .style('top', (event.offsetY - 10) + 'px');
            })
            .on('mouseout', () => tooltip.style('display', 'none'))
            .on('click', (event, d) => {
                if (d.url) window.open(d.url, '_blank');
            });

            // Tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x = Math.max(d.size, Math.min(width - d.size, d.x)))
                    .attr('cy', d => d.y = Math.max(d.size, Math.min(height - d.size, d.y)));

                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            // Drag behavior
            function drag(simulation) {
                return d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
        }

        // === TIMELINE VISUALIZATION ===
        function renderSpreadTimeline(article) {
            const container = document.getElementById('spread-timeline-track');
            if (!container || !article) return;

            const disinfo = article.disinfoAnalysis || {};
            const origin = disinfo.originEstimate || {};
            const mutations = disinfo.narrativeMutations || [];
            const peak = disinfo.amplificationPattern?.peakDate;

            // Build timeline points
            const points = [];

            // Origin point
            if (origin.firstSeen) {
                points.push({
                    date: origin.firstSeen,
                    type: 'origin',
                    label: 'First Seen',
                    detail: origin.firstSource || 'Unknown source'
                });
            }

            // Mutation points
            mutations.forEach(mut => {
                if (mut.firstSeen) {
                    points.push({
                        date: mut.firstSeen,
                        type: 'mutation',
                        label: mut.changeType || 'Mutation',
                        detail: (mut.variant || '').substring(0, 40)
                    });
                }
            });

            // Peak point
            if (peak) {
                points.push({
                    date: peak,
                    type: 'peak',
                    label: 'Peak Spread',
                    detail: 'Maximum amplification'
                });
            }

            // Current/now point
            points.push({
                date: new Date().toISOString().split('T')[0],
                type: 'current',
                label: 'Now',
                detail: 'Current state'
            });

            // Sort by date
            points.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (points.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No timeline data available.</div>';
                return;
            }

            // Calculate positions
            const minDate = new Date(points[0].date);
            const maxDate = new Date(points[points.length - 1].date);
            const range = maxDate - minDate || 1;

            container.innerHTML = `
                <div class="timeline-line"></div>
                ${points.map((p, i) => {
                    const pos = points.length === 1 ? 50 : ((new Date(p.date) - minDate) / range) * 90 + 5;
                    return `
                        <div class="timeline-point" style="left: ${pos}%" title="${p.detail}">
                            <div class="timeline-dot ${p.type}"></div>
                            <div class="timeline-label">
                                <div class="timeline-label-title">${p.label}</div>
                                <div>${formatDate(p.date)}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
        }

        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // === RENDER DISINFO ANALYSIS TAB ===
        function renderDisinfoTab(article) {
            const disinfo = article.disinfoAnalysis;
            if (!disinfo) return '';

            const origin = disinfo.originEstimate || {};
            const spread = disinfo.amplificationPattern || {};
            const mutations = disinfo.narrativeMutations || [];
            const campaign = disinfo.disinfoCampaignIndicators || {};

            // Build spread stats
            const stats = [];
            if (spread.spreadVelocity) stats.push({ label: 'Spread Velocity', value: spread.spreadVelocity });
            if (spread.botInvolvement) stats.push({ label: 'Bot Activity', value: spread.botInvolvement });
            if (origin.confidence) stats.push({ label: 'Origin Confidence', value: Math.round(origin.confidence * 100) + '%' });

            return `
                <div class="disinfo-section">
                    <!-- Network Graph -->
                    <div class="network-graph-container">
                        <div class="network-graph-header">
                            <div class="network-graph-title">
                                <i data-lucide="git-branch"></i>
                                Claim Spread Network
                            </div>
                            <div class="network-graph-legend">
                                <div class="legend-item"><div class="legend-dot claim"></div> Claim</div>
                                <div class="legend-item"><div class="legend-dot source"></div> Source</div>
                                <div class="legend-item"><div class="legend-dot amplifier"></div> Amplifier</div>
                                <div class="legend-item"><div class="legend-dot mutation"></div> Mutation</div>
                            </div>
                        </div>
                        <div id="network-graph"></div>
                    </div>

                    <!-- Timeline -->
                    <div class="spread-timeline">
                        <div class="timeline-header">
                            <i data-lucide="calendar"></i>
                            Spread Timeline
                        </div>
                        <div class="timeline-track" id="spread-timeline-track"></div>
                        ${stats.length > 0 ? `
                            <div class="spread-stats">
                                ${stats.map(s => `
                                    <div class="spread-stat">
                                        <div class="spread-stat-value">${s.value}</div>
                                        <div class="spread-stat-label">${s.label}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>

                    <!-- Origin Info -->
                    ${origin.firstSeen ? `
                        <div class="disinfo-origin">
                            <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="search"></i> Origin Estimate
                            </h4>
                            <p><strong>First Seen:</strong> ${formatDate(origin.firstSeen)}</p>
                            <p><strong>Source:</strong> ${escapeHtml(origin.firstSource || 'Unknown')}</p>
                            <p><strong>Origin Type:</strong> ${origin.originType || 'Unknown'}</p>
                            <p><strong>Confidence:</strong> ${Math.round((origin.confidence || 0) * 100)}%</p>
                        </div>
                    ` : ''}

                    <!-- Top Amplifiers -->
                    ${spread.topAmplifiers && spread.topAmplifiers.length > 0 ? `
                        <div class="disinfo-spread">
                            <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="share-2"></i> Top Amplifiers
                            </h4>
                            <div class="amplifier-list">
                                ${spread.topAmplifiers.slice(0, 5).map(amp => `
                                    <div class="amplifier-card">
                                        <span class="amplifier-type">${amp.type || 'unknown'}</span>
                                        <span class="amplifier-name">${escapeHtml(amp.name)}</span>
                                        <span class="amplifier-reach">${formatNumber(amp.reach)} reach</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Narrative Mutations -->
                    ${mutations.length > 0 ? `
                        <div class="disinfo-spread">
                            <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="git-merge"></i> Narrative Mutations
                            </h4>
                            <div class="mutation-timeline">
                                ${mutations.map(mut => `
                                    <div class="mutation-item">
                                        <span class="mutation-date">${formatDate(mut.firstSeen)}</span>
                                        <div class="mutation-text">"${escapeHtml(mut.variant)}"</div>
                                        <span class="mutation-type">${mut.changeType || 'modification'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Campaign Indicators -->
                    ${campaign.isLikelyCampaign ? `
                        <div class="disinfo-origin" style="border-left: 3px solid var(--verdict-false);">
                            <h4 style="margin-bottom: 12px; color: var(--verdict-false); display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="alert-triangle"></i> Potential Coordinated Campaign
                            </h4>
                            ${campaign.campaignName ? `<p><strong>Campaign:</strong> ${escapeHtml(campaign.campaignName)}</p>` : ''}
                            ${campaign.knownActors && campaign.knownActors.length > 0 ? `
                                <p><strong>Known Actors:</strong> ${campaign.knownActors.map(a => escapeHtml(a)).join(', ')}</p>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Enhanced displayArticle to include disinfo tab rendering
        const originalDisplayArticle = displayArticle;
        displayArticle = function(article) {
            originalDisplayArticle(article);

            // After content is rendered, initialize network graph and timeline
            setTimeout(() => {
                if (article.disinfoAnalysis) {
                    renderNetworkGraph(article);
                    renderSpreadTimeline(article);
                }
            }, 100);
        };
    </script>
</body>
</html>
