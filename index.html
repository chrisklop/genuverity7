<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT RESTORED -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GenuVerity | The Infinite Archive</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* === THEME SYSTEM - Dark/Light with Radix Colors === */
        /* Using Slate scale for neutrals, Blue for accents */
        /* WCAG AA compliant: 4.5:1 normal text, 3:1 large text */

        /* DARK MODE (Default) - Based on Radix Slate Dark */
        :root, [data-theme="dark"] {
            /* Background layers (Radix slate-dark 1-6) */
            --bg-deep: #111113;      /* slate-1: app background */
            --bg-card: #18191b;      /* slate-2: subtle background */
            --bg-elevated: #212225;  /* slate-3: UI element background */

            /* Text hierarchy (Radix slate-dark 11-12) */
            --text-main: #ffffff;    /* pure white for main text */
            --text-muted: #9ba1a6;   /* slate-11: low contrast text */
            --text-prose: #ffffff;   /* white for body text - accessibility */
            --text-bold: #ffffff;    /* pure white for bold emphasis */

            /* Borders and dividers */
            --border-color: rgba(255, 255, 255, 0.08);

            /* Accent colors (Radix Blue scale) */
            --accent-blue: #3e63dd;  /* blue-9: solid backgrounds */
            --accent-green: #30a46c; /* green-9: success states */
            --accent-warm: #f76b15;  /* orange-9: warning states */
            --accent-teal: #06b6d4;  /* teal-500: fact check, enhance */

            /* Logo styling */
            --logo-accent: #3e63dd;
            --logo-bg: linear-gradient(135deg, #1f2f6d, #3e63dd);
            --logo-text: #edeef0;

            /* Glass effects */
            --glass: rgba(17, 17, 19, 0.95);
            --glass-border: rgba(62, 99, 221, 0.15);

            /* Shadows and gradients */
            --shadow-color: rgba(0, 0, 0, 0.5);
            --gradient-start: #151517;
            --gradient-end: #111113;
            --chart-bg: rgba(62, 99, 221, 0.06);
        }

        /* LIGHT MODE - Based on Radix Slate Light */
        [data-theme="light"] {
            /* Background layers (Radix slate-light 1-6) */
            --bg-deep: #fbfcfd;      /* slate-1: app background */
            --bg-card: #ffffff;      /* white for cards */
            --bg-elevated: #f1f3f5;  /* slate-3: UI element background */

            /* Text hierarchy (Radix slate-light 11-12) */
            --text-main: #1c2024;    /* slate-12: high contrast text */
            --text-muted: #60646c;   /* slate-11: low contrast text */
            --text-prose: #3e4249;   /* between 11-12 for body text */

            /* Borders and dividers */
            --border-color: rgba(0, 0, 0, 0.08);

            /* Accent colors (Radix Blue scale - light mode) */
            --accent-blue: #3e63dd;  /* blue-9: solid backgrounds */
            --accent-green: #30a46c; /* green-9: success states */
            --accent-warm: #f76b15;  /* orange-9: warning states */
            --accent-teal: #06b6d4;  /* teal-500: fact check, enhance */

            /* Logo styling */
            --logo-accent: #3e63dd;
            --logo-bg: linear-gradient(135deg, #1f2f6d, #3e63dd);
            --logo-text: #ffffff;

            /* Glass effects */
            --glass: rgba(251, 252, 253, 0.95);
            --glass-border: rgba(62, 99, 221, 0.12);

            /* Shadows and gradients */
            --shadow-color: rgba(0, 0, 0, 0.06);
            --gradient-start: #eef1f4;
            --gradient-end: #fbfcfd;
            --chart-bg: rgba(62, 99, 221, 0.04);
        }

        /* System preference detection - auto-apply light mode */
        @media (prefers-color-scheme: light) {
            :root:not([data-theme="dark"]) {
                /* Background layers */
                --bg-deep: #fbfcfd;
                --bg-card: #ffffff;
                --bg-elevated: #f1f3f5;

                /* Text hierarchy */
                --text-main: #1c2024;
                --text-muted: #60646c;
                --text-prose: #3e4249;

                /* Borders */
                --border-color: rgba(0, 0, 0, 0.08);

                /* Accents */
                --accent-blue: #3e63dd;
                --accent-green: #30a46c;
                --accent-warm: #f76b15;
                --accent-teal: #06b6d4;

                /* Logo */
                --logo-accent: #3e63dd;
                --logo-bg: linear-gradient(135deg, #1f2f6d, #3e63dd);
                --logo-text: #ffffff;

                /* Glass */
                --glass: rgba(251, 252, 253, 0.95);
                --glass-border: rgba(62, 99, 221, 0.12);

                /* Shadows */
                --shadow-color: rgba(0, 0, 0, 0.06);
                --gradient-start: #eef1f4;
                --gradient-end: #fbfcfd;
                --chart-bg: rgba(62, 99, 221, 0.04);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(circle at 50% 0%, var(--gradient-start) 0%, var(--gradient-end) 80%);
            transition: background-color 0.3s, color 0.3s;
        }

        /* === READING PROGRESS BAR === */
        #reading-progress {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            z-index: 40;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        #reading-progress.visible {
            transform: translateY(0);
        }

        #progress-bar {
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            width: 0%;
            transition: width 0.1s ease-out;
        }

        /* === KEYBOARD SHORTCUTS MODAL === */
        #shortcuts-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #shortcuts-modal.visible {
            display: flex;
        }

        .shortcuts-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px var(--shadow-color);
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-main);
            box-shadow: 0 2px 0 var(--shadow-color);
        }

        /* === LOGO STYLING === */
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: var(--logo-bg);
            color: var(--logo-text);
            transition: background 0.3s, color 0.3s;
        }

        /* === LOGO VERITY CIRCUIT TRACE === */
        .logo-verity {
            color: var(--logo-accent);
            position: relative;
            display: inline-block;
        }

        /* Circuit trace underline - thin line beneath the text */
        .logo-verity::after {
            content: '';
            position: absolute;
            bottom: 0.05em;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--logo-accent) 50%,
                transparent 100%
            );
            opacity: 0;
            animation: circuit-trace 12s ease-in-out infinite;
            animation-delay: 3s;
        }

        /* The traveling energy pulse */
        .logo-verity::before {
            content: '';
            position: absolute;
            bottom: 0.05em;
            left: -10%;
            width: 20%;
            height: 2px;
            background: linear-gradient(90deg,
                transparent,
                rgba(62, 99, 221, 0.8),
                #fff,
                rgba(62, 99, 221, 0.8),
                transparent
            );
            opacity: 0;
            filter: blur(0.5px);
            box-shadow: 0 0 8px rgba(62, 99, 221, 0.6), 0 0 16px rgba(62, 99, 221, 0.3);
            animation: circuit-pulse 12s ease-in-out infinite;
            animation-delay: 3s;
        }

        @keyframes circuit-trace {
            0%, 85%, 100% { opacity: 0; }
            88%, 97% { opacity: 0.4; }
        }

        @keyframes circuit-pulse {
            0%, 85% {
                opacity: 0;
                left: -20%;
            }
            88% {
                opacity: 1;
                left: -20%;
            }
            97% {
                opacity: 1;
                left: 100%;
            }
            100% {
                opacity: 0;
                left: 100%;
            }
        }

        /* Circuit trace for Sources First header - green themed */
        .sources-first-title h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-green) 50%, transparent 100%);
            opacity: 0;
            animation: circuit-trace-green 15s ease-in-out infinite;
            animation-delay: 5s;
        }

        .sources-first-title h3::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: -10%;
            width: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.8), #fff, rgba(16, 185, 129, 0.8), transparent);
            opacity: 0;
            filter: blur(0.3px);
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
            animation: circuit-pulse-green 15s ease-in-out infinite;
            animation-delay: 5s;
        }

        @keyframes circuit-trace-green {
            0%, 87%, 100% { opacity: 0; }
            90%, 97% { opacity: 0.5; }
        }

        @keyframes circuit-pulse-green {
            0%, 87% { opacity: 0; left: -20%; }
            90% { opacity: 1; left: -20%; }
            97% { opacity: 1; left: 100%; }
            100% { opacity: 0; left: 100%; }
        }

        /* Circuit trace for report title - one-time on load */
        #report-title {
            position: relative;
            display: inline-block;
        }

        #report-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-blue) 50%, transparent 100%);
            opacity: 0;
            animation: title-trace 2s ease-out forwards;
            animation-delay: 0.5s;
        }

        #report-title::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10%;
            width: 25%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(62, 99, 221, 0.8), #fff, rgba(62, 99, 221, 0.8), transparent);
            opacity: 0;
            filter: blur(0.5px);
            box-shadow: 0 0 8px rgba(62, 99, 221, 0.6);
            animation: title-pulse 2s ease-out forwards;
            animation-delay: 0.5s;
        }

        @keyframes title-trace {
            0%, 20% { opacity: 0; }
            30%, 80% { opacity: 0.4; }
            100% { opacity: 0; }
        }

        @keyframes title-pulse {
            0%, 20% { opacity: 0; left: -25%; }
            30% { opacity: 1; left: -25%; }
            80% { opacity: 1; left: 100%; }
            100% { opacity: 0; left: 100%; }
        }

        /* === THEME TOGGLE BUTTON === */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        .theme-toggle:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
            border-color: var(--accent-blue);
        }

        /* === USER MENU & DROPDOWN === */
        .user-menu-container {
            position: relative;
        }

        .user-avatar-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, var(--accent-blue) 0%, #8b5cf6 100%);
            border: 2px solid transparent;
            color: white;
            position: relative;
        }

        .user-avatar-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 0 3px rgba(62, 99, 221, 0.3);
        }

        .user-avatar-btn.has-user {
            background: none;
            border: 2px solid var(--accent-blue);
        }

        .user-avatar-btn.has-user img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-activity-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: var(--accent-green);
            border: 2px solid var(--bg-deep);
            border-radius: 50%;
        }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 260px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.2s ease;
            z-index: 200;
            overflow: hidden;
        }

        .user-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .user-dropdown-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(62, 99, 221, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
        }

        .user-dropdown-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue) 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-dropdown-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-dropdown-name {
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        .user-dropdown-status {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
        }

        .user-dropdown-item:hover {
            background: var(--bg-elevated);
        }

        .user-dropdown-item i {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .user-dropdown-item span:first-of-type {
            flex: 1;
        }

        .user-dropdown-badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .user-dropdown-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .user-dropdown-signin {
            color: var(--accent-blue);
        }

        .user-dropdown-signin i {
            color: var(--accent-blue);
        }

        /* === STANDALONE DASHBOARD VIEW === */
        .dashboard-standalone {
            min-height: calc(100vh - 64px);
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .dashboard-back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .dashboard-back-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
            border-color: var(--accent-blue);
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .dashboard-title i {
            color: var(--accent-blue);
        }

        .dashboard-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .dashboard-session-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 12px;
        }

        .dashboard-sync-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, #8b5cf6 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dashboard-sync-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(62, 99, 221, 0.4);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .dashboard-section-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .dashboard-section-card.dashboard-section-wide {
            grid-column: span 2;
        }

        .dashboard-section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
        }

        .dashboard-section-header i {
            color: var(--accent-blue);
        }

        .dashboard-section-header h2 {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
        }

        .dashboard-section-count {
            background: var(--accent-blue);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .dashboard-add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .dashboard-add-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .stash-persist-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }

        .stash-persist-toggle:hover,
        .stash-persist-toggle.active {
            color: var(--accent-green);
        }

        .dashboard-section-content {
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .dashboard-pipelines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .dashboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dashboard-item:hover {
            background: rgba(62, 99, 221, 0.1);
            transform: translateX(4px);
        }

        .dashboard-item-title {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dashboard-item-meta {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .dashboard-item-remove {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s;
        }

        .dashboard-item:hover .dashboard-item-remove {
            opacity: 1;
        }

        .dashboard-item-remove:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 12px;
        }

        .dashboard-stat {
            text-align: center;
            padding: 16px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .dashboard-stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 4px;
        }

        .dashboard-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dashboard-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .dashboard-pipeline-card {
            display: flex;
            flex-direction: column;
            padding: 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .dashboard-pipeline-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .dashboard-pipeline-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 6px;
        }

        .dashboard-pipeline-count {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .dashboard-section-card.dashboard-section-wide {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .dashboard-standalone {
                padding: 16px;
            }
            .dashboard-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-section-card.dashboard-section-wide {
                grid-column: span 1;
            }
            .dashboard-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* === SOURCES BUTTON (In navbar center) === */
        .nav-sources-btn {
            display: none; /* Hidden by default, shown on essay pages */
            align-items: center;
            gap: 0.5rem;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px solid var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
            color: var(--text-main);
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .nav-sources-btn.visible {
            display: flex;
        }

        .nav-sources-btn .sources-shield {
            color: var(--accent-green);
        }

        .nav-sources-btn .sources-chevron {
            color: var(--accent-green);
            transition: transform 0.3s ease;
            margin-left: 2px;
        }

        /* Rotate chevron when expanded */
        .nav-sources-btn.expanded .sources-chevron {
            transform: rotate(180deg);
        }

        /* Always show the Sources label */
        .nav-sources-btn .nav-sources-label {
            display: inline;
            color: var(--accent-green);
        }

        .nav-sources-btn .nav-sources-count {
            background: var(--accent-green);
            color: var(--bg-deep);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .nav-sources-btn:hover {
            background: var(--accent-green);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            transform: scale(1.02);
        }

        .nav-sources-btn:hover .sources-shield,
        .nav-sources-btn:hover .sources-chevron,
        .nav-sources-btn:hover .nav-sources-label {
            color: white;
        }

        .nav-sources-btn:hover .nav-sources-count {
            background: white;
            color: var(--accent-green);
        }

        /* Traveling spark effect when drawer is closed */
        .nav-sources-btn:not(.expanded) {
            position: relative;
            overflow: hidden;
        }

        .nav-sources-btn:not(.expanded)::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(16, 185, 129, 0.1) 20%,
                rgba(16, 185, 129, 0.4) 40%,
                rgba(255, 255, 255, 0.6) 50%,
                rgba(16, 185, 129, 0.4) 60%,
                rgba(16, 185, 129, 0.1) 80%,
                transparent 100%
            );
            animation: sources-spark 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes sources-spark {
            0% { left: -100%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 200%; opacity: 0; }
        }

        /* Subtle ambient glow underneath */
        .nav-sources-btn:not(.expanded)::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 22px;
            background: radial-gradient(ellipse at center, rgba(16, 185, 129, 0.15) 0%, transparent 70%);
            animation: sources-breathe 4s ease-in-out infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes sources-breathe {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }

        /* Active/expanded state */
        .nav-sources-btn.expanded {
            background: var(--accent-green);
            color: white;
        }

        .nav-sources-btn.expanded .sources-shield,
        .nav-sources-btn.expanded .sources-chevron,
        .nav-sources-btn.expanded .nav-sources-label {
            color: white;
        }

        .nav-sources-btn.expanded .nav-sources-count {
            background: white;
            color: var(--accent-green);
        }

        /* === ARTICLE TIMESTAMP & REFRESH === */
        .article-timestamp {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
        }

        .article-timestamp .timestamp-text {
            font-family: 'JetBrains Mono', monospace;
        }

        .article-timestamp .regenerate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: none;
            color: var(--text-muted);
        }

        .article-timestamp .regenerate-btn:hover {
            background: var(--accent-blue);
            color: white;
            transform: rotate(90deg);
        }

        .article-timestamp .regenerate-btn:active {
            transform: rotate(180deg);
        }

        /* === DARK/LIGHT THEME TOGGLE === */
        .theme-toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .theme-toggle-switch:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-blue);
            color: var(--text-main);
        }

        .theme-toggle-switch .icon-sun,
        .theme-toggle-switch .icon-moon {
            width: 16px;
            height: 16px;
            transition: opacity 0.2s, transform 0.3s;
        }

        /* Show sun in dark mode, moon in light mode */
        :root .theme-toggle-switch .icon-sun,
        [data-theme="dark"] .theme-toggle-switch .icon-sun {
            opacity: 1;
        }
        :root .theme-toggle-switch .icon-moon,
        [data-theme="dark"] .theme-toggle-switch .icon-moon {
            opacity: 0;
            position: absolute;
        }

        [data-theme="light"] .theme-toggle-switch .icon-sun {
            opacity: 0;
            position: absolute;
        }
        [data-theme="light"] .theme-toggle-switch .icon-moon {
            opacity: 1;
            position: relative;
        }

        .theme-toggle-switch .toggle-label {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* === ACTION BUTTONS === */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
        }

        .action-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
            border-color: var(--accent-blue);
        }

        .action-btn.primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #1a1410;
        }

        .action-btn.primary:hover {
            background: #a68520;
        }

        .action-btn.enhance-btn {
            background: linear-gradient(135deg, #06b6d4, #0d9488);
            border-color: #06b6d4;
            color: white;
            position: relative;
            overflow: visible;
        }

        /* Occasional sparkle animation in top-right corner */
        .action-btn.enhance-btn::after {
            content: 'âœ¦';
            position: absolute;
            top: -4px;
            right: -2px;
            font-size: 10px;
            color: #fbbf24;
            text-shadow: 0 0 4px #fbbf24, 0 0 8px #f59e0b;
            opacity: 0;
            transform: scale(0) rotate(0deg);
            animation: enhance-sparkle 8s ease-in-out infinite;
            animation-delay: 2s;
            pointer-events: none;
        }

        @keyframes enhance-sparkle {
            0%, 90%, 100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            92% {
                opacity: 1;
                transform: scale(1.2) rotate(15deg);
            }
            94% {
                opacity: 0.8;
                transform: scale(0.9) rotate(-10deg);
            }
            96% {
                opacity: 1;
                transform: scale(1.1) rotate(5deg);
            }
            98% {
                opacity: 0.6;
                transform: scale(0.8) rotate(-5deg);
            }
        }

        .action-btn.enhance-btn:hover::after {
            animation: enhance-sparkle-hover 1.5s ease-in-out infinite;
        }

        @keyframes enhance-sparkle-hover {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: scale(1.3) rotate(15deg);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.1) rotate(-10deg);
            }
            75% {
                opacity: 1;
                transform: scale(1.2) rotate(10deg);
            }
        }

        .action-btn.enhance-btn:hover {
            background: linear-gradient(135deg, #22d3ee, #14b8a6);
            border-color: #22d3ee;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .action-btn.enhance-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.enhance-btn:disabled::after {
            animation: none;
            opacity: 0;
        }

        /* Enhancement counter badge */
        .enhance-count-badge {
            position: absolute;
            top: -6px;
            left: -6px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: 2px solid var(--bg-deep);
            border-radius: 9px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
            z-index: 10;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .enhance-count-badge.visible {
            opacity: 1;
            transform: scale(1);
        }

        .enhance-count-badge.pulse {
            animation: badge-pulse 0.6s ease-out;
        }

        @keyframes badge-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Version Toggle Button */
        .action-btn.version-toggle-btn {
            position: relative;
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #2dd4bf;
        }

        .action-btn.version-toggle-btn:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: #2dd4bf;
            color: #5eead4;
        }

        .action-btn.version-toggle-btn.showing-original {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .action-btn.version-toggle-btn.showing-original:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fcd34d;
        }

        /* Inline Enhancement Progress Widget */
        .enhance-progress-widget {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 320px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(13, 148, 136, 0.15));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.2), 0 0 0 1px rgba(255,255,255,0.05) inset;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .enhance-progress-widget.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .enhance-progress-widget.complete {
            border-color: rgba(16, 185, 129, 0.5);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.25), 0 0 0 1px rgba(255,255,255,0.05) inset;
        }

        .enhance-widget-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .enhance-widget-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #06b6d4, #0d9488);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .enhance-progress-widget.complete .enhance-widget-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .enhance-widget-icon svg {
            width: 18px;
            height: 18px;
        }

        .enhance-widget-icon.spinning svg {
            animation: spin 1.5s linear infinite;
        }

        .enhance-widget-title {
            flex: 1;
        }

        .enhance-widget-title h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
            margin: 0 0 2px 0;
        }

        .enhance-widget-title span {
            font-size: 11px;
            color: var(--text-muted);
        }

        .enhance-widget-progress {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .enhance-widget-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #06b6d4, #2dd4bf, #06b6d4);
            background-size: 200% 100%;
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease-out;
            animation: shimmer 2s ease-in-out infinite;
        }

        .enhance-progress-widget.complete .enhance-widget-progress-bar {
            background: linear-gradient(90deg, #10b981, #34d399, #10b981);
            width: 100% !important;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .enhance-widget-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .enhance-widget-status .status-dot {
            width: 6px;
            height: 6px;
            background: #06b6d4;
            border-radius: 50%;
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        .enhance-progress-widget.complete .enhance-widget-status .status-dot {
            background: #10b981;
            animation: none;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .enhance-widget-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            opacity: 0;
            transform: translateY(8px);
            transition: all 0.3s ease;
        }

        .enhance-progress-widget.complete .enhance-widget-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .enhance-widget-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .enhance-widget-btn.primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .enhance-widget-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .enhance-widget-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: var(--text-main);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .enhance-widget-btn.secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        /* Confetti animation for completion */
        .enhance-confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            animation: confetti-fall 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-20px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(60px) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-10px) rotate(0deg) scale(0);
                opacity: 0;
            }
            20% {
                transform: translateY(0) rotate(90deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(80px) rotate(720deg) scale(0.5);
                opacity: 0;
            }
        }

        /* --- VIEW MANAGEMENT --- */
        .view-section {
            display: none;
            padding-top: 80px;
            /* Offset for Nav */
            min-height: 100vh;
            padding-bottom: 100px;
            width: 100%;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- NAVIGATION --- */
        .nav-glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-link {
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
            font-weight: 600;
        }

        .nav-link:hover {
            color: var(--text-main);
        }

        /* --- MAGAZINE LAYOUT ENGINE --- */
        .article-container {
            max-width: 900px;
            margin: 0 auto;
            display: block;
        }

        /* Report View - Professional Single Column Layout */
        .report-layout {
            display: block;
            max-width: 720px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .report-main {
            width: 100%;
        }

        @media (min-width: 768px) {
            .report-layout {
                padding: 0 2rem;
            }
        }

        @media (min-width: 1200px) {
            .report-layout {
                max-width: 760px;
                padding: 0;
            }
        }

        /* === SOURCES DRAWER OVERLAY === */
        .sources-drawer-overlay {
            position: fixed;
            inset: 0;
            top: 64px; /* Below navbar */
            background: rgba(0, 0, 0, 0);
            z-index: 43;
            pointer-events: none;
            transition: background 0.3s ease;
        }

        .sources-drawer-overlay.active {
            background: rgba(0, 0, 0, 0.5);
            pointer-events: auto;
            backdrop-filter: blur(2px);
        }

        /* === SOURCES DRAWER (Slide-down from navbar) === */
        .sources-first-banner {
            position: fixed;
            top: 64px; /* Below navbar */
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            width: 90%;
            max-width: 800px;
            z-index: 44;
            background: linear-gradient(180deg, var(--bg-elevated), var(--bg-card));
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 40px rgba(16, 185, 129, 0.1);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            max-height: calc(100vh - 100px);
        }

        /* Drawer open state */
        .sources-first-banner.drawer-open {
            transform: translateX(-50%) translateY(0);
        }

        /* The sliding content wrapper */
        .sources-first-content {
            overflow-y: auto;
            max-height: calc(100vh - 140px);
            transition: opacity 0.3s ease;
        }

        /* Hide legacy collapsed states - now using drawer-open */
        .sources-first-banner.collapsed .sources-first-content {
            max-height: none;
            opacity: 1;
        }

        .sources-first-banner.collapsed {
            border-color: var(--border-color);
            background: linear-gradient(180deg, var(--bg-elevated), var(--bg-card));
        }

        /* Gradient accent at top of drawer */
        .sources-first-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green), var(--accent-blue));
            background-size: 200% 100%;
            animation: sources-gradient 3s ease infinite;
        }

        @keyframes sources-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .sources-first-inner {
            padding: 1.5rem;
        }

        .sources-first-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .sources-first-title-group {
            display: flex;
            align-items: center;
        }

        .sources-first-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sources-first-title h3 {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--accent-blue);
            margin: 0;
            position: relative;
            display: inline-block;
        }

        .sources-first-title .shield-icon {
            color: var(--accent-green);
            animation: shield-pulse 2s ease-in-out infinite;
        }

        @keyframes shield-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .sources-first-byline {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-style: italic;
        }

        /* Tab Navigation */
        .sources-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
        }

        .sources-tab {
            position: relative;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
        }

        .sources-tab:hover {
            color: var(--text-main);
        }

        .sources-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .sources-tab .tab-count {
            display: inline-block;
            background: var(--bg-deep);
            color: var(--text-muted);
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
        }

        .sources-tab.active .tab-count {
            background: var(--accent-blue);
            color: white;
        }

        /* Mobile tabs - horizontal scroll */
        @media (max-width: 480px) {
            .sources-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .sources-tabs::-webkit-scrollbar { display: none; }
            .sources-tab { font-size: 0.65rem; padding: 0.4rem 0.6rem; }
        }

        /* Tab Content Panels */
        .sources-tab-panels {
            position: relative;
            min-height: 180px;
        }

        .sources-tab-panel {
            display: none;
            animation: tab-fade-in 0.3s ease;
        }

        .sources-tab-panel.active {
            display: block;
        }

        @keyframes tab-fade-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tab CTA - subtle encouragement */
        .tab-cta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-style: italic;
        }

        .tab-cta i {
            color: var(--accent-blue);
            opacity: 0.7;
        }

        .sources-first-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
        }

        @media (max-width: 768px) {
            .sources-first-grid {
                grid-template-columns: 1fr;
            }
        }

        .top-source-card {
            background: var(--bg-deep);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: source-fade-in 0.4s ease forwards;
            opacity: 0;
            transform: translateY(8px);
        }

        .top-source-card:nth-child(1) { animation-delay: 0.05s; }
        .top-source-card:nth-child(2) { animation-delay: 0.1s; }
        .top-source-card:nth-child(3) { animation-delay: 0.15s; }
        .top-source-card:nth-child(4) { animation-delay: 0.2s; }

        @keyframes source-fade-in {
            to { opacity: 1; transform: translateY(0); }
        }

        .top-source-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px -4px rgba(0, 0, 150, 0.15);
        }

        .top-source-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent var(--accent-green) transparent transparent;
            opacity: 0.7;
        }

        .top-source-rank {
            font-size: 0.6rem;
            font-weight: 800;
            color: var(--accent-blue);
            margin-bottom: 0.2rem;
            opacity: 0.7;
        }

        .top-source-domain {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.2rem;
        }

        .top-source-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-main);
            line-height: 1.3;
            margin-bottom: 0.4rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .top-source-score {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .top-source-score-bar {
            flex: 1;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .top-source-score-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.8s ease;
        }

        .top-source-score-fill.high { background: linear-gradient(90deg, #10b981, #34d399); }
        .top-source-score-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .top-source-score-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }

        .top-source-score-value {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent-green);
            min-width: 26px;
            text-align: right;
        }

        /* === THREE-PANEL COMMAND CENTER LAYOUT === */
        .three-panel-layout {
            display: flex;
            height: calc(100vh - 64px);
            overflow: hidden;
            position: relative;
        }

        /* Side Panel Base Styles */
        .side-panel {
            width: 240px;
            min-width: 240px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-color: var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .side-panel.collapsed {
            width: 44px;
            min-width: 44px;
        }

        .side-panel-left {
            border-right: 1px solid var(--border-color);
        }

        .side-panel-right {
            border-left: 1px solid var(--border-color);
        }

        /* Panel Header */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .panel-title i {
            width: 16px;
            height: 16px;
        }

        .side-panel-left .panel-title {
            color: var(--accent-teal);
        }

        .side-panel-right .panel-title {
            color: var(--accent-blue);
        }

        .panel-close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-close-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
        }

        .side-panel.collapsed .panel-header {
            display: none;
        }

        /* Collapsed Strip */
        .panel-collapsed-strip {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            cursor: pointer;
            padding: 1rem 0;
            transition: all 0.2s;
        }

        .side-panel.collapsed .panel-collapsed-strip {
            display: flex;
        }

        .collapsed-strip-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .side-panel-left .collapsed-strip-text {
            color: var(--accent-teal);
        }

        .side-panel-right .collapsed-strip-text {
            color: var(--accent-blue);
        }

        .collapsed-strip-icon {
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .side-panel-left .collapsed-strip-icon {
            transform: rotate(0deg);
        }

        .side-panel-right .collapsed-strip-icon {
            transform: rotate(180deg);
        }

        .panel-collapsed-strip:hover {
            background: var(--bg-elevated);
        }

        .panel-collapsed-strip:hover .collapsed-strip-icon {
            color: var(--text-main);
        }

        .collapsed-count-badge {
            background: var(--accent-blue);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 0.5rem;
        }

        .side-panel-left .collapsed-count-badge {
            background: var(--accent-teal);
        }

        /* Panel Content */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .side-panel.collapsed .panel-content {
            display: none;
        }

        .panel-content::-webkit-scrollbar {
            width: 4px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        /* Panel Cards */
        .panel-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.875rem;
            margin-bottom: 0.625rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panel-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .panel-card.fact-check:hover {
            border-color: var(--accent-teal);
        }

        .panel-card.active {
            border-color: var(--accent-blue);
            background: rgba(62, 99, 221, 0.08);
        }

        .panel-card.fact-check.active {
            border-color: var(--accent-teal);
            background: rgba(45, 212, 191, 0.08);
        }

        /* Verdict Badge */
        .verdict-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .verdict-badge.true {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.2);
        }

        .verdict-badge.false {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.2);
        }

        .verdict-badge.mixed {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.2);
        }

        .verdict-badge.mostly-true {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.2);
        }

        .verdict-badge.mostly-false {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
            box-shadow: 0 0 8px rgba(249, 115, 22, 0.2);
        }

        .verdict-badge.investigation {
            background: rgba(62, 99, 221, 0.15);
            color: var(--accent-blue);
        }

        .verdict-badge.fractal {
            background: rgba(48, 164, 108, 0.15);
            color: var(--accent-green);
        }

        /* Card Content */
        .panel-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.3;
            margin-bottom: 0.375rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .panel-card-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-card-date {
            font-size: 0.65rem;
            color: var(--text-muted);
            opacity: 0.7;
        }

        .panel-card-verdict {
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .panel-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .panel-empty i {
            display: block;
            margin: 0 auto 0.5rem;
            opacity: 0.3;
        }

        /* Center Panel */
        .center-panel {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .center-panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        /* Landing State */
        .center-landing {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4rem 2rem;
            flex: 1;
        }

        .center-landing-logo {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        .center-landing-logo span {
            color: var(--accent-blue);
        }

        .center-landing-tagline {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .center-search-container {
            width: 100%;
            max-width: 500px;
        }

        /* Article View in Center */
        .center-article {
            width: 100%;
            display: none;
        }

        .center-article.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .three-panel-layout {
                flex-direction: column;
            }

            .side-panel {
                display: none;
            }

            .center-panel {
                height: auto;
            }

            /* Show mobile tabs instead */
            .mobile-tabs {
                display: flex !important;
            }
        }

        /* Mobile Tabs (hidden on desktop) */
        .mobile-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            z-index: 50;
            padding: 0.5rem;
        }

        .mobile-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.65rem;
            cursor: pointer;
        }

        .mobile-tab.active {
            color: var(--accent-blue);
        }

        .mobile-tab.fact-checks.active {
            color: var(--accent-teal);
        }

        /* ============================================
           RESEARCH DASHBOARD - Article View Three-Panel
           ============================================ */

        .research-dashboard {
            display: flex;
            height: calc(100vh - 64px);
            overflow: hidden;
            position: relative;
        }

        /* Dashboard Side Panels */
        .dashboard-panel {
            width: 260px;
            min-width: 260px;
            height: 100%;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-color: var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 10;
        }

        .dashboard-panel-left {
            border-right: 1px solid var(--border-color);
        }

        .dashboard-panel-right {
            border-left: 1px solid var(--border-color);
        }

        .dashboard-panel.collapsed {
            width: 48px;
            min-width: 48px;
        }

        .dashboard-panel.collapsed .dashboard-panel-header,
        .dashboard-panel.collapsed .dashboard-panel-content {
            display: none;
        }

        .dashboard-panel.collapsed .dashboard-collapsed-strip {
            display: flex;
        }

        /* Dashboard Panel Header */
        .dashboard-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .dashboard-panel-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-main);
        }

        .dashboard-panel-title i {
            width: 16px;
            height: 16px;
            color: var(--accent-blue);
        }

        .dashboard-panel-left .dashboard-panel-title i {
            color: var(--accent-teal);
        }

        .dashboard-panel-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .dashboard-panel-close:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
        }

        /* Dashboard Panel Content */
        .dashboard-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .dashboard-panel-content::-webkit-scrollbar {
            width: 4px;
        }

        .dashboard-panel-content::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        /* Dashboard Section */
        .dashboard-section {
            margin-bottom: 1.25rem;
        }

        .dashboard-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.625rem;
            padding: 0 0.25rem;
        }

        .dashboard-section-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .dashboard-section-toggle {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            font-size: 0.65rem;
        }

        .dashboard-section-toggle:hover {
            color: var(--accent-blue);
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dashboard-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .dashboard-card-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-main);
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .dashboard-card-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .dashboard-card-badge {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(62, 99, 221, 0.15);
            color: var(--accent-blue);
        }

        .dashboard-card-badge.fact-check {
            background: rgba(45, 212, 191, 0.15);
            color: var(--accent-teal);
        }

        .dashboard-card-badge.fractal {
            background: rgba(48, 164, 108, 0.15);
            color: var(--accent-green);
        }

        .dashboard-card-remove {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .dashboard-card:hover .dashboard-card-remove {
            opacity: 1;
        }

        .dashboard-card-remove:hover {
            color: #ef4444;
        }

        /* Stash Card Styling */
        .stash-card {
            border-left: 3px solid var(--accent-teal);
        }

        .stash-card:hover {
            border-color: var(--accent-teal);
            border-left-color: var(--accent-teal);
        }

        /* Generation Card in Left Panel */
        .panel-gen-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .panel-gen-card.complete {
            border-color: var(--accent-green);
            background: rgba(48, 164, 108, 0.08);
        }

        .panel-gen-card.enhance {
            border-color: rgba(6, 182, 212, 0.3);
        }

        .panel-gen-card.enhance.complete {
            border-color: rgba(6, 182, 212, 0.6);
            background: rgba(6, 182, 212, 0.08);
        }

        .panel-gen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.375rem;
        }

        .panel-gen-type {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .panel-gen-type.investigation { color: var(--accent-blue); }
        .panel-gen-type.fact-check { color: #2dd4bf; }
        .panel-gen-type.fractal { color: var(--accent-green); }
        .panel-gen-type.enhance { color: #06b6d4; }

        .panel-gen-percent {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent-warm);
        }

        .panel-gen-card.complete .panel-gen-percent {
            color: var(--accent-green);
        }

        .panel-gen-card.enhance .panel-gen-percent {
            color: #2dd4bf;
        }

        .panel-gen-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.375rem;
        }

        .panel-gen-progress {
            height: 3px;
            background: var(--bg-deep);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .panel-gen-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-warm), #f59e0b);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .panel-gen-card.complete .panel-gen-progress-bar {
            background: var(--accent-green);
        }

        .panel-gen-card.enhance .panel-gen-progress-bar {
            background: linear-gradient(90deg, #06b6d4, #2dd4bf);
        }

        .panel-gen-status {
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .panel-gen-actions {
            display: none;
            gap: 0.375rem;
        }

        .panel-gen-card.complete .panel-gen-actions {
            display: flex;
        }

        .panel-gen-btn {
            flex: 1;
            padding: 5px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panel-gen-btn.primary {
            background: var(--accent-green);
            color: #000;
        }

        .panel-gen-btn.primary:hover {
            filter: brightness(1.1);
        }

        .panel-gen-btn.primary.enhance {
            background: linear-gradient(135deg, #06b6d4, #0d9488);
            color: #fff;
        }

        .panel-gen-btn.secondary {
            background: var(--bg-deep);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .panel-gen-btn.secondary:hover {
            color: var(--text-main);
        }

        .panel-gen-empty {
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        /* Navbar Generation Indicator */
        .nav-gen-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(247, 107, 21, 0.15);
            border: 1px solid rgba(247, 107, 21, 0.3);
            border-radius: 20px;
            color: var(--accent-warm);
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-gen-indicator.visible {
            display: flex;
        }

        .nav-gen-indicator:hover {
            background: rgba(247, 107, 21, 0.25);
            border-color: rgba(247, 107, 21, 0.5);
        }

        .nav-gen-indicator .spinner {
            width: 12px;
            height: 12px;
            animation: spin 1s linear infinite;
        }

        .nav-gen-indicator.complete {
            background: rgba(48, 164, 108, 0.15);
            border-color: rgba(48, 164, 108, 0.3);
            color: var(--accent-green);
        }

        .nav-gen-indicator.complete:hover {
            background: rgba(48, 164, 108, 0.25);
            border-color: rgba(48, 164, 108, 0.5);
        }

        /* Hide floating badge when in report view on desktop (panels handle it) */
        @media (min-width: 1024px) {
            #view-report.active ~ #deep-dive-badge {
                display: none !important;
            }
        }

        /* Related Card with Stash Button */
        .related-card {
            position: relative;
        }

        .related-card-stash {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        .related-card:hover .related-card-stash {
            opacity: 1;
        }

        .related-card-stash:hover {
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        /* Dashboard Collapsed Strip */
        .dashboard-collapsed-strip {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 1rem;
            cursor: pointer;
            padding: 1rem 0;
        }

        .dashboard-collapsed-strip:hover {
            background: var(--bg-elevated);
        }

        .dashboard-collapsed-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
        }

        .dashboard-panel-left .dashboard-collapsed-text {
            transform: rotate(180deg);
        }

        .dashboard-collapsed-count {
            background: var(--accent-blue);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
        }

        .dashboard-panel-left .dashboard-collapsed-count {
            background: var(--accent-teal);
        }

        /* Dashboard Center Panel */
        .dashboard-center {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .dashboard-center .report-layout {
            max-width: 680px;
            transition: max-width 0.3s ease;
        }

        .research-dashboard.left-collapsed .dashboard-center .report-layout,
        .research-dashboard.right-collapsed .dashboard-center .report-layout {
            max-width: 720px;
        }

        .research-dashboard.both-collapsed .dashboard-center .report-layout,
        .research-dashboard.focus-mode .dashboard-center .report-layout {
            max-width: 760px;
        }

        /* Focus Mode */
        .research-dashboard.focus-mode .dashboard-panel {
            width: 0;
            min-width: 0;
            opacity: 0;
            overflow: hidden;
        }

        .focus-footer {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            z-index: 40;
            justify-content: space-between;
            align-items: center;
        }

        .research-dashboard.focus-mode .focus-footer {
            display: flex;
        }

        .focus-footer-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .focus-footer-btn:hover {
            border-color: var(--accent-blue);
            color: var(--text-main);
        }

        .focus-footer-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Generation Progress Card */
        .gen-progress-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .gen-progress-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .gen-progress-bar {
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .gen-progress-fill {
            height: 100%;
            background: var(--accent-blue);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .gen-progress-fill.complete {
            background: var(--accent-green);
        }

        .gen-progress-status {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Discovery Mode Toggle */
        .discovery-mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 2px;
        }

        .discovery-mode-btn {
            background: transparent;
            border: none;
            font-size: 0.6rem;
            padding: 3px 8px;
            border-radius: 16px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .discovery-mode-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        /* Quick Query Section (in Discovery panel) */
        .quick-query-section {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .quick-query-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quick-query-input {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.7rem;
            color: var(--text-main);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            resize: none;
            min-height: 2.5rem;
            max-height: 5rem;
        }

        .quick-query-input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(62, 99, 221, 0.15);
        }

        .quick-query-input::placeholder {
            color: var(--text-muted);
            font-size: 0.65rem;
        }

        .quick-query-actions {
            display: flex;
            gap: 0.5rem;
        }

        .quick-query-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.4rem 0.5rem;
            border-radius: 5px;
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .quick-query-btn.investigate {
            background: var(--accent-blue);
            color: white;
        }

        .quick-query-btn.investigate:hover {
            background: #4a71e5;
        }

        .quick-query-btn.fact-check {
            background: var(--accent-teal);
            color: white;
        }

        .quick-query-btn.fact-check:hover {
            background: #0891b2;
        }

        .quick-query-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-query-hint {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.25rem;
        }

        .quick-query-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Responsive: Hide panels below 1280px */
        @media (max-width: 1279px) {
            .dashboard-panel {
                position: fixed;
                top: 64px;
                bottom: 0;
                z-index: 45;
            }

            .dashboard-panel-left {
                left: 0;
                transform: translateX(-100%);
            }

            .dashboard-panel-right {
                right: 0;
                transform: translateX(100%);
            }

            .dashboard-panel.mobile-visible {
                transform: translateX(0);
            }

            .dashboard-center {
                width: 100%;
            }
        }

        /* Mobile Bottom Tab Navigation (< 768px) */
        .mobile-bottom-tabs {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 50;
            padding: 0 8px;
            padding-bottom: env(safe-area-inset-bottom, 8px);
        }

        .mobile-bottom-tabs-inner {
            display: flex;
            align-items: center;
            justify-content: space-around;
            height: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .mobile-tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 6px 16px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.6rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .mobile-tab-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
        }

        .mobile-tab-btn.active {
            color: var(--accent-blue);
        }

        .mobile-tab-btn.research.active {
            color: var(--accent-teal);
        }

        .mobile-tab-btn .tab-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            min-width: 16px;
            height: 16px;
            background: var(--accent-warm);
            color: #000;
            font-size: 0.55rem;
            font-weight: 700;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .mobile-tab-btn .tab-badge:empty {
            display: none;
        }

        /* Mobile Panel Overlays */
        .mobile-panel-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 44;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .mobile-panel-overlay.active {
            opacity: 1;
        }

        /* Mobile: Show bottom tabs and adjust layout */
        @media (max-width: 767px) {
            .mobile-bottom-tabs {
                display: block;
            }

            .mobile-panel-overlay {
                display: block;
                pointer-events: none;
            }

            .mobile-panel-overlay.active {
                pointer-events: auto;
            }

            /* Add bottom padding for content to not be hidden by tabs */
            .dashboard-center {
                padding-bottom: calc(56px + env(safe-area-inset-bottom, 8px) + 16px) !important;
            }

            /* Hide focus footer on mobile (use bottom tabs instead) */
            .focus-footer {
                display: none !important;
            }

            /* Mobile panel styling */
            .dashboard-panel {
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 16px 16px 0 0;
                top: auto !important;
                bottom: calc(56px + env(safe-area-inset-bottom, 8px));
                max-height: 70vh;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 45;
            }

            .dashboard-panel.mobile-visible {
                transform: translateY(0);
            }

            .dashboard-panel-left,
            .dashboard-panel-right {
                left: 0;
                right: 0;
            }

            /* Hide panel close button on mobile (use overlay or tabs to close) */
            .dashboard-panel-close {
                display: none;
            }

            /* Add grab handle for mobile panels */
            .dashboard-panel::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: var(--border-color);
                border-radius: 2px;
            }

            .dashboard-panel-content {
                max-height: calc(70vh - 56px);
                overflow-y: auto;
            }

            /* Mobile collapsed strip not needed */
            .dashboard-collapsed-strip {
                display: none !important;
            }

            /* Adjust navbar for mobile */
            .nav-gen-indicator {
                font-size: 0.6rem;
                padding: 4px 8px;
            }
        }

        /* Tablet: Panels as side drawers with overlay */
        @media (min-width: 768px) and (max-width: 1279px) {
            .mobile-panel-overlay {
                display: block;
                pointer-events: none;
            }

            .mobile-panel-overlay.active {
                pointer-events: auto;
            }
        }

        /* Legacy Portal Layout (keeping for fallback) */
        .portal-layout {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 80px);
            padding: 0 1rem;
        }

        .portal-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 0;
        }

        .portal-right {
            padding: 2rem 0;
        }

        @media (min-width: 1024px) {
            .portal-layout {
                flex-direction: row;
                height: calc(100vh - 80px);
                overflow: hidden;
                padding: 0 2rem;
            }

            .portal-left {
                width: 50%;
                flex-shrink: 0;
                align-items: flex-start;
                padding-left: 6rem;
                position: sticky;
                top: 80px;
                height: calc(100vh - 80px);
            }

            .portal-right {
                width: 50%;
                height: calc(100vh - 80px);
                overflow-y: auto;
                padding: 3rem 2rem 3rem 0;
                scrollbar-width: thin;
                scrollbar-color: var(--border-color) transparent;
            }

            .portal-right::-webkit-scrollbar {
                width: 6px;
            }

            .portal-right::-webkit-scrollbar-track {
                background: transparent;
            }

            .portal-right::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 3px;
            }

            .portal-right::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }
        }

        .prose-text {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            line-height: 1.8;
            color: var(--text-prose);
            text-align: justify;
            margin-bottom: 2rem;
        }

        /* Bold text styling for accessibility */
        .prose-text strong,
        .prose-text b,
        .prose-content strong,
        .prose-content b {
            color: var(--text-bold);
            font-weight: 700;
        }

        .prose-h2 {
            font-family: 'Inter', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding-bottom: 10px;
            /* clear: both; REMOVED to allow headers to wrap next to floats */
            position: relative;
            z-index: 2;
            /* Ensure text is above any weird float issues */
        }

        /* === PARENT/CHILD ESSAY NAVIGATION === */
        .parent-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1.5rem;
            padding: 10px 16px;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            color: var(--accent-blue);
            font-weight: 500;
        }

        .parent-breadcrumb:hover {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.1));
            transform: translateX(4px);
        }

        .parent-breadcrumb i {
            opacity: 0.7;
            transition: transform 0.2s ease;
        }

        .parent-breadcrumb:hover i {
            transform: translateX(-3px);
        }

        /* Child essay badge for Deep Dive label */
        .child-essay-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #f87171;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 10px;
        }

        /* Child essay indicator dots on parent article */
        .child-essays-rail {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 30;
        }

        .child-essay-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .child-essay-dot:hover {
            transform: scale(1.4);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.6);
        }

        .child-essay-dot::after {
            content: attr(data-title);
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            white-space: nowrap;
            background: var(--bg-card);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text-main);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            border: 1px solid var(--border-color);
        }

        .child-essay-dot:hover::after {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .child-essays-rail {
                display: none;
            }
        }

        /* === FACT CHECK VERDICT BANNER === */
        .verdict-banner {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 5px solid;
            background: linear-gradient(90deg, rgba(0,0,0,0.3), transparent);
        }

        .verdict-banner .verdict-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        .verdict-banner .verdict-label {
            font-size: 1.5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .verdict-banner .verdict-confidence {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-left: auto;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
        }

        /* Nuance potential - inviting exploration */
        .verdict-banner .verdict-nuance {
            font-size: 0.8rem;
            margin-left: auto;
            padding: 8px 14px;
            border-radius: 20px;
            background: rgba(6, 182, 212, 0.15);
            border: 1px solid rgba(6, 182, 212, 0.3);
            color: #5eead4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .verdict-banner .verdict-nuance .nuance-hint {
            font-size: 0.7rem;
            opacity: 0.7;
            font-style: italic;
        }

        /* === FACT CHECK STORY SECTION === */
        .fact-check-story {
            margin: 24px 0 32px 0;
            padding: 24px;
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-card) 100%);
            border-left: 4px solid var(--accent-blue);
            border-radius: 0 12px 12px 0;
        }

        .fact-check-story .prose-h2 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.4rem;
            color: var(--text-main);
        }

        .fact-check-story .prose-text {
            margin-bottom: 16px;
            line-height: 1.8;
        }

        .fact-check-story .prose-text:last-child {
            margin-bottom: 0;
        }

        /* === FACT CHECK GO DEEPER CTA === */
        .fact-check-deeper {
            margin: 32px 0;
            padding: 24px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            text-align: center;
        }

        .fact-check-deeper .deeper-prompt {
            font-size: 1.1rem;
            color: var(--text-main);
            margin: 0 0 12px 0;
            font-weight: 600;
        }

        .fact-check-deeper .deeper-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fact-check-deeper .deeper-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .fact-check-deeper .deeper-note {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 12px 0 0 0;
        }

        /* === FACT CHECK WIKIPEDIA-STYLE TABS === */
        .fact-check-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0;
            background: var(--bg-card);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .fact-check-tab {
            padding: 12px 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fact-check-tab:hover {
            color: var(--text-main);
            background: rgba(255,255,255,0.05);
        }

        .fact-check-tab.active {
            color: var(--accent-blue);
            background: var(--bg-elevated);
        }

        .fact-check-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
        }

        .fact-check-tab i {
            width: 14px;
            height: 14px;
            opacity: 0.7;
        }

        .fact-check-tab.active i {
            opacity: 1;
        }

        /* Pro Checks tab - coral/red accent */
        .fact-check-tab.pro-checks {
            color: #f87171;
        }

        .fact-check-tab.pro-checks.active {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .fact-check-tab.pro-checks.active::after {
            background: #ef4444;
        }

        .fact-check-tab-content {
            display: none;
            padding: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
            margin-bottom: 2rem;
        }

        .fact-check-tab-content.active {
            display: block;
        }

        /* Pro Checks tab content styling */
        .pro-checks-tab {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), var(--bg-card));
        }

        .pro-fact-checks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .pro-fact-check-card {
            display: block;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-elevated);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .pro-fact-check-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .pro-fact-check-card.rating-false {
            border-left: 3px solid #ef4444;
        }

        .pro-fact-check-card.rating-true {
            border-left: 3px solid #10b981;
        }

        .pro-fact-check-card.rating-mixed {
            border-left: 3px solid #f59e0b;
        }

        .pfc-publisher {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .pfc-rating {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-main);
        }

        .rating-false .pfc-rating { color: #f87171; }
        .rating-true .pfc-rating { color: #34d399; }
        .rating-mixed .pfc-rating { color: #fbbf24; }

        .pfc-title {
            font-size: 0.85rem;
            color: var(--text-prose);
            line-height: 1.4;
        }

        /* Context list styling */
        .context-list {
            list-style: none;
            padding: 0;
            margin: 16px 0;
        }

        .context-list li {
            padding: 12px 16px;
            margin-bottom: 10px;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 8px 8px 0;
        }

        /* Evidence section styling */
        .evidence-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .evidence-grid {
                grid-template-columns: 1fr;
            }
        }

        .evidence-column {
            padding: 16px;
            border-radius: 8px;
        }

        .evidence-column.supporting {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .evidence-column.contradicting {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .evidence-column h4 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .evidence-column.supporting h4 {
            color: #10b981;
        }

        .evidence-column.contradicting h4 {
            color: #ef4444;
        }

        .evidence-column ul {
            margin: 0;
            padding-left: 20px;
        }

        .evidence-column li {
            margin-bottom: 8px;
            color: var(--text-prose);
            font-size: 0.9rem;
        }

        /* Claim card styling */
        .claim-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .claim-card .claim-verdict {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .claim-card .claim-verdict.true {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .claim-card .claim-verdict.false {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .claim-card .claim-verdict.mixed {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .claim-card .claim-text {
            font-weight: 500;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .claim-card .claim-evidence {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Evidence list styling */
        .evidence-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .evidence-list li {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: var(--bg-elevated);
            border-left: 3px solid;
        }

        .evidence-list.contradicting li {
            border-color: #ef4444;
            color: var(--text-prose);
        }

        .evidence-list.supporting li {
            border-color: #10b981;
            color: var(--text-prose);
        }

        .context-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .context-list li {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: var(--bg-elevated);
            border-left: 3px solid var(--accent-blue);
            color: var(--text-prose);
        }

        /* Verdict colors */
        .verdict-true {
            border-color: #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.2), transparent);
        }
        .verdict-true .verdict-icon { color: #10b981; }
        .verdict-true .verdict-label { color: #10b981; }

        .verdict-false {
            border-color: #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.2), transparent);
        }
        .verdict-false .verdict-icon { color: #ef4444; }
        .verdict-false .verdict-label { color: #ef4444; }

        .verdict-mostly_true {
            border-color: #22c55e;
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.2), transparent);
        }
        .verdict-mostly_true .verdict-icon { color: #22c55e; }
        .verdict-mostly_true .verdict-label { color: #22c55e; }

        .verdict-mostly_false {
            border-color: #f97316;
            background: linear-gradient(90deg, rgba(249, 115, 22, 0.2), transparent);
        }
        .verdict-mostly_false .verdict-icon { color: #f97316; }
        .verdict-mostly_false .verdict-label { color: #f97316; }

        .verdict-mixed {
            border-color: #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.2), transparent);
        }
        .verdict-mixed .verdict-icon { color: #f59e0b; }
        .verdict-mixed .verdict-label { color: #f59e0b; }

        .verdict-unverifiable {
            border-color: #6b7280;
            background: linear-gradient(90deg, rgba(107, 114, 128, 0.2), transparent);
        }
        .verdict-unverifiable .verdict-icon { color: #6b7280; }
        .verdict-unverifiable .verdict-label { color: #6b7280; }

        /* Claims breakdown section */
        .claims-section {
            margin: 2rem 0;
        }

        .claim-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 1rem;
            position: relative;
        }

        .claim-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 10px 0 0 10px;
        }

        .claim-card.claim-true::before { background: #10b981; }
        .claim-card.claim-false::before { background: #ef4444; }
        .claim-card.claim-mixed::before { background: #f59e0b; }

        .claim-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .claim-verdict-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .claim-verdict-badge.true { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .claim-verdict-badge.false { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .claim-verdict-badge.mixed { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

        .claim-evidence {
            font-size: 0.9rem;
            color: var(--text-prose);
            line-height: 1.6;
        }

        /* Evidence summary grid */
        .evidence-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 2rem 0;
        }

        @media (max-width: 768px) {
            .evidence-grid {
                grid-template-columns: 1fr;
            }
        }

        .evidence-column {
            padding: 16px;
            border-radius: 10px;
        }

        .evidence-column.supporting {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .evidence-column.contradicting {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .evidence-column h4 {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .evidence-column.supporting h4 { color: #10b981; }
        .evidence-column.contradicting h4 { color: #ef4444; }

        .evidence-column p {
            font-size: 0.9rem;
            color: var(--text-prose);
            margin-bottom: 8px;
            padding-left: 16px;
            position: relative;
        }

        .evidence-column.supporting p::before {
            content: '+';
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: 700;
        }

        .evidence-column.contradicting p::before {
            content: '-';
            position: absolute;
            left: 0;
            color: #ef4444;
            font-weight: 700;
        }

        /* Fact check badge for search/trending */
        .fact-check-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(6, 182, 212, 0.2);
            color: #2dd4bf;
            margin-left: 8px;
        }

        /* Generate search box - textarea for paragraphs */
        #generate-search-box {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #generate-search-box textarea {
            resize: none;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.5;
        }

        /* Pasted content preview */
        .pasted-content-preview {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .pasted-content-preview.extracting {
            border-color: #3b82f6;
            animation: pulse-border 1.5s ease-in-out infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #3b82f6; }
            50% { border-color: #8b5cf6; }
        }

        .pasted-image-thumb {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .pasted-content-info {
            flex: 1;
            min-width: 0;
        }

        .pasted-content-type {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #3b82f6;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pasted-content-type.twitter { color: #1d9bf0; }
        .pasted-content-type.youtube { color: #ff0000; }
        .pasted-content-type.image { color: #10b981; }

        .pasted-content-text {
            font-size: 0.85rem;
            color: var(--text-main);
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .pasted-content-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .pasted-content-close {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .pasted-content-close:hover {
            background: var(--bg-card);
            color: var(--text-main);
        }

        .extracting-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #generate-search-box .generate-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* Mode toggle pill */
        .mode-toggle {
            display: flex;
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 3px;
            border: 1px solid var(--border-color);
        }

        .mode-toggle-btn {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .mode-toggle-btn:hover {
            color: var(--text-main);
        }

        .mode-toggle-btn.active {
            color: white;
        }

        .mode-toggle-btn.active.investigate {
            background: var(--accent-blue);
        }

        .mode-toggle-btn.active.fact-check {
            background: #06b6d4;
        }

        .mode-toggle-btn i {
            width: 12px;
            height: 12px;
        }

        /* Generate button */
        #generate-search-box .generate-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--accent-blue);
            color: white;
        }

        #generate-search-box .generate-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        #generate-search-box .generate-btn.fact-check-mode {
            background: #06b6d4;
        }

        #generate-search-box .generate-btn.fact-check-mode:hover {
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        /* Browse by Type - Tabbed Interface */
        .browse-type-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
        }

        .browse-type-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: -1px;
        }

        .browse-type-tab:hover {
            color: var(--text-main);
            background: var(--bg-elevated);
        }

        .browse-type-tab.active {
            border-bottom-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .browse-type-tab.active.investigations {
            border-bottom-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .browse-type-tab.active.fact-checks {
            border-bottom-color: #2dd4bf;
            color: #2dd4bf;
        }

        .browse-type-tab.active.deep-dives {
            border-bottom-color: var(--accent-green);
            color: var(--accent-green);
        }

        .browse-type-tab i {
            width: 14px;
            height: 14px;
        }

        .browse-type-tab .tab-count {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: var(--bg-elevated);
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .browse-type-tab.active .tab-count {
            background: currentColor;
            color: var(--bg-deep);
        }

        .browse-type-content {
            display: none;
        }

        .browse-type-content.active {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .browse-type-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        /* === PROFESSIONAL FACT CHECKS SECTION === */
        .prior-fact-checks-section {
            margin: 2rem 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 12px;
        }

        .prior-fact-checks-section .prose-h2 {
            font-size: 1.3rem;
            margin-top: 0;
            margin-bottom: 1rem;
            color: #2dd4bf;
            border-bottom: none;
            padding-bottom: 0;
        }

        .prior-fact-checks-section .prose-text {
            font-size: 0.95rem;
            margin-bottom: 1rem;
            text-align: left;
        }

        .prior-fact-checks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 1rem;
        }

        .prior-fact-check-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid;
            position: relative;
        }

        .prior-fact-check-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .prior-fact-check-card.true { border-color: #10b981; }
        .prior-fact-check-card.mostly_true { border-color: #22c55e; }
        .prior-fact-check-card.false { border-color: #ef4444; }
        .prior-fact-check-card.mostly_false { border-color: #f97316; }
        .prior-fact-check-card.mixed { border-color: #f59e0b; }
        .prior-fact-check-card.unverifiable { border-color: #6b7280; }

        .pfc-publisher {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .pfc-rating {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .prior-fact-check-card.true .pfc-rating { color: #10b981; }
        .prior-fact-check-card.mostly_true .pfc-rating { color: #22c55e; }
        .prior-fact-check-card.false .pfc-rating { color: #ef4444; }
        .prior-fact-check-card.mostly_false .pfc-rating { color: #f97316; }
        .prior-fact-check-card.mixed .pfc-rating { color: #f59e0b; }
        .prior-fact-check-card.unverifiable .pfc-rating { color: #6b7280; }

        .pfc-title {
            font-size: 0.8rem;
            color: var(--text-prose);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .pfc-disclaimer {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            margin: 0;
        }

        @media (max-width: 768px) {
            .prior-fact-checks-grid {
                grid-template-columns: 1fr;
            }
        }

        /* FLOATS (The Wrapping) */
        /* === STYLE E: HOVER REVEAL INFOGRAPHICS === */
        .float-figure {
            width: 100%;
            margin: 2rem 0;
            background: transparent;
            border: none;
            border-radius: 8px;
            padding: 0;
            position: relative;
            overflow: hidden;
            /* shape-outside is key for magazine wrapping */
            shape-outside: margin-box;
            margin-bottom: 2rem;
            clear: both;
        }

        .float-figure img,
        .float-figure canvas {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
            transition: transform 0.3s ease;
        }

        /* Override inline height on inner wrapper to eliminate gap below infographics */
        .float-figure > div[style*="height"] {
            height: auto !important;
            min-height: 150px; /* Ensure charts have minimum space */
        }

        .float-figure:hover img,
        .float-figure:hover canvas {
            transform: scale(1.02);
        }

        /* Infographic Loading Placeholder */
        .infographic-placeholder {
            width: 100%;
            aspect-ratio: 16/10;
            background: linear-gradient(135deg, #0a0a1a 0%, #050505 50%, #0a0a1a 100%);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        .infographic-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: placeholderShimmer 2s infinite;
        }

        @keyframes placeholderShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .placeholder-icon {
            width: 48px;
            height: 48px;
            border: 2px solid rgba(59, 130, 246, 0.5);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: placeholderSpin 1.2s linear infinite;
        }

        @keyframes placeholderSpin {
            to { transform: rotate(360deg); }
        }

        .placeholder-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .placeholder-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
            max-width: 80%;
            text-align: center;
        }

        @media (min-width: 1024px) {
            .float-figure {
                clear: none;
            }

            /* Allow side-by-side on desktop */

            .float-figure.right {
                float: right;
                width: 40%;
                margin-left: 3rem;
                margin-bottom: 0.75rem;
                margin-top: 0.5rem;
                shape-margin: 2rem;
            }

            .float-figure.left {
                float: left;
                width: 40%;
                margin-right: 3rem;
                margin-bottom: 0.75rem;
                margin-top: 0.5rem;
                shape-margin: 2rem;
            }
        }

        /* Hover reveal caption overlay */
        .fig-caption {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: #fff;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.85));
            padding: 2.5rem 1rem 0.75rem;
            border-radius: 0 0 8px 8px;
            text-align: left;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .float-figure:hover .fig-caption {
            opacity: 1;
        }

        .fig-deep-dive {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            width: 24px;
            height: 24px;
            font-size: 0; /* Hide text content */
            color: #fff;
            background: linear-gradient(135deg, var(--accent-blue), #5b8def);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            vertical-align: middle;
            position: relative;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            overflow: hidden; /* Hide any text overflow */
        }

        .fig-deep-dive::before {
            content: '+';
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1;
        }

        .fig-deep-dive:hover {
            background: linear-gradient(135deg, #5b8def, #7c9eff);
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.5);
        }

        .fig-deep-dive.queued {
            background: linear-gradient(135deg, var(--accent-green), #45c97a);
            pointer-events: none;
            transform: scale(1);
        }

        .fig-deep-dive.queued::before {
            content: 'âœ“';
            font-size: 0.9rem;
        }

        .fig-deep-dive.queued:hover {
            transform: scale(1);
        }

        /* Light mode adjustments for overlay */
        [data-theme="light"] .fig-caption {
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.75));
        }

        /* Infographic Lightbox Modal */
        #infographic-lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #infographic-lightbox.visible {
            display: flex;
            opacity: 1;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 85vh;
            background: var(--chart-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #infographic-lightbox.visible .lightbox-content {
            transform: scale(1);
        }

        .lightbox-close {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 36px;
            height: 36px;
            background: var(--bg-deep);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            color: var(--text-main);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10001;
        }

        .lightbox-close:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            transform: scale(1.1);
        }

        .lightbox-image-container {
            max-width: 80vw;
            max-height: 65vh;
            overflow: hidden;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-image-container img {
            max-width: 100%;
            max-height: 65vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .lightbox-image-container canvas {
            max-width: 100%;
            max-height: 65vh;
        }

        .lightbox-caption {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 1rem;
        }

        .lightbox-caption .fig-deep-dive {
            font-size: 0.75rem;
            padding: 4px 12px;
        }

        /* === SIMILAR ARTICLES MODAL === */
        #similar-articles-modal {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
        }

        #similar-articles-modal.visible {
            background: rgba(0, 0, 0, 0.6);
            pointer-events: auto;
            opacity: 1;
            backdrop-filter: blur(4px);
        }

        .similar-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 540px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s ease;
        }

        #similar-articles-modal.visible .similar-modal-content {
            transform: scale(1) translateY(0);
        }

        .similar-modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .similar-modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .similar-modal-header h3 i {
            color: #10b981;
        }

        .similar-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .similar-modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
        }

        .similar-modal-query {
            padding: 1rem 1.5rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
        }

        .similar-modal-query .query-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .similar-modal-query .query-text {
            font-size: 0.95rem;
            color: var(--text-main);
            font-weight: 500;
        }

        .similar-modal-body {
            padding: 1rem 1.5rem;
            max-height: 340px;
            overflow-y: auto;
        }

        .similar-intro {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .similar-article-card {
            padding: 0.875rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .similar-article-card:hover {
            border-color: #10b981;
            transform: translateX(4px);
        }

        .similar-article-card:last-child {
            margin-bottom: 0;
        }

        .similar-card-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.35rem;
        }

        .similar-match-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            font-weight: 600;
        }

        .similar-type-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .similar-type-badge.fact-check {
            background: rgba(45, 212, 191, 0.15);
            color: #2dd4bf;
        }

        .similar-article-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-main);
            line-height: 1.3;
        }

        .similar-article-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
            line-height: 1.4;
        }

        .similar-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        .similar-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .similar-btn-generate {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            border: none;
        }

        .similar-btn-generate:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .similar-btn-cancel {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        .similar-btn-cancel:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
        }

        .free-badge {
            font-size: 0.65rem;
            padding: 2px 5px;
            background: #10b981;
            color: white;
            border-radius: 3px;
            margin-left: 0.25rem;
        }

        /* Make float-figure clickable */
        .float-figure {
            cursor: zoom-in;
        }

        .float-figure .fig-deep-dive {
            cursor: pointer;
        }

        /* Deep Dive Hover Preview Tooltip */
        .deep-dive-tooltip {
            position: fixed;
            width: 280px;
            max-width: 90vw;
            padding: 12px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .deep-dive-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--border-color);
        }

        .deep-dive-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 7px solid transparent;
            border-top-color: var(--card-bg);
            z-index: 1;
        }

        .deep-dive-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-context {
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-prose);
            margin-bottom: 10px;
        }

        .tooltip-action {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--accent-blue), #4f46e5);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .tooltip-action:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tooltip-rabbit {
            font-size: 1rem;
        }

        /* HIGHLIGHTS & LIVING NUMBERS */
        .highlight-glow {
            color: var(--text-main);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
            font-weight: 700;
        }

        [data-theme="light"] .highlight-glow {
            text-shadow: none;
            background: linear-gradient(120deg, rgba(59, 130, 246, 0.2) 0%, rgba(16, 185, 129, 0.2) 100%);
            padding: 0 4px;
            border-radius: 4px;
        }

        /* Light mode text fixes */
        [data-theme="light"] .text-white {
            color: var(--text-main) !important;
        }

        [data-theme="light"] strong.text-white {
            color: var(--text-main) !important;
        }

        [data-theme="light"] .trending-card h3 {
            color: var(--text-main) !important;
        }

        [data-theme="light"] .hover\:text-white:hover {
            color: var(--text-main) !important;
        }

        [data-theme="light"] .fractal-trigger {
            color: var(--accent-blue) !important;
        }

        [data-theme="light"] .fractal-trigger:hover {
            color: var(--text-main) !important;
        }

        /* Keep logo G styled properly */
        [data-theme="light"] .bg-blue-600.text-white {
            color: white !important;
        }

        .living-number {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
            font-weight: 700;
            display: inline-block;
        }

        /* INTERACTIVE ELEMENTS */
        .fractal-trigger {
            border-bottom: 1px dashed var(--accent-blue);
            color: #93c5fd;
            cursor: zoom-in;
            transition: all 0.2s;
            font-weight: 700;
            position: relative;
        }

        .fractal-trigger:hover {
            background: rgba(59, 130, 246, 0.15);
            color: white;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* INTERACTIVE ELEMENTS */
        .fractal-trigger {
            border-bottom: 1px dashed var(--accent-blue);
            color: #93c5fd;
            cursor: zoom-in;
            transition: all 0.2s;
            font-weight: 700;
            position: relative;
        }

        .fractal-trigger:hover {
            background: rgba(59, 130, 246, 0.15);
            color: white;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* INTELLIGENCE CARD (Rich Tooltip) */
        .intelligence-card {
            visibility: hidden;
            position: fixed;
            /* Fixed to avoid overflow issues */
            width: 320px;
            background: rgba(15, 23, 42, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px);
            pointer-events: none;
            /* Let clicks pass through if needed, but usually we want it strictly informational */
        }

        .intelligence-card.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* FRACTAL TRIGGER TOOLTIP */
        .fractal-tooltip {
            visibility: hidden;
            position: fixed;
            width: 280px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.1));
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(59, 130, 246, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
            transform: translateY(8px);
            pointer-events: none;
        }

        .fractal-tooltip.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .fractal-tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .fractal-tooltip-title {
            font-weight: 700;
            color: #93c5fd;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fractal-tooltip-action {
            font-size: 10px;
            color: rgba(147, 197, 253, 0.7);
            background: rgba(59, 130, 246, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .fractal-tooltip-content {
            font-size: 12px;
            color: var(--text-prose);
            line-height: 1.5;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .source-domain {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .trust-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .trust-high {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .trust-med {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .card-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .card-snippet {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: #cbd5e1;
            line-height: 1.5;
        }

        /* The Spade Citation */
        .citation-spade {
            font-family: 'Inter', sans-serif;
            color: var(--accent-green);
            font-size: 0.75rem;
            vertical-align: super;
            cursor: pointer;
            margin-left: 1px;
            opacity: 0.7;
            transition: all 0.2s;
            display: inline-block;
            padding: 0 2px;
        }

        .citation-spade:hover {
            opacity: 1;
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.6);
        }

        /* Link append style */
        a.citation-link {
            text-decoration: none;
            color: inherit;
        }

        .fractal-context {
            display: none;
            margin: 1rem 0 1rem 2rem;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 8px 8px 0;
            font-size: 1rem;
            color: #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            clear: both;
        }

        .fractal-context.open {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Trending Cards - Base */
        .trending-card {
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.3s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 1rem;
        }

        .trending-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            background: var(--bg-elevated);
        }

        [data-theme="light"] .trending-card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        [data-theme="light"] .trending-card p {
            color: var(--text-muted) !important;
        }

        /* Graduated Card Sizes - 1st is largest, decreasing to 4th (30% reduced) */
        .trending-card-1 {
            padding: 1.25rem;
        }
        .trending-card-1 h3 { font-size: 1.25rem; }
        .trending-card-1 p { font-size: 0.9rem; line-height: 1.5; }

        .trending-card-2 {
            padding: 1rem;
        }
        .trending-card-2 h3 { font-size: 1.1rem; }
        .trending-card-2 p { font-size: 0.85rem; }

        .trending-card-3 {
            padding: 0.875rem;
        }
        .trending-card-3 h3 { font-size: 1rem; }
        .trending-card-3 p { font-size: 0.8rem; }

        .trending-card-4 {
            padding: 0.75rem;
        }
        .trending-card-4 h3 { font-size: 0.9rem; }
        .trending-card-4 p { font-size: 0.75rem; }

        /* 2-column card layout - content left, sources right */
        .card-inner {
            display: flex;
            gap: 1rem;
        }
        .card-content {
            flex: 1;
            min-width: 0;
        }
        .card-sources {
            width: 180px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            border-left: 1px solid var(--border-color);
            padding-left: 0.75rem;
            font-size: 0.65rem;
        }
        .card-sources .source-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-sources .source-name {
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-sources .source-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .card-sources .source-dot.high { background: #10b981; }
        .card-sources .source-dot.medium { background: #f59e0b; }
        .card-sources .source-dot.low { background: #ef4444; }

        /* Mini source badge for browse cards */
        .browse-source {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.8;
        }
        .browse-source .source-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .browse-source .source-dot.high { background: #10b981; }
        .browse-source .source-dot.medium { background: #f59e0b; }
        .browse-source .source-dot.low { background: #ef4444; }

        @media (max-width: 640px) {
            .card-sources { display: none; }
        }

        /* 5th card and beyond - Compact list style */
        .trending-card-list {
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.3s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .trending-card-list:hover {
            transform: translateX(4px);
            border-color: var(--accent-blue);
            background: var(--bg-elevated);
        }

        .trending-card-list .card-tag {
            font-size: 0.55rem;
            white-space: nowrap;
            min-width: 70px;
        }

        .trending-card-list h4 {
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.3;
            flex: 1;
        }

        [data-theme="light"] .trending-card-list {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        /* Expand/Browse section */
        .browse-more-header {
            padding: 0.75rem 1rem;
            border: 1px dashed var(--border-color);
            border-radius: 0.5rem;
            background: transparent;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        /* Typewriter effect */
        .typewriter {
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid var(--text-muted);
            animation: typing 4s steps(40, end) forwards, blink-caret 0.75s step-end infinite;
        }

        .typewriter.done {
            border-right: none;
            animation: none;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: var(--text-muted); }
        }

        /* Queue Deep Dive Button (replaces old rabbit-hole-btn) */
        .rabbit-hole-btn,
        .queue-deepdive-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(37, 99, 235, 0.15));
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            color: #93c5fd;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            box-sizing: border-box;
        }

        .queue-deepdive-btn .queue-btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--accent-blue), #5b8def);
            border-radius: 50%;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            flex-shrink: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .queue-deepdive-btn .queue-btn-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .queue-deepdive-btn .queue-btn-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .queue-deepdive-btn .queue-btn-topic {
            font-size: 0.85rem;
            color: var(--text-main);
            font-weight: 600;
        }

        .rabbit-hole-btn:hover,
        .queue-deepdive-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(37, 99, 235, 0.25));
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
        }

        .queue-deepdive-btn:hover .queue-btn-icon {
            transform: rotate(90deg) scale(1.1);
        }

        .queue-deepdive-btn.queued {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.15));
            border-color: rgba(16, 185, 129, 0.4);
            pointer-events: none;
        }

        .queue-deepdive-btn.queued .queue-btn-icon {
            background: linear-gradient(135deg, var(--accent-green), #45c97a);
        }

        .queue-deepdive-btn.queued .queue-btn-label {
            color: var(--accent-green);
        }

        /* Hover Queue Pill (Phase 2) */
        .hover-queue-pill {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px 4px 6px;
            background: linear-gradient(135deg, var(--accent-blue), #5b8def);
            border-radius: 14px;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transform: translateX(-8px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            white-space: nowrap;
        }

        .hover-queue-pill.visible {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .hover-queue-pill:hover {
            background: linear-gradient(135deg, #5b8def, #7c9eff);
            transform: scale(1.05);
        }

        .hover-queue-pill .pill-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 0.8rem;
        }

        .hover-queue-pill.queued {
            background: linear-gradient(135deg, var(--accent-green), #45c97a);
            pointer-events: none;
        }

        /* Make fractal-trigger position relative for pill positioning */
        .fractal-trigger {
            position: relative;
        }

        /* === DEEP DIVE LOADING SCREEN === */
        #deep-dive-loader {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(5, 5, 5, 0.97);
            backdrop-filter: blur(20px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        #deep-dive-loader.visible {
            display: flex;
        }

        /* Morphing blob animation - trust-evoking organic movement */
        .loader-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .loader-blob {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #8b6914 0%, #c9a227 30%, #e8b84a 50%, #d4a574 70%, #8b6914 100%);
            background-size: 300% 300%;
            animation: morphBlob 8s ease-in-out infinite, gradientShift 6s ease infinite, floatBlob 4s ease-in-out infinite;
            filter: blur(0px);
            box-shadow:
                0 0 60px rgba(201, 162, 39, 0.5),
                0 0 100px rgba(212, 165, 116, 0.3),
                inset 0 0 30px rgba(255, 240, 200, 0.15);
        }

        .loader-blob::before {
            content: '';
            position: absolute;
            inset: 3px;
            background: rgba(26, 20, 16, 0.4);
            border-radius: inherit;
            animation: morphBlob 8s ease-in-out infinite reverse;
        }

        /* Scanning lines effect */
        .loader-scan {
            position: absolute;
            inset: -10px;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(201, 162, 39, 0.04) 2px,
                rgba(201, 162, 39, 0.04) 4px
            );
            animation: scanMove 2s linear infinite;
            pointer-events: none;
        }

        @keyframes morphBlob {
            0%, 100% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
            25% {
                border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
            }
            50% {
                border-radius: 50% 60% 30% 60% / 30% 70% 60% 40%;
            }
            75% {
                border-radius: 60% 40% 60% 30% / 70% 30% 50% 60%;
            }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes floatBlob {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.02); }
        }

        @keyframes scanMove {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* Status indicators */
        .loader-status {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.5;
            transition: opacity 0.3s, color 0.3s;
        }

        .status-item.active {
            opacity: 1;
            color: var(--accent-green);
        }

        .status-item.active .status-dot {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-item.complete {
            opacity: 1;
            color: var(--accent-blue);
        }

        .status-item.complete .status-dot {
            background: var(--accent-blue);
        }

        .status-item.complete::after {
            content: 'âœ“';
            font-size: 0.6rem;
            margin-left: 0.25rem;
            color: var(--accent-blue);
        }

        .status-item.done {
            opacity: 1;
            color: var(--accent-green);
        }

        .status-item.done .status-dot {
            background: var(--accent-green);
        }

        .status-item.done::after {
            content: 'âœ“';
            font-size: 0.6rem;
            margin-left: 0.25rem;
            color: var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s;
        }

        .loader-text {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: #e2e2e5;
            text-align: center;
            max-width: 90vw;
            width: 600px;
            padding: 0 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .loader-subtext {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: #6b7280;
            max-width: 450px;
            text-align: center;
            line-height: 1.7;
        }

        /* Context Preview in Loader */
        .loader-context-preview {
            margin-top: 1.5rem;
            max-width: 500px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            text-align: left;
        }

        .context-preview-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .context-preview-text {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--text-prose);
            line-height: 1.6;
            max-height: 120px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .context-preview-text::-webkit-scrollbar {
            width: 4px;
        }

        .context-preview-text::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .loader-progress {
            width: 300px;
            height: 3px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b6914, #c9a227, #e8b84a, #d4a574);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.3s ease-out;
            animation: shimmer 2s linear infinite;
            border-radius: 2px;
        }

        @keyframes progress {
            0% { width: 0%; }
            5% { width: 8%; }
            15% { width: 20%; }
            30% { width: 35%; }
            50% { width: 55%; }
            70% { width: 72%; }
            85% { width: 85%; }
            100% { width: 95%; }
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* === LANDING PAGE ANIMATIONS === */

        /* Soft bouncy drop-in animation */
        @keyframes dropIn {
            0% {
                opacity: 0;
                transform: translateY(-30px);
            }
            60% {
                opacity: 1;
                transform: translateY(8px);
            }
            80% {
                transform: translateY(-4px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Gentle fade-up for cards */
        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Soft attention roll for logo - gentle and refined */
        @keyframes attentionBounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            25% {
                transform: translateY(-5px) scale(1.01);
            }
            50% {
                transform: translateY(-2px) scale(1.005);
            }
            75% {
                transform: translateY(-1px) scale(1.002);
            }
        }

        /* Animation classes */
        .anim-drop-in {
            animation: dropIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
        }

        .anim-fade-up {
            animation: fadeUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .anim-attention {
            animation: attentionBounce 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Staggered delays for children */
        .anim-delay-1 { animation-delay: 0.1s; }
        .anim-delay-2 { animation-delay: 0.2s; }
        .anim-delay-3 { animation-delay: 0.3s; }
        .anim-delay-4 { animation-delay: 0.4s; }
        .anim-delay-5 { animation-delay: 0.5s; }
        .anim-delay-6 { animation-delay: 0.6s; }
        .anim-delay-7 { animation-delay: 0.7s; }
        .anim-delay-8 { animation-delay: 0.8s; }

        /* === BOOKMARKS SIDEBAR === */
        #bookmarks-sidebar {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 360px;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            overflow-y: auto;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.3);
        }

        #bookmarks-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pipeline-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
        }

        .pipeline-header:hover {
            color: var(--accent-blue);
        }

        .pipeline-items {
            margin-top: 0.75rem;
        }

        .bookmark-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .bookmark-item:hover {
            background: var(--bg-elevated);
        }

        .bookmark-item-title {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-pipeline-btn {
            width: 100%;
            padding: 0.75rem;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .add-pipeline-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        /* === FLOATING DEEP DIVE BADGE === */
        #deep-dive-badge {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 90;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        #deep-dive-badge.visible {
            display: flex;
        }

        #deep-dive-badge.minimized {
            min-width: auto;
            padding: 8px 12px;
            border-radius: 20px;
        }

        #deep-dive-badge.minimized .badge-expanded {
            display: none;
        }

        #deep-dive-badge.minimized .badge-minimized {
            display: flex;
        }

        .badge-minimized {
            display: none;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }

        .badge-toggle:hover {
            color: var(--accent-blue);
        }

        .badge-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-blue);
        }

        .badge-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .badge-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .badge-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .badge-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .badge-free {
            color: var(--accent-green) !important;
        }

        .badge-paid {
            color: #f59e0b !important;
        }

        .badge-divider {
            width: 1px;
            height: 30px;
            background: var(--border-color);
        }

        .badge-remaining {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(124, 154, 94, 0.1);
            border: 1px solid rgba(124, 154, 94, 0.3);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--accent-green);
        }

        .badge-remaining.depleted {
            background: rgba(196, 92, 62, 0.1);
            border-color: rgba(196, 92, 62, 0.3);
            color: #c45c3e;
        }

        /* === GENERATION CARDS IN BADGE === */
        .badge-generations {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .badge-generations:empty {
            display: none;
        }

        .badge-generations-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-warm);
        }

        .badge-generations-header .gen-count {
            background: var(--accent-warm);
            color: #000;
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 8px;
        }

        .gen-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .gen-card.complete {
            border-color: var(--accent-green);
            background: rgba(48, 164, 108, 0.08);
        }

        .gen-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .gen-card-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-main);
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .gen-card-percent {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent-warm);
        }

        .gen-card.complete .gen-card-percent {
            color: var(--accent-green);
        }

        .gen-card-progress {
            height: 3px;
            background: var(--bg-deep);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .gen-card-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-warm), #f59e0b);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .gen-card.complete .gen-card-progress-bar {
            background: var(--accent-green);
        }

        .gen-card-status {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .gen-card-actions {
            display: none;
            margin-top: 8px;
        }

        .gen-card.complete .gen-card-actions {
            display: flex;
            gap: 6px;
        }

        .gen-card-btn {
            flex: 1;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gen-card-btn.primary {
            background: var(--accent-green);
            color: #000;
        }

        .gen-card-btn.primary:hover {
            filter: brightness(1.1);
        }

        .gen-card-btn.secondary {
            background: var(--bg-deep);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        .gen-card-btn.secondary:hover {
            color: var(--text-main);
        }

        /* Enhance-specific styling */
        .gen-card.enhance {
            border-color: rgba(6, 182, 212, 0.3);
        }

        .gen-card.enhance.complete {
            border-color: rgba(6, 182, 212, 0.6);
            background: rgba(6, 182, 212, 0.08);
        }

        .gen-card-progress-bar.enhance {
            background: linear-gradient(90deg, #06b6d4, #2dd4bf);
        }

        .gen-card.enhance.complete .gen-card-progress-bar {
            background: linear-gradient(90deg, #06b6d4, #2dd4bf);
        }

        .gen-card.enhance .gen-card-percent {
            color: #2dd4bf;
        }

        .gen-card-btn.primary.enhance {
            background: linear-gradient(135deg, #06b6d4, #0d9488);
            color: #fff;
        }

        /* Minimized badge with generations */
        #deep-dive-badge.minimized .badge-generations {
            display: none;
        }

        .badge-mini-gen {
            display: none;
            align-items: center;
            gap: 4px;
            color: var(--accent-warm);
        }

        #deep-dive-badge.minimized.has-generations .badge-mini-gen {
            display: flex;
        }

        .badge-mini-gen .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Badge visible when has generations, even outside report view */
        #deep-dive-badge.has-generations {
            display: flex !important;
        }

        /* === PDF PRINT STYLES === */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            .nav-glass, #reading-progress, #shortcuts-modal, #bookmarks-sidebar, #deep-dive-loader, #deep-dive-badge {
                display: none !important;
            }
            .view-section {
                padding-top: 0 !important;
            }
            .float-figure {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .prose-h2 {
                page-break-after: avoid;
            }
        }
    </style>
</head>

<body>

    <!-- DEEP DIVE LOADING SCREEN -->
    <div id="deep-dive-loader">
        <div class="loader-container">
            <div class="loader-blob"></div>
            <div class="loader-scan"></div>
        </div>
        <div class="loader-text" id="loader-title">Generating Intelligence Report</div>
        <div class="loader-subtext" id="loader-subtitle">Researching sources, cross-referencing data, and synthesizing insights...</div>

        <!-- Context Preview Section -->
        <div id="loader-context-preview" class="loader-context-preview" style="display: none;">
            <div class="context-preview-label">Using context from parent article:</div>
            <div id="loader-context-text" class="context-preview-text"></div>
        </div>

        <div class="loader-status" id="loader-status-stages">
            <div class="status-item" id="status-init">
                <span class="status-dot"></span>
                <span>Initializing</span>
            </div>
            <div class="status-item" id="status-connect">
                <span class="status-dot"></span>
                <span>Connecting</span>
            </div>
            <div class="status-item" id="status-research">
                <span class="status-dot"></span>
                <span>Researching</span>
            </div>
            <div class="status-item" id="status-writing">
                <span class="status-dot"></span>
                <span>Writing</span>
            </div>
            <div class="status-item" id="status-analysis">
                <span class="status-dot"></span>
                <span>Analyzing</span>
            </div>
            <div class="status-item" id="status-charts">
                <span class="status-dot"></span>
                <span>Charts</span>
            </div>
            <div class="status-item" id="status-sources">
                <span class="status-dot"></span>
                <span>Sources</span>
            </div>
            <div class="status-item" id="status-complete">
                <span class="status-dot"></span>
                <span>Complete</span>
            </div>
        </div>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="loader-progress-bar"></div>
        </div>
        <div id="loader-percent" style="color: var(--accent); font-size: 0.9rem; margin-top: 0.5rem; font-family: monospace;">0%</div>
        <button onclick="cancelDeepDive()" class="action-btn" style="margin-top: 1rem; opacity: 0.7;">
            <i data-lucide="x" class="w-4 h-4"></i> Cancel
        </button>
    </div>

    <!-- INLINE ENHANCEMENT PROGRESS WIDGET -->
    <div id="enhance-progress-widget" class="enhance-progress-widget">
        <div class="enhance-widget-header">
            <div class="enhance-widget-icon spinning" id="enhance-widget-icon">
                <i data-lucide="sparkles"></i>
            </div>
            <div class="enhance-widget-title">
                <h4 id="enhance-widget-title">Enhancing Article</h4>
                <span id="enhance-widget-percent">0%</span>
            </div>
        </div>
        <div class="enhance-widget-progress">
            <div class="enhance-widget-progress-bar" id="enhance-widget-bar"></div>
        </div>
        <div class="enhance-widget-status">
            <span class="status-dot"></span>
            <span id="enhance-widget-status">Preparing enhancement...</span>
        </div>
        <div class="enhance-widget-actions">
            <button class="enhance-widget-btn primary" onclick="applyEnhancement()">
                <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                Apply Enhancement
            </button>
            <button class="enhance-widget-btn secondary" onclick="dismissEnhancement()">
                Dismiss
            </button>
        </div>
    </div>

    <!-- BOOKMARKS SIDEBAR -->
    <div id="bookmarks-sidebar">
        <div class="sidebar-header">
            <h2 class="text-lg font-bold" style="color: var(--text-main);">
                <i data-lucide="library" class="w-5 h-5 inline mr-2"></i>Research Library
            </h2>
            <button onclick="toggleBookmarksSidebar()" style="color: var(--text-muted);">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="bookmarks-content">
            <!-- Populated by JS -->
        </div>
        <div class="pipeline-section">
            <button onclick="createNewPipeline()" class="add-pipeline-btn">
                <i data-lucide="folder-plus" class="w-4 h-4"></i>
                Create New Pipeline
            </button>
        </div>
    </div>

    <!-- FLOATING RESEARCH STATUS BADGE -->
    <div id="deep-dive-badge">
        <!-- Minimized view -->
        <div class="badge-minimized" onclick="toggleBadgeSize()">
            <span class="badge-mini-gen" id="badge-mini-gen">
                <i data-lucide="loader-2" class="w-3 h-3 spin"></i>
                <span id="badge-mini-gen-count">0</span>
            </span>
            <i data-lucide="layers" class="w-4 h-4" style="color: var(--accent-blue);"></i>
            <span class="badge-free" id="badge-mini-free">0</span>/<span class="badge-paid" id="badge-mini-paid">0</span>
            <button class="badge-toggle" onclick="event.stopPropagation(); toggleBadgeSize();">
                <i data-lucide="maximize-2" class="w-3 h-3"></i>
            </button>
        </div>
        <!-- Expanded view -->
        <div class="badge-expanded">
            <div class="badge-header">
                <i data-lucide="activity" class="w-4 h-4"></i>
                Research Status
                <button class="badge-toggle" style="margin-left: auto;" onclick="toggleBadgeSize()">
                    <i data-lucide="minimize-2" class="w-3 h-3"></i>
                </button>
            </div>
            <!-- Active Generations Section -->
            <div class="badge-generations" id="badge-generations">
                <!-- Generation cards inserted here dynamically -->
            </div>
            <!-- Deep Dives Section -->
            <div class="badge-stats">
                <div class="badge-stat">
                    <span class="badge-stat-value badge-free" id="badge-free-count">0</span>
                    <span class="badge-stat-label">Free</span>
                </div>
                <div class="badge-divider"></div>
                <div class="badge-stat">
                    <span class="badge-stat-value badge-paid" id="badge-paid-count">0</span>
                    <span class="badge-stat-label">Costs Token</span>
                </div>
            </div>
            <div class="badge-remaining" id="badge-remaining">
                <i data-lucide="zap" class="w-3 h-3"></i>
                <span id="badge-remaining-text">3 remaining free today</span>
            </div>
        </div>
    </div>

    <!-- Infographic Lightbox Modal -->
    <div id="infographic-lightbox" onclick="closeLightbox(event)">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <button class="lightbox-close" onclick="closeLightbox(event)">&times;</button>
            <div class="lightbox-image-container" id="lightbox-image-container">
                <!-- Image/canvas will be cloned here -->
            </div>
            <div class="lightbox-caption" id="lightbox-caption">
                <!-- Caption with Deep Dive button will be cloned here -->
            </div>
        </div>
    </div>

    <!-- Similar Articles Modal -->
    <div id="similar-articles-modal" onclick="closeSimilarModal(event)">
        <div class="similar-modal-content" onclick="event.stopPropagation()">
            <div class="similar-modal-header">
                <h3><i data-lucide="search-check" class="w-5 h-5"></i> Related Content Found</h3>
                <button class="similar-modal-close" onclick="closeSimilarModal()">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="similar-modal-query">
                <div class="query-label">Your search</div>
                <div class="query-text" id="similar-query-text"></div>
            </div>
            <div class="similar-modal-body">
                <p class="similar-intro">We found existing articles that might answer your question. Click one to read it for free, or generate a fresh analysis.</p>
                <div id="similar-articles-list">
                    <!-- Similar articles will be rendered here -->
                </div>
            </div>
            <div class="similar-modal-footer">
                <button class="similar-btn similar-btn-cancel" onclick="closeSimilarModal()">
                    Cancel
                </button>
                <button class="similar-btn similar-btn-generate" id="similar-generate-btn">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    Generate New
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Hover Element -->
    <div id="receipt-tooltip"
        class="receipt-card fixed hidden z-[100] w-[320px] bg-[#141419] border border-[#3f3f46] rounded-lg p-4 shadow-2xl pointer-events-none transition-opacity duration-200 opacity-0">
        <div class="text-[0.7rem] text-[#9ca3af] uppercase mb-2 border-b border-[#3f3f46] pb-1">SOURCE VERIFICATION
        </div>
        <div id="receipt-text" class="text-sm text-[#e4e4e7]"></div>
    </div>

    <!-- READING PROGRESS BAR -->
    <div id="reading-progress">
        <div id="progress-bar"></div>
        <div id="progress-text" class="text-xs text-center py-1 font-mono" style="color: var(--text-muted);">0 min read â€¢ 0% complete</div>
    </div>

    <!-- NAV -->
    <nav class="fixed top-0 w-full z-50 nav-glass h-16">
        <div class="w-full px-6 lg:px-8 h-full flex items-center justify-between">
            <!-- Left: Logo -->
            <div class="flex items-center gap-3 cursor-pointer flex-1" onclick="switchView('view-portal')">
                <div class="logo-icon">G</div>
                <span class="font-bold text-xl tracking-tight">Genu<span style="color: var(--logo-accent);">Verity</span></span>
            </div>

            <!-- Center: Sources Button (only visible on essay pages) -->
            <div class="flex-1 flex justify-center items-center" style="z-index: 51; position: relative;">
                <button id="nav-sources-btn" class="nav-sources-btn" onclick="toggleSourcesBanner()" title="Toggle Sources (S)">
                    <i data-lucide="shield-check" class="w-4 h-4 sources-shield"></i>
                    <span class="nav-sources-label">Sources</span>
                    <span class="nav-sources-count" id="nav-sources-count">0</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 sources-chevron"></i>
                </button>
            </div>

            <!-- Right: Other buttons -->
            <div class="flex items-center gap-4 flex-1 justify-end">
                <div class="hidden md:flex gap-6 text-sm font-medium">
                    <a href="https://gen-ui-essay-demo.vercel.app" target="_blank" class="nav-link" style="color: var(--accent-blue);">
                        <i data-lucide="flask-conical" class="w-3.5 h-3.5 inline mr-1"></i>Research Lab
                    </a>
                    <a class="nav-link">Manifesto</a>
                    <a href="/methods.html" class="nav-link">Methods</a>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Generation Progress Indicator -->
                    <div id="nav-gen-indicator" class="nav-gen-indicator" onclick="handleNavGenClick()" title="Research in progress">
                        <i data-lucide="loader-2" class="spinner"></i>
                        <span id="nav-gen-text">Generating...</span>
                    </div>
                    <!-- Bookmarks/Library -->
                    <button onclick="toggleBookmarksSidebar()" class="theme-toggle" title="Research Library (L)">
                        <i data-lucide="library" class="w-4 h-4"></i>
                    </button>
                    <!-- Dark/Light Mode Toggle -->
                    <button onclick="toggleTheme()" class="theme-toggle-switch" title="Toggle dark/light mode (T)">
                        <i data-lucide="sun" class="icon-sun w-4 h-4"></i>
                        <i data-lucide="moon" class="icon-moon w-4 h-4"></i>
                    </button>
                    <!-- Keyboard Shortcuts Help -->
                    <button onclick="toggleShortcutsModal()" class="theme-toggle" title="Keyboard shortcuts (?)">
                        <i data-lucide="keyboard" class="w-4 h-4"></i>
                    </button>
                    <!-- User Menu / Dashboard Access -->
                    <div class="user-menu-container">
                        <button onclick="toggleUserMenu()" class="user-avatar-btn" title="My Research (U)">
                            <i data-lucide="user" class="w-4 h-4 user-icon-anon"></i>
                            <span class="user-activity-dot"></span>
                        </button>
                        <div id="user-dropdown" class="user-dropdown">
                            <div class="user-dropdown-header">
                                <div class="user-dropdown-avatar">
                                    <i data-lucide="user" class="w-6 h-6"></i>
                                </div>
                                <div class="user-dropdown-info">
                                    <span class="user-dropdown-name">Researcher</span>
                                    <span class="user-dropdown-status">Local Session</span>
                                </div>
                            </div>
                            <div class="user-dropdown-divider"></div>
                            <button class="user-dropdown-item" onclick="switchView('view-dashboard'); toggleUserMenu();">
                                <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                                <span>My Dashboard</span>
                            </button>
                            <button class="user-dropdown-item" onclick="switchView('view-dashboard'); toggleUserMenu();">
                                <i data-lucide="history" class="w-4 h-4"></i>
                                <span>Reading History</span>
                                <span class="user-dropdown-badge" id="history-count-badge">0</span>
                            </button>
                            <button class="user-dropdown-item" onclick="switchView('view-dashboard'); toggleUserMenu();">
                                <i data-lucide="bookmark" class="w-4 h-4"></i>
                                <span>Stashed Articles</span>
                                <span class="user-dropdown-badge" id="stash-count-badge">0</span>
                            </button>
                            <button class="user-dropdown-item" onclick="toggleBookmarksSidebar(); toggleUserMenu();">
                                <i data-lucide="folder" class="w-4 h-4"></i>
                                <span>Pipelines</span>
                                <span class="user-dropdown-badge" id="pipelines-count-badge">0</span>
                            </button>
                            <div class="user-dropdown-divider"></div>
                            <button class="user-dropdown-item user-dropdown-signin" onclick="showSignInPrompt(); toggleUserMenu();">
                                <i data-lucide="log-in" class="w-4 h-4"></i>
                                <span>Sign In</span>
                                <span class="user-dropdown-hint">Sync across devices</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- VIEW 1: PORTAL (Three-Panel Command Center) -->
    <section id="view-portal" class="view-section active">
        <div class="three-panel-layout">

            <!-- LEFT PANEL: Fact Checks -->
            <aside id="panel-fact-checks" class="side-panel side-panel-left">
                <!-- Header (shown when expanded) -->
                <div class="panel-header">
                    <div class="panel-title">
                        <i data-lucide="scale"></i>
                        <span>Fact Checks</span>
                    </div>
                    <button class="panel-close-btn" onclick="togglePanel('fact-checks')" title="Collapse panel">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Content (shown when expanded) -->
                <div class="panel-content" id="fact-checks-list">
                    <!-- Dynamically populated with fact check cards -->
                    <div class="panel-empty" style="text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.8rem;">
                        <i data-lucide="scale" class="w-8 h-8 mx-auto mb-2" style="opacity: 0.3;"></i>
                        <p>No fact checks yet</p>
                        <p style="font-size: 0.7rem; margin-top: 0.5rem;">Enter a claim in the search box to fact check it</p>
                    </div>
                </div>

                <!-- Collapsed Strip (shown when collapsed) -->
                <div class="panel-collapsed-strip" onclick="togglePanel('fact-checks')">
                    <span class="collapsed-strip-text">Fact Checks</span>
                    <i data-lucide="chevron-right" class="collapsed-strip-icon w-4 h-4"></i>
                    <span class="collapsed-count-badge" id="fc-count-badge">0</span>
                </div>
            </aside>

            <!-- CENTER PANEL: Main Content -->
            <main class="center-panel">
                <!-- Landing State -->
                <div id="center-landing" class="center-landing">
                    <h1 class="center-landing-logo">
                        Genu<span>Verity</span>
                    </h1>
                    <p class="center-landing-tagline">Where curiosity meets evidence.</p>

                    <!-- Search Box -->
                    <div class="center-search-container">
                        <div id="generate-search-box">
                            <!-- Pasted content preview (hidden by default) -->
                            <div id="pasted-content-preview" class="pasted-content-preview" style="display: none;">
                                <img id="pasted-image-thumb" class="pasted-image-thumb" style="display: none;" alt="Pasted image">
                                <div class="pasted-content-info">
                                    <div id="pasted-content-type" class="pasted-content-type">
                                        <span class="extracting-spinner"></span>
                                        <span id="pasted-type-label">Extracting claim...</span>
                                    </div>
                                    <div id="pasted-content-text" class="pasted-content-text"></div>
                                    <div id="pasted-content-meta" class="pasted-content-meta"></div>
                                </div>
                                <button class="pasted-content-close" onclick="clearPastedContent()" title="Clear">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <textarea id="generate-input"
                                placeholder="Type a claim, question, or paste a tweet/YouTube link/meme screenshot..."
                                class="w-full px-4 py-3 rounded-xl border text-sm"
                                style="background: var(--bg-card); border-color: var(--border-color); color: var(--text-main);"
                                oninput="updateGenerateMode(this.value)"
                                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); triggerGenerate(); }"
                                rows="3"></textarea>
                            <div class="generate-controls">
                                <div class="mode-toggle">
                                    <button id="mode-fact-check" class="mode-toggle-btn active fact-check" onclick="setGenerateMode('fact_check')">
                                        <i data-lucide="scale"></i>
                                        Fact Check
                                    </button>
                                    <button id="mode-investigate" class="mode-toggle-btn investigate" onclick="setGenerateMode('investigate')">
                                        <i data-lucide="search"></i>
                                        Investigate
                                    </button>
                                </div>
                                <button id="generate-btn" onclick="triggerGenerate()" class="generate-btn fact-check-mode">
                                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                                    <span id="generate-btn-label">Fact Check</span>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs mt-2" style="color: var(--text-muted);">
                            <span style="opacity: 0.7;">Paste:</span>
                            <span style="color: #1d9bf0;">X/Twitter</span> â€¢
                            <span style="color: #ff0000;">YouTube</span> â€¢
                            <span style="color: #10b981;">Screenshots</span>
                            <span style="opacity: 0.5; margin-left: 8px;">|</span>
                            <span style="opacity: 0.7; margin-left: 8px;">Shift+Enter new line â€¢ Enter submit</span>
                        </p>
                    </div>
                </div>

                <!-- Article View (hidden initially, shown when article selected) -->
                <div id="center-article" class="center-article">
                    <!-- Article content will be injected here -->
                </div>
            </main>

            <!-- RIGHT PANEL: Investigations -->
            <aside id="panel-investigations" class="side-panel side-panel-right">
                <!-- Header (shown when expanded) -->
                <div class="panel-header">
                    <div class="panel-title">
                        <i data-lucide="search"></i>
                        <span>Investigations</span>
                    </div>
                    <button class="panel-close-btn" onclick="togglePanel('investigations')" title="Collapse panel">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Content (shown when expanded) -->
                <div class="panel-content" id="investigations-list">
                    <!-- Dynamically populated with investigation cards -->
                    <div class="panel-empty" style="text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.8rem;">
                        <i data-lucide="search" class="w-8 h-8 mx-auto mb-2" style="opacity: 0.3;"></i>
                        <p>No investigations yet</p>
                        <p style="font-size: 0.7rem; margin-top: 0.5rem;">Enter a topic to start investigating</p>
                    </div>
                </div>

                <!-- Collapsed Strip (shown when collapsed) -->
                <div class="panel-collapsed-strip" onclick="togglePanel('investigations')">
                    <span class="collapsed-strip-text">Investigations</span>
                    <i data-lucide="chevron-left" class="collapsed-strip-icon w-4 h-4"></i>
                    <span class="collapsed-count-badge" id="inv-count-badge">0</span>
                </div>
            </aside>
        </div>

        <!-- Mobile Tabs (hidden on desktop) -->
        <div class="mobile-tabs">
            <button class="mobile-tab fact-checks" onclick="showMobilePanel('fact-checks')">
                <i data-lucide="scale" class="w-5 h-5"></i>
                <span>Fact Checks</span>
            </button>
            <button class="mobile-tab active" onclick="showMobilePanel('home')">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span>Home</span>
            </button>
            <button class="mobile-tab" onclick="showMobilePanel('investigations')">
                <i data-lucide="search" class="w-5 h-5"></i>
                <span>Investigations</span>
            </button>
        </div>
    </section>

    <!-- VIEW 2: REPORT (Research Dashboard Three-Panel Layout) -->
    <section id="view-report" class="view-section">
        <div id="research-dashboard" class="research-dashboard">

            <!-- Mobile Panel Overlay -->
            <div id="mobile-panel-overlay" class="mobile-panel-overlay" onclick="closeMobilePanels()"></div>

            <!-- LEFT PANEL: Research Workspace -->
            <aside id="dashboard-panel-left" class="dashboard-panel dashboard-panel-left">
                <div class="dashboard-panel-header">
                    <div class="dashboard-panel-title">
                        <i data-lucide="folder-kanban"></i>
                        <span>Research</span>
                    </div>
                    <button class="dashboard-panel-close" onclick="toggleDashboardPanel('left')" title="Collapse panel">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="dashboard-panel-content">
                    <!-- Stash Section -->
                    <div class="dashboard-section" id="stash-section">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Stash (<span id="stash-count">0</span>)</span>
                            <button class="dashboard-section-toggle" onclick="toggleStashPersist()" id="stash-persist-btn" title="Keep stash after closing">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div id="stash-list">
                            <div class="dashboard-empty" style="text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.7rem;">
                                Press S to stash current article
                            </div>
                        </div>
                    </div>

                    <!-- Pipelines Section -->
                    <div class="dashboard-section" id="pipelines-section">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Pipelines</span>
                        </div>
                        <div id="pipelines-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Generating Section -->
                    <div class="dashboard-section" id="generating-section">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Generating (<span id="gen-count">0</span>/5)</span>
                        </div>
                        <div id="gen-list">
                            <!-- Populated dynamically from activeGenerations -->
                        </div>
                    </div>
                </div>

                <!-- Collapsed Strip -->
                <div class="dashboard-collapsed-strip" onclick="toggleDashboardPanel('left')">
                    <span class="dashboard-collapsed-text">Research</span>
                    <i data-lucide="chevron-right" class="w-4 h-4" style="color: var(--text-muted);"></i>
                    <span class="dashboard-collapsed-count" id="left-collapsed-count">0</span>
                </div>
            </aside>

            <!-- CENTER PANEL: Article Content -->
            <main class="dashboard-center">
                <div class="report-layout">
                    <!-- Main Article Content -->
                    <div class="report-main">
                        <!-- SOURCES FIRST BANNER - Dynamically populated -->
                        <!-- Sources drawer overlay (click to close) -->
                        <div id="sources-drawer-overlay" class="sources-drawer-overlay" onclick="toggleSourcesBanner()"></div>
                        <div id="sources-first-container"></div>

                        <div class="mb-12 border-b pb-8" style="border-color: var(--border-color);">
                            <div class="flex items-center justify-between mb-6">
                                <button onclick="switchView('view-portal')"
                                    class="text-xs font-bold hover:text-blue-700 flex items-center gap-2" style="color: var(--text-muted);">â† RETURN TO
                                    ARCHIVE</button>
                                <div class="flex items-center gap-2">
                                    <!-- Generation timestamp and refresh -->
                                    <div id="article-timestamp" class="article-timestamp hidden">
                                        <span class="timestamp-text"></span>
                                        <button onclick="regenerateArticle()" class="regenerate-btn" title="Regenerate article with fresh data">
                                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                    <button onclick="stashCurrentArticle()" class="action-btn" title="Stash Article (S)">
                                        <i data-lucide="archive" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Stash</span>
                                    </button>
                                    <button onclick="toggleFocusMode()" class="action-btn" title="Focus Mode (F)">
                                        <i data-lucide="maximize-2" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="enhanceArticle()" id="enhance-btn" class="action-btn enhance-btn" title="Enhance Article (E)">
                                        <span id="enhance-count-badge" class="enhance-count-badge">0</span>
                                        <i data-lucide="sparkles" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Enhance</span>
                                    </button>
                                    <button onclick="toggleArticleVersion()" id="version-toggle-btn" class="action-btn version-toggle-btn hidden" title="View original version">
                                        <i data-lucide="history" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Original</span>
                                    </button>
                                    <button onclick="toggleBookmark()" id="bookmark-btn" class="action-btn" title="Bookmark (B)">
                                        <i data-lucide="bookmark" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Save</span>
                                    </button>
                                    <button onclick="exportToMarkdown()" class="action-btn" title="Export Markdown (M)">
                                        <i data-lucide="file-text" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">MD</span>
                                    </button>
                                    <button onclick="exportToPDF()" class="action-btn" title="Export PDF (P)">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">PDF</span>
                                    </button>
                                </div>
                            </div>
                            <h1 id="report-title" class="text-5xl md:text-6xl font-bold leading-tight" style="color: var(--text-main);">Loading...</h1>
                        </div>
                        <div id="report-body" ondblclick="toggleFocusMode()"></div>
                    </div>

                    <!-- Hidden container for JS compatibility (sources now in tabbed banner above) -->
                    <div id="report-sources" style="display: none;"></div>

                    <!-- Child Essays Rail (shown when article has child essays) -->
                    <div id="child-essays-rail" class="child-essays-rail hidden"></div>
                </div>

                <!-- Focus Mode Footer -->
                <div class="focus-footer">
                    <button class="focus-footer-btn" onclick="toggleDashboardPanel('left')">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        Stash (<span id="focus-stash-count">0</span>)
                    </button>
                    <span class="focus-footer-hint">Press F or Esc to exit focus mode</span>
                    <button class="focus-footer-btn" onclick="toggleDashboardPanel('right')">
                        Related (<span id="focus-related-count">0</span>)
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </main>

            <!-- RIGHT PANEL: Discovery -->
            <aside id="dashboard-panel-right" class="dashboard-panel dashboard-panel-right">
                <div class="dashboard-panel-header">
                    <div class="dashboard-panel-title">
                        <i data-lucide="compass"></i>
                        <span>Discovery</span>
                    </div>
                    <button class="dashboard-panel-close" onclick="toggleDashboardPanel('right')" title="Collapse panel">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="dashboard-panel-content">
                    <!-- Quick Query Section -->
                    <div class="quick-query-section">
                        <div class="quick-query-form">
                            <textarea
                                id="quick-query-input"
                                class="quick-query-input"
                                placeholder="Research something while you read... e.g., 'Is 5G actually dangerous?'"
                                rows="2"
                                onkeydown="handleQuickQueryKeydown(event)"
                            ></textarea>
                            <div class="quick-query-actions">
                                <button class="quick-query-btn investigate" onclick="submitQuickQuery('investigate')" title="Queue investigation">
                                    <i data-lucide="search"></i>
                                    Investigate
                                </button>
                                <button class="quick-query-btn fact-check" onclick="submitQuickQuery('fact-check')" title="Queue fact check">
                                    <i data-lucide="scale"></i>
                                    Fact Check
                                </button>
                            </div>
                            <div class="quick-query-hint">Press Enter to investigate, Shift+Enter for fact check</div>
                        </div>
                    </div>

                    <!-- Related Content Section -->
                    <div class="dashboard-section" id="related-section">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Related</span>
                            <div class="discovery-mode-toggle">
                                <button class="discovery-mode-btn active" onclick="setDiscoveryMode('focus')" title="Same category">Focus</button>
                                <button class="discovery-mode-btn" onclick="setDiscoveryMode('explore')" title="Diverse">Explore</button>
                            </div>
                        </div>
                        <div id="related-list">
                            <div class="dashboard-empty" style="text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.7rem;">
                                Loading related content...
                            </div>
                        </div>
                    </div>

                    <!-- Recently Viewed Section -->
                    <div class="dashboard-section" id="recent-section">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Recently Viewed</span>
                        </div>
                        <div id="recent-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Queued Deep Dives Section -->
                    <div class="dashboard-section" id="queued-section">
                        <div class="dashboard-section-header">
                            <span class="dashboard-section-title">Queued Deep Dives</span>
                        </div>
                        <div id="queued-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Collapsed Strip -->
                <div class="dashboard-collapsed-strip" onclick="toggleDashboardPanel('right')">
                    <span class="dashboard-collapsed-text">Discovery</span>
                    <i data-lucide="chevron-left" class="w-4 h-4" style="color: var(--text-muted);"></i>
                    <span class="dashboard-collapsed-count" id="right-collapsed-count">0</span>
                </div>
            </aside>

        </div>

            <!-- Mobile Bottom Tabs (visible < 768px) -->
            <nav class="mobile-bottom-tabs" id="mobile-bottom-tabs">
                <div class="mobile-bottom-tabs-inner">
                    <button class="mobile-tab-btn research" onclick="toggleMobilePanel('left')" id="mobile-tab-research">
                        <i data-lucide="folder-kanban" class="w-5 h-5"></i>
                        <span>Research</span>
                        <span class="tab-badge" id="mobile-research-badge"></span>
                    </button>
                    <button class="mobile-tab-btn active" onclick="closeMobilePanels()" id="mobile-tab-article">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        <span>Article</span>
                    </button>
                    <button class="mobile-tab-btn" onclick="toggleMobilePanel('right')" id="mobile-tab-discovery">
                        <i data-lucide="compass" class="w-5 h-5"></i>
                        <span>Discovery</span>
                        <span class="tab-badge" id="mobile-discovery-badge"></span>
                    </button>
                </div>
            </nav>

    </section>

    <!-- VIEW 3: STATIC -->
    <section id="view-static" class="view-section">
        <div class="article-container px-6">
            <button onclick="switchView('view-portal')"
                class="text-xs font-bold text-gray-500 hover:text-white mb-6 flex items-center gap-2">â† RETURN</button>
            <h1 id="static-title" class="text-5xl font-bold text-white mb-8"></h1>
            <div id="static-content" class="prose-text"></div>
        </div>
    </section>

    <!-- VIEW 4: DASHBOARD (My Research) -->
    <section id="view-dashboard" class="view-section">
        <div class="dashboard-standalone">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <button onclick="switchView('view-portal')" class="dashboard-back-btn">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span>Back to Portal</span>
                </button>
                <h1 class="dashboard-title">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                    My Research Dashboard
                </h1>
                <div class="dashboard-user-info">
                    <span class="dashboard-session-type">Local Session</span>
                    <button onclick="showSignInPrompt()" class="dashboard-sync-btn">
                        <i data-lucide="cloud" class="w-4 h-4"></i>
                        <span>Sync</span>
                    </button>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Reading History Section -->
                <div class="dashboard-section-card">
                    <div class="dashboard-section-header">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        <h2>Reading History</h2>
                        <span class="dashboard-section-count" id="dash-history-count">0</span>
                    </div>
                    <div class="dashboard-section-content" id="dash-history-list">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Stashed Articles Section -->
                <div class="dashboard-section-card">
                    <div class="dashboard-section-header">
                        <i data-lucide="bookmark" class="w-5 h-5"></i>
                        <h2>Stashed Articles</h2>
                        <span class="dashboard-section-count" id="dash-stash-count">0</span>
                        <button onclick="toggleStashPersist()" class="stash-persist-toggle" id="dash-stash-persist" title="Keep stash after closing">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        </button>
                    </div>
                    <div class="dashboard-section-content" id="dash-stash-list">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Active Generations Section -->
                <div class="dashboard-section-card">
                    <div class="dashboard-section-header">
                        <i data-lucide="loader" class="w-5 h-5"></i>
                        <h2>In Progress</h2>
                        <span class="dashboard-section-count" id="dash-gen-count">0</span>
                    </div>
                    <div class="dashboard-section-content" id="dash-gen-list">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Pipelines Section -->
                <div class="dashboard-section-card dashboard-section-wide">
                    <div class="dashboard-section-header">
                        <i data-lucide="folder" class="w-5 h-5"></i>
                        <h2>Research Pipelines</h2>
                        <span class="dashboard-section-count" id="dash-pipeline-count">0</span>
                        <button onclick="createNewPipeline()" class="dashboard-add-btn">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="dashboard-section-content dashboard-pipelines-grid" id="dash-pipelines-list">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Stats Section -->
                <div class="dashboard-section-card">
                    <div class="dashboard-section-header">
                        <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                        <h2>Research Stats</h2>
                    </div>
                    <div class="dashboard-stats">
                        <div class="dashboard-stat">
                            <span class="dashboard-stat-value" id="dash-stat-articles">0</span>
                            <span class="dashboard-stat-label">Articles Read</span>
                        </div>
                        <div class="dashboard-stat">
                            <span class="dashboard-stat-value" id="dash-stat-deepdives">0</span>
                            <span class="dashboard-stat-label">Deep Dives</span>
                        </div>
                        <div class="dashboard-stat">
                            <span class="dashboard-stat-value" id="dash-stat-factchecks">0</span>
                            <span class="dashboard-stat-label">Fact Checks</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. THE CONTENT DATABASE ---
        const reports = {
            // Static articles have been migrated to Vercel Blob storage
            // All articles are now loaded dynamically via /api/cache/list and /api/article/{slug}
        };

        // --- ESSAY VALIDATION SYSTEM ---
        // Gold standard schema - required fields for complete essays
        const ESSAY_SCHEMA = {
            required: ['title', 'cardTitle', 'cardTag', 'cardTagColor', 'cardDescription', 'content', 'chartType', 'sources'],
            recommended: ['citationDatabase', 'contextData'],
            contentChecks: {
                minLength: 500,           // Minimum content length (chars)
                hasProseText: true,       // Must have .prose-text paragraphs
                hasProseH2: true,         // Must have .prose-h2 headings
                hasCitationSpades: true,  // Must have citation spades
                hasSources: 4             // Minimum number of sources
            }
        };

        // Validate a single essay against gold standard
        function validateEssay(key, essay) {
            const issues = { critical: [], warnings: [], info: [] };

            // Check if it's a dynamic placeholder (allowed to be incomplete)
            if (essay._isDynamic && !essay.content) {
                issues.info.push('Dynamic placeholder - will be generated on demand');
                return issues;
            }

            // Check required fields
            for (const field of ESSAY_SCHEMA.required) {
                if (!essay[field]) {
                    issues.critical.push(`Missing required field: ${field}`);
                }
            }

            // Check recommended fields
            for (const field of ESSAY_SCHEMA.recommended) {
                if (!essay[field]) {
                    issues.warnings.push(`Missing recommended field: ${field}`);
                }
            }

            // Content quality checks
            if (essay.content) {
                if (essay.content.length < ESSAY_SCHEMA.contentChecks.minLength) {
                    issues.warnings.push(`Content too short: ${essay.content.length} chars (min: ${ESSAY_SCHEMA.contentChecks.minLength})`);
                }
                if (!essay.content.includes('class="prose-text"')) {
                    issues.warnings.push('Missing .prose-text paragraphs');
                }
                if (!essay.content.includes('class="prose-h2"')) {
                    issues.warnings.push('Missing .prose-h2 section headings');
                }
                if (!essay.content.includes('citation-spade')) {
                    issues.critical.push('Missing citation spades - sources not linked to content');
                }
            }

            // Sources check
            if (essay.sources && essay.sources.length < ESSAY_SCHEMA.contentChecks.hasSources) {
                issues.warnings.push(`Insufficient sources: ${essay.sources.length} (min: ${ESSAY_SCHEMA.contentChecks.hasSources})`);
            }

            // Citation database consistency check
            if (essay.content && essay.citationDatabase) {
                const spadeMatches = essay.content.match(/data-id="([^"]+)"/g) || [];
                const spadeIds = spadeMatches.map(m => m.match(/data-id="([^"]+)"/)[1]);
                const dbIds = Object.keys(essay.citationDatabase);

                for (const id of spadeIds) {
                    if (!dbIds.includes(id)) {
                        issues.critical.push(`Citation spade '${id}' has no entry in citationDatabase`);
                    }
                }
            }

            return issues;
        }

        // Validate all essays and return summary
        function validateAllEssays() {
            const results = {};
            let totalCritical = 0;
            let totalWarnings = 0;

            for (const [key, essay] of Object.entries(reports)) {
                const issues = validateEssay(key, essay);
                results[key] = issues;
                totalCritical += issues.critical.length;
                totalWarnings += issues.warnings.length;
            }

            return { results, totalCritical, totalWarnings };
        }

        // Run validation on startup (development aid)
        (function runStartupAudit() {
            const { results, totalCritical, totalWarnings } = validateAllEssays();

            if (totalCritical > 0 || totalWarnings > 0) {
                console.group('%cðŸ“‹ GenuVerity Essay Audit', 'color: #f76b15; font-weight: bold; font-size: 14px;');
                console.log(`%cTotal: ${Object.keys(results).length} essays | ${totalCritical} critical issues | ${totalWarnings} warnings`,
                    totalCritical > 0 ? 'color: #c45c3e;' : 'color: #30a46c;');

                for (const [key, issues] of Object.entries(results)) {
                    if (issues.critical.length > 0 || issues.warnings.length > 0) {
                        console.group(`%c${key}`, issues.critical.length > 0 ? 'color: #c45c3e;' : 'color: #f76b15;');
                        issues.critical.forEach(i => console.error(`âŒ ${i}`));
                        issues.warnings.forEach(i => console.warn(`âš ï¸ ${i}`));
                        issues.info.forEach(i => console.info(`â„¹ï¸ ${i}`));
                        console.groupEnd();
                    }
                }
                console.groupEnd();
            } else {
                console.log('%câœ… GenuVerity Essay Audit: All essays pass validation', 'color: #30a46c; font-weight: bold;');
            }

            // Store results for programmatic access
            window.essayValidation = { results, totalCritical, totalWarnings };
        })();

        // --- 2. VIEW LOGIC ---
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);

            // Hide deep dive tooltip when switching views
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            // Hide navbar sources button and article title when leaving report view
            if (id !== 'view-report') {
                updateNavSourcesButton(false);
                // Hide navbar article title
                const navArticleTitle = document.getElementById('nav-article-title');
                if (navArticleTitle) navArticleTitle.classList.add('hidden');
            }

            // Refresh trending section when returning to portal (to show newly generated articles)
            if (id === 'view-portal') {
                renderTrendingSection();
                // Update URL to root when returning to portal
                if (typeof updateUrlForPortal === 'function') {
                    updateUrlForPortal();
                }
                // Reset center panel to landing state (hide article, show search)
                const centerLanding = document.getElementById('center-landing');
                const centerArticle = document.getElementById('center-article');
                if (centerLanding) centerLanding.style.display = 'flex';
                if (centerArticle) centerArticle.classList.remove('active');
            }

            // Render dashboard when switching to dashboard view
            if (id === 'view-dashboard') {
                renderStandaloneDashboard();
            }
        }

        // Toggle Sources drawer slide-down
        function toggleSourcesBanner() {
            const banner = document.getElementById('sources-banner');
            const navBtn = document.getElementById('nav-sources-btn');
            const overlay = document.getElementById('sources-drawer-overlay');

            if (!banner) return;

            const isOpen = banner.classList.contains('drawer-open');

            if (isOpen) {
                // Close drawer
                banner.classList.remove('drawer-open');
                if (overlay) overlay.classList.remove('active');
                if (navBtn) navBtn.classList.remove('expanded');
            } else {
                // Open drawer
                banner.classList.add('drawer-open');
                if (overlay) overlay.classList.add('active');
                if (navBtn) navBtn.classList.add('expanded');
            }
        }

        // ========== USER MENU & STANDALONE DASHBOARD ==========

        // Toggle user dropdown menu
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('open');
                if (dropdown.classList.contains('open')) {
                    updateUserMenuBadges();
                }
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.querySelector('.user-menu-container');
            const dropdown = document.getElementById('user-dropdown');
            if (container && dropdown && !container.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Update badge counts in user menu
        function updateUserMenuBadges() {
            // History count
            try {
                const history = JSON.parse(localStorage.getItem('genuverity-reading-history') || '[]');
                const historyBadge = document.getElementById('history-count-badge');
                if (historyBadge) historyBadge.textContent = history.length;
            } catch (e) {}

            // Stash count
            const stash = getSessionStash();
            const stashBadge = document.getElementById('stash-count-badge');
            if (stashBadge) stashBadge.textContent = stash.length;

            // Pipelines count
            try {
                const pipelines = JSON.parse(localStorage.getItem('genuverity-pipelines') || '{}');
                const pipelinesBadge = document.getElementById('pipelines-count-badge');
                if (pipelinesBadge) pipelinesBadge.textContent = Object.keys(pipelines).length;
            } catch (e) {}
        }

        // Show sign-in prompt (placeholder for OAuth)
        function showSignInPrompt() {
            showToast('Sign In Coming Soon', 'OAuth integration with Google/GitHub planned', 'info');
        }

        // Render standalone dashboard view
        function renderStandaloneDashboard() {
            // Reading History
            try {
                const history = JSON.parse(localStorage.getItem('genuverity-reading-history') || '[]');
                const historyList = document.getElementById('dash-history-list');
                const historyCount = document.getElementById('dash-history-count');

                if (historyCount) historyCount.textContent = history.length;

                if (historyList) {
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="dashboard-empty">No reading history yet</div>';
                    } else {
                        historyList.innerHTML = history.slice(0, 10).map(item => {
                            const timeAgo = formatTimeAgo(item.viewedAt);
                            return `
                                <div class="dashboard-item" onclick="loadReport('${item.key}')">
                                    <span class="dashboard-item-title">${item.title}</span>
                                    <span class="dashboard-item-meta">${timeAgo}</span>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {}

            // Stashed Articles
            const stash = getSessionStash();
            const stashList = document.getElementById('dash-stash-list');
            const stashCount = document.getElementById('dash-stash-count');

            if (stashCount) stashCount.textContent = stash.length;

            if (stashList) {
                if (stash.length === 0) {
                    stashList.innerHTML = '<div class="dashboard-empty">Press S while reading to stash articles</div>';
                } else {
                    stashList.innerHTML = stash.map(item => `
                        <div class="dashboard-item" onclick="loadReport('${item.key}')">
                            <span class="dashboard-item-title">${item.title}</span>
                            <button class="dashboard-item-remove" onclick="event.stopPropagation(); removeFromStash('${item.key}'); renderStandaloneDashboard();">Ã—</button>
                        </div>
                    `).join('');
                }
            }

            // Active Generations - use same styled cards as left panel
            const genCount = document.getElementById('dash-gen-count');
            const genList = document.getElementById('dash-gen-list');

            if (genCount) genCount.textContent = activeGenerations.size;

            if (genList) {
                if (activeGenerations.size === 0) {
                    genList.innerHTML = '<div class="dashboard-empty">No active research</div>';
                } else {
                    let genHtml = '';
                    activeGenerations.forEach((gen, id) => {
                        const isComplete = gen.percent === 100;
                        const isEnhance = gen.type === 'enhance';
                        const isFactCheck = gen.type === 'fact_check';
                        const isInvestigation = gen.type === 'report' || gen.type === 'investigation';

                        let typeInfo;
                        if (isEnhance) {
                            typeInfo = { icon: 'sparkles', label: 'Enhance', cssClass: 'enhance' };
                        } else if (isFactCheck) {
                            typeInfo = { icon: 'scale', label: 'Fact Check', cssClass: 'fact-check' };
                        } else if (isInvestigation) {
                            typeInfo = { icon: 'search', label: 'Investigation', cssClass: 'investigation' };
                        } else {
                            typeInfo = { icon: 'layers', label: 'Fractal', cssClass: 'fractal' };
                        }

                        let actionsHtml = '';
                        if (isEnhance) {
                            actionsHtml = isComplete ? `
                                <button class="panel-gen-btn primary enhance" onclick="applyEnhancement()">Apply</button>
                                <button class="panel-gen-btn secondary" onclick="dismissEnhancement(); removeGeneration('${id}')">Dismiss</button>
                            ` : '';
                        } else if (isComplete) {
                            actionsHtml = `
                                <button class="panel-gen-btn primary" onclick="viewCompletedGeneration('${id}')">View</button>
                                <button class="panel-gen-btn secondary" onclick="removeGeneration('${id}')">Dismiss</button>
                            `;
                        }

                        genHtml += `
                            <div class="panel-gen-card ${isComplete ? 'complete' : ''} ${isEnhance ? 'enhance' : ''}" id="dash-gen-${id}">
                                <div class="panel-gen-header">
                                    <span class="panel-gen-type ${typeInfo.cssClass}">
                                        <i data-lucide="${typeInfo.icon}" class="w-3 h-3"></i>
                                        ${typeInfo.label}
                                    </span>
                                    <span class="panel-gen-percent">${gen.percent}%</span>
                                </div>
                                <div class="panel-gen-title" title="${gen.fullTopic}">${gen.topic}</div>
                                <div class="panel-gen-progress">
                                    <div class="panel-gen-progress-bar" style="width: ${gen.percent}%"></div>
                                </div>
                                <div class="panel-gen-status">${gen.status}</div>
                                <div class="panel-gen-actions">${actionsHtml}</div>
                            </div>
                        `;
                    });
                    genList.innerHTML = genHtml;
                }
            }

            // Pipelines
            try {
                const pipelines = JSON.parse(localStorage.getItem('genuverity-pipelines') || '{}');
                const pipelinesList = document.getElementById('dash-pipelines-list');
                const pipelinesCount = document.getElementById('dash-pipeline-count');
                const pipelineKeys = Object.keys(pipelines);

                if (pipelinesCount) pipelinesCount.textContent = pipelineKeys.length;

                if (pipelinesList) {
                    if (pipelineKeys.length === 0) {
                        pipelinesList.innerHTML = '<div class="dashboard-empty">Create pipelines to organize your research</div>';
                    } else {
                        pipelinesList.innerHTML = pipelineKeys.map(name => {
                            const articles = pipelines[name] || [];
                            return `
                                <div class="dashboard-pipeline-card" onclick="toggleBookmarksSidebar()">
                                    <span class="dashboard-pipeline-name">${name}</span>
                                    <span class="dashboard-pipeline-count">${articles.length} article${articles.length !== 1 ? 's' : ''}</span>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (e) {}

            // Stats
            try {
                const history = JSON.parse(localStorage.getItem('genuverity-reading-history') || '[]');
                const statArticles = document.getElementById('dash-stat-articles');
                const statDeepDives = document.getElementById('dash-stat-deepdives');
                const statFactChecks = document.getElementById('dash-stat-factchecks');

                if (statArticles) statArticles.textContent = history.length;

                // Count deep dives and fact checks from history
                let deepDives = 0;
                let factChecks = 0;
                history.forEach(item => {
                    if (item.category && item.category.toLowerCase().includes('deep dive')) deepDives++;
                    if (item.category && item.category.toLowerCase().includes('fact check')) factChecks++;
                });

                if (statDeepDives) statDeepDives.textContent = deepDives;
                if (statFactChecks) statFactChecks.textContent = factChecks;
            } catch (e) {}

            // Re-init icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // ========== RESEARCH DASHBOARD FUNCTIONS ==========

        // Dashboard state management
        const dashboardState = {
            currentArticleKey: null,
            leftPanelCollapsed: false,
            rightPanelCollapsed: false,
            focusModeActive: false,
            stashPersist: false,
            discoveryMode: 'explore' // 'explore' or 'focus'
        };

        // Initialize dashboard from localStorage
        function initDashboardState() {
            const savedPrefs = localStorage.getItem('genuverity-dashboard-prefs');
            if (savedPrefs) {
                try {
                    const prefs = JSON.parse(savedPrefs);
                    dashboardState.leftPanelCollapsed = prefs.leftCollapsed || false;
                    dashboardState.rightPanelCollapsed = prefs.rightCollapsed || false;
                    dashboardState.stashPersist = prefs.stashPersist || false;
                    dashboardState.discoveryMode = prefs.discoveryMode || 'explore';
                } catch (e) {
                    console.warn('Could not load dashboard prefs', e);
                }
            }
            applyDashboardState();
        }

        // Apply dashboard state to DOM
        function applyDashboardState() {
            const dashboard = document.getElementById('research-dashboard');
            if (!dashboard) return;

            // Apply panel collapse states
            if (dashboardState.leftPanelCollapsed) {
                dashboard.classList.add('left-collapsed');
            } else {
                dashboard.classList.remove('left-collapsed');
            }

            if (dashboardState.rightPanelCollapsed) {
                dashboard.classList.add('right-collapsed');
            } else {
                dashboard.classList.remove('right-collapsed');
            }

            // Update stash persist toggle
            const stashToggle = document.getElementById('stash-persist-btn');
            if (stashToggle) {
                stashToggle.classList.toggle('active', dashboardState.stashPersist);
            }

            // Update discovery mode toggle buttons
            const focusBtn = document.querySelector('.discovery-mode-btn[onclick*="focus"]');
            const exploreBtn = document.querySelector('.discovery-mode-btn[onclick*="explore"]');
            if (focusBtn && exploreBtn) {
                focusBtn.classList.toggle('active', dashboardState.discoveryMode === 'focus');
                exploreBtn.classList.toggle('active', dashboardState.discoveryMode === 'explore');
            }
        }

        // Save dashboard preferences
        function saveDashboardPrefs() {
            localStorage.setItem('genuverity-dashboard-prefs', JSON.stringify({
                leftCollapsed: dashboardState.leftPanelCollapsed,
                rightCollapsed: dashboardState.rightPanelCollapsed,
                stashPersist: dashboardState.stashPersist,
                discoveryMode: dashboardState.discoveryMode
            }));
        }

        // Toggle dashboard panel (left/right)
        function toggleDashboardPanel(side) {
            const dashboard = document.getElementById('research-dashboard');
            if (!dashboard) return;

            if (side === 'left') {
                dashboardState.leftPanelCollapsed = !dashboardState.leftPanelCollapsed;
                dashboard.classList.toggle('left-collapsed', dashboardState.leftPanelCollapsed);
            } else if (side === 'right') {
                dashboardState.rightPanelCollapsed = !dashboardState.rightPanelCollapsed;
                dashboard.classList.toggle('right-collapsed', dashboardState.rightPanelCollapsed);
            }

            // Update both-collapsed state
            if (dashboardState.leftPanelCollapsed && dashboardState.rightPanelCollapsed) {
                dashboard.classList.add('both-collapsed');
            } else {
                dashboard.classList.remove('both-collapsed');
            }

            saveDashboardPrefs();
        }

        // Toggle focus mode (hide both panels)
        function toggleFocusMode() {
            const dashboard = document.getElementById('research-dashboard');
            if (!dashboard) return;

            dashboardState.focusModeActive = !dashboardState.focusModeActive;
            dashboard.classList.toggle('focus-mode', dashboardState.focusModeActive);

            // Show toast notification
            if (dashboardState.focusModeActive) {
                showToast('Focus mode enabled', 'Press Esc or F to exit', 'info');
            }
        }

        // Mobile panel state
        let activeMobilePanel = null;

        // Toggle mobile panel (for bottom tab navigation on mobile)
        function toggleMobilePanel(side) {
            const leftPanel = document.getElementById('dashboard-panel-left');
            const rightPanel = document.getElementById('dashboard-panel-right');
            const overlay = document.getElementById('mobile-panel-overlay');

            // Update tab button states
            const tabResearch = document.getElementById('mobile-tab-research');
            const tabArticle = document.getElementById('mobile-tab-article');
            const tabDiscovery = document.getElementById('mobile-tab-discovery');

            // If tapping the same panel that's open, close it
            if (activeMobilePanel === side) {
                closeMobilePanels();
                return;
            }

            // Close any open panel first
            leftPanel?.classList.remove('mobile-visible');
            rightPanel?.classList.remove('mobile-visible');

            // Open the requested panel
            if (side === 'left') {
                leftPanel?.classList.add('mobile-visible');
                activeMobilePanel = 'left';
                tabResearch?.classList.add('active');
                tabArticle?.classList.remove('active');
                tabDiscovery?.classList.remove('active');
            } else if (side === 'right') {
                rightPanel?.classList.add('mobile-visible');
                activeMobilePanel = 'right';
                tabResearch?.classList.remove('active');
                tabArticle?.classList.remove('active');
                tabDiscovery?.classList.add('active');
            }

            // Show overlay
            overlay?.classList.add('active');
        }

        // Close all mobile panels
        function closeMobilePanels() {
            const leftPanel = document.getElementById('dashboard-panel-left');
            const rightPanel = document.getElementById('dashboard-panel-right');
            const overlay = document.getElementById('mobile-panel-overlay');

            leftPanel?.classList.remove('mobile-visible');
            rightPanel?.classList.remove('mobile-visible');
            overlay?.classList.remove('active');
            activeMobilePanel = null;

            // Reset tab button states (Article is default active)
            const tabResearch = document.getElementById('mobile-tab-research');
            const tabArticle = document.getElementById('mobile-tab-article');
            const tabDiscovery = document.getElementById('mobile-tab-discovery');
            tabResearch?.classList.remove('active');
            tabArticle?.classList.add('active');
            tabDiscovery?.classList.remove('active');
        }

        // Update mobile tab badges
        function updateMobileTabBadges() {
            const stash = getSessionStash();
            const genCount = activeGenerations.size;
            const related = dashboardState.relatedArticles?.length || 0;

            // Research tab badge (stash + active generations)
            const researchBadge = document.getElementById('mobile-research-badge');
            const researchCount = stash.length + genCount;
            if (researchBadge) {
                researchBadge.textContent = researchCount > 0 ? researchCount : '';
            }

            // Discovery tab badge (related articles)
            const discoveryBadge = document.getElementById('mobile-discovery-badge');
            if (discoveryBadge) {
                discoveryBadge.textContent = related > 0 ? related : '';
            }
        }

        // Toggle stash persistence
        function toggleStashPersist() {
            dashboardState.stashPersist = !dashboardState.stashPersist;
            const toggle = document.getElementById('stash-persist-btn');
            if (toggle) {
                toggle.classList.toggle('active', dashboardState.stashPersist);
            }
            saveDashboardPrefs();

            // If turning on persistence, migrate session stash to localStorage
            if (dashboardState.stashPersist) {
                const sessionStash = getSessionStash();
                if (sessionStash.length > 0) {
                    localStorage.setItem('genuverity-stash', JSON.stringify(sessionStash));
                }
            }
            showToast(dashboardState.stashPersist ? 'Stash will persist' : 'Stash resets on close', '', 'info');
        }

        // Get stash items from appropriate storage
        function getSessionStash() {
            const storage = dashboardState.stashPersist ? localStorage : sessionStorage;
            const key = dashboardState.stashPersist ? 'genuverity-stash' : 'genuverity-session-stash';
            try {
                return JSON.parse(storage.getItem(key) || '[]');
            } catch (e) {
                return [];
            }
        }

        // Save stash items to appropriate storage
        function saveSessionStash(items) {
            const storage = dashboardState.stashPersist ? localStorage : sessionStorage;
            const key = dashboardState.stashPersist ? 'genuverity-stash' : 'genuverity-session-stash';
            storage.setItem(key, JSON.stringify(items));
        }

        // Stash the current article
        function stashCurrentArticle() {
            if (!dashboardState.currentArticleKey) {
                showToast('No article to stash', '', 'warning');
                return;
            }

            const key = dashboardState.currentArticleKey;
            const article = reports[key];

            // Get title from DOM if article not in reports (dynamically loaded articles)
            let title = key;
            if (article) {
                title = article.cardTitle || article.title || key;
            } else {
                // Try to get title from the DOM
                const titleEl = document.getElementById('report-title');
                if (titleEl && titleEl.textContent) {
                    title = titleEl.textContent;
                }
            }

            const stash = getSessionStash();

            // Check if already stashed
            if (stash.find(item => item.key === key)) {
                showToast('Already in stash', '', 'info');
                return;
            }

            // Add to stash (max 5 items, LIFO)
            stash.unshift({
                key: key,
                title: title,
                stashedAt: Date.now(),
                stashedFrom: null
            });

            // Limit to 5 items
            if (stash.length > 5) {
                stash.pop();
            }

            saveSessionStash(stash);
            renderStash();
            updateStashCounts();
            showToast('Article stashed', 'Press [ to view', 'success');
        }

        // Update all stash count displays
        function updateStashCounts() {
            const stash = getSessionStash();
            const count = stash.length;

            // Left panel stash count
            const stashCount = document.getElementById('stash-count');
            if (stashCount) stashCount.textContent = count;

            // Focus footer stash count
            const focusStashCount = document.getElementById('focus-stash-count');
            if (focusStashCount) focusStashCount.textContent = count;

            // Left collapsed count
            const leftCollapsedCount = document.getElementById('left-collapsed-count');
            if (leftCollapsedCount) leftCollapsedCount.textContent = count;

            // Update mobile tab badges
            updateMobileTabBadges();
        }

        // Remove item from stash
        function removeFromStash(key) {
            const stash = getSessionStash().filter(item => item.key !== key);
            saveSessionStash(stash);
            renderStash();
            updateStashCounts();
        }

        // Render stash panel
        function renderStash() {
            const container = document.getElementById('stash-list');
            if (!container) return;

            const stash = getSessionStash();

            // Update count badge
            const countEl = document.getElementById('stash-count');
            if (countEl) {
                countEl.textContent = stash.length;
            }

            // Update focus footer count
            const focusStashCount = document.querySelector('.focus-footer-btn[onclick*="left"] span');
            if (focusStashCount) {
                focusStashCount.textContent = `Stash: ${stash.length}`;
            }

            if (stash.length === 0) {
                container.innerHTML = '<div class="stash-empty">Press S to stash articles</div>';
                return;
            }

            container.innerHTML = stash.map((item, idx) => `
                <div class="stash-card" data-key="${item.key}">
                    <span class="stash-number">${idx + 1}</span>
                    <span class="stash-title" onclick="loadReport('${item.key}')">${item.title}</span>
                    <button class="stash-remove" onclick="removeFromStash('${item.key}')" title="Remove">Ã—</button>
                </div>
            `).join('');
        }

        // Jump to stash item by index
        function jumpToStashItem(index) {
            const stash = getSessionStash();
            if (index >= 0 && index < stash.length) {
                loadReport(stash[index].key);
            }
        }

        // Set discovery mode (explore vs focus)
        function setDiscoveryMode(mode) {
            dashboardState.discoveryMode = mode;
            // Update button active states
            const focusBtn = document.querySelector('.discovery-mode-btn[onclick*="focus"]');
            const exploreBtn = document.querySelector('.discovery-mode-btn[onclick*="explore"]');
            if (focusBtn && exploreBtn) {
                focusBtn.classList.toggle('active', mode === 'focus');
                exploreBtn.classList.toggle('active', mode === 'explore');
            }
            saveDashboardPrefs();
            renderRelatedContent();
        }

        // Toggle discovery mode
        function toggleDiscoveryMode() {
            const newMode = dashboardState.discoveryMode === 'explore' ? 'focus' : 'explore';
            setDiscoveryMode(newMode);
            showToast(newMode === 'focus' ? 'Deep Focus' : 'Explore mode', '', 'info');
        }

        // === QUICK QUERY FUNCTIONS ===
        // Handle keyboard shortcuts in quick query input
        function handleQuickQueryKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                submitQuickQuery('investigate');
            } else if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                submitQuickQuery('fact-check');
            }
        }

        // Submit quick query to queue
        function submitQuickQuery(type) {
            const input = document.getElementById('quick-query-input');
            if (!input) return;

            const query = input.value.trim();
            if (!query) {
                showToast('Enter a topic or claim', '', 'warning');
                input.focus();
                return;
            }

            // Check concurrent generation limits
            // NOTE: Payment packages will affect concurrent query limits
            // Free tier: 1 concurrent, Basic: 3 concurrent, Pro: 5 concurrent, Enterprise: unlimited
            const activeCount = generations.filter(g => g.status === 'generating').length;
            const MAX_CONCURRENT = 5; // Will be dynamic based on user tier when payment is implemented

            if (activeCount >= MAX_CONCURRENT) {
                showToast(`Maximum ${MAX_CONCURRENT} concurrent queries`, 'Please wait for current generations to complete', 'warning');
                return;
            }

            // Queue the generation based on type
            if (type === 'fact-check') {
                // Use fact check generation
                const genId = registerGeneration(query, 'fact-check');
                showToast('Queued for fact check', query.substring(0, 40) + '...', 'success');
                generateFactCheck(query, genId);
            } else {
                // Use investigation generation
                const genId = registerGeneration(query, 'investigation');
                showToast('Queued for investigation', query.substring(0, 40) + '...', 'success');
                startGeneration(query, genId);
            }

            // Clear input and show feedback
            input.value = '';
            input.blur();

            // Update the Research Status badge
            updateResearchStatusBadge();
        }

        // Render related content in discovery panel
        function renderRelatedContent() {
            const container = document.getElementById('related-list');
            if (!container || !dashboardState.currentArticleKey) {
                if (container) container.innerHTML = '<div class="stash-empty">View an article to see related content</div>';
                return;
            }

            const currentArticle = reports[dashboardState.currentArticleKey];
            if (!currentArticle) return;

            // Get all articles and score them
            const scored = [];
            for (const [key, article] of Object.entries(reports)) {
                if (key === dashboardState.currentArticleKey) continue;
                if (article.isChildEssay) continue; // Skip child essays

                let score = 0;

                // Tag matching (40 points)
                if (currentArticle.cardTag && article.cardTag) {
                    const currentTags = currentArticle.cardTag.split('//').map(t => t.trim().toLowerCase());
                    const articleTags = article.cardTag.split('//').map(t => t.trim().toLowerCase());

                    // Main category match
                    if (currentTags[0] && articleTags[0] && currentTags[0] === articleTags[0]) {
                        score += 25;
                    }
                    // Subcategory match (only in focus mode)
                    if (dashboardState.discoveryMode === 'focus' && currentTags[1] && articleTags[1] && currentTags[1] === articleTags[1]) {
                        score += 15;
                    }
                }

                // In explore mode, add diversity bonus for different categories
                if (dashboardState.discoveryMode === 'explore') {
                    const currentCategory = (currentArticle.cardTag || '').split('//')[0].trim().toLowerCase();
                    const articleCategory = (article.cardTag || '').split('//')[0].trim().toLowerCase();
                    if (currentCategory !== articleCategory) {
                        score += 10; // Diversity bonus
                    }
                }

                // Recency bonus (10 points if recent)
                if (article._cached_at) {
                    const cachedDate = new Date(article._cached_at);
                    const daysSinceCached = (Date.now() - cachedDate.getTime()) / (1000 * 60 * 60 * 24);
                    if (daysSinceCached < 7) {
                        score += 10;
                    }
                }

                // Add some randomness for variety
                score += Math.random() * 5;

                if (score > 0) {
                    scored.push({ key, article, score });
                }
            }

            // Sort by score and take top 5
            scored.sort((a, b) => b.score - a.score);
            const related = scored.slice(0, 5);

            if (related.length === 0) {
                container.innerHTML = '<div class="stash-empty">No related content found</div>';
                return;
            }

            container.innerHTML = related.map(({ key, article }) => {
                const typeClass = article.articleType === 'fact-check' ? 'fact-check' :
                                  article.isChildEssay ? 'deep-dive' : 'investigation';
                return `
                    <div class="related-card ${typeClass}" onclick="loadReport('${key}')">
                        <span class="related-type">${typeClass.replace('-', ' ')}</span>
                        <span class="related-title">${article.cardTitle || article.title || key}</span>
                        <button class="stash-btn" onclick="event.stopPropagation(); stashFromDiscovery('${key}')" title="Stash">â—€</button>
                    </div>
                `;
            }).join('');
        }

        // Stash article from discovery panel
        function stashFromDiscovery(key) {
            const article = reports[key];
            if (!article) return;

            const stash = getSessionStash();

            // Check if already stashed
            if (stash.find(item => item.key === key)) {
                showToast('Already in stash', '', 'info');
                return;
            }

            stash.unshift({
                key: key,
                title: article.cardTitle || article.title || key,
                stashedAt: Date.now(),
                stashedFrom: dashboardState.currentArticleKey
            });

            if (stash.length > 5) {
                stash.pop();
            }

            saveSessionStash(stash);
            renderStash();
            showToast('Added to stash', '', 'success');
        }

        // Render recently viewed
        function renderRecentlyViewed() {
            const container = document.getElementById('recent-list');
            if (!container) return;

            let history = [];
            try {
                history = JSON.parse(localStorage.getItem('genuverity-reading-history') || '[]');
            } catch (e) {
                history = [];
            }

            // Filter out current article and limit to 3
            const recent = history
                .filter(item => item.key !== dashboardState.currentArticleKey)
                .slice(0, 3);

            if (recent.length === 0) {
                container.innerHTML = '<div class="stash-empty">No recent articles</div>';
                return;
            }

            container.innerHTML = recent.map(item => {
                const timeAgo = formatTimeAgo(item.viewedAt);
                return `
                    <div class="recent-card" onclick="loadReport('${item.key}')">
                        <span class="recent-title">${item.title}</span>
                        <span class="recent-time">${timeAgo}</span>
                    </div>
                `;
            }).join('');
        }

        // Format time ago helper
        function formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Track article view in history
        function trackArticleView(key, article) {
            let history = [];
            try {
                history = JSON.parse(localStorage.getItem('genuverity-reading-history') || '[]');
            } catch (e) {
                history = [];
            }

            // Remove existing entry for this article
            history = history.filter(item => item.key !== key);

            // Add to front
            history.unshift({
                key: key,
                title: article.cardTitle || article.title || key,
                viewedAt: Date.now(),
                category: article.cardTag || ''
            });

            // Limit to 50 entries
            if (history.length > 50) {
                history = history.slice(0, 50);
            }

            localStorage.setItem('genuverity-reading-history', JSON.stringify(history));
        }

        // Initialize dashboard when viewing an article
        function initDashboard(articleKey) {
            dashboardState.currentArticleKey = articleKey;
            initDashboardState();
            renderStash();
            renderRelatedContent();
            renderRecentlyViewed();

            // Track the view
            const article = reports[articleKey];
            if (article) {
                trackArticleView(articleKey, article);
            }
        }

        // ========== END RESEARCH DASHBOARD FUNCTIONS ==========

        // Close drawer with Escape key and Dashboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }

            if (e.key === 'Escape') {
                // Exit focus mode first
                const dashboard = document.getElementById('research-dashboard');
                if (dashboard && dashboard.classList.contains('focus-mode')) {
                    toggleFocusMode();
                    return;
                }
                // Close sources drawer
                const banner = document.getElementById('sources-banner');
                if (banner && banner.classList.contains('drawer-open')) {
                    toggleSourcesBanner();
                }
            }

            // Global shortcut: U for user dashboard (works on any view)
            if (e.key === 'u' || e.key === 'U') {
                e.preventDefault();
                switchView('view-dashboard');
                return;
            }

            // Dashboard shortcuts only when viewing an article
            const viewReport = document.getElementById('view-report');
            if (!viewReport || !viewReport.classList.contains('active')) return;

            if (e.key === 'f' || e.key === 'F') {
                e.preventDefault();
                toggleFocusMode();
            } else if (e.key === 's' || e.key === 'S') {
                e.preventDefault();
                stashCurrentArticle();
            } else if (e.key === '[') {
                e.preventDefault();
                toggleDashboardPanel('left');
            } else if (e.key === ']') {
                e.preventDefault();
                toggleDashboardPanel('right');
            } else if (e.key >= '1' && e.key <= '5') {
                // Quick jump to stash items
                const stashIndex = parseInt(e.key) - 1;
                jumpToStashItem(stashIndex);
            }
        });

        // Show/hide navbar sources button based on view
        function updateNavSourcesButton(show, count = 0) {
            const navBtn = document.getElementById('nav-sources-btn');
            const countEl = document.getElementById('nav-sources-count');
            if (navBtn) {
                if (show) {
                    navBtn.classList.add('visible');
                    if (countEl) countEl.textContent = count;
                } else {
                    navBtn.classList.remove('visible');
                    navBtn.classList.remove('expanded');
                }
            }
        }

        // Initialize sources content height on load
        function initSourcesContent() {
            const content = document.getElementById('sources-content');
            if (content) {
                content.style.maxHeight = 'none';
            }
        }

        function loadReport(key) {
            const data = reports[key];

            // Reset enhance count when loading a new article
            resetEnhanceCount();

            // Update URL for shareable link
            updateUrlForArticle(key);

            // If report not in local database, try fetching from cache
            if (!data) {
                loadCachedReport(key);
                return;
            }

            // If report is marked as dynamic (cached on server), fetch from cache
            if (data._isDynamic && !data.content) {
                loadCachedReport(key);
                return;
            }

            // Validate essay before rendering (graceful degradation)
            const validation = validateEssay(key, data);
            if (validation.critical.length > 0) {
                console.warn(`Essay '${key}' has ${validation.critical.length} critical validation issues:`, validation.critical);
                // Show warning banner for development but still render what we have
                if (data.content) {
                    console.warn('Rendering essay with validation warnings - some features may not work correctly');
                }
            }

            renderReportData(data);
        }

        // Load a cached report from the server (uses fast slug endpoint)
        async function loadCachedReport(key) {
            try {
                // Show loading state
                switchView('view-report');
                document.getElementById('report-title').innerText = 'Loading...';
                document.getElementById('report-body').innerHTML = '<p class="prose-text">Retrieving article...</p>';

                // Use the fast slug endpoint
                const response = await fetch(`/api/article/${encodeURIComponent(key)}`);

                if (response.ok) {
                    const article = await response.json();
                    renderReportData(article, true);
                } else {
                    document.getElementById('report-title').innerText = 'Article Not Found';
                    document.getElementById('report-body').innerHTML = '<p class="prose-text">This article could not be found in the archive.</p>';
                }
            } catch (e) {
                console.error('Failed to load cached report:', e);
                document.getElementById('report-title').innerText = 'Error Loading Article';
                document.getElementById('report-body').innerHTML = '<p class="prose-text">Failed to retrieve the article. Please try again.</p>';
            }
        }

        // Common function to render report data
        function renderReportData(data, isDynamic = false) {
            // Hide any visible deep dive tooltip when loading new content
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            // Activate cooldown to prevent tooltip from immediately reappearing
            // This handles the case where mouse is already over a deep-dive button in new content
            tooltipCooldownActive = true;
            setTimeout(() => {
                tooltipCooldownActive = false;
            }, 500); // 500ms cooldown before tooltips can appear again

            switchView('view-report');
            document.getElementById('report-title').innerText = data.title;

            // For fact checks, restructure content into tabs
            if (data.articleType === 'fact_check' || data.verdict) {
                document.getElementById('report-body').innerHTML = restructureFactCheckContent(data);
            } else {
                document.getElementById('report-body').innerHTML = data.content;
            }

            // Update timestamp display
            updateArticleTimestamp(data);

            // Detect dynamic articles by checking for chartConfigs or chartType='dynamic'
            const hasDynamicCharts = data.chartConfigs && Object.keys(data.chartConfigs).length > 0;
            const isActuallyDynamic = isDynamic || hasDynamicCharts || data.chartType === 'dynamic';

            // Store dynamic citation database for hover/click handlers
            if (isActuallyDynamic && data.citationDatabase) {
                window.dynamicCitationDatabase = data.citationDatabase;
            }

            // Sort sources by score (highest first)
            const allSources = (data.sources || []).sort((a, b) => (b.score || 0) - (a.score || 0));

            // Split into tabs of 4 sources each
            const tabNames = ['Primary', 'Secondary', 'Tertiary', 'Quaternary'];
            const tabCTAs = [
                'These are the most credible sources for this topic',
                'Supporting evidence from trusted outlets',
                'Additional context and perspectives',
                'Extended research materials'
            ];
            const sourceGroups = [];
            for (let i = 0; i < allSources.length; i += 4) {
                sourceGroups.push(allSources.slice(i, i + 4));
            }

            // === SOURCES FIRST BANNER - TABBED VERSION ===
            const sourcesFirstContainer = document.getElementById('sources-first-container');
            if (allSources.length > 0) {
                // Build tab buttons
                const tabsHTML = sourceGroups.map((group, idx) => {
                    const tabName = tabNames[idx] || `Set ${idx + 1}`;
                    return `
                        <button class="sources-tab ${idx === 0 ? 'active' : ''}" data-tab="${idx}">
                            ${tabName}<span class="tab-count">${group.length}</span>
                        </button>
                    `;
                }).join('');

                // Build tab panels
                const panelsHTML = sourceGroups.map((group, groupIdx) => {
                    const cardsHTML = group.map((s, idx) => {
                        const scoreClass = s.score >= 90 ? 'high' : s.score >= 70 ? 'medium' : 'low';
                        const domain = s.url ? new URL(s.url).hostname.replace('www.', '') : 'Source';
                        const globalRank = groupIdx * 4 + idx + 1;
                        return `
                            <div class="top-source-card" ${s.url ? `onclick="window.open('${s.url}', '_blank')"` : ''}>
                                <div class="top-source-rank">#${globalRank}</div>
                                <div class="top-source-domain">${domain}</div>
                                <div class="top-source-title">${s.name}</div>
                                <div class="top-source-score">
                                    <div class="top-source-score-bar">
                                        <div class="top-source-score-fill ${scoreClass}" style="width: ${s.score}%"></div>
                                    </div>
                                    <span class="top-source-score-value">${s.score}%</span>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const ctaText = tabCTAs[groupIdx] || 'Explore these sources';

                    return `
                        <div class="sources-tab-panel ${groupIdx === 0 ? 'active' : ''}" data-panel="${groupIdx}">
                            <div class="sources-first-grid">${cardsHTML}</div>
                            <div class="tab-cta">
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                                <span>${ctaText}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                sourcesFirstContainer.innerHTML = `
                    <div class="sources-first-banner" id="sources-banner">
                        <div class="sources-first-content" id="sources-content">
                            <div class="sources-first-inner">
                                <div class="sources-first-header">
                                    <div class="sources-first-title-group">
                                        <div class="sources-first-title">
                                            <i data-lucide="shield-check" class="w-5 h-5 shield-icon"></i>
                                            <h3>Sources First</h3>
                                        </div>
                                    </div>
                                </div>
                                <p class="sources-first-byline">We encourage you to verify with primary sources before reading AI analysis.</p>
                                <div class="sources-tabs">${tabsHTML}</div>
                                <div class="sources-tab-panels">${panelsHTML}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Show navbar sources button with count
                updateNavSourcesButton(true, allSources.length);

                // Add tab switching functionality
                setTimeout(() => {
                    document.querySelectorAll('.sources-tab').forEach(tab => {
                        tab.addEventListener('click', function() {
                            const tabIdx = this.dataset.tab;
                            switchToSourcesTab(tabIdx);
                        });
                    });

                    // Add trackpad/touch swipe gesture support
                    initSourcesSwipeGestures();
                }, 50);
            } else {
                sourcesFirstContainer.innerHTML = '';
            }

            // Sidebar now shows summary only (sources are in tabs above)
            const sourceContainer = document.getElementById('report-sources');
            if (allSources.length > 0) {
                sourceContainer.innerHTML = `
                    <p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic; text-align: center; padding: 1rem;">
                        <i data-lucide="info" class="w-4 h-4" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>
                        All ${allSources.length} sources are displayed in the Sources First panel above.
                    </p>
                `;
            } else {
                sourceContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">No sources available.</p>';
            }

            // === CHILD ESSAYS RAIL ===
            const childEssaysRail = document.getElementById('child-essays-rail');
            if (data.childEssays && data.childEssays.length > 0) {
                // Build child essays indicators
                const childEssaysHTML = data.childEssays.map((childKey, idx) => {
                    const childData = reports[childKey];
                    if (!childData) return '';
                    return `
                        <div class="child-essay-dot" onclick="loadReport('${childKey}')" title="${childData.cardTitle || childData.title}">
                            <div class="dot-indicator"></div>
                            <div class="dot-label">${childData.cardTitle || 'Fractal ' + (idx + 1)}</div>
                        </div>
                    `;
                }).join('');

                childEssaysRail.innerHTML = `
                    <div class="rail-header">
                        <i data-lucide="git-branch" class="w-4 h-4"></i>
                        <span>Fractal Analysis</span>
                    </div>
                    <div class="rail-dots">
                        ${childEssaysHTML}
                    </div>
                `;
                childEssaysRail.classList.remove('hidden');
            } else {
                childEssaysRail.classList.add('hidden');
                childEssaysRail.innerHTML = '';
            }

            // Re-init icons for the new elements
            lucide.createIcons();

            // Critical: Wait for DOM to fully render, then initialize charts
            // Use multiple requestAnimationFrame calls to ensure paint completes
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        // For dynamic articles with chartConfigs, render them
                        if (isActuallyDynamic && data.chartConfigs) {
                            console.log('[Charts] Rendering dynamic charts for article, chartConfigs:', Object.keys(data.chartConfigs));
                            const chartsRendered = renderDynamicCharts(data.chartConfigs);

                            // If charts didn't render (canvases not found), retry after longer delay
                            if (!chartsRendered) {
                                console.log('[Charts] First attempt failed, retrying in 300ms...');
                                setTimeout(() => {
                                    renderDynamicCharts(data.chartConfigs);
                                }, 300);
                            }
                        } else if (data.chartType && data.chartType !== 'dynamic') {
                            // For pre-defined articles with specific chart types
                            renderCharts(data.chartType);
                        }
                        initLivingNumbers(); // Re-run observer for new elements
                        initLightboxHandlers(); // Initialize lightbox for infographics
                        initDeepDiveTooltips(); // Add hover tooltips to deep dive buttons
                        initHoverQueuePills(); // Add hover queue pills to fractal triggers
                    }, 150);
                });
            });
        }

        // Initialize deep dive hover tooltips with a single global tooltip
        let deepDiveTooltipEl = null;
        let tooltipCooldownActive = false; // Prevents tooltip from appearing immediately after content load

        function initDeepDiveTooltips() {
            // Create global tooltip element if it doesn't exist
            if (!deepDiveTooltipEl) {
                deepDiveTooltipEl = document.createElement('div');
                deepDiveTooltipEl.className = 'deep-dive-tooltip';
                deepDiveTooltipEl.innerHTML = `
                    <div class="tooltip-context"></div>
                    <div class="tooltip-action">
                        <span class="tooltip-rabbit">ðŸ‡</span>
                        <span>Go Down the Rabbit Hole</span>
                    </div>
                    <div class="tooltip-cost" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 0.75rem;"></div>
                `;
                document.body.appendChild(deepDiveTooltipEl);

                // Hide tooltip on mouseleave from buttons
                document.body.addEventListener('mouseover', (e) => {
                    // If mouse is not over a fig-deep-dive button and not over the tooltip itself, hide it
                    if (!e.target.closest('.fig-deep-dive') && !e.target.closest('.deep-dive-tooltip')) {
                        deepDiveTooltipEl.classList.remove('visible');
                    }
                });

                // Also hide on scroll and click anywhere
                document.addEventListener('scroll', () => {
                    deepDiveTooltipEl.classList.remove('visible');
                }, true);

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.fig-deep-dive')) {
                        deepDiveTooltipEl.classList.remove('visible');
                    }
                });
            }

            // Add hover listeners to all deep dive buttons
            document.querySelectorAll('.fig-deep-dive').forEach(element => {
                // Skip if already initialized
                if (element.dataset.tooltipInit) return;
                element.dataset.tooltipInit = 'true';

                element.addEventListener('mouseenter', (e) => {
                    // Skip if cooldown is active (prevents tooltip from appearing right after content load)
                    if (tooltipCooldownActive) return;

                    // Get context from parent figure caption
                    const figCaption = element.closest('.fig-caption');
                    const figureTitle = figCaption ? figCaption.textContent.replace('FRACTAL', '').replace('DEEP DIVE', '').trim().replace(/^Fig\s*\d+\.\s*/i, '') : 'this topic';

                    // Update tooltip content
                    const contextEl = deepDiveTooltipEl.querySelector('.tooltip-context');
                    const costEl = deepDiveTooltipEl.querySelector('.tooltip-cost');

                    contextEl.innerHTML = `Explore the data behind <strong>${figureTitle}</strong> with an AI-generated deep analysis.`;

                    // Show free/cost indicator
                    const isFree = userRemainingDives > 0;
                    if (isFree) {
                        costEl.innerHTML = `<span style="color: #10b981;">âœ“ FREE</span> <span style="color: var(--text-muted);">(${userRemainingDives} remaining today)</span>`;
                    } else {
                        costEl.innerHTML = `<span style="color: #f59e0b;">âš ï¸ Uses token</span>`;
                    }

                    // Position tooltip above the button
                    const rect = element.getBoundingClientRect();
                    let x = rect.left + (rect.width / 2) - 140; // Center tooltip (280px / 2)
                    let y = rect.top - 10;

                    // Boundary checks
                    if (x < 10) x = 10;
                    if (x + 280 > window.innerWidth - 10) x = window.innerWidth - 290;

                    deepDiveTooltipEl.style.left = x + 'px';
                    deepDiveTooltipEl.style.bottom = (window.innerHeight - y) + 'px';
                    deepDiveTooltipEl.style.top = 'auto';
                    deepDiveTooltipEl.classList.add('visible');
                });
            });
        }

        // --- 3. CHART RENDERER (Safe Mode) ---
        let activeCharts = [];

        function getChartTextColor() {
            const theme = document.documentElement.getAttribute('data-theme') || 'midnight';
            // Light themes need dark text
            const lightThemes = ['light', 'sand', 'mint'];
            return lightThemes.includes(theme) ? '#1e293b' : '#e8edf5';
        }

        function getThemeChartColors() {
            const theme = document.documentElement.getAttribute('data-theme') || 'midnight';
            const colorSchemes = {
                midnight: {
                    primary: '#000096', secondary: '#4a9d7c', tertiary: '#e57373',
                    quaternary: '#9575cd', muted: '#546e7a', accent: '#d4a574',
                    palette: ['#000096', '#4a9d7c', '#e57373', '#9575cd', '#546e7a', '#d4a574']
                },
                ocean: {
                    primary: '#3d8bd4', secondary: '#2dd4bf', tertiary: '#f472b6',
                    quaternary: '#60a5fa', muted: '#7ca0c4', accent: '#fbbf24',
                    palette: ['#3d8bd4', '#2dd4bf', '#f472b6', '#60a5fa', '#7ca0c4', '#fbbf24']
                },
                forest: {
                    primary: '#10b981', secondary: '#34d399', tertiary: '#fbbf24',
                    quaternary: '#4ade80', muted: '#7cb09a', accent: '#84cc16',
                    palette: ['#10b981', '#34d399', '#fbbf24', '#4ade80', '#7cb09a', '#84cc16']
                },
                ember: {
                    primary: '#f97316', secondary: '#ef4444', tertiary: '#fbbf24',
                    quaternary: '#fb923c', muted: '#c49080', accent: '#84cc16',
                    palette: ['#f97316', '#ef4444', '#fbbf24', '#fb923c', '#c49080', '#84cc16']
                },
                teal: {
                    primary: '#14b8a6', secondary: '#2dd4bf', tertiary: '#22d3ee',
                    quaternary: '#06b6d4', muted: '#5eead4', accent: '#fbbf24',
                    palette: ['#14b8a6', '#2dd4bf', '#22d3ee', '#06b6d4', '#5eead4', '#fbbf24']
                },
                slate: {
                    primary: '#64748b', secondary: '#6ee7b7', tertiary: '#fcd34d',
                    quaternary: '#94a3b8', muted: '#8b8f96', accent: '#f472b6',
                    palette: ['#64748b', '#6ee7b7', '#fcd34d', '#94a3b8', '#8b8f96', '#f472b6']
                },
                espresso: {
                    primary: '#c9a227', secondary: '#7c9a5e', tertiary: '#c45c3e',
                    quaternary: '#8b6750', muted: '#5a4a3a', accent: '#d4a574',
                    palette: ['#c9a227', '#7c9a5e', '#c45c3e', '#8b6750', '#5a4a3a', '#d4a574']
                },
                rose: {
                    primary: '#ec4899', secondary: '#f472b6', tertiary: '#34d399',
                    quaternary: '#fbbf24', muted: '#c4809a', accent: '#06b6d4',
                    palette: ['#ec4899', '#f472b6', '#34d399', '#fbbf24', '#c4809a', '#06b6d4']
                },
                cyan: {
                    primary: '#14b8a6', secondary: '#2dd4bf', tertiary: '#fbbf24',
                    quaternary: '#22d3ee', muted: '#70c4b8', accent: '#f59e0b',
                    palette: ['#14b8a6', '#2dd4bf', '#fbbf24', '#22d3ee', '#70c4b8', '#f59e0b']
                },
                light: {
                    primary: '#3b82f6', secondary: '#22c55e', tertiary: '#ef4444',
                    quaternary: '#06b6d4', muted: '#64748b', accent: '#f59e0b',
                    palette: ['#3b82f6', '#22c55e', '#ef4444', '#06b6d4', '#64748b', '#f59e0b']
                },
                sand: {
                    primary: '#b8860b', secondary: '#6b8e23', tertiary: '#cd853f',
                    quaternary: '#daa520', muted: '#7a6f5c', accent: '#8b4513',
                    palette: ['#b8860b', '#6b8e23', '#cd853f', '#daa520', '#7a6f5c', '#8b4513']
                },
                mint: {
                    primary: '#16a34a', secondary: '#22c55e', tertiary: '#eab308',
                    quaternary: '#4ade80', muted: '#4d7c5f', accent: '#0ea5e9',
                    palette: ['#16a34a', '#22c55e', '#eab308', '#4ade80', '#4d7c5f', '#0ea5e9']
                },
                kristie: {
                    primary: '#1e3a5f', secondary: '#a8e6cf', tertiary: '#ffd3b6',
                    quaternary: '#2c4a7c', muted: '#b8b8b8', accent: '#152840',
                    palette: ['#1e3a5f', '#a8e6cf', '#ffd3b6', '#2c4a7c', '#b8b8b8', '#152840']
                },
                aurora: {
                    primary: '#88c0d0', secondary: '#a3be8c', tertiary: '#ebcb8b',
                    quaternary: '#81a1c1', muted: '#5e81ac', accent: '#bf616a',
                    palette: ['#88c0d0', '#a3be8c', '#ebcb8b', '#81a1c1', '#5e81ac', '#bf616a']
                },
                cherry: {
                    primary: '#dc5050', secondary: '#50dc80', tertiary: '#dcb050',
                    quaternary: '#dc50a0', muted: '#d09090', accent: '#50dcdc',
                    palette: ['#dc5050', '#50dc80', '#dcb050', '#dc50a0', '#d09090', '#50dcdc']
                },
                cobalt: {
                    primary: '#0096ff', secondary: '#00ff96', tertiary: '#ffcc00',
                    quaternary: '#00b4ff', muted: '#80b3e0', accent: '#ff6b00',
                    palette: ['#0096ff', '#00ff96', '#ffcc00', '#00b4ff', '#80b3e0', '#ff6b00']
                }
            };
            return colorSchemes[theme] || colorSchemes.midnight;
        }

        // Gemini 3 Pro infographic mappings for pre-generated images
        const geminiInfographics = {
            'ai': {
                'chart_capex': '/infographics/ai_bubble_chart_capex.png',
                'chart_allocation': '/infographics/ai_bubble_chart_allocation.png',
                'chart_energy_demand': '/infographics/ai_bubble_chart_energy_demand.png',
                'plotlyForceChart': '/infographics/ai_bubble_chart_bubbles.png'
            },
            'congress': {
                'chart_returns': '/infographics/congress_trading_chart_returns.png',
                'chart_sectors': '/infographics/congress_trading_chart_sectors.png',
                'chart_violations': '/infographics/congress_trading_chart_violations.png'
            },
            'grift': {
                'chart_spending': '/infographics/campaign_grift_chart_spending.png',
                'chart_zombies': '/infographics/campaign_grift_chart_zombies.png',
                'chart_family_pay': '/infographics/campaign_grift_chart_family_pay.png'
            },
            'energy': {
                'chart_energy': '/infographics/energy_crisis_chart_energy.png',
                'chart_transformers': '/infographics/energy_crisis_chart_transformers.png'
            },
            'regulatory': {
                'chart_revolving': '/infographics/regulatory_capture_chart_revolving.png',
                'chart_fines': '/infographics/regulatory_capture_chart_fines.png'
            },
            'semiconductor': {
                'chart_tsmc_share': '/infographics/semiconductor_crisis_chart_tsmc_share.png',
                'chart_intel_decline': '/infographics/semiconductor_crisis_chart_intel_decline.png',
                'chart_nvidia_mcap': '/infographics/semiconductor_crisis_chart_nvidia_mcap.png',
                'chart_packaging': '/infographics/semiconductor_crisis_chart_packaging.png'
            }
        };

        // Helper function to render Gemini infographic image
        function renderGeminiInfographic(elementId, imagePath) {
            const container = document.getElementById(elementId);
            if (!container) return false;

            // Replace canvas with img if canvas exists
            const parent = container.parentElement;
            if (container.tagName === 'CANVAS' || container.tagName === 'DIV') {
                const img = document.createElement('img');
                img.src = imagePath;
                img.alt = elementId;
                img.className = 'gemini-infographic';
                img.style.cssText = 'width: 100%; height: auto; border-radius: 8px;';
                img.loading = 'eager'; // Load immediately, not lazily
                parent.innerHTML = '';
                parent.appendChild(img);
                return true;
            }
            return false;
        }

        function renderCharts(type) {
            // Check if Gemini infographics are already rendered - NEVER overwrite them
            const existingGeminiImages = document.querySelectorAll('.gemini-infographic');
            if (existingGeminiImages.length > 0) {
                console.log(`[Charts] Found ${existingGeminiImages.length} existing Gemini infographics - preserving them`);
                // Only destroy Chart.js instances, not Gemini images
                activeCharts.forEach(c => c.destroy());
                activeCharts = [];
                return; // Don't re-render anything
            }

            // Cleanup old charts
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            // Check if we have Gemini infographics for this type
            const infographics = geminiInfographics[type];
            if (infographics) {
                // Use Gemini-generated infographics instead of Chart.js
                console.log(`Using Gemini infographics for type: ${type}`);
                for (const [chartId, imagePath] of Object.entries(infographics)) {
                    renderGeminiInfographic(chartId, imagePath);
                }
                return; // Skip Chart.js rendering
            }

            // For dynamic type, check if we have dynamic Gemini infographics cached
            if (type === 'dynamic' && window.dynamicGeminiInfographics) {
                const dynamicKeys = Object.keys(window.dynamicGeminiInfographics);
                if (dynamicKeys.length > 0) {
                    console.log(`Using dynamic Gemini infographics for: ${dynamicKeys}`);
                    for (const [chartId, dataUrl] of Object.entries(window.dynamicGeminiInfographics)) {
                        renderGeminiInfographicFromData(chartId, dataUrl);
                    }
                    return; // Skip Chart.js rendering
                }
            }

            const chartTextColor = getChartTextColor();
            const colors = getThemeChartColors();
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true, ticks: { color: chartTextColor } }, y: { display: true, ticks: { color: chartTextColor } } } };

            if (type === 'ai') {
                const ctx1 = document.getElementById('chart_capex');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar', // Changed to Bar for better comparison
                        data: {
                            labels: ['Capex Spend', 'Revenue Gap'],
                            datasets: [
                                {
                                    label: 'Billions USD',
                                    data: [1000, 600],
                                    backgroundColor: [colors.tertiary, colors.primary],
                                    barPercentage: 0.5
                                }
                            ]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                title: { display: true, text: 'The Imbalance (2024)', color: chartTextColor }
                            }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_allocation');
                if (ctx2) {
                    // Changing from Doughnut to Line Chart showing Value Decay
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6'],
                            datasets: [
                                {
                                    label: 'Traditional Server Value',
                                    data: [100, 85, 70, 55, 40, 25],
                                    borderColor: colors.secondary,
                                    borderWidth: 2,
                                    tension: 0.4
                                },
                                {
                                    label: 'AI GPU Value',
                                    data: [100, 60, 30, 10, 0, 0],
                                    borderColor: colors.tertiary,
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                title: { display: true, text: 'Depreciation Curves', color: chartTextColor }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: '% Original Value' } }
                            }
                        }
                    }));
                }
                // Fig 3: Energy Demand Chart
                const ctx3 = document.getElementById('chart_energy_demand');
                if (ctx3) {
                    activeCharts.push(new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['2022', '2024', '2026 (Projected)'],
                            datasets: [{
                                label: 'Data Center Energy (TWh)',
                                data: [460, 650, 1000],
                                backgroundColor: [colors.secondary, colors.primary, colors.tertiary],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                title: { display: true, text: 'Global Data Center Energy Demand', color: chartTextColor }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'TWh' }, ticks: { color: chartTextColor } },
                                x: { ticks: { color: chartTextColor } }
                            }
                        }
                    }));
                }
                const plotDiv = document.getElementById('plotlyForceChart');
                if (plotDiv) {
                    Plotly.newPlot(plotDiv, [{ x: [1, 2, 3], y: [50, 80, 120], text: ['Railroad', 'Dot-Com', 'AI'], mode: 'markers+text', marker: { size: [40, 70, 110], color: [colors.muted, colors.primary, colors.tertiary], opacity: 0.9 }, textposition: 'bottom center', textfont: { color: chartTextColor, size: 14 }, type: 'scatter', hoverinfo: 'none' }], { paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', xaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [0.5, 3.5] }, yaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [20, 150] }, margin: { l: 0, r: 0, b: 20, t: 0 }, hovermode: false }, { displayModeBar: false });
                }
            } else if (type === 'congress') {
                const ctx1 = document.getElementById('chart_returns');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['House Dems', 'Republicans', 'S&P 500'],
                            datasets: [{
                                label: '2024 Returns (%)',
                                data: [31, 26, 25],
                                backgroundColor: [colors.primary, colors.tertiary, colors.secondary],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Alpha Gap (2024)', color: chartTextColor } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_sectors');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['Technology', 'Financials', 'Energy', 'Healthcare', 'Other'],
                            datasets: [{
                                data: [40, 20, 15, 15, 10], // Representative weighting based on NANC/KRUZ
                                backgroundColor: ['#c9a227', '#7c9a5e', '#c45c3e', '#8b6750', '#5a4a3a'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            cutout: '70%',
                            plugins: { title: { display: true, text: 'Portfolio Composition Bias', color: chartTextColor } }
                        }
                    }));
                }
                // Fig 3: STOCK Act Violations (2021-2024)
                const ctx3 = document.getElementById('chart_violations');
                if (ctx3) {
                    activeCharts.push(new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['2021', '2022', '2023', '2024'],
                            datasets: [{
                                label: 'Late Disclosures',
                                data: [54, 72, 89, 78], // Based on BusinessInsider tracking
                                backgroundColor: colors.tertiary,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'STOCK Act Violations by Year', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'grift') {
                const ctx1 = document.getElementById('chart_spending');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'pie',
                        data: {
                            labels: ['Political Contributions', 'Lifestyle/Travel', 'Consulting/Admin'],
                            datasets: [{
                                data: [45, 35, 20], // Based on Issue One ~45% stat
                                backgroundColor: ['#7c9a5e', '#c45c3e', '#d4a574'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Leadership PAC Spending', color: chartTextColor } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_zombies');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: ['Sen. Shelby', 'R. Blumenauer', 'P. McHenry'],
                            datasets: [{
                                label: 'Cash on Hand (Millions)',
                                data: [16, 5, 4], // Representative zombie hoards
                                backgroundColor: ['#8b6750', '#5a4a3a', '#5a4a3a'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Top Zombie Accounts (2024)', color: chartTextColor } }
                        }
                    }));
                }
                // Fig 3: Family Payments from Campaign Funds
                const ctx4 = document.getElementById('chart_family_pay');
                if (ctx4) {
                    activeCharts.push(new Chart(ctx4, {
                        type: 'bar',
                        data: {
                            labels: ['Comer (wife)', 'Jordan (wife)', 'Greene (husband)', 'Boebert (ex)', 'Gaetz (sister)'],
                            datasets: [{
                                label: 'Payments ($K)',
                                data: [160, 125, 180, 85, 95], // FEC filing data
                                backgroundColor: ['#c45c3e', '#c9a227', '#7c9a5e', '#d4a574', '#8b6750'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            indexAxis: 'y',
                            plugins: { title: { display: true, text: 'Top Family Payments (FEC Data)', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'regulatory') {
                const ctx1 = document.getElementById('chart_revolving');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['2001-2010 (POGO Study)'],
                            datasets: [{
                                label: 'Former Officials Lobbying SEC',
                                data: [419],
                                backgroundColor: ['#c45c3e'],
                                barThickness: 50
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Revolving Door Scale', color: chartTextColor } },
                            scales: { y: { beginAtZero: true } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_fines');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: ['Revenue (2023)', 'EU Antitrust Fine'],
                            datasets: [{
                                label: 'Amount ($ Billions)',
                                data: [307, 2.7],
                                backgroundColor: ['#7c9a5e', '#c45c3e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            indexAxis: 'y',
                            plugins: { title: { display: true, text: 'Google: Fine vs Revenue', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'energy') {
                const ctx1 = document.getElementById('chart_energy');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['2022 (Actual)', '2026 (IEA Forecast)'],
                            datasets: [{
                                label: 'Global Data Center Demand (TWh)',
                                data: [460, 800],
                                backgroundColor: ['#5a4a3a', '#c45c3e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Doubling of Demand', color: chartTextColor } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_transformers');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['2021', '2022', '2023', '2024'],
                            datasets: [{
                                label: 'Lead Time (Weeks)',
                                data: [50, 80, 100, 120], // Wood Mackenzie trend
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Transformer Supply Chain Crisis', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'model') {
                const ctx1 = document.getElementById('chart_data_wall');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ['2022', '2024', '2026', '2028'],
                            datasets: [
                                {
                                    label: 'Human Data Stock',
                                    data: [100, 100, 95, 90], // Relatively flat
                                    borderColor: '#7c9a5e',
                                    borderDash: [5, 5]
                                },
                                {
                                    label: 'AI Consumption',
                                    data: [10, 40, 100, 250], // Exponential
                                    borderColor: '#c45c3e',
                                    fill: true,
                                    backgroundColor: 'rgba(196, 92, 62, 0.1)'
                                }
                            ]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Data Wall (Intersection 2026)', color: chartTextColor } },
                            scales: { y: { display: false } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_collapse');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Gen 1 (Human)', 'Gen 2', 'Gen 3', 'Gen 4', 'Gen 5 (Collapse)'],
                            datasets: [{
                                label: 'Model Quality/Perplexity',
                                data: [100, 85, 60, 30, 5],
                                borderColor: '#8b6750',
                                backgroundColor: 'rgba(139, 103, 80, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Recursive Quality Decay', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'semiconductor') {
                // Chart 1: Global Foundry Market Share
                const ctx1 = document.getElementById('chart_tsmc_share');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['TSMC', 'Samsung', 'GlobalFoundries', 'UMC', 'SMIC', 'Others'],
                            datasets: [{
                                data: [64, 11, 6, 6, 6, 7],
                                backgroundColor: ['#c9a227', '#c45c3e', '#7c9a5e', '#d4a574', '#8b6750', '#5a4a3a'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            cutout: '60%',
                            plugins: { title: { display: true, text: 'Foundry Market Share 2024', color: chartTextColor } }
                        }
                    }));
                }
                // Fig 2: Intel Market Cap Decline
                const ctxIntel = document.getElementById('chart_intel_decline');
                if (ctxIntel) {
                    activeCharts.push(new Chart(ctxIntel, {
                        type: 'line',
                        data: {
                            labels: ['Jan 20', 'Jan 21', 'Jan 22', 'Jan 23', 'Jan 24', 'Dec 24'],
                            datasets: [{
                                label: 'Market Cap ($B)',
                                data: [260, 220, 190, 140, 100, 85], // Intel market cap decline
                                borderColor: '#c45c3e',
                                backgroundColor: 'rgba(196, 92, 62, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Intel Market Cap Collapse', color: chartTextColor } },
                            scales: { y: { beginAtZero: false } }
                        }
                    }));
                }
                // Chart 2: Nvidia Market Cap Growth
                const ctx2 = document.getElementById('chart_nvidia_mcap');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Jan 23', 'Jun 23', 'Jan 24', 'Jun 24', 'Dec 24'],
                            datasets: [{
                                label: 'Market Cap ($T)',
                                data: [0.4, 1.0, 1.5, 3.0, 4.5],
                                borderColor: '#7c9a5e',
                                backgroundColor: 'rgba(124, 154, 94, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Nvidia: The $4T Rocket', color: chartTextColor } },
                            scales: { y: { beginAtZero: true } }
                        }
                    }));
                }
                // Chart 3: Advanced Packaging Capacity
                const ctx3 = document.getElementById('chart_packaging');
                if (ctx3) {
                    activeCharts.push(new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['2024', '2025', '2026'],
                            datasets: [{
                                label: 'CoWoS Wafers/Month (K)',
                                data: [35, 70, 90],
                                backgroundColor: ['#5a4a3a', '#c9a227', '#7c9a5e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'TSMC Packaging Capacity Ramp', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'plastic') {
                // Chart 1: BPA Detection Rates
                const ctxBpa = document.getElementById('chart_bpa_levels');
                if (ctxBpa) {
                    activeCharts.push(new Chart(ctxBpa, {
                        type: 'bar',
                        data: {
                            labels: ['Adults', 'Children', 'Infants (bottle-fed)', 'Receipt Workers'],
                            datasets: [{
                                label: 'BPA Detection Rate (%)',
                                data: [93, 96, 99, 100],
                                backgroundColor: ['#30a46c', '#3e63dd', '#f76b15', '#c45c3e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'BPA Detection in U.S. Population', color: chartTextColor } },
                            scales: { y: { beginAtZero: true, max: 100 } }
                        }
                    }));
                }
                // Chart 2: Microplastic Ingestion by Source
                const ctxMicro = document.getElementById('chart_microplastic');
                if (ctxMicro) {
                    activeCharts.push(new Chart(ctxMicro, {
                        type: 'doughnut',
                        data: {
                            labels: ['Bottled Water', 'Tap Water', 'Shellfish', 'Salt', 'Air (Inhaled)'],
                            datasets: [{
                                data: [90000, 4000, 11000, 2000, 69000],
                                backgroundColor: ['#3e63dd', '#30a46c', '#f76b15', '#c9a227', '#9ba1a6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            cutout: '60%',
                            plugins: { title: { display: true, text: 'Annual Particle Ingestion by Source', color: chartTextColor } }
                        }
                    }));
                }
                // Chart 3: Health Effects Odds Ratios
                const ctxHealth = document.getElementById('chart_health_effects');
                if (ctxHealth) {
                    activeCharts.push(new Chart(ctxHealth, {
                        type: 'bar',
                        data: {
                            labels: ['Obesity', 'Diabetes', 'Heart Disease', 'Infertility', 'ADHD'],
                            datasets: [{
                                label: 'Increased Risk (Odds Ratio)',
                                data: [1.33, 1.68, 1.39, 1.55, 1.90],
                                backgroundColor: ['#f76b15', '#c45c3e', '#c9a227', '#3e63dd', '#30a46c'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'BPA-Linked Health Conditions (Odds Ratio vs Baseline 1.0)', color: chartTextColor } },
                            scales: { y: { beginAtZero: true } }
                        }
                    }));
                }
                // Chart 4: BPA vs Alternatives Estrogenic Activity
                const ctxAlt = document.getElementById('chart_alternatives');
                if (ctxAlt) {
                    activeCharts.push(new Chart(ctxAlt, {
                        type: 'bar',
                        data: {
                            labels: ['BPA', 'BPS', 'BPF', 'BPAF', 'Tritan'],
                            datasets: [{
                                label: 'Relative Estrogenic Activity',
                                data: [1.0, 0.95, 1.1, 2.3, 0.7],
                                backgroundColor: ['#c45c3e', '#f76b15', '#c9a227', '#3e63dd', '#30a46c'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Estrogenic Activity: BPA vs "BPA-Free" Alternatives', color: chartTextColor } },
                            scales: { y: { beginAtZero: true } }
                        }
                    }));
                }
            }
        }

        // Store for dynamically-generated Gemini infographics (chart_id -> image data URL)
        let dynamicGeminiInfographics = {};

        // Fetch Gemini-generated infographics for chart configs
        async function fetchGeminiInfographics(chartConfigs, articleTitle) {
            if (!chartConfigs || Object.keys(chartConfigs).length === 0) {
                return {};
            }

            console.log('[Infographics] Fetching Gemini infographics for:', Object.keys(chartConfigs));

            try {
                const response = await fetch('/api/infographics/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chart_configs: chartConfigs,
                        article_title: articleTitle || 'Article'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log(`[Infographics] Generated ${result.generated}/${result.total} infographics`);
                    return result.infographics || {};
                } else {
                    console.log('[Infographics] API error:', response.status);
                    return {};
                }
            } catch (e) {
                console.log('[Infographics] Fetch error:', e);
                return {};
            }
        }

        // Replace canvas with Gemini-generated infographic image
        function renderInfographic(chartId, imageData, canvas) {
            if (!imageData || !canvas) return false;

            // Create container for the infographic
            const container = canvas.parentElement;
            if (!container) return false;

            // Create image element
            const img = document.createElement('img');
            img.src = imageData;
            img.alt = `Infographic: ${chartId}`;
            img.className = 'gemini-infographic';
            img.style.cssText = 'width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);';

            // Hide canvas and insert image
            canvas.style.display = 'none';
            container.insertBefore(img, canvas);

            console.log('[Infographics] Rendered infographic for:', chartId);
            return true;
        }

        // Store dynamically generated Gemini infographics (base64 data URLs)
        window.dynamicGeminiInfographics = window.dynamicGeminiInfographics || {};

        // Show placeholder while infographic generates
        function showInfographicPlaceholder(chartId, chartTitle) {
            const canvas = document.getElementById(chartId);
            if (!canvas) {
                // Try finding in report body
                const reportBody = document.getElementById('report-body');
                if (!reportBody) return null;
                const canvases = reportBody.querySelectorAll('canvas');
                for (const c of canvases) {
                    if (c.id === chartId && !c.dataset.placeholderShown) {
                        c.dataset.placeholderShown = 'true';
                        return createPlaceholderElement(c, chartTitle);
                    }
                }
                return null;
            }
            return createPlaceholderElement(canvas, chartTitle);
        }

        function createPlaceholderElement(canvas, chartTitle) {
            const parent = canvas.parentElement;
            const placeholder = document.createElement('div');
            placeholder.className = 'infographic-placeholder';
            placeholder.dataset.chartId = canvas.id;
            placeholder.innerHTML = `
                <div class="placeholder-icon"></div>
                <div class="placeholder-text">Generating Infographic</div>
                <div class="placeholder-title">${chartTitle || 'Data Visualization'}</div>
            `;
            canvas.style.display = 'none';
            parent.insertBefore(placeholder, canvas);
            return placeholder;
        }

        // Replace placeholder with actual infographic
        function replacePlaceholderWithImage(chartId, imageDataUrl) {
            const placeholder = document.querySelector(`.infographic-placeholder[data-chart-id="${chartId}"]`);
            if (placeholder) {
                const parent = placeholder.parentElement;
                const img = document.createElement('img');
                img.src = imageDataUrl;
                img.alt = chartId;
                img.className = 'gemini-infographic';
                img.style.cssText = 'width: 100%; height: auto; border-radius: 8px; opacity: 0; transition: opacity 0.3s ease;';
                img.onload = () => { img.style.opacity = '1'; };
                parent.replaceChild(img, placeholder);
                // Remove hidden canvas
                const canvas = parent.querySelector('canvas');
                if (canvas) canvas.remove();
                console.log('[Infographics] Replaced placeholder with image for:', chartId);
                return true;
            }
            return false;
        }

        // Fallback to Chart.js if Gemini generation fails
        function renderChartJsFallback(chartConfigs, chartIds) {
            console.log('[Charts] Rendering Chart.js fallback for:', chartIds);
            const chartTextColor = getChartTextColor();
            const themeColors = getThemeChartColors();
            const defaultColors = themeColors.palette.concat([themeColors.accent, themeColors.muted]);

            for (const chartId of chartIds) {
                const config = chartConfigs[chartId];
                if (!config) continue;

                // Remove placeholder and restore canvas
                const placeholder = document.querySelector(`.infographic-placeholder[data-chart-id="${chartId}"]`);
                if (placeholder) {
                    const parent = placeholder.parentElement;
                    let canvas = parent.querySelector('canvas');
                    if (canvas) {
                        canvas.style.display = '';
                    } else {
                        canvas = document.createElement('canvas');
                        canvas.id = chartId;
                    }
                    placeholder.remove();
                    if (!parent.contains(canvas)) {
                        parent.appendChild(canvas);
                    }

                    // Render Chart.js
                    const ctx = canvas.getContext('2d');
                    const chartType = config.type || 'bar';
                    const data = config.data || {};
                    const colors = data.colors || defaultColors.slice(0, data.values?.length || 5);

                    try {
                        new Chart(ctx, {
                            type: chartType === 'pie' ? 'pie' : (chartType === 'line' ? 'line' : 'bar'),
                            data: {
                                labels: data.labels || [],
                                datasets: [{
                                    data: data.values || [],
                                    backgroundColor: colors,
                                    borderColor: chartType === 'line' ? colors[0] : colors.map(c => c + '80'),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { labels: { color: chartTextColor } },
                                    title: {
                                        display: !!config.title,
                                        text: config.title,
                                        color: chartTextColor
                                    }
                                },
                                scales: chartType !== 'pie' ? {
                                    x: { ticks: { color: chartTextColor } },
                                    y: { ticks: { color: chartTextColor } }
                                } : undefined
                            }
                        });
                        console.log('[Charts] Rendered Chart.js fallback for:', chartId);
                    } catch (e) {
                        console.error('[Charts] Failed to render fallback chart:', chartId, e);
                    }
                }
            }
        }

        // Generate Gemini 3 Pro infographics for dynamic charts
        async function generateGeminiInfographicsForCharts(chartConfigs, articleTitle, articleDescription = '') {
            if (!chartConfigs || Object.keys(chartConfigs).length === 0) {
                console.log('[Gemini] No chartConfigs to generate infographics for');
                return {};
            }

            const chartIds = Object.keys(chartConfigs);
            console.log('[Gemini] Requesting Gemini 3 Pro Midnight Tech infographics for:', chartIds);

            // Get article description for context if not provided
            if (!articleDescription) {
                const currentReport = reports[currentArticleKey];
                articleDescription = currentReport?.cardDescription || '';
            }

            try {
                const response = await fetch('/api/infographics/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chart_configs: chartConfigs,
                        article_title: articleTitle || 'Fractal Analysis',
                        article_description: articleDescription  // For shareable infographics
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[Gemini] API error:', response.status, errorText);
                    console.warn('[Gemini] Falling back to Chart.js - Gemini infographics unavailable');
                    return {};
                }

                const result = await response.json();
                console.log(`[Gemini] Generated ${result.generated}/${result.total} Midnight Tech infographics`);

                if (result.generated === 0) {
                    console.warn('[Gemini] No infographics generated - using Chart.js fallback');
                }

                // Store the generated infographics
                const infographics = result.infographics || {};
                let stored = 0;
                for (const [chartId, base64Data] of Object.entries(infographics)) {
                    if (base64Data) {
                        window.dynamicGeminiInfographics[chartId] = base64Data.startsWith('data:')
                            ? base64Data
                            : `data:image/png;base64,${base64Data}`;
                        stored++;
                    }
                }
                console.log(`[Gemini] Stored ${stored} infographics in dynamicGeminiInfographics`);

                return infographics;
            } catch (e) {
                console.error('[Gemini] Failed to generate infographics:', e);
                console.warn('[Gemini] Using Chart.js fallback due to error');
                return {};
            }
        }

        // Render a single Gemini infographic from base64 data
        function renderGeminiInfographicFromData(elementId, base64DataUrl) {
            const container = document.getElementById(elementId);
            if (!container) {
                // Try finding canvas by searching in report body
                const reportBody = document.getElementById('report-body');
                if (!reportBody) return false;

                const canvases = reportBody.querySelectorAll('canvas');
                for (const canvas of canvases) {
                    if (canvas.id === elementId || !canvas.dataset.geminiRendered) {
                        const parent = canvas.parentElement;
                        const img = document.createElement('img');
                        img.src = base64DataUrl;
                        img.alt = elementId;
                        img.className = 'gemini-infographic';
                        img.style.cssText = 'width: 100%; height: auto; border-radius: 8px;';
                        img.dataset.geminiRendered = 'true';
                        parent.innerHTML = '';
                        parent.appendChild(img);
                        console.log('[Gemini] Rendered infographic for:', elementId);
                        return true;
                    }
                }
                return false;
            }

            const parent = container.parentElement;
            if (container.tagName === 'CANVAS' || container.tagName === 'DIV') {
                const img = document.createElement('img');
                img.src = base64DataUrl;
                img.alt = elementId;
                img.className = 'gemini-infographic';
                img.style.cssText = 'width: 100%; height: auto; border-radius: 8px;';
                img.dataset.geminiRendered = 'true';
                parent.innerHTML = '';
                parent.appendChild(img);
                console.log('[Gemini] Rendered infographic for:', elementId);
                return true;
            }
            return false;
        }

        // Render charts from AI-generated article chartConfigs
        // Returns true if at least one chart was rendered, false otherwise
        async function renderDynamicCharts(chartConfigs, articleTitle = 'Investigation', skipGeminiGeneration = false) {
            console.log('[Charts] renderDynamicCharts called with:', chartConfigs);

            // Check if we already have Gemini images rendered in the DOM - PRESERVE THEM
            const existingGeminiImages = document.querySelectorAll('.gemini-infographic');
            if (existingGeminiImages.length > 0 && skipGeminiGeneration) {
                console.log(`[Charts] Preserving ${existingGeminiImages.length} existing Gemini infographics on theme change`);
                // Just update Chart.js colors if any are still active
                activeCharts.forEach(c => c.destroy());
                activeCharts = [];
                return true; // Images are preserved, nothing to do
            }

            // Cleanup old Chart.js charts (but preserve Gemini images)
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            if (!chartConfigs || Object.keys(chartConfigs).length === 0) {
                console.log('[Charts] No chartConfigs provided');
                return false;
            }

            // First, check if we have cached Gemini infographics for these charts
            let hasGeminiInfographics = false;
            for (const chartId of Object.keys(chartConfigs)) {
                if (window.dynamicGeminiInfographics[chartId]) {
                    hasGeminiInfographics = true;
                    break;
                }
            }

            // Now render: prefer cached Gemini infographics, show placeholders for pending
            let chartsRendered = 0;
            const chartKeys = Object.keys(chartConfigs);
            const chartsNeedingGeneration = [];

            for (const chartId of chartKeys) {
                const config = chartConfigs[chartId];
                // Check if we have a cached Gemini infographic for this chart
                if (window.dynamicGeminiInfographics[chartId]) {
                    if (renderGeminiInfographicFromData(chartId, window.dynamicGeminiInfographics[chartId])) {
                        chartsRendered++;
                        continue;
                    }
                }

                // No cached infographic - show placeholder if we'll be generating
                if (!skipGeminiGeneration) {
                    const chartTitle = config?.title || chartId.replace(/_/g, ' ');
                    showInfographicPlaceholder(chartId, chartTitle);
                    chartsNeedingGeneration.push(chartId);
                }
            }

            // If all charts were rendered from cache, we're done
            if (chartsRendered === chartKeys.length) {
                console.log(`[Charts] All ${chartsRendered} charts rendered from cached Gemini infographics`);
                return true;
            }

            // Generate missing infographics in background (non-blocking)
            if (chartsNeedingGeneration.length > 0 && !skipGeminiGeneration) {
                console.log('[Charts] Generating', chartsNeedingGeneration.length, 'infographics in background...');
                generateGeminiInfographicsForCharts(chartConfigs, articleTitle).then(infographics => {
                    // When ready, swap placeholders with actual images
                    for (const [chartId, base64Data] of Object.entries(infographics || {})) {
                        if (base64Data) {
                            const dataUrl = base64Data.startsWith('data:') ? base64Data : `data:image/png;base64,${base64Data}`;
                            window.dynamicGeminiInfographics[chartId] = dataUrl;
                            replacePlaceholderWithImage(chartId, dataUrl);
                        }
                    }
                }).catch(err => {
                    console.error('[Charts] Background infographic generation failed:', err);
                    // On failure, fall back to Chart.js for charts that are still placeholders
                    renderChartJsFallback(chartConfigs, chartsNeedingGeneration);
                });
                return true; // Return immediately, generation is async
            }

            // Otherwise, render remaining charts with Chart.js
            console.log('[Charts] Rendering remaining charts with Chart.js fallback...');

            const chartTextColor = getChartTextColor();
            const themeColors = getThemeChartColors();
            const defaultColors = themeColors.palette.concat([themeColors.accent, themeColors.muted]);

            // Get all canvases in the report body that haven't been used yet
            const reportBody = document.getElementById('report-body');
            const allCanvases = reportBody ? Array.from(reportBody.querySelectorAll('canvas')) : [];
            const usedCanvases = new Set();
            let fallbackIndex = 0;

            for (const [chartId, config] of Object.entries(chartConfigs)) {
                // Skip charts already rendered as Gemini infographics
                if (window.dynamicGeminiInfographics[chartId]) {
                    continue;
                }

                console.log('[Charts] Looking for canvas with id:', chartId);
                let canvas = document.getElementById(chartId);

                // If canvas not found by exact ID, try fallback to next available canvas
                if (!canvas) {
                    console.log('[Charts] Canvas NOT found for:', chartId);
                    console.log('[Charts] Available canvases:', allCanvases.map(c => c.id || '(no id)'));

                    // Find next unused canvas in the report body
                    while (fallbackIndex < allCanvases.length) {
                        const candidate = allCanvases[fallbackIndex];
                        if (!usedCanvases.has(candidate)) {
                            canvas = candidate;
                            usedCanvases.add(candidate);
                            console.log('[Charts] Using fallback canvas:', canvas.id || `(index ${fallbackIndex})`);
                            fallbackIndex++;
                            break;
                        }
                        fallbackIndex++;
                    }

                    if (!canvas) {
                        console.log('[Charts] No fallback canvas available for:', chartId);
                        continue;
                    }
                } else {
                    usedCanvases.add(canvas);
                }

                console.log('[Charts] Canvas found/assigned for:', chartId);

                const chartType = config.type || 'bar';
                const data = config.data || {};
                const labels = data.labels || [];
                const values = data.values || [];
                const colors = data.colors || defaultColors.slice(0, values.length);

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: config.title || '',
                        data: values,
                        backgroundColor: chartType === 'line' ? colors[0] + '33' : colors,
                        borderColor: chartType === 'line' ? colors[0] : colors,
                        borderWidth: chartType === 'line' ? 2 : 0,
                        fill: chartType === 'line',
                        tension: 0.4
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: !!config.title,
                            text: config.title || '',
                            color: chartTextColor
                        }
                    },
                    scales: chartType === 'doughnut' || chartType === 'radar' ? {} : {
                        x: { display: true, ticks: { color: chartTextColor } },
                        y: { display: true, ticks: { color: chartTextColor }, beginAtZero: true }
                    }
                };

                if (chartType === 'doughnut') {
                    options.cutout = '60%';
                }

                try {
                    activeCharts.push(new Chart(canvas, {
                        type: chartType,
                        data: chartData,
                        options: options
                    }));
                    chartsRendered++;
                    console.log('[Charts] Successfully rendered chart:', chartId);
                } catch (e) {
                    console.error('Failed to render chart:', chartId, e);
                }
            }

            console.log(`[Charts] Rendered ${chartsRendered}/${chartKeys.length} charts`);
            return chartsRendered > 0;
        }

        // --- 4. RESTRUCTURE FACT CHECK CONTENT INTO TABS ---
        function restructureFactCheckContent(data) {
            // Parse the HTML content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.content;

            // Remove ALL prior-fact-checks-section elements first (may be nested inside verdict-banner)
            tempDiv.querySelectorAll('.prior-fact-checks-section').forEach(el => el.remove());

            // Extract verdict banner (keep at top, but clean - small color-coded pane only)
            const verdictBanner = tempDiv.querySelector('.verdict-banner');
            let verdictBannerHTML = '';
            if (verdictBanner) {
                // Create a clean, compact verdict banner without the professional fact checks
                const icon = verdictBanner.querySelector('.verdict-icon');
                const label = verdictBanner.querySelector('.verdict-label');
                const nuance = verdictBanner.querySelector('.verdict-nuance');
                const verdictClass = verdictBanner.className;

                verdictBannerHTML = `<div class="${verdictClass}">
                    ${icon ? icon.outerHTML : ''}
                    ${label ? label.outerHTML : ''}
                    ${nuance ? nuance.outerHTML : ''}
                </div>`;
            }

            // Extract verdict summary (keep at top, outside tabs)
            const verdictSummary = tempDiv.querySelector('.verdict-summary');
            const verdictSummaryHTML = verdictSummary ? verdictSummary.outerHTML : '';

            // Remove any existing tabs structure from Claude
            const existingTabs = tempDiv.querySelector('.fact-check-tabs');
            if (existingTabs) existingTabs.remove();
            tempDiv.querySelectorAll('.fact-check-tab-content').forEach(el => el.remove());

            // Find all H2/H3 sections and their content
            const sections = {};
            let currentSection = 'intro';
            let currentContent = [];

            // Process all child nodes
            Array.from(tempDiv.childNodes).forEach(node => {
                // Skip verdict banner and summary - we handle them separately
                if (node === verdictBanner || node === verdictSummary) return;

                if (node.nodeName === 'H2' || node.nodeName === 'H3') {
                    // Save previous section
                    if (currentContent.length > 0) {
                        if (!sections[currentSection]) sections[currentSection] = '';
                        sections[currentSection] += currentContent.join('');
                    }
                    // Start new section based on heading text
                    const headingText = node.textContent.toLowerCase();
                    if (headingText.includes('claim') || headingText.includes('sub-claim')) {
                        currentSection = 'claim';
                    } else if (headingText.includes('evidence') || headingText.includes('quality')) {
                        currentSection = 'evidence';
                    } else if (headingText.includes('context') || headingText.includes('background') || headingText.includes('historical')) {
                        currentSection = 'context';
                    } else if (headingText.includes('conclusion') || headingText.includes('verdict') || headingText.includes('bottom line')) {
                        currentSection = 'conclusion';
                    } else {
                        // Keep in current section
                    }
                    currentContent = [node.outerHTML || ''];
                } else if (node.outerHTML) {
                    currentContent.push(node.outerHTML);
                }
            });
            // Save last section
            if (currentContent.length > 0) {
                if (!sections[currentSection]) sections[currentSection] = '';
                sections[currentSection] += currentContent.join('');
            }

            // Build content for each tab - prefer JSON data over HTML parsing

            // CLAIM TAB: Build from data.claims array if available
            let claimContent = '';
            if (data.claims && data.claims.length > 0) {
                claimContent = data.claims.map(claim => `
                    <div class="claim-card">
                        <div class="claim-header">
                            <span class="claim-verdict claim-${(claim.verdict || 'unknown').toLowerCase()}">${claim.verdict || 'Under Review'}</span>
                        </div>
                        <p class="prose-text claim-text">"${claim.text}"</p>
                        ${claim.evidence ? `<p class="prose-text claim-evidence"><strong>Finding:</strong> ${claim.evidence}</p>` : ''}
                    </div>
                `).join('');
            } else {
                // Fallback to parsed HTML sections
                claimContent = sections.claim || sections.intro || '<p class="prose-text">No claim information available.</p>';
            }

            // EVIDENCE TAB: Build from data.evidenceSummary if available
            let evidenceContent = '';
            if (data.evidenceSummary && (data.evidenceSummary.supporting?.length || data.evidenceSummary.contradicting?.length)) {
                if (data.evidenceSummary.contradicting && data.evidenceSummary.contradicting.length > 0) {
                    evidenceContent += '<h3 class="prose-h3">Contradicting Evidence</h3><ul class="evidence-list contradicting">' +
                        data.evidenceSummary.contradicting.map(e => `<li class="prose-text">âœ— ${e}</li>`).join('') +
                        '</ul>';
                }
                if (data.evidenceSummary.supporting && data.evidenceSummary.supporting.length > 0) {
                    evidenceContent += '<h3 class="prose-h3">Supporting Evidence</h3><ul class="evidence-list supporting">' +
                        data.evidenceSummary.supporting.map(e => `<li class="prose-text">âœ“ ${e}</li>`).join('') +
                        '</ul>';
                }
            }
            if (!evidenceContent) {
                // Fallback to parsed HTML sections
                evidenceContent = sections.evidence || '<p class="prose-text">No evidence analysis available.</p>';
            }

            // CONTEXT TAB: Build from evidenceSummary.context if available, or from sections
            let contextContent = '';
            if (data.evidenceSummary && data.evidenceSummary.context && data.evidenceSummary.context.length > 0) {
                contextContent = '<h3 class="prose-h3">Important Context</h3><ul class="context-list">' +
                    data.evidenceSummary.context.map(c => `<li class="prose-text">â€¢ ${c}</li>`).join('') +
                    '</ul>';
            } else {
                contextContent = sections.context || '';
            }
            if (!contextContent) {
                contextContent = '<p class="prose-text">No additional context available for this claim.</p>';
            }

            // Build Pro Fact Checks content from priorFactChecks array
            let proFactChecksContent = '';
            if (data.priorFactChecks && data.priorFactChecks.length > 0) {
                proFactChecksContent = '<h3 class="prose-h3">What Professional Fact-Checkers Say</h3><div class="pro-fact-checks-grid">';
                data.priorFactChecks.forEach(fc => {
                    const ratingClass = (fc.rating || '').toLowerCase().includes('false') ? 'rating-false' :
                                       (fc.rating || '').toLowerCase().includes('true') ? 'rating-true' : 'rating-mixed';
                    proFactChecksContent += `
                        <a href="${fc.url}" target="_blank" rel="noopener" class="pro-fact-check-card ${ratingClass}">
                            <div class="pfc-publisher">${fc.publisher || 'Fact Checker'}</div>
                            <div class="pfc-rating">${fc.rating || 'Reviewed'}</div>
                            <div class="pfc-title">${fc.title || fc.claim || 'View fact check'}</div>
                        </a>
                    `;
                });
                proFactChecksContent += '</div>';
            } else {
                proFactChecksContent = '<p class="prose-text">No professional fact checks found for this claim. This may be a new or less widely circulated claim.</p>';
            }

            const conclusionContent = sections.conclusion || '';

            return `
                ${verdictBannerHTML}
                ${verdictSummaryHTML}

                <!-- TABBED INTERFACE -->
                <div class="fact-check-tabs">
                    <button class="fact-check-tab active" onclick="switchFactCheckTab(event, 'tab-claim')">
                        <i data-lucide="quote"></i> Claim
                    </button>
                    <button class="fact-check-tab" onclick="switchFactCheckTab(event, 'tab-evidence')">
                        <i data-lucide="scale"></i> Evidence
                    </button>
                    <button class="fact-check-tab" onclick="switchFactCheckTab(event, 'tab-context')">
                        <i data-lucide="info"></i> Context
                    </button>
                    <button class="fact-check-tab pro-checks" onclick="switchFactCheckTab(event, 'tab-pro-checks')">
                        <i data-lucide="shield-check"></i> Pro Checks
                    </button>
                </div>

                <!-- TAB: CLAIM -->
                <div id="tab-claim" class="fact-check-tab-content active">
                    ${claimContent}
                </div>

                <!-- TAB: EVIDENCE -->
                <div id="tab-evidence" class="fact-check-tab-content">
                    ${evidenceContent}
                </div>

                <!-- TAB: CONTEXT -->
                <div id="tab-context" class="fact-check-tab-content">
                    ${contextContent}
                </div>

                <!-- TAB: PRO FACT CHECKS -->
                <div id="tab-pro-checks" class="fact-check-tab-content pro-checks-tab">
                    ${proFactChecksContent}
                </div>

                ${conclusionContent ? `<div class="fact-check-conclusion">${conclusionContent}</div>` : ''}
            `;
        }

        // --- 5. FACT CHECK TAB SWITCHING ---
        function switchFactCheckTab(event, tabId) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.fact-check-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.fact-check-tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab and corresponding content
            event.currentTarget.classList.add('active');
            const tabContent = document.getElementById(tabId);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Re-init lucide icons for the newly visible tab
            if (window.lucide) lucide.createIcons();
        }

        // --- 5. FRACTAL CONTEXT LOGIC ---
        function expandContext(element, id, nextTopic) {
            if (element.nextElementSibling && element.nextElementSibling.classList.contains('fractal-context')) {
                element.nextElementSibling.remove();
                return;
            }

            const contextData = {
                'goldman_analysis': `<strong>CONTEXT:</strong> While Goldman's economists predict a possible 9% GDP boost, their Head of Equity Research warns that "bubbles take a long time to burst," citing that AI lacks a "killer app" to justify the $1T spend.`,
                'sequoia_math': `<strong>CONTEXT:</strong> The "revenue hole" grew from $125B in 2023 to $600B in 2024. This suggests infrastructure is being built for future demand that has not yet materialized in software sales.`,
                'eight_trillion': `<strong>CONTEXT:</strong> The $8T figure extrapolates the cost of 100GW of planned capacity at ~$80B per gigawatt.`,
                'obsolescence': `<strong>CONTEXT:</strong> While traditional servers last 7 years, AI GPUs burn out or become economically obsolete in 3-5 years. This "Depreciation Bomb" destroys profit margins.`,
                'solow_paradox': `<strong>CONTEXT:</strong> The Solow Paradox states that we see the computer age everywhere but in the productivity statistics. AI has yet to break this trend.`,
                'pac_slush': `<strong>CONTEXT:</strong> Leadership PACs were created in 1978 for travel expenses. Today, the FEC is "deadlocked" on whether personal use bans apply to them, effectively legalizing their use for luxury perks.`,
                'three_mile_island': `<strong>CONTEXT:</strong> Microsoft is paying >$100/MWh (double the market rate) to restart the TMI nuclear reactor. This "behind-the-meter" deal bypasses the public grid entirely.`,
                'mad_disorder': `<strong>CONTEXT:</strong> MAD occurs when models train on synthetic data. They lose "variance" (creativity) and converge on the "median," erasing low-probability knowledge forever.`,
                'cost_of_business': `<strong>CONTEXT:</strong> A $2.7B fine for a company earning $307B is just 0.8% of revenue. In comparison, a speeding ticket is often a higher % of an average person's income.`,
                'gelsinger_exit': `<strong>CONTEXT:</strong> Pat Gelsinger was forced out December 1, 2024 after Intel's stock cratered 62% under his watch. His ambitious "IDM 2.0" strategy to compete with TSMC as a foundry failed spectacularly, with the foundry division losing $7B+ annually. CFO David Zinsner and Intel Products CEO MJ Holthaus now serve as interim co-CEOs.`,
                'chips_act': `<strong>CONTEXT:</strong> The CHIPS and Science Act allocated $52.7B for semiconductor manufacturing: $39B for fab incentives, $13.2B for R&D, plus a 25% investment tax credit. Despite this, Arizona construction has stalledâ€”five suppliers to Intel and TSMC have postponed projects citing labor shortages.`
            };

            const div = document.createElement('div');
            div.className = 'fractal-context';
            const triggerText = element.innerText;
            let content = contextData[id] || "Retrieving verified context...";

            // Always add the new styled queue button
            const escapedTopic = triggerText.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            content += `
                <button class="queue-deepdive-btn" onclick="queueDeepDiveFromContext(this, '${escapedTopic}')">
                    <span class="queue-btn-icon">+</span>
                    <span class="queue-btn-text">
                        <span class="queue-btn-label">Queue Fractal Analysis</span>
                        <span class="queue-btn-topic">${triggerText}</span>
                    </span>
                </button>
            `;

            div.innerHTML = content;
            element.parentNode.insertBefore(div, element.nextSibling);
            setTimeout(() => div.classList.add('open'), 10);
        }

        // Queue deep dive from fractal context expansion
        function queueDeepDiveFromContext(btn, topic) {
            // Check if at max capacity
            if (activeGenerations.size >= MAX_CONCURRENT_GENERATIONS) {
                showNotification(`Queue full (${MAX_CONCURRENT_GENERATIONS} max). Wait for one to complete.`, 'warning');
                return;
            }

            // Mark button as queued
            btn.classList.add('queued');
            btn.querySelector('.queue-btn-icon').textContent = 'âœ“';
            btn.querySelector('.queue-btn-label').textContent = 'Queued';

            // Get parent article context
            const articleTitle = document.getElementById('report-title')?.innerText || '';
            const currentReport = reports[currentArticleKey];
            const articleDescription = currentReport?.cardDescription || '';

            // Build rich context
            let context = `Parent Article: "${articleTitle}"\n`;
            if (articleDescription) {
                context += `Article Focus: ${articleDescription}\n`;
            }

            // Show toast notification
            const shortTopic = topic.length > 35 ? topic.substring(0, 32) + '...' : topic;
            showNotification(`Queued: "${shortTopic}"`, 'success');

            // Start generation in background
            generateDeepDive(topic, context, currentArticleKey, articleTitle);

            // Show badge
            const badge = document.getElementById('deep-dive-badge');
            if (badge) {
                badge.classList.add('visible');
                badge.classList.remove('minimized');
                setTimeout(() => {
                    if (!badge.matches(':hover')) {
                        badge.classList.add('minimized');
                    }
                }, 3000);
            }
        }

        // --- 4b. HOVER QUEUE PILL FOR FRACTAL TRIGGERS ---
        let hoverQueuePill = null;
        let hoverQueueTimeout = null;
        let currentHoveredTrigger = null;

        function initHoverQueuePills() {
            // Create global hover pill if it doesn't exist
            if (!hoverQueuePill) {
                hoverQueuePill = document.createElement('div');
                hoverQueuePill.className = 'hover-queue-pill';
                hoverQueuePill.innerHTML = `
                    <span class="pill-icon">+</span>
                    <span class="pill-text">Queue</span>
                `;
                document.body.appendChild(hoverQueuePill);

                // Handle pill click
                hoverQueuePill.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (currentHoveredTrigger && !hoverQueuePill.classList.contains('queued')) {
                        queueFromHoverPill(currentHoveredTrigger);
                    }
                });

                // Hide pill when mouse leaves it (unless moving to trigger)
                hoverQueuePill.addEventListener('mouseleave', (e) => {
                    // Small delay to allow moving to the trigger
                    hoverQueueTimeout = setTimeout(() => {
                        if (!currentHoveredTrigger?.matches(':hover')) {
                            hideHoverPill();
                        }
                    }, 100);
                });
            }

            // Add hover listeners to all fractal triggers
            document.querySelectorAll('.fractal-trigger').forEach(trigger => {
                if (trigger.dataset.hoverPillInit) return;
                trigger.dataset.hoverPillInit = 'true';

                trigger.addEventListener('mouseenter', (e) => {
                    clearTimeout(hoverQueueTimeout);
                    currentHoveredTrigger = trigger;
                    showHoverPill(trigger);
                });

                trigger.addEventListener('mouseleave', (e) => {
                    // Delay hide to allow moving to pill
                    hoverQueueTimeout = setTimeout(() => {
                        if (!hoverQueuePill?.matches(':hover')) {
                            hideHoverPill();
                        }
                    }, 200);
                });
            });
        }

        function showHoverPill(trigger) {
            if (!hoverQueuePill) return;

            // Reset state if it was previously queued for different topic
            if (hoverQueuePill.dataset.queuedTopic !== trigger.innerText) {
                hoverQueuePill.classList.remove('queued');
                hoverQueuePill.querySelector('.pill-icon').textContent = '+';
                hoverQueuePill.querySelector('.pill-text').textContent = 'Queue';
            }

            // Position pill to the right of the trigger
            const rect = trigger.getBoundingClientRect();
            const pillWidth = 70; // approximate

            let x = rect.right + 8;
            let y = rect.top + (rect.height / 2) - 12; // center vertically

            // Boundary check - if pill would go off screen, position it below
            if (x + pillWidth > window.innerWidth - 10) {
                x = rect.left;
                y = rect.bottom + 4;
            }

            hoverQueuePill.style.left = x + 'px';
            hoverQueuePill.style.top = y + 'px';
            hoverQueuePill.classList.add('visible');
        }

        function hideHoverPill() {
            if (hoverQueuePill) {
                hoverQueuePill.classList.remove('visible');
            }
            currentHoveredTrigger = null;
        }

        function queueFromHoverPill(trigger) {
            const topic = trigger.innerText;

            // Check if at max capacity
            if (activeGenerations.size >= MAX_CONCURRENT_GENERATIONS) {
                showNotification(`Queue full (${MAX_CONCURRENT_GENERATIONS} max). Wait for one to complete.`, 'warning');
                return;
            }

            // Mark pill as queued
            hoverQueuePill.classList.add('queued');
            hoverQueuePill.querySelector('.pill-icon').textContent = 'âœ“';
            hoverQueuePill.querySelector('.pill-text').textContent = 'Queued';
            hoverQueuePill.dataset.queuedTopic = topic;

            // Get parent article context
            const articleTitle = document.getElementById('report-title')?.innerText || '';
            const currentReport = reports[currentArticleKey];
            const articleDescription = currentReport?.cardDescription || '';

            let context = `Parent Article: "${articleTitle}"\n`;
            if (articleDescription) {
                context += `Article Focus: ${articleDescription}\n`;
            }

            // Show toast
            const shortTopic = topic.length > 35 ? topic.substring(0, 32) + '...' : topic;
            showNotification(`Queued: "${shortTopic}"`, 'success');

            // Start generation
            generateDeepDive(topic, context, currentArticleKey, articleTitle);

            // Show badge
            const badge = document.getElementById('deep-dive-badge');
            if (badge) {
                badge.classList.add('visible');
                badge.classList.remove('minimized');
                setTimeout(() => {
                    if (!badge.matches(':hover')) {
                        badge.classList.add('minimized');
                    }
                }, 3000);
            }

            // Hide pill after short delay
            setTimeout(() => {
                hideHoverPill();
            }, 800);
        }

        // Initialize hover pills when DOM ready and after article loads
        document.addEventListener('DOMContentLoaded', initHoverQueuePills);

        // Initialize three-panel layout
        document.addEventListener('DOMContentLoaded', function() {
            restorePanelStates();
            populateSidePanels();
        });

        // --- 5. INTELLIGENCE CARD SYSTEM ---

        // Granular Source Database
        const citationDatabase = {
            'goldman_trillion': {
                domain: 'GOLDMANSACHS.COM',
                score: 98,
                title: 'Gen AI: Too Much Spend?',
                snippet: 'Tech Giants and utilities set to invest $1 Trillion in AI Capex over coming years.',
                url: 'https://www.goldmansachs.com/intelligence/pages/gen-ai-too-much-spend-too-little-benefit.html'
            },
            'covello_skeptic': {
                domain: 'GOLDMANSACHS.COM',
                score: 98,
                title: 'Jim Covello Analysis',
                snippet: 'Covello argues AI technology is "exceptionally expensive" and lacks a "killer app" to justify costs.',
                url: 'https://www.goldmansachs.com/intelligence/pages/gen-ai-too-much-spend-too-little-benefit.html'
            },
            'sequoia_gap': {
                domain: 'SEQUOIACAP.COM',
                score: 99,
                title: "AI's $600B Question",
                snippet: 'The revenue gap between AI infrastructure spend and revenue has widened to $600B annually as of June 2024.',
                url: 'https://www.sequoiacap.com/article/ais-600b-question/'
            },
            'sequoia_method': {
                domain: 'SEQUOIACAP.COM',
                score: 99,
                title: 'Revenue Math Methodology',
                snippet: 'Calculation doubles Nvidia run-rate for TCO, then doubles again for 50% end-user margins.',
                url: 'https://www.sequoiacap.com/article/ais-600b-question/'
            },
            'aws_lifespan': {
                domain: 'AWS.AMAZON.COM',
                score: 100,
                title: 'AWS Strategy Update',
                snippet: 'AWS officially extended the useful life of its servers from 5 years to 6 years in 2024.',
                url: 'https://aws.amazon.com/blogs/aws/'
            },
            'nvidia_perf': {
                domain: 'NVIDIA.COM',
                score: 100,
                title: 'Blackwell B100 Specs',
                snippet: 'B100 delivers 2.5x the performance of H100 for AI training workloads.',
                url: 'https://www.nvidia.com/en-us/data-center/technologies/blackwell-architecture/'
            },
            'iea_demand': {
                domain: 'IEA.ORG',
                score: 96,
                title: 'Electricity 2024 Report',
                snippet: 'Global data center electricity consumption projected to reach 1000 TWh by 2026.',
                url: 'https://www.iea.org/reports/electricity-2024'
            },
            'tmi_deal': {
                domain: 'CONSTELLATION.COM',
                score: 100,
                title: 'Crane Clean Energy Center',
                snippet: 'Constellation & Microsoft sign 20-year PPA to restart Three Mile Island Unit 1.',
                url: 'https://www.constellationenergy.com/newsroom/2024/Constellation-to-Launch-Crane-Clean-Energy-Center-Restoring-Jobs-and-Carbon-Free-Power-to-the-Grid.html'
            },
            'tmi_cost': {
                domain: 'BLOOMBERG.COM',
                score: 92,
                title: 'Nuclear Premum Pricing',
                snippet: 'Analysts estimate deal pricing at >$100/MWh, significantly above renewable market rates.',
                url: 'https://www.bloomberg.com/news/articles/2024-09-20/microsoft-s-three-mile-island-deal-is-the-largest-clean-power-agreement-yet'
            },
            'gen_ai_revenue': {
                domain: 'GRANDVIEWRESEARCH.COM',
                score: 85,
                title: 'Market Size 2024',
                snippet: 'Estimates for 2024 Generative AI revenue range from $16B to $67B, well under the $100B mark.',
                url: 'https://www.grandviewresearch.com/industry-analysis/generative-ai-market-report'
            },
            // Semiconductor Wars citations
            'tsmc_share': {
                domain: 'VISIONOFHUMANITY.ORG',
                score: 97,
                title: 'Taiwan Semiconductor Dependency',
                snippet: 'TSMC global market share rose to 64%, up from 60% prior year, driven by AI chip demand.',
                url: 'https://www.visionofhumanity.org/global-tech-dependence-on-taiwan-semiconductors/'
            },
            'intel_loss': {
                domain: 'CNBC.COM',
                score: 98,
                title: 'Intel Q3 2024 Losses',
                snippet: 'Around $7B in restructuring charges contributed to a staggering $19B net loss in first 9 months of 2024.',
                url: 'https://www.cnbc.com/2024/11/01/intel-q3-earnings-report-2024.html'
            },
            'taiwan_dominance': {
                domain: 'GLOBALTAIWAN.ORG',
                score: 96,
                title: 'Taiwan Chip Manufacturing',
                snippet: 'Over 60% of world semiconductors, and almost 90% of most sophisticated chips, are made in Taiwan.',
                url: 'https://globaltaiwan.org/2024/01/taiwan-semiconductor-industry/'
            },
            'cutting_edge': {
                domain: 'SCIENCEDIRECT.COM',
                score: 99,
                title: 'TSMC Advanced Nodes',
                snippet: 'In cutting-edge nodes (5nm, 3nm), TSMC market share exceeds 90%. Only Samsung competes.',
                url: 'https://www.sciencedirect.com/science/article/pii/S0048969723066347'
            },
            'iep_cost': {
                domain: 'VISIONOFHUMANITY.ORG',
                score: 97,
                title: 'Taiwan Conflict Economic Cost',
                snippet: 'IEP estimates full-scale Taiwan conflict could result in $10 trillion loss to global economy.',
                url: 'https://www.visionofhumanity.org/global-tech-dependence-on-taiwan-semiconductors/'
            },
            'intel_foundry': {
                domain: 'CNBC.COM',
                score: 98,
                title: 'Intel Foundry Operating Loss',
                snippet: 'Intel foundry business recorded $7B operating loss in 2023 on sales of $18.9B.',
                url: 'https://www.cnbc.com/2024/04/02/intel-foundry-lost-7-billion-from-operations-last-year.html'
            },
            'intel_stock': {
                domain: 'CNN.COM',
                score: 99,
                title: 'Intel Stock Collapse',
                snippet: 'Intel stock fell 62% under Gelsinger, market cap fell below $100B for first time since 2012.',
                url: 'https://www.cnn.com/2024/12/02/tech/intel-ceo-pat-gelsinger-retires/index.html'
            },
            'nvidia_mcap': {
                domain: 'CNBC.COM',
                score: 100,
                title: 'Nvidia $4 Trillion Milestone',
                snippet: 'Nvidia passed $4 trillion market capâ€”the only publicly traded company to ever reach that mark.',
                url: 'https://www.cnbc.com/2024/11/05/nvidia-hits-record-high-4-trillion-market-cap.html'
            },
            'nvidia_revenue': {
                domain: 'STATISTA.COM',
                score: 99,
                title: 'Nvidia Data Center Revenue',
                snippet: 'Data center revenue exploded 216% YoY, reaching $47.5B in fiscal 2024.',
                url: 'https://www.statista.com/statistics/716573/nvidia-data-center-revenue/'
            },
            'msft_chips': {
                domain: 'PCGAMER.COM',
                score: 95,
                title: 'Microsoft H100 Purchases',
                snippet: 'Microsoft purchased 485,000 Hopper AI chips in 2024â€”twice as many as nearest competitor Meta.',
                url: 'https://www.pcgamer.com/hardware/microsoft-bought-485000-nvidia-ai-chips-this-year-which-is-twice-as-many-as-meta/'
            },
            'tsmc_arizona': {
                domain: 'Z2DATA.COM',
                score: 96,
                title: 'TSMC Arizona Delays',
                snippet: 'TSMC $40B Arizona fab suffered multiple delays. Facilities likely not operational until 2028.',
                url: 'https://www.z2data.com/insights/tsmc-arizona-fab-construction-delays'
            },
            'tsmc_packaging': {
                domain: 'SUPPLYFRAME.COM',
                score: 97,
                title: 'TSMC Packaging Bottleneck',
                snippet: 'TSMC Chairman: "It is not shortage of AI chips, it is the shortage of our packaging capacity."',
                url: 'https://www.supplyframe.com/resources/commodity-iq/tsmc-advanced-packaging-bottleneck'
            },
            'cowos_capacity': {
                domain: 'DELOITTE.COM',
                score: 99,
                title: 'CoWoS Capacity Expansion',
                snippet: 'TSMC CoWoS capacity: 35K wpm (2024) â†’ 70K (2025) â†’ 90K by end of 2026. 157% increase.',
                url: 'https://www2.deloitte.com/us/en/insights/industry/technology/technology-media-and-telecom-predictions/2025/semiconductor-advanced-packaging.html'
            },
            'china_self': {
                domain: 'CFR.ORG',
                score: 98,
                title: 'China Chip Self-Sufficiency',
                snippet: 'China at ~16% chip self-sufficiency despite targeting 70% by 2025. Still imports $400B+ annually.',
                url: 'https://www.cfr.org/backgrounder/china-taiwan-relations-tension-us-policy'
            }
        };

        // Init Lucide
        lucide.createIcons();
        initReceipts();
        initRefLinks();
        renderTrendingSection();

        // === PERIODIC LOGO ATTENTION ANIMATION ===
        // Soft roll every 24-36 seconds when on portal view (half as often, much gentler)
        function startLogoAttention() {
            const triggerAttention = () => {
                const logo = document.getElementById('portal-logo');
                const portalView = document.getElementById('view-portal');
                // Only animate if portal view is visible
                if (logo && portalView && portalView.classList.contains('active')) {
                    logo.classList.add('anim-attention');
                    // Remove class after animation completes (1.2s duration)
                    setTimeout(() => logo.classList.remove('anim-attention'), 1200);
                }
                // Schedule next animation at random interval (24-36 seconds - half as often)
                const nextDelay = 24000 + Math.random() * 12000;
                setTimeout(triggerAttention, nextDelay);
            };
            // Start first animation after 15 seconds (more patience)
            setTimeout(triggerAttention, 15000);
        }
        startLogoAttention();

        // === TYPEWRITER CURSOR CLEANUP ===
        // Remove blinking cursor after typewriter animation completes
        setTimeout(() => {
            const typewriter = document.querySelector('.typewriter');
            if (typewriter) typewriter.classList.add('done');
        }, 4500); // 4s typing + 0.5s buffer

        // === DYNAMIC TRENDING SECTION ===
        function renderTrendingSection() {
            const featuredContainer = document.getElementById('trending-featured');
            const moreContainer = document.getElementById('trending-more');

            if (!featuredContainer) {
                return;
            }

            // Get all reports with card metadata (excluding child essays)
            const allArticles = [];
            for (const [key, report] of Object.entries(reports)) {
                // Skip child essays - they're accessed via parent articles
                if (report.isChildEssay) {
                    continue;
                }

                if (report.cardTitle) {
                    allArticles.push({
                        key,
                        title: report.cardTitle,
                        tag: report.cardTag || 'INVESTIGATION',
                        tagColor: report.cardTagColor || 'text-blue-700',
                        description: report.cardDescription || '',
                        hasChildEssays: report.childEssays && report.childEssays.length > 0
                    });
                }
            }

            // Also fetch cached articles from server
            fetch('/api/cache/list')
                .then(res => res.json())
                .then(data => {
                    // Add cached articles that aren't already in reports or allArticles
                    if (data.articles) {
                        // Helper to normalize titles for comparison
                        const normalizeTitle = (title) => (title || '').toLowerCase().replace(/[^a-z0-9]/g, '');

                        // Get existing titles for dedup
                        const existingTitles = new Set(allArticles.map(a => normalizeTitle(a.title)));
                        const existingKeys = new Set(allArticles.map(a => a.key));

                        data.articles.forEach(article => {
                            const articleTitle = article.title || article.topic || 'Untitled';
                            const normalizedTitle = normalizeTitle(articleTitle);

                            // Skip if key already exists, title is duplicate, or in reports
                            if (reports[article.key] || existingKeys.has(article.key) || existingTitles.has(normalizedTitle)) {
                                console.log('[Portal] Skipping duplicate:', article.key, articleTitle.substring(0, 40));
                                return;
                            }

                            existingKeys.add(article.key);
                            existingTitles.add(normalizedTitle);

                            // Determine tag and color based on article_type
                            let tag = 'INVESTIGATION';
                            let tagColor = 'text-blue-400';
                            const articleType = article.article_type || (article.parent_key ? 'deep_dive' : 'investigation');

                            if (articleType === 'fact_check') {
                                tag = article.verdict ? `FACT CHECK: ${article.verdict}` : 'FACT CHECK';
                                tagColor = 'text-teal-400';
                            } else if (articleType === 'deep_dive' || article.parent_key) {
                                tag = 'FRACTAL';
                                tagColor = 'text-green-400';
                            }

                            allArticles.push({
                                key: article.key,
                                title: articleTitle,
                                tag,
                                tagColor,
                                description: article.topic || article.cardDescription || '',
                                isCached: true,
                                parentKey: article.parent_key || '',
                                parentTitle: article.parent_title || '',
                                articleType,
                                cachedAt: article.cached_at || '',
                                verdict: article.verdict || '',
                                topSources: article.top_sources || []
                            });
                        });
                    }

                    // Sort by recency (newest first)
                    allArticles.sort((a, b) => {
                        const dateA = a.cachedAt ? new Date(a.cachedAt) : new Date(0);
                        const dateB = b.cachedAt ? new Date(b.cachedAt) : new Date(0);
                        return dateB - dateA; // Newest first
                    });

                    renderArticleCards(allArticles, featuredContainer, moreContainer);
                })
                .catch(() => {
                    // If fetch fails, just render local articles
                    renderArticleCards(allArticles, featuredContainer, moreContainer);
                });
        }

        function renderArticleCards(articles, featuredContainer, moreContainer) {
            // Helper to format date (e.g., "Dec 13" or "Dec 13, 2024" if not current year)
            function formatCardDate(dateStr) {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    const now = new Date();
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const month = months[date.getMonth()];
                    const day = date.getDate();
                    if (date.getFullYear() === now.getFullYear()) {
                        return `${month} ${day}`;
                    }
                    return `${month} ${day}, ${date.getFullYear()}`;
                } catch (e) {
                    return '';
                }
            }

            // Helper to get sources for an article (use topSources for cached, fall back to reports)
            function getArticleSources(article, maxSources = 4) {
                // First check topSources from cache index
                if (article.topSources && article.topSources.length > 0) {
                    return article.topSources.slice(0, maxSources);
                }
                // Fall back to static reports object
                const report = reports[article.key];
                if (!report || !report.sources) return [];
                return report.sources.slice(0, maxSources);
            }

            // Helper to render sources column (for main cards - shows 4 sources)
            function renderSources(sources) {
                if (!sources || sources.length === 0) {
                    return `<div class="card-sources">
                        <div class="source-item"><span class="source-dot high"></span>Reuters</div>
                        <div class="source-item"><span class="source-dot high"></span>AP News</div>
                    </div>`;
                }
                return `<div class="card-sources">
                    ${sources.map(s => {
                        const score = s.score || 80;
                        const level = score >= 85 ? 'high' : score >= 70 ? 'medium' : 'low';
                        const name = s.name || s.domain || 'Source';
                        return `<div class="source-item"><span class="source-dot ${level}"></span><span class="source-name">${name.substring(0, 28)}</span></div>`;
                    }).join('')}
                </div>`;
            }

            // Helper to render mini source badge (for browse cards - shows 1 source)
            function renderMiniSource(sources) {
                if (!sources || sources.length === 0) return '';
                const s = sources[0];
                const score = s.score || 80;
                const level = score >= 85 ? 'high' : score >= 70 ? 'medium' : 'low';
                const name = s.name || s.domain || 'Source';
                return `<span class="browse-source"><span class="source-dot ${level}"></span>${name.substring(0, 20)}</span>`;
            }

            // Split: top 4 get graduated sizes, 5th+ goes to browse list
            const mainCards = articles.slice(0, 4);
            const browseList = articles.slice(4);

            // Render main cards with 2-column layout (content left, sources right)
            featuredContainer.innerHTML = mainCards.map((article, i) => {
                const sources = getArticleSources(article, 4);
                const dateStr = formatCardDate(article.cachedAt);
                const parentLink = article.parentKey ? `
                    <div class="parent-link" onclick="event.stopPropagation(); loadReport('${article.parentKey}')" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; cursor: pointer;">
                        <span style="color: var(--accent-teal); opacity: 0.7;">&#8627;</span>
                        From: <span style="color: var(--accent-blue); text-decoration: underline;">${article.parentTitle || 'Parent Article'}</span>
                    </div>
                ` : '';
                return `
                <div onclick="loadReport('${article.key}')" class="trending-card trending-card-${i + 1} anim-fade-up anim-delay-${4 + i}">
                    <div class="card-inner">
                        <div class="card-content">
                            <div class="card-meta" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span class="text-xs font-mono ${article.tagColor}">${article.tag}</span>
                                ${dateStr ? `<span class="card-date" style="font-size: 0.7rem; color: var(--text-muted); opacity: 0.7;">${dateStr}</span>` : ''}
                            </div>
                            <h3 class="font-bold mb-1" style="color: var(--text-main);">${article.title}</h3>
                            <p style="color: var(--text-muted);">${article.description}</p>
                            ${parentLink}
                        </div>
                        ${renderSources(sources)}
                    </div>
                </div>`;
            }).join('');

            // Render browse list (5th card and beyond) - tabbed by type
            if (browseList.length > 0) {
                // Categorize articles
                const investigations = browseList.filter(a => !a.articleType || a.articleType === 'investigation');
                const factChecks = browseList.filter(a => a.articleType === 'fact_check');
                const deepDives = browseList.filter(a => a.articleType === 'deep_dive');

                // Helper to render a single article card
                const renderBrowseCard = (article, i) => {
                    const dateStr = formatCardDate(article.cachedAt);
                    const sources = getArticleSources(article, 1);
                    const sourceHtml = renderMiniSource(sources);
                    return `
                    <div onclick="loadReport('${article.key}')" class="trending-card-list anim-fade-up" style="animation-delay: ${0.05 + i * 0.03}s;">
                        <div class="browse-card-meta" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                            <span class="card-tag font-mono ${article.tagColor}">${article.tag}</span>
                            ${dateStr ? `<span style="font-size: 0.7rem; color: var(--text-muted); opacity: 0.7;">${dateStr}</span>` : ''}
                            ${sourceHtml}
                        </div>
                        <h4 style="color: var(--text-main);">${article.title}</h4>
                        ${article.parentKey ? `
                            <div class="parent-link" onclick="event.stopPropagation(); loadReport('${article.parentKey}')" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; cursor: pointer;">
                                <span style="color: var(--accent-teal); opacity: 0.7;">&#8627;</span>
                                From: <span style="color: var(--accent-blue); text-decoration: underline;">${article.parentTitle || 'Parent Article'}</span>
                            </div>
                        ` : ''}
                    </div>
                `;};

                // Determine which tab should be active (first one with content)
                const defaultTab = investigations.length > 0 ? 'investigations' :
                                   factChecks.length > 0 ? 'fact-checks' : 'deep-dives';

                moreContainer.innerHTML = `
                    <div class="browse-more-header anim-fade-up anim-delay-8">Browse by Type</div>

                    <!-- Tab buttons -->
                    <div class="browse-type-tabs anim-fade-up anim-delay-8">
                        <button class="browse-type-tab investigations ${defaultTab === 'investigations' ? 'active' : ''}"
                                onclick="switchBrowseTab(event, 'investigations')">
                            <i data-lucide="search"></i>
                            Investigations
                            <span class="tab-count">${investigations.length}</span>
                        </button>
                        <button class="browse-type-tab fact-checks ${defaultTab === 'fact-checks' ? 'active' : ''}"
                                onclick="switchBrowseTab(event, 'fact-checks')">
                            <i data-lucide="scale"></i>
                            Fact Checks
                            <span class="tab-count">${factChecks.length}</span>
                        </button>
                        <button class="browse-type-tab deep-dives ${defaultTab === 'deep-dives' ? 'active' : ''}"
                                onclick="switchBrowseTab(event, 'deep-dives')">
                            <i data-lucide="layers"></i>
                            Fractal Analysis
                            <span class="tab-count">${deepDives.length}</span>
                        </button>
                    </div>

                    <!-- Tab content -->
                    <div id="browse-investigations" class="browse-type-content ${defaultTab === 'investigations' ? 'active' : ''}">
                        ${investigations.length > 0
                            ? investigations.map((a, i) => renderBrowseCard(a, i)).join('')
                            : '<div class="browse-type-empty">No investigations yet</div>'}
                    </div>
                    <div id="browse-fact-checks" class="browse-type-content ${defaultTab === 'fact-checks' ? 'active' : ''}">
                        ${factChecks.length > 0
                            ? factChecks.map((a, i) => renderBrowseCard(a, i)).join('')
                            : '<div class="browse-type-empty">No fact checks yet</div>'}
                    </div>
                    <div id="browse-deep-dives" class="browse-type-content ${defaultTab === 'deep-dives' ? 'active' : ''}">
                        ${deepDives.length > 0
                            ? deepDives.map((a, i) => renderBrowseCard(a, i)).join('')
                            : '<div class="browse-type-empty">No fractal analyses yet</div>'}
                    </div>
                `;
                moreContainer.style.display = 'flex';
                moreContainer.style.flexDirection = 'column';
                moreContainer.style.gap = '0.5rem';

                // Re-init lucide icons
                if (window.lucide) lucide.createIcons();
            } else {
                moreContainer.style.display = 'none';
            }
        }

        // Switch between Browse by Type tabs (Investigations, Fact Checks, Deep Dives)
        function switchBrowseTab(event, tabId) {
            // Remove active from all tabs
            document.querySelectorAll('.browse-type-tab').forEach(tab => tab.classList.remove('active'));
            // Remove active from all content
            document.querySelectorAll('.browse-type-content').forEach(content => content.classList.remove('active'));
            // Add active to clicked tab
            event.currentTarget.classList.add('active');
            // Show corresponding content
            document.getElementById('browse-' + tabId).classList.add('active');
        }

        // === THREE-PANEL LAYOUT FUNCTIONS ===

        // Toggle panel collapse/expand
        function togglePanel(panelId) {
            const panelMap = {
                'fact-checks': 'panel-fact-checks',
                'investigations': 'panel-investigations'
            };
            const panel = document.getElementById(panelMap[panelId]);
            if (!panel) return;

            panel.classList.toggle('collapsed');

            // Save state to localStorage
            const collapsedPanels = JSON.parse(localStorage.getItem('genuverity-collapsed-panels') || '{}');
            collapsedPanels[panelId] = panel.classList.contains('collapsed');
            localStorage.setItem('genuverity-collapsed-panels', JSON.stringify(collapsedPanels));

            // Re-init icons in case they changed
            if (window.lucide) lucide.createIcons();
        }

        // Restore panel states from localStorage
        function restorePanelStates() {
            const collapsedPanels = JSON.parse(localStorage.getItem('genuverity-collapsed-panels') || '{}');
            if (collapsedPanels['fact-checks']) {
                document.getElementById('panel-fact-checks')?.classList.add('collapsed');
            }
            if (collapsedPanels['investigations']) {
                document.getElementById('panel-investigations')?.classList.add('collapsed');
            }
        }

        // Mobile tab switching
        function showMobilePanel(panelId) {
            // Update mobile tabs
            document.querySelectorAll('.mobile-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.mobile-tab.${panelId === 'home' ? 'active' : panelId}`)?.classList.add('active');
            event.currentTarget.classList.add('active');

            // Show/hide panels based on selection
            const fcPanel = document.getElementById('panel-fact-checks');
            const invPanel = document.getElementById('panel-investigations');
            const centerPanel = document.querySelector('.center-panel');

            // Reset all
            fcPanel?.classList.remove('mobile-visible');
            invPanel?.classList.remove('mobile-visible');
            centerPanel?.classList.remove('mobile-hidden');

            if (panelId === 'fact-checks') {
                fcPanel?.classList.add('mobile-visible');
                centerPanel?.classList.add('mobile-hidden');
            } else if (panelId === 'investigations') {
                invPanel?.classList.add('mobile-visible');
                centerPanel?.classList.add('mobile-hidden');
            }
            // 'home' shows center panel (default)
        }

        // Render panel card (compact version for side panels)
        function renderPanelCard(article) {
            const verdictColors = {
                'TRUE': '#10b981',
                'MOSTLY TRUE': '#34d399',
                'MIXED': '#f59e0b',
                'MOSTLY FALSE': '#f97316',
                'FALSE': '#ef4444'
            };

            const isFactCheck = article.articleType === 'fact_check';
            const verdictColor = isFactCheck && article.verdict ? verdictColors[article.verdict] || '#6b7280' : null;

            // Format date
            let dateStr = '';
            if (article.cachedAt) {
                const date = new Date(article.cachedAt);
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                dateStr = `${months[date.getMonth()]} ${date.getDate()}`;
            }

            return `
                <div class="panel-card" onclick="loadReportInCenter('${article.key}')">
                    ${isFactCheck && article.verdict ? `
                        <div class="panel-card-verdict" style="background: ${verdictColor}20; border-left: 3px solid ${verdictColor};">
                            <span class="verdict-badge" style="color: ${verdictColor};">${article.verdict}</span>
                        </div>
                    ` : ''}
                    <div class="panel-card-title">${article.title}</div>
                    ${dateStr ? `<div class="panel-card-date">${dateStr}</div>` : ''}
                </div>
            `;
        }

        // Populate side panels with articles
        function populateSidePanels() {
            const fcList = document.getElementById('fact-checks-list');
            const invList = document.getElementById('investigations-list');
            const fcBadge = document.getElementById('fc-count-badge');
            const invBadge = document.getElementById('inv-count-badge');

            if (!fcList || !invList) return;

            // Get articles from cache
            fetch('/api/cache/list')
                .then(res => res.json())
                .then(data => {
                    const factChecks = [];
                    const investigations = [];

                    // Also add local reports
                    for (const [key, report] of Object.entries(reports)) {
                        if (report.isChildEssay) continue;
                        if (!report.cardTitle) continue;

                        const articleType = report.articleType || 'investigation';
                        const article = {
                            key,
                            title: report.cardTitle || report.title,
                            articleType,
                            verdict: report.verdict || '',
                            cachedAt: report._cached_at || ''
                        };

                        if (articleType === 'fact_check') {
                            factChecks.push(article);
                        } else {
                            investigations.push(article);
                        }
                    }

                    // Add cached articles
                    if (data.articles) {
                        data.articles.forEach(article => {
                            // Skip duplicates
                            if (reports[article.key]) return;

                            const articleType = article.article_type || 'investigation';
                            const item = {
                                key: article.key,
                                title: article.title || article.topic || 'Untitled',
                                articleType,
                                verdict: article.verdict || '',
                                cachedAt: article.cached_at || ''
                            };

                            if (articleType === 'fact_check') {
                                factChecks.push(item);
                            } else {
                                investigations.push(item);
                            }
                        });
                    }

                    // Sort by recency
                    const sortByDate = (a, b) => {
                        const dateA = a.cachedAt ? new Date(a.cachedAt) : new Date(0);
                        const dateB = b.cachedAt ? new Date(b.cachedAt) : new Date(0);
                        return dateB - dateA;
                    };
                    factChecks.sort(sortByDate);
                    investigations.sort(sortByDate);

                    // Update badges
                    if (fcBadge) fcBadge.textContent = factChecks.length;
                    if (invBadge) invBadge.textContent = investigations.length;

                    // Render fact checks
                    if (factChecks.length > 0) {
                        fcList.innerHTML = factChecks.map(renderPanelCard).join('');
                    } else {
                        fcList.innerHTML = `
                            <div class="panel-empty">
                                <i data-lucide="scale" class="w-8 h-8 mx-auto mb-2" style="opacity: 0.3;"></i>
                                <p>No fact checks yet</p>
                                <p style="font-size: 0.7rem; margin-top: 0.5rem;">Enter a claim to fact check it</p>
                            </div>
                        `;
                    }

                    // Render investigations
                    if (investigations.length > 0) {
                        invList.innerHTML = investigations.map(renderPanelCard).join('');
                    } else {
                        invList.innerHTML = `
                            <div class="panel-empty">
                                <i data-lucide="search" class="w-8 h-8 mx-auto mb-2" style="opacity: 0.3;"></i>
                                <p>No investigations yet</p>
                                <p style="font-size: 0.7rem; margin-top: 0.5rem;">Enter a topic to investigate</p>
                            </div>
                        `;
                    }

                    // Re-init icons
                    if (window.lucide) lucide.createIcons();
                })
                .catch(err => {
                    console.error('[Panels] Error loading articles:', err);
                });
        }

        // Load article in center panel (instead of full view switch)
        function loadReportInCenter(key) {
            const centerLanding = document.getElementById('center-landing');
            const centerArticle = document.getElementById('center-article');

            // For now, use the existing loadReport which switches to view-report
            // In the future, we could render inline in center panel
            loadReport(key);
        }

        function initReceipts() {
            // Create the Intelligence Card Element
            const card = document.createElement('div');
            card.className = 'intelligence-card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="source-domain">LOADING...</span>
                    <span class="trust-score">0%</span>
                </div>
                <div class="card-title"></div>
                <div class="card-snippet"></div>
            `;
            document.body.appendChild(card);

            const domainEl = card.querySelector('.source-domain');
            const scoreEl = card.querySelector('.trust-score');
            const titleEl = card.querySelector('.card-title');
            const snippetEl = card.querySelector('.card-snippet');

            // Helper to get citation data from global or dynamic database
            function getCitationData(id) {
                // Check global database first
                if (citationDatabase[id]) return citationDatabase[id];
                // Then check dynamic database (for AI-generated articles)
                if (window.dynamicCitationDatabase && window.dynamicCitationDatabase[id]) {
                    const d = window.dynamicCitationDatabase[id];
                    // Normalize trustScore to score
                    return { ...d, score: d.score || d.trustScore };
                }
                return null;
            }

            // Event Delegation
            document.body.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('citation-spade')) {
                    const id = e.target.getAttribute('data-id');
                    const data = getCitationData(id);

                    if (data) {
                        domainEl.innerText = data.domain;
                        scoreEl.innerText = (data.score || data.trustScore) + '% VERIFIED';
                        titleEl.innerText = data.title;
                        snippetEl.innerText = data.snippet;

                        // Color Logic
                        scoreEl.className = 'trust-score'; // reset
                        const score = data.score || data.trustScore;
                        if (score >= 95) scoreEl.classList.add('trust-high');
                        else scoreEl.classList.add('trust-med');

                        card.classList.add('visible');
                    }
                }
            });

            document.body.addEventListener('mousemove', (e) => {
                if (card.classList.contains('visible')) {
                    // Offset from mouse
                    let x = e.clientX + 20;
                    let y = e.clientY + 20;

                    // Boundary checks
                    if (x + 320 > window.innerWidth) x = e.clientX - 340;
                    if (y + 150 > window.innerHeight) y = e.clientY - 150;

                    card.style.left = x + 'px';
                    card.style.top = y + 'px';
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('citation-spade')) {
                    card.classList.remove('visible');
                }
            });

            // Click handler for citation spades - opens source URL
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('citation-spade')) {
                    const id = e.target.getAttribute('data-id');
                    const data = getCitationData(id);

                    if (data && data.url) {
                        // Open URL in new tab with referrer
                        window.open(data.url, '_blank', 'noopener');
                    } else if (data && data.domain) {
                        // Fallback: construct a search URL from domain and title
                        const searchQuery = encodeURIComponent(`${data.title} site:${data.domain.toLowerCase()}`);
                        window.open(`https://www.google.com/search?q=${searchQuery}`, '_blank', 'noopener');
                    }
                }
            });

            // === FRACTAL TRIGGER TOOLTIP ===
            const fractalTooltip = document.createElement('div');
            fractalTooltip.className = 'fractal-tooltip';
            fractalTooltip.innerHTML = `
                <div class="fractal-tooltip-header">
                    <span class="fractal-tooltip-title"></span>
                    <span class="fractal-tooltip-action"></span>
                </div>
                <div class="fractal-tooltip-content"></div>
                <div class="fractal-tooltip-cost" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(59, 130, 246, 0.2); font-size: 10px;"></div>
            `;
            document.body.appendChild(fractalTooltip);

            const fractalTitleEl = fractalTooltip.querySelector('.fractal-tooltip-title');
            const fractalContentEl = fractalTooltip.querySelector('.fractal-tooltip-content');
            const fractalActionEl = fractalTooltip.querySelector('.fractal-tooltip-action');
            const fractalCostEl = fractalTooltip.querySelector('.fractal-tooltip-cost');

            // Helper to get context data
            function getContextData(key) {
                const currentReport = reports[currentArticleKey];
                if (currentReport?.contextData?.[key]) return currentReport.contextData[key];
                if (window.dynamicContextData?.[key]) return window.dynamicContextData[key];
                return null;
            }

            // Fractal trigger hover
            document.body.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('fractal-trigger')) {
                    const onclickAttr = e.target.getAttribute('onclick');
                    const keyMatch = onclickAttr?.match(/expandContext\(this,\s*'([^']+)'\)/);
                    const key = keyMatch ? keyMatch[1] : null;
                    const termText = e.target.textContent.trim();

                    const contextData = key ? getContextData(key) : null;

                    fractalTitleEl.textContent = termText;
                    if (contextData && contextData.expanded) {
                        fractalContentEl.textContent = contextData.expanded.substring(0, 200) + (contextData.expanded.length > 200 ? '...' : '');
                        fractalActionEl.textContent = 'Click to explore';
                    } else {
                        fractalContentEl.textContent = 'Click to generate a fractal analysis on this topic';
                        fractalActionEl.textContent = 'Generate';
                    }

                    // Show free/cost indicator
                    const isFree = userRemainingDives > 0;
                    if (isFree) {
                        fractalCostEl.innerHTML = `<span style="color: #10b981;">âœ“ FREE</span> <span style="color: var(--text-muted);">(${userRemainingDives} remaining today)</span>`;
                    } else {
                        fractalCostEl.innerHTML = `<span style="color: #f59e0b;">âš ï¸ Uses token</span> <span style="color: var(--text-muted);">(daily limit reached)</span>`;
                    }

                    fractalTooltip.classList.add('visible');
                }
            });

            document.body.addEventListener('mousemove', (e) => {
                if (fractalTooltip.classList.contains('visible')) {
                    let x = e.clientX + 15;
                    let y = e.clientY + 15;

                    // Boundary checks
                    if (x + 300 > window.innerWidth) x = e.clientX - 315;
                    if (y + 120 > window.innerHeight) y = e.clientY - 130;

                    fractalTooltip.style.left = x + 'px';
                    fractalTooltip.style.top = y + 'px';
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('fractal-trigger')) {
                    fractalTooltip.classList.remove('visible');
                }
            });

            // Global click handler to hide fractal tooltip when clicking anywhere
            document.addEventListener('click', (e) => {
                // Hide fractal tooltip unless clicking on the fractal-trigger itself
                if (!e.target.classList.contains('fractal-trigger') && !e.target.closest('.fractal-tooltip')) {
                    fractalTooltip.classList.remove('visible');
                }
            });

            // Init Living Numbers Observer
            initLivingNumbers();
        }

        function initLivingNumbers() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const target = parseInt(el.getAttribute('data-target'));
                        const suffix = el.getAttribute('data-suffix');
                        const prefix = suffix.startsWith('$') ? '' : (el.innerText.includes('$') ? '$' : ''); // Try to keep existing prefix logic or simple
                        // Actually, let's just use raw counting logic
                        let current = 0;
                        const duration = 1500; // ms
                        const stepTime = 20;
                        const steps = duration / stepTime;
                        const increment = target / steps;

                        const timer = setInterval(() => {
                            current += increment;
                            if (current >= target) {
                                current = target;
                                clearInterval(timer);
                            }
                            // Formatter
                            let display = Math.floor(current);
                            if (el.innerText.includes('$') || suffix === 'B') display = '$' + display; // simple hack for now

                            el.innerText = display + suffix;
                        }, stepTime);

                        observer.unobserve(el);
                    }
                });
            }, { threshold: 0.5 });

            document.querySelectorAll('.living-number').forEach(el => observer.observe(el));
        }

        // Add ?ref=GenuVerity to all external links
        function initRefLinks() {
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.hostname !== window.location.hostname && !link.href.includes('ref=')) {
                    e.preventDefault();
                    const url = new URL(link.href);
                    url.searchParams.set('ref', 'GenuVerity');
                    window.open(url.toString(), '_blank');
                }
            });
        }

        // --- 6. GENAI INTEGRATION (LOCAL) ---

        // Extract chartConfigs from partial JSON - critical for timeout recovery
        function extractChartConfigs(text) {
            const charts = {};

            // Look for chartConfigs section - now comes BEFORE content
            const chartSection = text.match(/"chartConfigs"\s*:\s*\{([\s\S]*?)\}\s*,\s*"(?:contextData|citationDatabase|sources|content)"/);
            if (!chartSection) return charts;

            const section = chartSection[1];

            // Extract individual chart definitions - match any chart ID pattern (not just "chart_")
            // Matches IDs like: "chart_main", "plastic_bottles_chart1", "topic_name_chart_1", etc.
            const chartPattern = /"([a-zA-Z_][a-zA-Z0-9_]*(?:chart|Chart)[a-zA-Z0-9_]*)"\s*:\s*(\{[^}]*"type"\s*:\s*"[^"]+"\s*,[^}]*"data"\s*:\s*\{[^}]*\}[^}]*\})/g;
            let match;

            while ((match = chartPattern.exec(section)) !== null) {
                const chartId = match[1];
                const chartJson = match[2];
                try {
                    charts[chartId] = JSON.parse(chartJson);
                    console.log('Extracted chart:', chartId);
                } catch (e) {
                    // Manual extraction fallback
                    const typeMatch = chartJson.match(/"type"\s*:\s*"([^"]+)"/);
                    const titleMatch = chartJson.match(/"title"\s*:\s*"([^"]+)"/);
                    const labelsMatch = chartJson.match(/"labels"\s*:\s*\[([^\]]+)\]/);
                    const valuesMatch = chartJson.match(/"values"\s*:\s*\[([^\]]+)\]/);
                    const colorsMatch = chartJson.match(/"colors"\s*:\s*\[([^\]]+)\]/);

                    if (typeMatch && labelsMatch && valuesMatch) {
                        try {
                            charts[chartId] = {
                                type: typeMatch[1],
                                data: {
                                    labels: JSON.parse('[' + labelsMatch[1] + ']'),
                                    values: JSON.parse('[' + valuesMatch[1] + ']'),
                                    colors: colorsMatch ? JSON.parse('[' + colorsMatch[1] + ']') : ['#3b82f6']
                                },
                                title: titleMatch ? titleMatch[1] : 'Chart'
                            };
                            console.log('Manually extracted chart:', chartId);
                        } catch (e2) {}
                    }
                }
            }

            return charts;
        }

        // Sanitize JSON string - fix common LLM issues
        function sanitizeJsonString(text) {
            // Replace smart quotes with straight quotes
            text = text.replace(/[""]/g, '"').replace(/['']/g, "'");

            // Fix unescaped control characters inside strings
            let result = [];
            let inString = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"' && (i === 0 || text[i-1] !== '\\')) {
                    inString = !inString;
                    result.push(c);
                } else if (inString) {
                    if (c === '\n') result.push('\\n');
                    else if (c === '\r') result.push('\\r');
                    else if (c === '\t') result.push('\\t');
                    else result.push(c);
                } else {
                    result.push(c);
                }
            }
            text = result.join('');

            // Remove trailing commas before } or ]
            text = text.replace(/,(\s*[}\]])/g, '$1');

            return text;
        }

        // Client-side JSON repair for truncated responses (global scope)
        function repairTruncatedJSON(text) {
            if (!text || typeof text !== 'string') return null;

            text = text.trim();

            // Remove markdown fences
            if (text.startsWith('```json')) text = text.slice(7);
            if (text.startsWith('```')) text = text.slice(3);
            if (text.endsWith('```')) text = text.slice(0, -3);
            text = text.trim();

            // Sanitize common LLM JSON issues
            text = sanitizeJsonString(text);

            // Try parsing as-is first
            try {
                return JSON.parse(text);
            } catch (e) {
                console.log('Initial parse failed:', e.message);
            }

            // Count unclosed braces/brackets
            let openBraces = 0, openBrackets = 0;
            let inString = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"' && (i === 0 || text[i-1] !== '\\')) {
                    inString = !inString;
                }
                if (!inString) {
                    if (c === '{') openBraces++;
                    else if (c === '}') openBraces--;
                    else if (c === '[') openBrackets++;
                    else if (c === ']') openBrackets--;
                }
            }

            // Close string if needed
            let repaired = text;
            if (inString) repaired += '"';

            // Close brackets then braces
            repaired += ']'.repeat(Math.max(0, openBrackets));
            repaired += '}'.repeat(Math.max(0, openBraces));

            try {
                const data = JSON.parse(repaired);
                console.log('JSON repair successful');
                data._partial = true;
                return data;
            } catch (e) {
                console.log('JSON repair failed:', e);
            }

            // Last resort: extract key fields with regex - PRESERVE CHARTS!
            try {
                const keyMatch = text.match(/"key"\s*:\s*"([^"]+)"/);
                const titleMatch = text.match(/"title"\s*:\s*"([^"]+)"/);
                const cardTitleMatch = text.match(/"cardTitle"\s*:\s*"([^"]+)"/);
                const cardTagMatch = text.match(/"cardTag"\s*:\s*"([^"]+)"/);
                const cardDescMatch = text.match(/"cardDescription"\s*:\s*"([^"]+)"/);

                if (keyMatch && titleMatch) {
                    // CRITICAL: Extract chartConfigs even from truncated JSON
                    const chartConfigs = extractChartConfigs(text);
                    console.log('Extracted', Object.keys(chartConfigs).length, 'charts from truncated JSON');

                    // Extract content - it comes AFTER chartConfigs now
                    const contentMatch = text.match(/"content"\s*:\s*"([\s\S]*?)(?:"\s*[,}]|$)/);
                    let content = contentMatch ? contentMatch[1] : '<p class="prose-text">Article content was truncated. The charts and data are preserved.</p>';

                    // Unescape content
                    content = content.replace(/\\"/g, '"').replace(/\\n/g, '\n');

                    return {
                        key: keyMatch[1],
                        title: titleMatch[1],
                        cardTitle: cardTitleMatch ? cardTitleMatch[1] : titleMatch[1].substring(0, 50),
                        cardTag: cardTagMatch ? cardTagMatch[1] : 'INVESTIGATION',
                        cardDescription: cardDescMatch ? cardDescMatch[1] : '',
                        content: content,
                        chartConfigs: chartConfigs,  // PRESERVE CHARTS!
                        contextData: {},
                        citationDatabase: {},
                        sources: [],
                        _partial: true
                    };
                }
            } catch (e) {
                console.log('Regex extraction failed:', e);
            }

            return null;
        }

        // Progress update helper
        function updateProgress(stage, percent, message) {
            // Update subtitle
            const subtitle = document.getElementById('loader-subtitle');
            if (subtitle) subtitle.textContent = message;

            // Update progress bar
            const progressBar = document.getElementById('loader-progress-bar');
            if (progressBar) progressBar.style.width = percent + '%';

            // Update percent display
            const percentDisplay = document.getElementById('loader-percent');
            if (percentDisplay) percentDisplay.textContent = percent + '%';

            // Map backend stages to UI elements
            const stageMap = {
                'init': 'status-init',
                'connect': 'status-connect',
                'research': 'status-research',
                'title': 'status-writing',
                'writing': 'status-writing',
                'analysis': 'status-analysis',
                'deep': 'status-analysis',
                'charts': 'status-charts',
                'sources': 'status-sources',
                'complete': 'status-complete'
            };

            // Reset all stages
            document.querySelectorAll('#loader-status-stages .status-item').forEach(el => {
                el.classList.remove('active', 'done');
            });

            // Mark completed stages
            const stageOrder = ['init', 'connect', 'research', 'writing', 'analysis', 'charts', 'sources', 'complete'];
            const currentIdx = stageOrder.indexOf(stage === 'title' ? 'writing' : (stage === 'deep' ? 'analysis' : stage));

            stageOrder.forEach((s, idx) => {
                const elId = 'status-' + s;
                const el = document.getElementById(elId);
                if (el) {
                    if (idx < currentIdx) {
                        el.classList.add('done');
                    } else if (idx === currentIdx) {
                        el.classList.add('active');
                    }
                }
            });
        }

        // Reset progress UI
        function resetProgressUI() {
            document.querySelectorAll('#loader-status-stages .status-item').forEach(el => {
                el.classList.remove('active', 'done');
            });
            const progressBar = document.getElementById('loader-progress-bar');
            if (progressBar) progressBar.style.width = '0%';
            const percentDisplay = document.getElementById('loader-percent');
            if (percentDisplay) percentDisplay.textContent = '0%';
        }

        async function generateReport(initialTopic = null) {
            let topic = initialTopic;
            if (!topic) {
                topic = prompt("Enter a topic for the GenuVerity Intelligence Engine:");
            }
            if (!topic) return;

            // Register this generation (returns null if at max capacity)
            const genId = registerGeneration(topic, 'report');
            if (!genId) return;

            // Reset enhance count for new article
            resetEnhanceCount();

            // Visual feedback on search box button (brief)
            const searchBtn = document.querySelector('#generate-search-box button');
            const searchInput = document.getElementById('generate-input');
            const originalBtnContent = searchBtn ? searchBtn.innerHTML : '';
            if (searchBtn) {
                searchBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
                searchBtn.disabled = true;
                lucide.createIcons();
            }
            if (searchInput) {
                searchInput.value = '';
                searchInput.placeholder = 'Generation started in background...';
            }

            // Restore search box quickly so user can queue more
            setTimeout(() => {
                if (searchBtn) {
                    searchBtn.innerHTML = originalBtnContent;
                    searchBtn.disabled = false;
                }
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'What do you want to investigate?';
                }
                lucide.createIcons();
            }, 1500);

            // Run generation in background (non-blocking)
            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "Generation failed");
                }

                // Handle SSE streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let articleContent = null;
                let currentEvent = null;
                let debugLog = [];

                debugLog.push(`[SSE] Starting stream for topic: ${topic}`);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        debugLog.push(`[SSE] Stream ended. articleContent type: ${typeof articleContent}`);
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    debugLog.push(`[SSE] Received chunk: ${chunk.length} bytes, buffer now: ${buffer.length} bytes`);

                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                            debugLog.push(`[SSE] Event type: ${currentEvent}`);
                        } else if (line.startsWith('data: ')) {
                            if (!currentEvent) {
                                debugLog.push(`[SSE] WARNING: data line without event type!`);
                                continue;
                            }
                            try {
                                const data = JSON.parse(line.slice(6));
                                debugLog.push(`[SSE] Parsed ${currentEvent} data: ${typeof data}`);

                                if (currentEvent === 'progress') {
                                    // Update the generation card instead of full-screen loader
                                    updateGenerationProgress(genId, data.percent, data.message);
                                } else if (currentEvent === 'content') {
                                    articleContent = data;
                                    debugLog.push(`[SSE] Content received! Keys: ${Object.keys(data).join(', ')}`);
                                } else if (currentEvent === 'error') {
                                    debugLog.push(`[SSE] Error event: ${data}`);
                                    throw new Error(data);
                                }
                            } catch (parseErr) {
                                debugLog.push(`[SSE] JSON parse error: ${parseErr.message}`);
                                debugLog.push(`[SSE] Raw data (first 200): ${line.slice(6, 206)}`);
                            }
                            currentEvent = null;
                        }
                    }
                }

                console.log('[Generate Debug Log]', debugLog.join('\n'));

                try {
                    const existingLogs = JSON.parse(localStorage.getItem('genuverity_debug') || '[]');
                    existingLogs.push({ timestamp: new Date().toISOString(), topic, log: debugLog });
                    while (existingLogs.length > 10) existingLogs.shift();
                    localStorage.setItem('genuverity_debug', JSON.stringify(existingLogs));
                } catch (e) {}

                if (articleContent === null) {
                    console.error('[Generate] No content received! Debug log:', debugLog);
                    throw new Error('No content received from server. Check console for debug log.');
                }

                let data;
                if (typeof articleContent === 'object' && articleContent !== null) {
                    data = articleContent;
                    console.log('[Generate] Received article object with keys:', Object.keys(data));
                } else {
                    console.error('[Generate] Unexpected content type:', typeof articleContent, articleContent);
                    throw new Error(`Unexpected content type: ${typeof articleContent}. Check console.`);
                }

                const key = data.key || topic.toLowerCase().replace(/\s+/g, '_').slice(0, 20);
                reports[key] = data;

                // Mark generation as complete - user can click "View" to see it
                completeGeneration(genId, key, data);

            } catch (e) {
                console.error('[Generate] Error:', e);
                // Update card to show error state
                updateGenerationProgress(genId, 0, `Error: ${e.message}`);
                // Remove after a delay so user sees the error
                setTimeout(() => removeGeneration(genId), 5000);
            }
        }

        // Detect if input looks like a fact-check request
        function detectInputType(text) {
            if (!text || text.length < 3) return 'investigate';

            // EARLY DETECTION: "[Group] are" pattern - classic prejudicial claim structure
            // Triggers as soon as user types "X are" where X looks like a group noun
            const earlyClaimPattern = /\b(people|they|immigrants?|illegals?|refugees?|muslims?|jews?|christians?|mexicans?|chinese|americans?|democrats?|republicans?|liberals?|conservatives?|haitians?|somalis?|africans?|asians?|blacks?|whites?|men|women|kids|children|teachers?|cops?|police|politicians?|elites?|rich|poor|homeless|criminals?|terrorists?)\s+are\s+/i;
            if (earlyClaimPattern.test(text)) return 'fact_check';

            // Explicit fact-check patterns
            const explicitFactCheckPatterns = [
                /^["'].*["']$/,                         // Quoted text: "Trump said X"
                /is it true|did .+ really/i,           // Question format
                /fact.?check|verify this|check this/i, // Explicit keywords
                /said that|claimed|stated|announced/i, // Attribution language
                /true or false|real or fake/i,         // Binary question
                /debunk|myth|hoax|rumor|conspiracy/i,  // Debunking language
                /^did\s+/i,                            // Starts with "Did"
                /\btrue\??$/i,                         // Ends with "true?"
                /^is\s+(the|it|this|that)\s+/i,       // "Is the earth flat"
                /^are\s+(there|they|these)\s+/i,      // "Are there aliens"
            ];

            for (const pattern of explicitFactCheckPatterns) {
                if (pattern.test(text)) return 'fact_check';
            }

            // Claim-like statements (declarative assertions that could be true/false)
            const claimPatterns = [
                /\bcause[sd]?\s+(cancer|autism|death|disease)/i,  // "X causes cancer/autism"
                /\bare\s+eating\b/i,                               // "X are eating Y"
                /\bare\s+(committing|doing|taking|getting|stealing|killing)/i, // "X are committing crimes"
                /\b(is|are)\s+(flat|round|fake|real|a\s+hoax)/i,  // "earth is flat"
                /\b(doesn't|does not|don't|do not)\s+exist/i,     // "X doesn't exist"
                /\b(never|didn't|did not)\s+(happen|land|go)/i,   // "moon landing never happened"
                /\bstole\s+(the\s+)?election/i,                   // "X stole the election"
                /\bis\s+(a\s+)?(fraud|scam|fake|hoax|lie)/i,      // "X is a fraud"
                /\b(illegals?|immigrants?)\s+(are|is)\s+/i,       // Immigration claims
                /\bcontrol(s|led)?\s+(the\s+)?(media|banks|government|world)/i, // Conspiracy patterns
                /\b(chemtrails?|5g|microchip|tracking)/i,         // Common conspiracy topics
                /\bvaccine[sd]?\s+(are|is|cause|don't|kill)/i,   // Vaccine claims
                /\bgovernment\s+(is\s+)?(hiding|lying|covering)/i, // Government conspiracy
                /\bproven\s+(false|true|wrong|right)/i,           // "proven false"
                /\b(exposed|exposed as|caught)\b/i,               // "exposed as a liar"
                /\b(crime|crimes|criminal|murder|rape|theft|fraud)\b/i, // Crime-related claims
                /\bdeport(ation|ed|ing)?\b/i,                     // Deportation claims
                /\billegal(ly)?\b/i,                              // "illegal" anything
            ];

            for (const pattern of claimPatterns) {
                if (pattern.test(text)) return 'fact_check';
            }

            // Short declarative statements (under 100 chars, no question mark, looks like a claim)
            if (text.length < 100 && !text.includes('?')) {
                // Check if it's structured like a claim (subject + verb + predicate)
                const looksLikeClaim = /^[A-Z]?[a-z]+\s+(is|are|was|were|has|have|had|will|can|could|would|should|did|does|do)\s+/i.test(text);
                const hasActionVerb = /\b(eating|killing|stealing|hiding|lying|controlling|destroying|poisoning|spreading|causing|committing|raping|murdering|invading|replacing)\b/i.test(text);

                if (looksLikeClaim && hasActionVerb) {
                    return 'fact_check';
                }
            }

            return 'investigate';
        }

        // Track user's manual mode selection (null = auto-detect)
        let userSelectedMode = null;

        // Set mode manually (called when user clicks toggle buttons)
        function setGenerateMode(mode) {
            userSelectedMode = mode;
            updateModeToggleUI(mode);
        }

        // Update the mode toggle UI to reflect current mode
        function updateModeToggleUI(mode) {
            const investigateBtn = document.getElementById('mode-investigate');
            const factCheckBtn = document.getElementById('mode-fact-check');
            const generateBtn = document.getElementById('generate-btn');
            const generateLabel = document.getElementById('generate-btn-label');

            if (!investigateBtn || !factCheckBtn) return;

            // Reset both buttons
            investigateBtn.classList.remove('active');
            factCheckBtn.classList.remove('active');
            generateBtn?.classList.remove('fact-check-mode');

            if (mode === 'fact_check') {
                factCheckBtn.classList.add('active');
                generateBtn?.classList.add('fact-check-mode');
                if (generateLabel) generateLabel.textContent = 'Fact Check';
            } else {
                investigateBtn.classList.add('active');
                if (generateLabel) generateLabel.textContent = 'Investigate';
            }
        }

        // Update mode indicator as user types (auto-detect unless manually set)
        function updateGenerateMode(value) {
            // If user manually selected a mode, don't auto-change
            if (userSelectedMode !== null) return;

            const detectedMode = detectInputType(value);

            if (value.length < 3) {
                // Reset to fact_check (the default) when input is short
                updateModeToggleUI('fact_check');
                return;
            }

            updateModeToggleUI(detectedMode);
        }

        // Generate fact check article
        async function generateFactCheck(claim) {
            // Register this generation (returns null if at max capacity)
            const genId = registerGeneration(claim, 'fact_check');
            if (!genId) return;

            try {
                const response = await fetch('/api/fact-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ claim })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            const eventType = line.slice(7).trim();
                            continue;
                        }
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                if (data.stage && data.percent !== undefined) {
                                    // Progress update
                                    updateGenerationProgress(genId, data.percent, data.message);
                                } else if (data.key) {
                                    // Content received - fact check complete
                                    console.log('[FactCheck] Generated:', data.key);

                                    // Store in reports cache
                                    reports[data.key] = data;

                                    // Mark generation as complete
                                    completeGeneration(genId, data.key, data);

                                    // Auto-load the fact check
                                    renderReportData(data, true);
                                    currentArticleKey = data.key;

                                    // Show notification
                                    const shortTitle = (data.cardTitle || data.title || claim).substring(0, 40);
                                    showNotification(`Fact check complete: ${shortTitle}`, 'success');
                                }
                            } catch (e) {
                                // Not JSON, skip
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('[FactCheck] Error:', e);
                updateGenerationProgress(genId, 0, `Error: ${e.message}`);
                setTimeout(() => removeGeneration(genId), 5000);
            }
        }

        // Trigger generate from search box - checks for similar articles first
        async function triggerGenerate() {
            const input = document.getElementById('generate-input');
            const topic = input?.value?.trim();
            if (!topic) return;

            // Use user's manual selection if set, otherwise use fact_check as default
            const mode = userSelectedMode !== null ? userSelectedMode : 'fact_check';

            // Show brief checking indicator
            const searchBtn = document.querySelector('#generate-search-box button');
            const originalBtnContent = searchBtn ? searchBtn.innerHTML : '';
            if (searchBtn) {
                searchBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>';
                searchBtn.disabled = true;
                lucide.createIcons();
            }

            try {
                // Check cache for exact match or similar articles
                const cacheResult = await checkIfCached(topic);

                // Restore button
                if (searchBtn) {
                    searchBtn.innerHTML = originalBtnContent;
                    searchBtn.disabled = false;
                    lucide.createIcons();
                }

                // If exact match, load it directly (free)
                if (cacheResult.cached && cacheResult.article) {
                    input.value = '';
                    userSelectedMode = null;
                    updateModeToggleUI('fact_check');
                    loadReport(cacheResult.article.key);
                    showNotification('Found existing article - loaded for free!', 'success');
                    return;
                }

                // If similar articles found, show modal to let user choose
                if (cacheResult.similar && cacheResult.similar.length > 0) {
                    showSimilarArticlesModal(topic, cacheResult.similar, mode);
                    // Don't clear input yet - user might cancel
                    return;
                }

                // No matches - proceed with generation
                input.value = '';
                userSelectedMode = null;
                updateModeToggleUI('fact_check');

                if (mode === 'fact_check') {
                    generateFactCheck(topic);
                    showNotification(`Fact-checking: "${topic.substring(0, 30)}..."`, 'info');
                } else {
                    generateReport(topic);
                }
            } catch (e) {
                console.error('Cache check failed:', e);
                // Restore button and proceed with generation anyway
                if (searchBtn) {
                    searchBtn.innerHTML = originalBtnContent;
                    searchBtn.disabled = false;
                    lucide.createIcons();
                }
                input.value = '';
                userSelectedMode = null;
                updateModeToggleUI('fact_check');

                if (mode === 'fact_check') {
                    generateFactCheck(topic);
                } else {
                    generateReport(topic);
                }
            }
        }

        // Initialize - start on portal view (no default report load)

        // ============================================
        // PASTE HANDLER: Images, Twitter/X links, YouTube links
        // ============================================

        let extractedClaimData = null; // Store extracted claim from paste

        function clearPastedContent() {
            extractedClaimData = null;
            const preview = document.getElementById('pasted-content-preview');
            if (preview) preview.style.display = 'none';
            document.getElementById('pasted-image-thumb').style.display = 'none';
            document.getElementById('generate-input').placeholder = 'Type a claim, question, or paste a tweet/YouTube link/meme screenshot...';
        }

        function showPastedPreview(type, isExtracting = true) {
            const preview = document.getElementById('pasted-content-preview');
            const typeEl = document.getElementById('pasted-content-type');
            const textEl = document.getElementById('pasted-content-text');
            const metaEl = document.getElementById('pasted-content-meta');
            const labelEl = document.getElementById('pasted-type-label');

            preview.style.display = 'flex';
            preview.classList.toggle('extracting', isExtracting);

            if (isExtracting) {
                typeEl.innerHTML = '<span class="extracting-spinner"></span><span id="pasted-type-label">Extracting claim...</span>';
                textEl.textContent = '';
                metaEl.textContent = '';
            }

            // Set type-specific styling
            typeEl.className = 'pasted-content-type ' + type;
            lucide.createIcons();
        }

        function updatePastedPreview(result, type) {
            const preview = document.getElementById('pasted-content-preview');
            const typeEl = document.getElementById('pasted-content-type');
            const textEl = document.getElementById('pasted-content-text');
            const metaEl = document.getElementById('pasted-content-meta');

            preview.classList.remove('extracting');

            const icons = {
                'image': 'image',
                'twitter': 'twitter',
                'youtube': 'youtube'
            };

            const labels = {
                'image': 'Meme/Image',
                'twitter': 'X/Twitter Post',
                'youtube': 'YouTube Video'
            };

            typeEl.innerHTML = `<i data-lucide="${icons[type] || 'file'}" class="w-4 h-4"></i><span>${labels[type] || 'Content'}</span>`;
            textEl.textContent = result.claim || result.extracted_text || 'No claim extracted';
            metaEl.textContent = result.context || '';

            // Store for submission
            extractedClaimData = result;

            // Update textarea with extracted claim
            const input = document.getElementById('generate-input');
            if (input && result.claim) {
                input.value = result.claim;
                updateGenerateMode(result.claim);
            }

            lucide.createIcons();
        }

        async function extractClaimFromContent(inputType, content) {
            try {
                const response = await fetch('/api/extract-claim', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input_type: inputType, content: content })
                });
                return await response.json();
            } catch (e) {
                console.error('Extract claim error:', e);
                return { success: false, error: e.message };
            }
        }

        function detectSocialMediaLink(text) {
            // Twitter/X
            if (/(?:twitter\.com|x\.com)\/\w+\/status\/\d+/.test(text)) {
                return { type: 'twitter', url: text.match(/(https?:\/\/(?:twitter\.com|x\.com)\/\w+\/status\/\d+)/)?.[1] };
            }
            // YouTube
            if (/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)/.test(text)) {
                return { type: 'youtube', url: text.match(/(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)[a-zA-Z0-9_-]+)/)?.[1] };
            }
            return null;
        }

        // Initialize paste handler on textarea
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('generate-input');
            if (!textarea) return;

            // Handle paste event
            textarea.addEventListener('paste', async (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;

                // Check for image paste
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        if (!file) return;

                        // Show preview with image thumbnail
                        showPastedPreview('image', true);
                        const thumb = document.getElementById('pasted-image-thumb');

                        // Convert to base64
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            const base64 = event.target.result;
                            thumb.src = base64;
                            thumb.style.display = 'block';

                            // Extract claim from image
                            const result = await extractClaimFromContent('image', base64);
                            if (result.success) {
                                updatePastedPreview(result, 'image');
                                showNotification('Claim extracted from image!', 'success');
                            } else {
                                updatePastedPreview({ claim: 'Failed to extract claim', context: result.error }, 'image');
                                showNotification('Failed to extract claim from image', 'error');
                            }
                        };
                        reader.readAsDataURL(file);
                        return;
                    }
                }

                // Check for social media link paste (allow default paste behavior but also process)
                setTimeout(async () => {
                    const pastedText = textarea.value;
                    const socialLink = detectSocialMediaLink(pastedText);

                    if (socialLink) {
                        showPastedPreview(socialLink.type, true);

                        const result = await extractClaimFromContent(socialLink.type, socialLink.url);
                        if (result.success) {
                            updatePastedPreview(result, socialLink.type);
                            showNotification(`Content extracted from ${socialLink.type === 'twitter' ? 'X/Twitter' : 'YouTube'}!`, 'success');
                        } else {
                            updatePastedPreview({ claim: 'Failed to fetch content', context: result.error }, socialLink.type);
                        }
                    }
                }, 100);
            });
        });

        // ============================================
        // PHASE 1: QUICK WINS FEATURES
        // ============================================

        // === DARK/LIGHT THEME SYSTEM ===
        let currentArticleKey = 'congress_trading';
        let currentEnhanceCount = 0; // Track how many times the current article has been enhanced
        let pendingEnhancedReport = null; // Store the enhanced report until user clicks "Apply"
        let isEnhancing = false; // Track if enhancement is in progress
        let originalVersions = {}; // Store original article versions before enhancement
        let isShowingOriginal = false; // Track if currently showing original version

        // Update the enhance count badge
        function updateEnhanceCountBadge(count) {
            const badge = document.getElementById('enhance-count-badge');
            if (!badge) return;

            badge.textContent = count;
            if (count > 0) {
                badge.classList.add('visible');
                // Trigger pulse animation
                badge.classList.remove('pulse');
                void badge.offsetWidth; // Force reflow
                badge.classList.add('pulse');
            } else {
                badge.classList.remove('visible');
            }
        }

        // Reset enhance count when loading a new article
        // Note: If article was previously enhanced, this will be overridden in loadReport
        function resetEnhanceCount() {
            // Don't reset here - let loadReport handle restoring the correct count
            // This is kept for backwards compatibility with other callers
            currentEnhanceCount = 0;
            updateEnhanceCountBadge(0);
        }

        function initTheme() {
            const saved = localStorage.getItem('genuverity-theme');
            // If user has explicit preference, use it
            // Otherwise, check system preference, defaulting to dark
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else {
                // Let CSS media query handle system preference
                // Only set explicit theme if user has dark preference on a light-preferring system
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                // Light mode handled by CSS media query
            }
            // Re-initialize lucide icons to ensure theme toggle icons render
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('genuverity-theme', theme);

            // Re-render charts with new theme colors
            if (currentArticleKey && reports[currentArticleKey]) {
                const report = reports[currentArticleKey];
                // For dynamic articles with chartConfigs, use renderDynamicCharts
                if (report.chartType === 'dynamic' && report.chartConfigs) {
                    console.log('[Theme] Re-rendering dynamic charts after theme change');
                    // Skip Gemini generation since we already have them (or already tried)
                    renderDynamicCharts(report.chartConfigs, report.title || 'Investigation', true);
                } else {
                    renderCharts(report.chartType);
                }
            }

            // Re-initialize lucide icons for theme toggle
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Toggle between dark and light mode
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            // If no explicit theme or dark, switch to light
            // If light, switch to dark
            const newTheme = (current === 'light') ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't set explicit preference
            if (!localStorage.getItem('genuverity-theme')) {
                if (e.matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }
        });

        // === SOURCES TAB SWIPE GESTURES ===
        // Supports Mac trackpad horizontal swipes and touch swipes on mobile

        // Switch to a specific sources tab by index
        function switchToSourcesTab(tabIdx) {
            const tabs = document.querySelectorAll('.sources-tab');
            const panels = document.querySelectorAll('.sources-tab-panel');
            if (tabs.length === 0) return;

            // Clamp to valid range
            tabIdx = Math.max(0, Math.min(parseInt(tabIdx), tabs.length - 1));

            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            tabs[tabIdx].classList.add('active');

            // Update active panel
            panels.forEach(p => p.classList.remove('active'));
            const targetPanel = document.querySelector(`.sources-tab-panel[data-panel="${tabIdx}"]`);
            if (targetPanel) targetPanel.classList.add('active');
        }

        // Get current active tab index
        function getCurrentSourcesTabIndex() {
            const activeTab = document.querySelector('.sources-tab.active');
            return activeTab ? parseInt(activeTab.dataset.tab) : 0;
        }

        // Get total number of sources tabs
        function getSourcesTabCount() {
            return document.querySelectorAll('.sources-tab').length;
        }

        // Initialize swipe gesture handlers
        function initSourcesSwipeGestures() {
            const panelsContainer = document.querySelector('.sources-tab-panels');
            if (!panelsContainer) return;

            // === TRACKPAD SWIPE (Mac/Windows) ===
            // Uses wheel event with deltaX for horizontal scrolling
            let accumulatedDeltaX = 0;
            let wheelTimeout = null;
            const SWIPE_THRESHOLD = 50; // Accumulated pixels needed to trigger tab switch

            panelsContainer.addEventListener('wheel', (e) => {
                // Only respond to horizontal scroll (trackpad two-finger swipe)
                if (Math.abs(e.deltaX) > Math.abs(e.deltaY) && Math.abs(e.deltaX) > 2) {
                    e.preventDefault();

                    accumulatedDeltaX += e.deltaX;

                    // Clear existing timeout
                    if (wheelTimeout) clearTimeout(wheelTimeout);

                    // Check if threshold reached
                    if (Math.abs(accumulatedDeltaX) >= SWIPE_THRESHOLD) {
                        const currentIdx = getCurrentSourcesTabIndex();
                        const totalTabs = getSourcesTabCount();

                        if (accumulatedDeltaX > 0 && currentIdx < totalTabs - 1) {
                            // Swiped left -> go to next tab
                            switchToSourcesTab(currentIdx + 1);
                        } else if (accumulatedDeltaX < 0 && currentIdx > 0) {
                            // Swiped right -> go to previous tab
                            switchToSourcesTab(currentIdx - 1);
                        }

                        accumulatedDeltaX = 0;
                    }

                    // Reset accumulator after a pause in scrolling
                    wheelTimeout = setTimeout(() => {
                        accumulatedDeltaX = 0;
                    }, 150);
                }
            }, { passive: false });

            // === TOUCH SWIPE (Mobile/Tablet) ===
            let touchStartX = 0;
            let touchStartY = 0;
            let isSwiping = false;
            const TOUCH_THRESHOLD = 50;

            panelsContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false;
            }, { passive: true });

            panelsContainer.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;

                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchStartX - touchX;
                const deltaY = touchStartY - touchY;

                // Only swipe horizontally if it's primarily a horizontal gesture
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    isSwiping = true;
                    e.preventDefault();
                }
            }, { passive: false });

            panelsContainer.addEventListener('touchend', (e) => {
                if (!isSwiping) {
                    touchStartX = 0;
                    return;
                }

                const touchEndX = e.changedTouches[0].clientX;
                const deltaX = touchStartX - touchEndX;

                if (Math.abs(deltaX) >= TOUCH_THRESHOLD) {
                    const currentIdx = getCurrentSourcesTabIndex();
                    const totalTabs = getSourcesTabCount();

                    if (deltaX > 0 && currentIdx < totalTabs - 1) {
                        // Swiped left -> go to next tab
                        switchToSourcesTab(currentIdx + 1);
                    } else if (deltaX < 0 && currentIdx > 0) {
                        // Swiped right -> go to previous tab
                        switchToSourcesTab(currentIdx - 1);
                    }
                }

                touchStartX = 0;
                isSwiping = false;
            }, { passive: true });
        }

        // --- MARKDOWN EXPORT ---
        async function exportToMarkdown() {
            const title = document.getElementById('report-title').innerText;
            const content = document.getElementById('report-body');
            const filename = 'GenuVerity_' + title.replace(/[^a-z0-9]/gi, '_').substring(0, 50) + '.md';

            // Convert HTML to Markdown
            let markdown = `# ${title}\n\n`;
            markdown += `*Generated by GenuVerity on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}*\n\n---\n\n`;

            // Clone content to manipulate
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;

            // Remove chart canvases and figure containers (keep captions)
            tempDiv.querySelectorAll('canvas').forEach(el => el.remove());

            // Process the HTML to markdown
            let htmlContent = tempDiv.innerHTML;

            // Convert headers
            htmlContent = htmlContent.replace(/<h2[^>]*class="prose-h2"[^>]*>(.*?)<\/h2>/gi, '\n## $1\n\n');

            // Convert highlight-glow to bold
            htmlContent = htmlContent.replace(/<span[^>]*class="highlight-glow"[^>]*>(.*?)<\/span>/gi, '**$1**');

            // Convert living numbers (get the data-target value)
            htmlContent = htmlContent.replace(/<span[^>]*class="living-number"[^>]*data-target="([^"]*)"[^>]*data-suffix="([^"]*)"[^>]*>[^<]*<\/span>/gi, '**$1$2**');

            // Convert fractal triggers to bold
            htmlContent = htmlContent.replace(/<strong[^>]*class="fractal-trigger"[^>]*>(.*?)<\/strong>/gi, '**$1**');

            // Convert citation spades to reference markers
            htmlContent = htmlContent.replace(/<span[^>]*class="citation-spade"[^>]*data-id="([^"]*)"[^>]*>[^<]*<\/span>/gi, '[^$1]');

            // Convert figure captions
            htmlContent = htmlContent.replace(/<div[^>]*class="fig-caption"[^>]*>(.*?)<\/div>/gi, '\n*$1*\n');

            // Remove float-figure divs but keep inner content
            htmlContent = htmlContent.replace(/<div[^>]*class="float-figure[^"]*"[^>]*>/gi, '\n');

            // Convert paragraphs
            htmlContent = htmlContent.replace(/<p[^>]*class="prose-text"[^>]*>(.*?)<\/p>/gi, '$1\n\n');

            // Convert remaining strong/bold
            htmlContent = htmlContent.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            htmlContent = htmlContent.replace(/<b>(.*?)<\/b>/gi, '**$1**');

            // Convert em/italic
            htmlContent = htmlContent.replace(/<em>(.*?)<\/em>/gi, '*$1*');
            htmlContent = htmlContent.replace(/<i>(.*?)<\/i>/gi, '*$1*');

            // Remove remaining HTML tags
            htmlContent = htmlContent.replace(/<[^>]+>/g, '');

            // Clean up whitespace
            htmlContent = htmlContent.replace(/\n{3,}/g, '\n\n');
            htmlContent = htmlContent.replace(/&nbsp;/g, ' ');
            htmlContent = htmlContent.replace(/&amp;/g, '&');
            htmlContent = htmlContent.replace(/&lt;/g, '<');
            htmlContent = htmlContent.replace(/&gt;/g, '>');
            htmlContent = htmlContent.replace(/&quot;/g, '"');

            markdown += htmlContent.trim();

            // Add sources section
            const currentReport = reports[currentArticleKey];
            if (currentReport?.sources?.length) {
                markdown += '\n\n---\n\n## Sources\n\n';
                currentReport.sources.forEach(s => {
                    if (s.url) {
                        markdown += `- [${s.name}](${s.url}) (Trust Score: ${s.score}%)\n`;
                    } else {
                        markdown += `- ${s.name} (Trust Score: ${s.score}%)\n`;
                    }
                });
            }

            // Download the file with better cross-browser support
            const blob = new Blob([markdown], { type: 'text/plain;charset=utf-8' });

            // Try using the modern File System Access API first
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'Markdown Files',
                            accept: { 'text/markdown': ['.md'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    return;
                } catch (err) {
                    // User cancelled or API failed, fall through to legacy method
                    if (err.name !== 'AbortError') console.log('Save picker failed, using fallback');
                }
            }

            // Fallback: create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            a.target = '_self';
            document.body.appendChild(a);

            // Use setTimeout to ensure the click is processed
            setTimeout(() => {
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }, 0);
        }

        // --- PDF EXPORT (IMPROVED) ---
        function exportToPDF() {
            const content = document.getElementById('report-body');
            const title = document.getElementById('report-title').innerText;
            const filename = 'GenuVerity_' + title.replace(/[^a-z0-9]/gi, '_').substring(0, 50) + '.pdf';

            // Show loading state
            const btn = document.querySelector('[onclick="exportToPDF()"]');
            const originalHTML = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Exporting...';
                btn.disabled = true;
            }

            // Get sources for the footer
            const currentReport = reports[currentArticleKey];
            const sourcesHTML = currentReport?.sources?.map(s =>
                `<div style="margin: 4px 0; font-size: 9px; color: #888;">â€¢ ${s.name} (Trust: ${s.score}%)</div>`
            ).join('') || '';

            // Clone and prepare content for PDF
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="padding: 40px; background: #ffffff; color: #1a1a1a; font-family: 'Georgia', serif; line-height: 1.6;">
                    <!-- Header -->
                    <div style="border-bottom: 3px solid #8b6914; padding-bottom: 24px; margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-size: 11px; color: #8b6914; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;">GENUVERITY INTELLIGENCE REPORT</div>
                            <div style="font-size: 10px; color: #666;">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <h1 style="font-size: 32px; font-weight: 700; margin: 0; color: #111; line-height: 1.2;">${title}</h1>
                    </div>

                    <!-- Content -->
                    <div class="pdf-body" style="font-size: 11pt; color: #333;">
                        ${content.innerHTML
                            .replace(/style="[^"]*color:[^"]*"/gi, '')
                            .replace(/class="highlight-glow"/g, 'style="font-weight: bold; background: #f5e6d3; padding: 2px 6px; border-radius: 3px;"')
                            .replace(/class="living-number"/g, 'style="font-family: monospace; color: #8b6914; font-weight: bold;"')
                            .replace(/class="prose-h2"/g, 'style="font-size: 18pt; font-weight: bold; color: #111; margin-top: 28px; margin-bottom: 16px; border-bottom: 1px solid #ddd; padding-bottom: 8px;"')
                            .replace(/class="prose-text"/g, 'style="margin-bottom: 16px; text-align: justify; color: #333;"')
                            .replace(/class="float-figure[^"]*"/g, 'style="margin: 20px 0; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;"')
                            .replace(/class="fig-caption"/g, 'style="font-size: 9pt; color: #666; text-align: center; margin-top: 8px; font-style: italic;"')
                            .replace(/class="citation-spade"/g, 'style="color: #8b6914; font-size: 8pt; vertical-align: super;"')
                            .replace(/class="fractal-trigger"[^>]*/g, 'style="font-weight: bold; color: #6b5020;"')
                        }
                    </div>

                    <!-- Sources Footer -->
                    <div style="margin-top: 48px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
                        <div style="font-size: 10px; font-weight: 700; color: #666; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Sources & Methodology</div>
                        ${sourcesHTML}
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #eee; display: flex; justify-content: space-between; font-size: 8px; color: #999;">
                        <span>Generated by GenuVerity Intelligence Platform</span>
                        <span>genuverity.com</span>
                    </div>
                </div>
            `;

            const opt = {
                margin: [0.4, 0.4, 0.6, 0.4],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    letterRendering: true
                },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(pdfContent).save().then(() => {
                if (btn) {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            });
        }

        // === DEEP DIVE GENERATION ===
        let deepDiveAbortController = null;
        let statusAnimationInterval = null;

        // Animate status indicators during deep dive generation
        function startStatusAnimation() {
            const stages = ['status-init', 'status-connect', 'status-research', 'status-writing', 'status-analysis', 'status-charts', 'status-sources', 'status-complete'];
            const subtitles = [
                'Initializing research pipeline...',
                'Establishing secure connection...',
                'Scanning authoritative sources and cross-referencing data...',
                'Writing investigative analysis...',
                'Deep analysis in progress...',
                'Generating data visualizations...',
                'Verifying and compiling sources...',
                'Finalizing your report...'
            ];
            const loaderSubtitle = document.getElementById('loader-subtitle');
            let currentStage = 0;

            // Reset all stages
            stages.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('active', 'complete');
                }
            });

            // Start first stage
            document.getElementById(stages[0]).classList.add('active');
            loaderSubtitle.textContent = subtitles[0];

            // Progress through stages
            statusAnimationInterval = setInterval(() => {
                if (currentStage < stages.length - 1) {
                    // Mark current as complete
                    document.getElementById(stages[currentStage]).classList.remove('active');
                    document.getElementById(stages[currentStage]).classList.add('complete');

                    // Move to next stage
                    currentStage++;
                    document.getElementById(stages[currentStage]).classList.add('active');
                    loaderSubtitle.textContent = subtitles[currentStage];
                }
            }, 4000); // Advance every 4 seconds
        }

        function stopStatusAnimation() {
            if (statusAnimationInterval) {
                clearInterval(statusAnimationInterval);
                statusAnimationInterval = null;
            }
        }

        async function generateDeepDive(topic, context = '', parentKey = '', parentTitle = '') {
            // IMMEDIATELY hide any floating tooltips
            const fractalTooltip = document.querySelector('.fractal-tooltip');
            if (fractalTooltip) {
                fractalTooltip.classList.remove('visible');
            }
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            // Register this generation (returns null if at max capacity)
            const genId = registerGeneration(topic, 'deepdive');
            if (!genId) return;

            // Reset enhance count for new article
            resetEnhanceCount();

            deepDiveAbortController = new AbortController();

            try {
                const response = await fetch('/api/deep-dive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        context,
                        parent_key: parentKey,
                        parent_title: parentTitle
                    }),
                    signal: deepDiveAbortController.signal
                });

                // Check for HTTP errors (rate limiting, etc.)
                if (response.status === 429) {
                    const error = await response.json();
                    throw new Error(error.detail?.message || 'Daily limit exceeded');
                }

                if (!response.ok && !response.headers.get('content-type')?.includes('text/event-stream')) {
                    const error = await response.json().catch(() => ({ detail: 'Generation failed' }));
                    throw new Error(error.detail || 'Generation failed');
                }

                // Handle SSE streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let articleData = null;
                let lastPartialContent = '';
                let currentEvent = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                        } else if (line.startsWith('data: ') && currentEvent) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                console.log('[SSE] Event:', currentEvent, 'Data type:', typeof data);
                                if (currentEvent === 'progress') {
                                    // Update the generation card instead of full-screen loader
                                    updateGenerationProgress(genId, data.percent, data.message);
                                } else if (currentEvent === 'content') {
                                    console.log('[SSE] Received content, keys:', Object.keys(data));
                                    articleData = data;
                                } else if (currentEvent === 'partial') {
                                    console.log('[SSE] Received partial content, length:', typeof data === 'string' ? data.length : 'object');
                                    lastPartialContent = data;
                                } else if (currentEvent === 'rawcontent') {
                                    console.log('[SSE] Received raw content, attempting repair');
                                    articleData = repairTruncatedJSON(data);
                                } else if (currentEvent === 'error') {
                                    console.error('[SSE] Error event:', data);
                                    throw new Error(data);
                                }
                            } catch (parseError) {
                                console.error('[SSE] Parse error:', parseError, 'for event:', currentEvent);
                                if (currentEvent === 'error') throw parseError;
                            }
                            currentEvent = null;
                        }
                    }
                }

                // If no final content but we have partial, try to repair it
                console.log('[SSE] Stream complete. articleData:', !!articleData, 'lastPartialContent:', !!lastPartialContent);
                if (!articleData && lastPartialContent) {
                    console.log('[SSE] Attempting to repair partial content, length:', typeof lastPartialContent === 'string' ? lastPartialContent.length : 'object');
                    articleData = repairTruncatedJSON(lastPartialContent);
                    console.log('[SSE] Repair result:', !!articleData);
                }

                if (!articleData) {
                    console.error('[SSE] No article data - throwing error');
                    throw new Error('No article data received');
                }
                console.log('[SSE] Article data ready, key:', articleData.key, 'title:', articleData.title?.substring(0, 50));

                // Add to reports database
                const key = articleData.key || topic.toLowerCase().replace(/[^a-z0-9]+/g, '_');
                reports[key] = {
                    title: articleData.title,
                    content: articleData.content,
                    chartType: 'dynamic',
                    chartConfigs: articleData.chartConfigs || {},
                    contextData: articleData.contextData || {},
                    citationDatabase: articleData.citationDatabase || {},
                    sources: articleData.sources || [],
                    cardTitle: articleData.cardTitle || articleData.title?.substring(0, 50) || topic,
                    cardTag: articleData.cardTag || 'INVESTIGATION',
                    cardTagColor: articleData.cardTagColor || 'text-blue-400',
                    cardDescription: articleData.cardDescription || topic
                };

                // Store dynamic data globally
                window.dynamicChartConfigs = articleData.chartConfigs || {};
                window.dynamicContextData = articleData.contextData || {};
                window.dynamicCitationDatabase = articleData.citationDatabase || {};

                // Update remaining dives count
                if (articleData._remaining_today !== undefined) {
                    userRemainingDives = articleData._remaining_today;
                } else if (!articleData._from_cache) {
                    userRemainingDives = Math.max(0, userRemainingDives - 1);
                }

                // Mark as cached and save locally
                cachedArticles[topic.toLowerCase()] = true;
                saveGeneratedArticleLocally(key, reports[key]);

                // Mark generation as complete - user can click "View" to see it
                completeGeneration(genId, key, reports[key]);

                // Update badge
                setTimeout(() => {
                    updateDeepDiveBadge();
                }, 200);

            } catch (e) {
                if (e.name === 'AbortError') {
                    console.log('Deep dive cancelled');
                    removeGeneration(genId);
                } else if (e.message?.includes('429') || e.message?.includes('daily_limit') || e.message?.includes('Daily limit')) {
                    console.error('Daily limit exceeded');
                    updateGenerationProgress(genId, 0, 'Daily limit exceeded');
                    userRemainingDives = 0;
                    updateBadgeRemaining();
                    setTimeout(() => removeGeneration(genId), 5000);
                } else {
                    console.error('Deep dive error:', e);
                    updateGenerationProgress(genId, 0, `Error: ${e.message}`);
                    setTimeout(() => removeGeneration(genId), 5000);
                }
            }

            deepDiveAbortController = null;
        }

        function cancelDeepDive() {
            if (deepDiveAbortController) {
                deepDiveAbortController.abort();
            }
            stopStatusAnimation();
            // Legacy loader cleanup (in case still used elsewhere)
            const loader = document.getElementById('deep-dive-loader');
            if (loader) loader.classList.remove('visible');
            const contextPreview = document.getElementById('loader-context-preview');
            if (contextPreview) contextPreview.style.display = 'none';
        }

        // NOTE: renderDynamicCharts is defined earlier in the file (around line 3906)
        // This duplicate has been removed to avoid conflicts

        // === DEEP DIVE CACHE & BADGE SYSTEM ===
        let cachedArticles = {};  // Local cache of known cached articles
        let userRemainingDives = 3;

        // === LOCAL STORAGE PERSISTENCE ===
        const LOCAL_ARTICLES_KEY = 'genuverity-generated-articles';

        function saveGeneratedArticleLocally(key, article) {
            try {
                const stored = JSON.parse(localStorage.getItem(LOCAL_ARTICLES_KEY) || '{}');
                stored[key] = article;
                localStorage.setItem(LOCAL_ARTICLES_KEY, JSON.stringify(stored));
                console.log(`Saved article "${key}" to localStorage`);
            } catch (e) {
                console.error('Failed to save article to localStorage:', e);
            }
        }

        function loadLocallyStoredArticles() {
            try {
                const stored = JSON.parse(localStorage.getItem(LOCAL_ARTICLES_KEY) || '{}');
                let count = 0;
                Object.entries(stored).forEach(([key, article]) => {
                    if (!reports[key]) {
                        reports[key] = article;
                        cachedArticles[key] = true;
                        count++;
                    }
                });
                if (count > 0) {
                    console.log(`Loaded ${count} articles from localStorage`);
                }
            } catch (e) {
                console.error('Failed to load articles from localStorage:', e);
            }
        }

        // Load locally stored articles on startup
        loadLocallyStoredArticles();

        // Fetch user's remaining free dives on load
        async function fetchUserUsage() {
            try {
                const response = await fetch('/api/usage');
                const data = await response.json();
                userRemainingDives = data.remaining;
                updateBadgeRemaining();
            } catch (e) {
                console.error('Failed to fetch usage:', e);
            }
        }

        // Check if a topic is cached (free) - returns { cached, article, similar }
        async function checkIfCached(topic) {
            try {
                const response = await fetch('/api/cache/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                const data = await response.json();
                return {
                    cached: data.cached || false,
                    article: data.cached ? data.article : null,
                    similar: data.similar || []
                };
            } catch (e) {
                return { cached: false, article: null, similar: [] };
            }
        }

        // Similar articles modal state
        let pendingSimilarSearch = null; // { topic, mode }

        function showSimilarArticlesModal(topic, similarArticles, mode) {
            const modal = document.getElementById('similar-articles-modal');
            const queryText = document.getElementById('similar-query-text');
            const listContainer = document.getElementById('similar-articles-list');
            const generateBtn = document.getElementById('similar-generate-btn');

            // Store pending search for generate button
            pendingSimilarSearch = { topic, mode };

            // Set query text
            queryText.textContent = topic;

            // Render similar articles
            listContainer.innerHTML = similarArticles.map(article => {
                const isFactCheck = article.article_type === 'fact_check';
                const typeBadgeClass = isFactCheck ? 'similar-type-badge fact-check' : 'similar-type-badge';
                const typeLabel = isFactCheck ? 'Fact Check' : (article.article_type === 'deep_dive' ? 'Deep Dive' : 'Investigation');

                return `
                    <div class="similar-article-card" onclick="loadSimilarArticle('${article.key}')">
                        <div class="similar-card-header">
                            <span class="similar-match-badge">${article.similarity}% match</span>
                            <span class="${typeBadgeClass}">${typeLabel}</span>
                            <span class="free-badge">FREE</span>
                        </div>
                        <div class="similar-article-title">${article.cardTitle || article.title}</div>
                        ${article.cardDescription ? `<div class="similar-article-desc">${article.cardDescription}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Update generate button text based on mode
            generateBtn.innerHTML = mode === 'fact_check'
                ? '<i data-lucide="scale" class="w-4 h-4"></i> New Fact Check'
                : '<i data-lucide="sparkles" class="w-4 h-4"></i> New Investigation';

            // Show modal
            modal.classList.add('visible');
            lucide.createIcons();
        }

        function closeSimilarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('similar-articles-modal');
            modal.classList.remove('visible');
            pendingSimilarSearch = null;
        }

        function loadSimilarArticle(key) {
            closeSimilarModal();
            loadReport(key);
        }

        function proceedWithGeneration() {
            if (!pendingSimilarSearch) return;
            const { topic, mode } = pendingSimilarSearch;
            closeSimilarModal();

            if (mode === 'fact_check') {
                generateFactCheck(topic);
                showNotification(`Fact-checking: "${topic.substring(0, 30)}..."`, 'info');
            } else {
                generateReport(topic);
            }
        }

        // Attach to generate button
        document.addEventListener('DOMContentLoaded', () => {
            const genBtn = document.getElementById('similar-generate-btn');
            if (genBtn) genBtn.onclick = proceedWithGeneration;
        });

        // === GENERATION STATE MANAGEMENT ===
        const MAX_CONCURRENT_GENERATIONS = 5;
        const activeGenerations = new Map(); // id -> { topic, percent, status, key, data }
        let generationIdCounter = 0;

        function registerGeneration(topic, type = 'report') {
            if (activeGenerations.size >= MAX_CONCURRENT_GENERATIONS) {
                alert(`Maximum ${MAX_CONCURRENT_GENERATIONS} concurrent generations allowed. Please wait for one to complete.`);
                return null;
            }

            const id = `gen_${++generationIdCounter}`;
            activeGenerations.set(id, {
                topic: topic.length > 40 ? topic.substring(0, 37) + '...' : topic,
                fullTopic: topic,
                percent: 0,
                status: 'Initializing...',
                type: type,
                key: null,
                data: null,
                startTime: Date.now()
            });

            renderGenerationCards();
            updateBadgeGenerationState();
            return id;
        }

        function updateGenerationProgress(genId, percent, status) {
            const gen = activeGenerations.get(genId);
            if (!gen) return;

            gen.percent = Math.min(percent, 99); // Keep at 99% until actually complete
            gen.status = status || gen.status;

            // Update both the floating badge card and panel card
            const cards = [
                document.getElementById(`gen-card-${genId}`),
                document.getElementById(`panel-gen-${genId}`)
            ];

            cards.forEach(card => {
                if (card) {
                    const progressBar = card.querySelector('[class*="progress-bar"]');
                    const percentEl = card.querySelector('[class*="percent"]');
                    const statusEl = card.querySelector('[class*="status"]');

                    if (progressBar) progressBar.style.width = `${gen.percent}%`;
                    if (percentEl) percentEl.textContent = `${gen.percent}%`;
                    if (statusEl) statusEl.textContent = gen.status;
                }
            });

            // Update navbar indicator text
            const activeCount = Array.from(activeGenerations.values()).filter(g => g.percent < 100).length;
            const navText = document.getElementById('nav-gen-text');
            if (navText && activeCount > 0) {
                navText.textContent = `${activeCount} generating...`;
            }
        }

        function completeGeneration(genId, articleKey, articleData) {
            const gen = activeGenerations.get(genId);
            if (!gen) return;

            gen.percent = 100;
            gen.status = 'Ready to view';
            gen.key = articleKey;
            gen.data = articleData;

            // Update both the floating badge card and panel card
            const cards = [
                document.getElementById(`gen-card-${genId}`),
                document.getElementById(`panel-gen-${genId}`)
            ];

            cards.forEach(card => {
                if (card) {
                    card.classList.add('complete');
                    const progressBar = card.querySelector('[class*="progress-bar"]');
                    const percentEl = card.querySelector('[class*="percent"]');
                    const statusEl = card.querySelector('[class*="status"]');

                    if (progressBar) progressBar.style.width = '100%';
                    if (percentEl) percentEl.textContent = '100%';
                    if (statusEl) statusEl.textContent = 'Ready to view';
                }
            });

            // Full re-render to show action buttons
            renderGenerationCards();
            updateBadgeGenerationState();
        }

        function removeGeneration(genId) {
            activeGenerations.delete(genId);
            renderGenerationCards();
            updateBadgeGenerationState();
        }

        function viewCompletedGeneration(genId) {
            const gen = activeGenerations.get(genId);
            if (!gen || !gen.key) return;

            // Load the report
            loadReport(gen.key);

            // Remove from active generations
            removeGeneration(genId);
        }

        function renderGenerationCards() {
            // Get generation type info helper
            function getGenTypeInfo(gen) {
                const isEnhance = gen.type === 'enhance';
                const isFactCheck = gen.type === 'fact_check';
                const isInvestigation = gen.type === 'report' || gen.type === 'investigation';

                if (isEnhance) {
                    return { icon: 'sparkles', color: '#06b6d4', label: 'Enhance', cssClass: 'enhance' };
                } else if (isFactCheck) {
                    return { icon: 'scale', color: '#2dd4bf', label: 'Fact Check', cssClass: 'fact-check' };
                } else if (isInvestigation) {
                    return { icon: 'search', color: 'var(--accent-blue)', label: 'Investigation', cssClass: 'investigation' };
                } else {
                    return { icon: 'layers', color: 'var(--accent-green)', label: 'Fractal', cssClass: 'fractal' };
                }
            }

            // Count active (in-progress) and complete generations
            const activeCount = Array.from(activeGenerations.values()).filter(g => g.percent < 100).length;
            const completeCount = activeGenerations.size - activeCount;

            // === 1. Update Navbar Indicator ===
            const navIndicator = document.getElementById('nav-gen-indicator');
            const navText = document.getElementById('nav-gen-text');
            if (navIndicator && navText) {
                if (activeGenerations.size === 0) {
                    navIndicator.classList.remove('visible', 'complete');
                } else if (activeCount > 0) {
                    navIndicator.classList.add('visible');
                    navIndicator.classList.remove('complete');
                    navText.textContent = `${activeCount} generating...`;
                    navIndicator.title = 'Research in progress - click to view';
                } else if (completeCount > 0) {
                    navIndicator.classList.add('visible', 'complete');
                    navText.textContent = `${completeCount} ready`;
                    navIndicator.title = 'Research complete - click to view';
                }
            }

            // === 2. Update Left Panel Generation List ===
            const panelGenList = document.getElementById('gen-list');
            const panelGenCount = document.getElementById('gen-count');

            if (panelGenCount) {
                panelGenCount.textContent = activeGenerations.size;
            }

            if (panelGenList) {
                if (activeGenerations.size === 0) {
                    panelGenList.innerHTML = '<div class="panel-gen-empty">No active research</div>';
                } else {
                    let panelHtml = '';
                    activeGenerations.forEach((gen, id) => {
                        const typeInfo = getGenTypeInfo(gen);
                        const isComplete = gen.percent === 100;
                        const isEnhance = gen.type === 'enhance';

                        // Build action buttons
                        let actionsHtml = '';
                        if (isEnhance) {
                            actionsHtml = isComplete ? `
                                <button class="panel-gen-btn primary enhance" onclick="applyEnhancement()">Apply</button>
                                <button class="panel-gen-btn secondary" onclick="dismissEnhancement(); removeGeneration('${id}')">Dismiss</button>
                            ` : `
                                <button class="panel-gen-btn secondary" onclick="dismissEnhancement(); removeGeneration('${id}')">Cancel</button>
                            `;
                        } else {
                            actionsHtml = isComplete ? `
                                <button class="panel-gen-btn primary" onclick="viewCompletedGeneration('${id}')">View</button>
                                <button class="panel-gen-btn secondary" onclick="removeGeneration('${id}')">Dismiss</button>
                            ` : '';
                        }

                        panelHtml += `
                            <div class="panel-gen-card ${isComplete ? 'complete' : ''} ${isEnhance ? 'enhance' : ''}" id="panel-gen-${id}">
                                <div class="panel-gen-header">
                                    <span class="panel-gen-type ${typeInfo.cssClass}">
                                        <i data-lucide="${typeInfo.icon}" class="w-3 h-3"></i>
                                        ${typeInfo.label}
                                    </span>
                                    <span class="panel-gen-percent">${gen.percent}%</span>
                                </div>
                                <div class="panel-gen-title" title="${gen.fullTopic}">${gen.topic}</div>
                                <div class="panel-gen-progress">
                                    <div class="panel-gen-progress-bar" style="width: ${gen.percent}%"></div>
                                </div>
                                <div class="panel-gen-status">${gen.status}</div>
                                <div class="panel-gen-actions">${actionsHtml}</div>
                            </div>
                        `;
                    });
                    panelGenList.innerHTML = panelHtml;
                }
            }

            // === 3. Update Floating Badge (for mobile/non-article views) ===
            const badgeContainer = document.getElementById('badge-generations');
            if (badgeContainer) {
                if (activeGenerations.size === 0) {
                    badgeContainer.innerHTML = '';
                } else {
                    let badgeHtml = `
                        <div class="badge-generations-header">
                            <i data-lucide="loader-2" class="w-3 h-3 spin"></i>
                            Generating
                            <span class="gen-count">${activeGenerations.size}</span>
                        </div>
                    `;

                    activeGenerations.forEach((gen, id) => {
                        const typeInfo = getGenTypeInfo(gen);
                        const isComplete = gen.percent === 100;
                        const isEnhance = gen.type === 'enhance';

                        let actionsHtml = '';
                        if (isEnhance) {
                            actionsHtml = isComplete ? `
                                <button class="gen-card-btn primary enhance" onclick="applyEnhancement()">Apply</button>
                                <button class="gen-card-btn secondary" onclick="dismissEnhancement(); removeGeneration('${id}')">Dismiss</button>
                            ` : `
                                <button class="gen-card-btn secondary" onclick="dismissEnhancement(); removeGeneration('${id}')">Cancel</button>
                            `;
                        } else {
                            actionsHtml = `
                                <button class="gen-card-btn primary" onclick="viewCompletedGeneration('${id}')">View</button>
                                <button class="gen-card-btn secondary" onclick="removeGeneration('${id}')">Dismiss</button>
                            `;
                        }

                        badgeHtml += `
                            <div class="gen-card ${isComplete ? 'complete' : ''} ${isEnhance ? 'enhance' : ''}" id="gen-card-${id}">
                                <div class="gen-card-header">
                                    <span class="gen-card-type" style="color: ${typeInfo.color}; font-size: 0.65rem;">
                                        <i data-lucide="${typeInfo.icon}" class="w-3 h-3 inline"></i>
                                        ${typeInfo.label}
                                    </span>
                                    <span class="gen-card-percent">${gen.percent}%</span>
                                </div>
                                <div class="gen-card-title" title="${gen.fullTopic}">${gen.topic}</div>
                                <div class="gen-card-progress">
                                    <div class="gen-card-progress-bar ${isEnhance ? 'enhance' : ''}" style="width: ${gen.percent}%"></div>
                                </div>
                                <div class="gen-card-status">${gen.status}</div>
                                <div class="gen-card-actions">
                                    ${actionsHtml}
                                </div>
                            </div>
                        `;
                    });

                    badgeContainer.innerHTML = badgeHtml;
                }
            }

            // Re-initialize lucide icons
            if (window.lucide) lucide.createIcons();

            // Update mobile tab badges
            updateMobileTabBadges();
        }

        // Handle click on navbar generation indicator
        function handleNavGenClick() {
            const viewReport = document.getElementById('view-report');
            const isReportView = viewReport && viewReport.classList.contains('active');

            if (isReportView) {
                // If viewing an article, ensure left panel is open and scroll to generating section
                const leftPanel = document.getElementById('dashboard-panel-left');
                if (leftPanel && leftPanel.classList.contains('collapsed')) {
                    toggleDashboardPanel('left');
                }
                // Scroll to generating section
                const genSection = document.getElementById('generating-section');
                if (genSection) {
                    genSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // If on portal/other view, go to dashboard
                switchView('view-dashboard');
            }
        }

        function updateBadgeGenerationState() {
            const badge = document.getElementById('deep-dive-badge');
            const miniGenCount = document.getElementById('badge-mini-gen-count');

            const activeCount = Array.from(activeGenerations.values()).filter(g => g.percent < 100).length;

            if (activeCount > 0) {
                badge.classList.add('has-generations');
                if (miniGenCount) miniGenCount.textContent = activeCount;
            } else {
                badge.classList.remove('has-generations');
            }

            // Ensure badge is visible if we have active generations
            if (activeGenerations.size > 0 && !badge.classList.contains('visible')) {
                badge.classList.add('visible');
            }
        }

        // Update the floating badge
        function updateDeepDiveBadge() {
            const badge = document.getElementById('deep-dive-badge');
            const reportView = document.getElementById('view-report');
            const isReportView = reportView && reportView.classList.contains('active');

            // Keep badge visible if there are active generations, even outside report view
            if (!isReportView) {
                if (activeGenerations.size === 0) {
                    badge.classList.remove('visible');
                }
                return;
            }

            // Count fractal triggers in current article
            const triggers = document.querySelectorAll('#report-body .fractal-trigger');
            const contextData = window.dynamicContextData || {};

            let freeCount = 0;
            let paidCount = 0;

            triggers.forEach(trigger => {
                const key = trigger.getAttribute('onclick')?.match(/expandContext\(this,\s*'([^']+)'\)/)?.[1];
                const topicName = key ? key.replace(/_/g, ' ') : trigger.textContent;

                // Check if in local reports or contextData has full article
                if (reports[topicName.toLowerCase().replace(/\s+/g, '_')] || cachedArticles[topicName.toLowerCase()]) {
                    freeCount++;
                } else {
                    paidCount++;
                }
            });

            document.getElementById('badge-free-count').textContent = freeCount;
            document.getElementById('badge-paid-count').textContent = paidCount;

            badge.classList.add('visible');
            updateBadgeRemaining();
            lucide.createIcons();
        }

        function updateBadgeRemaining() {
            const remainingEl = document.getElementById('badge-remaining');
            const textEl = document.getElementById('badge-remaining-text');

            if (userRemainingDives > 0) {
                remainingEl.classList.remove('depleted');
                textEl.textContent = `${userRemainingDives} remaining free today`;
            } else {
                remainingEl.classList.add('depleted');
                textEl.textContent = 'No free remaining today';
            }

            // Also update mini badge
            const miniFree = document.getElementById('badge-mini-free');
            const miniPaid = document.getElementById('badge-mini-paid');
            if (miniFree && miniPaid) {
                miniFree.textContent = document.getElementById('badge-free-count')?.textContent || '0';
                miniPaid.textContent = document.getElementById('badge-paid-count')?.textContent || '0';
            }
        }

        // Toggle badge between minimized and expanded states
        function toggleBadgeSize() {
            const badge = document.getElementById('deep-dive-badge');
            badge.classList.toggle('minimized');

            // Save preference to localStorage
            localStorage.setItem('badgeMinimized', badge.classList.contains('minimized'));
        }

        // Restore badge state on load
        function restoreBadgeState() {
            const isMinimized = localStorage.getItem('badgeMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('deep-dive-badge').classList.add('minimized');
            }
        }

        // Hook fractal triggers to generate deep dives
        async function expandContext(element, key) {
            // IMMEDIATELY hide the fractal tooltip when clicking a trigger
            const fractalTooltip = document.querySelector('.fractal-tooltip');
            if (fractalTooltip) {
                fractalTooltip.classList.remove('visible');
            }

            // Check for existing context data
            const contextData = window.dynamicContextData || {};

            // The actual clickable text is what we use for the topic
            const clickedText = element.textContent.trim();
            const topicForDeepDive = clickedText;  // Use actual element text, not the key

            // First check if we already have this article loaded LOCALLY (instant)
            const possibleKeys = [
                clickedText.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                key,
                key?.replace(/_/g, ' ')?.toLowerCase()?.replace(/[^a-z0-9]+/g, '_')
            ].filter(Boolean);

            for (const testKey of possibleKeys) {
                if (reports[testKey]) {
                    loadReport(testKey);
                    return;
                }
            }

            // If we have pre-generated inline context, show it immediately
            if (contextData[key]) {
                let existingContext = element.nextElementSibling;
                if (existingContext && existingContext.classList.contains('fractal-context')) {
                    existingContext.classList.toggle('open');
                } else {
                    const escapedTopic = topicForDeepDive.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const contextDiv = document.createElement('div');
                    contextDiv.className = 'fractal-context open';
                    contextDiv.innerHTML = `
                        <p>${contextData[key].expanded}</p>
                        <button class="queue-deepdive-btn" onclick="queueDeepDiveFromContext(this, '${escapedTopic}')">
                            <span class="queue-btn-icon">+</span>
                            <span class="queue-btn-text">
                                <span class="queue-btn-label">Queue Fractal Analysis</span>
                                <span class="queue-btn-topic">${topicForDeepDive}</span>
                            </span>
                        </button>
                    `;
                    element.parentNode.insertBefore(contextDiv, element.nextSibling);
                }
                return;
            }

            // No local data - show IMMEDIATE feedback, then check cache in background
            showNotification(`Checking "${topicForDeepDive.substring(0, 25)}..."`, 'info');

            // Background cache check - non-blocking
            checkIfCached(topicForDeepDive).then(cached => {
                if (cached) {
                    // It's cached - load it for FREE (pleasant surprise!)
                    const cacheKey = cached.key || possibleKeys[0];
                    reports[cacheKey] = cached;
                    cachedArticles[topicForDeepDive.toLowerCase()] = true;

                    window.dynamicChartConfigs = cached.chartConfigs || {};
                    window.dynamicContextData = cached.contextData || {};
                    window.dynamicCitationDatabase = cached.citationDatabase || {};

                    showNotification(`Found cached article!`, 'success');
                    loadReport(cacheKey);
                    setTimeout(() => renderDynamicCharts(cached.chartConfigs || {}), 200);
                } else {
                    // Not cached - queue generation with instant feedback
                    queueDeepDiveInstant(topicForDeepDive);
                }
            }).catch(() => {
                // On error, just queue it
                queueDeepDiveInstant(topicForDeepDive);
            });
        }

        // Queue deep dive instantly (no confirmation, just add to queue)
        function queueDeepDiveInstant(topic) {
            // Hide any floating tooltips
            const fractalTooltip = document.querySelector('.fractal-tooltip');
            if (fractalTooltip) {
                fractalTooltip.classList.remove('visible');
            }

            // Check if at max capacity
            if (activeGenerations.size >= MAX_CONCURRENT_GENERATIONS) {
                showNotification(`Queue full (${MAX_CONCURRENT_GENERATIONS} max). Wait for one to complete.`, 'warning');
                return;
            }

            // Get parent article context
            const articleTitle = document.getElementById('report-title')?.innerText || '';
            const currentReport = reports[currentArticleKey];
            const articleDescription = currentReport?.cardDescription || '';

            let context = `Parent Article: "${articleTitle}"\n`;
            if (articleDescription) {
                context += `Article Focus: ${articleDescription}\n`;
            }

            // Show toast notification
            const shortTopic = topic.length > 35 ? topic.substring(0, 32) + '...' : topic;
            showNotification(`Queued: "${shortTopic}"`, 'success');

            // Start generation in background
            generateDeepDive(topic, context, currentArticleKey, articleTitle);

            // Show badge
            const badge = document.getElementById('deep-dive-badge');
            if (badge) {
                badge.classList.add('visible');
                badge.classList.remove('minimized');
                setTimeout(() => {
                    if (!badge.matches(':hover')) {
                        badge.classList.add('minimized');
                    }
                }, 3000);
            }
        }

        // Queue full investigation from fact check "Go Deeper" button
        async function queueDeepDiveFromFactCheck() {
            // Get the fact check title
            const titleEl = document.getElementById('report-title');
            if (!titleEl) {
                showNotification('Could not find fact check topic', 'error');
                return;
            }

            // Extract topic from title (remove "Fact Check: " prefix if present)
            let topic = titleEl.innerText;
            topic = topic.replace(/^Fact Check:\s*/i, '').trim();

            const btn = document.querySelector('.fact-check-deeper .deeper-btn');
            const shortTopic = topic.length > 35 ? topic.substring(0, 32) + '...' : topic;

            // Show checking state
            if (btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Checking...';
                btn.disabled = true;
                lucide.createIcons();
            }

            // Check cache FIRST - maybe someone already generated this investigation
            try {
                const cached = await checkIfCached(topic);
                if (cached) {
                    // FOUND! Load it instantly for FREE
                    const cacheKey = cached.key || topic.toLowerCase().replace(/\s+/g, '_').substring(0, 20);
                    reports[cacheKey] = cached;

                    window.dynamicChartConfigs = cached.chartConfigs || {};
                    window.dynamicContextData = cached.contextData || {};
                    window.dynamicCitationDatabase = cached.citationDatabase || {};

                    showNotification(`Investigation already exists! Loading...`, 'success');

                    if (btn) {
                        btn.innerHTML = '<i data-lucide="external-link"></i> View Investigation';
                        btn.style.background = 'linear-gradient(135deg, #3e63dd 0%, #5b7ee5 100%)';
                        btn.disabled = false;
                        btn.onclick = () => loadReport(cacheKey);
                        lucide.createIcons();
                    }

                    // Load the cached article
                    loadReport(cacheKey);
                    setTimeout(() => renderDynamicCharts(cached.chartConfigs || {}), 200);
                    return;
                }
            } catch (e) {
                console.log('Cache check failed, proceeding with generation:', e);
            }

            // Not cached - proceed with generation
            // Check if at max capacity
            if (activeGenerations.size >= MAX_CONCURRENT_GENERATIONS) {
                showNotification(`Queue full (${MAX_CONCURRENT_GENERATIONS} max). Wait for one to complete.`, 'warning');
                if (btn) {
                    btn.innerHTML = '<i data-lucide="arrow-right"></i> Generate Full Investigation';
                    btn.disabled = false;
                    btn.style.background = '';
                    lucide.createIcons();
                }
                return;
            }

            // Show toast notification
            showNotification(`Queued Investigation: "${shortTopic}"`, 'success');

            // Update button to show queued state
            if (btn) {
                btn.innerHTML = '<i data-lucide="check"></i> Investigation Queued';
                btn.disabled = true;
                btn.style.background = 'linear-gradient(135deg, #30a46c 0%, #10b981 100%)';
                lucide.createIcons();
            }

            // Start generation using regular generate endpoint
            generateReport(topic);

            // Show badge
            const badge = document.getElementById('deep-dive-badge');
            if (badge) {
                badge.classList.add('visible');
                badge.classList.remove('minimized');
                setTimeout(() => {
                    if (!badge.matches(':hover')) {
                        badge.classList.add('minimized');
                    }
                }, 3000);
            }
        }

        // Legacy function - redirects to instant queue
        function promptDeepDive(topic) {
            queueDeepDiveInstant(topic);
        }

        // === INFOGRAPHIC LIGHTBOX ===
        let currentLightboxFigure = null;

        function openLightbox(floatFigure) {
            const lightbox = document.getElementById('infographic-lightbox');
            const imageContainer = document.getElementById('lightbox-image-container');
            const captionContainer = document.getElementById('lightbox-caption');

            if (!lightbox || !floatFigure) return;

            currentLightboxFigure = floatFigure;

            // Clear previous content
            imageContainer.innerHTML = '';
            captionContainer.innerHTML = '';

            // Get the image/canvas container (first div child with height)
            const chartContainer = floatFigure.querySelector('div[style*="height"], .gemini-infographic, img');
            const caption = floatFigure.querySelector('.fig-caption');

            // Clone the image or canvas
            if (chartContainer) {
                const img = floatFigure.querySelector('img');
                const canvas = floatFigure.querySelector('canvas');

                if (img) {
                    // For Gemini infographics (images)
                    const clonedImg = img.cloneNode(true);
                    clonedImg.style.maxWidth = '100%';
                    clonedImg.style.maxHeight = '65vh';
                    clonedImg.style.width = 'auto';
                    clonedImg.style.height = 'auto';
                    imageContainer.appendChild(clonedImg);
                } else if (canvas) {
                    // For Chart.js canvases - convert to image
                    try {
                        const dataUrl = canvas.toDataURL('image/png');
                        const newImg = document.createElement('img');
                        newImg.src = dataUrl;
                        newImg.style.maxWidth = '100%';
                        newImg.style.maxHeight = '65vh';
                        imageContainer.appendChild(newImg);
                    } catch (e) {
                        console.log('[Lightbox] Could not convert canvas:', e);
                        // Fallback: clone the container
                        const cloned = chartContainer.cloneNode(true);
                        cloned.style.height = 'auto';
                        cloned.style.maxHeight = '65vh';
                        imageContainer.appendChild(cloned);
                    }
                }
            }

            // Clone the caption with Deep Dive button
            if (caption) {
                captionContainer.innerHTML = caption.innerHTML;
                // Re-attach click handlers for Deep Dive buttons in lightbox
                const deepDiveBtn = captionContainer.querySelector('.fig-deep-dive');
                if (deepDiveBtn) {
                    deepDiveBtn.onclick = function(e) {
                        e.stopPropagation();
                        closeLightbox(e);
                        // Small delay to let lightbox close
                        setTimeout(() => {
                            handleDeepDive(deepDiveBtn);
                        }, 100);
                    };
                }
            }

            // Show the lightbox
            lightbox.style.display = 'flex';
            requestAnimationFrame(() => {
                lightbox.classList.add('visible');
            });

            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox(event) {
            if (event) {
                event.stopPropagation();
            }
            const lightbox = document.getElementById('infographic-lightbox');
            if (!lightbox) return;

            lightbox.classList.remove('visible');
            setTimeout(() => {
                lightbox.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);

            currentLightboxFigure = null;
        }

        // Escape key to close lightbox
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const lightbox = document.getElementById('infographic-lightbox');
                if (lightbox && lightbox.classList.contains('visible')) {
                    closeLightbox();
                }
            }
        });

        // Attach click handlers to all float-figures
        function initLightboxHandlers() {
            document.querySelectorAll('.float-figure').forEach(figure => {
                // Only add click if not already added
                if (!figure.dataset.lightboxEnabled) {
                    figure.dataset.lightboxEnabled = 'true';
                    figure.addEventListener('click', (e) => {
                        // Don't open lightbox if clicking the Deep Dive button
                        if (e.target.classList.contains('fig-deep-dive')) {
                            return;
                        }
                        openLightbox(figure);
                    });
                }
            });
        }

        // Initialize on page load and after article loads
        document.addEventListener('DOMContentLoaded', initLightboxHandlers);

        // Handle deep dive from infographic - extracts context automatically
        function handleDeepDive(topicOrElement) {
            // Hide the deep dive tooltip immediately when clicked
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            let topic, context, clickedElement;

            // If passed a string, use it as the topic (legacy support)
            if (typeof topicOrElement === 'string') {
                topic = topicOrElement;
            } else {
                // Extract context from the clicked element
                clickedElement = topicOrElement;
                topic = extractDeepDiveTopic(clickedElement);
            }

            // Get parent article context
            const articleTitle = document.getElementById('report-title')?.innerText || '';
            const currentReport = reports[currentArticleKey];
            const articleDescription = currentReport?.cardDescription || '';

            // Build rich context
            context = `Parent Article: "${articleTitle}"\n`;
            if (articleDescription) {
                context += `Article Focus: ${articleDescription}\n`;
            }

            // Check if at max capacity
            if (activeGenerations.size >= MAX_CONCURRENT_GENERATIONS) {
                showNotification(`Queue full (${MAX_CONCURRENT_GENERATIONS} max). Wait for one to complete.`, 'warning');
                return;
            }

            // Mark the clicked button as queued (visual feedback)
            if (clickedElement) {
                clickedElement.classList.add('queued');
            }

            // Show toast notification
            const shortTopic = topic.length > 40 ? topic.substring(0, 37) + '...' : topic;
            showNotification(`Queued: "${shortTopic}"`, 'success');

            // Immediately start generation in background
            generateDeepDive(topic, context, currentArticleKey, articleTitle);

            // Make sure badge is visible and expanded to show progress
            const badge = document.getElementById('deep-dive-badge');
            if (badge) {
                badge.classList.add('visible');
                // Briefly expand to show new item, then user can minimize
                badge.classList.remove('minimized');
                setTimeout(() => {
                    // Auto-minimize after 3 seconds if user hasn't interacted
                    if (!badge.matches(':hover')) {
                        badge.classList.add('minimized');
                    }
                }, 3000);
            }
        }

        // Extract topic from figure caption context or data-topic attribute
        function extractDeepDiveTopic(element) {
            // Check for explicit data-topic attribute first (for inline deep dives)
            if (element.dataset && element.dataset.topic) {
                return element.dataset.topic;
            }

            // Get the figure caption (parent element)
            const figCaption = element.closest('.fig-caption');
            if (figCaption) {
                // Extract text before the FRACTAL button
                let captionText = figCaption.textContent.replace('FRACTAL', '').replace('DEEP DIVE', '').trim();
                // Remove "Fig X. " prefix
                captionText = captionText.replace(/^Fig\s*\d+\.\s*/i, '');
                return captionText;
            }

            // Check for section heading fractal analysis
            const h2Parent = element.closest('.prose-h2');
            if (h2Parent) {
                return h2Parent.textContent.replace('FRACTAL', '').replace('DEEP DIVE', '').replace(/^\d+\.\s*/, '').trim();
            }

            // Fallback: look for nearby heading
            const floatFigure = element.closest('.float-figure');
            if (floatFigure) {
                const prevSibling = floatFigure.previousElementSibling;
                if (prevSibling && prevSibling.classList.contains('prose-h2')) {
                    return prevSibling.textContent.replace(/^\d+\.\s*/, '');
                }
            }

            return 'This Topic';
        }

        // --- ARTICLE TIMESTAMP & REGENERATE ---
        function updateArticleTimestamp(data) {
            const timestampEl = document.getElementById('article-timestamp');
            if (!timestampEl) return;

            const timestampText = timestampEl.querySelector('.timestamp-text');

            // Check for cached timestamp from API
            const cachedAt = data._cached_at || data._generatedAt;

            if (cachedAt) {
                const date = new Date(cachedAt);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor(diffMs / (1000 * 60));

                let timeAgo;
                if (diffMins < 60) {
                    timeAgo = `${diffMins}m ago`;
                } else if (diffHours < 24) {
                    timeAgo = `${diffHours}h ago`;
                } else if (diffDays < 7) {
                    timeAgo = `${diffDays}d ago`;
                } else {
                    timeAgo = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }

                timestampText.textContent = timeAgo;
                timestampEl.classList.remove('hidden');
            } else {
                // For static articles without timestamps
                timestampEl.classList.add('hidden');
            }

            // Reinitialize lucide icons for the refresh button
            if (window.lucide) lucide.createIcons();
        }

        async function regenerateArticle() {
            const title = document.getElementById('report-title').innerText;

            if (!confirm(`Regenerate "${title}"?\n\nThis will create a fresh version of this article with the latest data and analysis. The current version will be replaced.`)) {
                return;
            }

            // Get the topic from currentReport or derive from title
            const topic = currentReport?._topic || currentReport?.key || title;

            showNotification('Regenerating article...', 'info');

            try {
                // Use the generate endpoint to create a fresh article
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });

                if (!response.ok) throw new Error('Failed to regenerate');

                // Read SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let articleContent = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const eventLine = lines[lines.indexOf(line) - 1];
                            if (eventLine && eventLine.includes('content')) {
                                try {
                                    articleContent = JSON.parse(line.substring(6));
                                } catch (e) {
                                    articleContent = line.substring(6);
                                }
                            }
                        }
                    }
                }

                if (articleContent) {
                    // Parse if needed
                    let data = typeof articleContent === 'string' ? JSON.parse(articleContent) : articleContent;

                    // Add generation timestamp
                    data._generatedAt = new Date().toISOString();

                    // Render the regenerated article
                    currentReport = data;
                    renderReportData(data, true);

                    showNotification('Article regenerated with fresh data!', 'success');
                } else {
                    throw new Error('No content received');
                }
            } catch (error) {
                console.error('Regeneration failed:', error);
                showNotification('Regeneration failed. Please try again.', 'error');
            }
        }

        // --- BOOKMARKS ---
        function getBookmarks() {
            const saved = localStorage.getItem('genuverity-bookmarks');
            return saved ? JSON.parse(saved) : [];
        }

        function saveBookmarks(bookmarks) {
            localStorage.setItem('genuverity-bookmarks', JSON.stringify(bookmarks));
        }

        // --- INLINE ENHANCEMENT WIDGET FUNCTIONS ---
        function showEnhanceWidget() {
            console.log('[EnhanceWidget] Showing widget...');
            enhanceCharsReceived = 0; // Reset char counter
            const widget = document.getElementById('enhance-progress-widget');
            if (widget) {
                widget.classList.add('visible');
                widget.classList.remove('complete');
                // Reset state
                const bar = document.getElementById('enhance-widget-bar');
                const percent = document.getElementById('enhance-widget-percent');
                const status = document.getElementById('enhance-widget-status');
                const title = document.getElementById('enhance-widget-title');
                const icon = document.getElementById('enhance-widget-icon');

                if (bar) bar.style.width = '0%';
                if (percent) percent.textContent = '0%';
                if (status) status.textContent = 'Preparing enhancement...';
                if (title) title.textContent = 'Enhancing Article';
                if (icon) {
                    icon.classList.add('spinning');
                    icon.classList.remove('complete');
                    icon.innerHTML = '<i data-lucide="sparkles"></i>';
                }
                lucide.createIcons();
                console.log('[EnhanceWidget] Widget is now visible');
            } else {
                console.error('[EnhanceWidget] Widget element not found!');
            }
        }

        let enhanceCharsReceived = 0;
        function updateEnhanceWidget(percent, message, charsReceived = null) {
            console.log('[EnhanceWidget] Update:', percent + '%', message, charsReceived ? `(${charsReceived} chars)` : '');
            const bar = document.getElementById('enhance-widget-bar');
            const percentEl = document.getElementById('enhance-widget-percent');
            const statusEl = document.getElementById('enhance-widget-status');

            if (bar) bar.style.width = `${percent}%`;
            if (percentEl) percentEl.textContent = `${percent}%`;

            // Show message with live char count if available
            if (statusEl) {
                if (charsReceived !== null) {
                    enhanceCharsReceived = charsReceived;
                }
                const charInfo = enhanceCharsReceived > 0 ? ` (${Math.round(enhanceCharsReceived/1000)}k chars)` : '';
                statusEl.textContent = message + charInfo;
            }
        }

        function showEnhanceWidgetComplete() {
            const widget = document.getElementById('enhance-progress-widget');
            const icon = document.getElementById('enhance-widget-icon');
            const title = document.getElementById('enhance-widget-title');
            const statusEl = document.getElementById('enhance-widget-status');

            if (widget) {
                widget.classList.add('complete');
                // Create confetti burst
                createEnhanceConfetti();
            }
            if (icon) {
                icon.classList.remove('spinning');
                icon.classList.add('complete');
                icon.innerHTML = '<i data-lucide="check-circle" class="w-6 h-6"></i>';
            }
            if (title) title.textContent = 'Enhancement Ready!';
            if (statusEl) statusEl.textContent = 'Click below to apply the enhanced version';

            lucide.createIcons();
        }

        function createEnhanceConfetti() {
            const widget = document.getElementById('enhance-progress-widget');
            if (!widget) return;

            const colors = ['#10b981', '#3b82f6', '#06b6d4', '#f59e0b', '#ec4899'];
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'enhance-confetti-container';
            confettiContainer.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;overflow:hidden;border-radius:inherit;';

            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 8 + 4}px;
                    height: ${Math.random() * 8 + 4}px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    left: ${Math.random() * 100}%;
                    top: 50%;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                    animation: confettiFall ${Math.random() * 1.5 + 1}s ease-out forwards;
                    opacity: 0;
                `;
                confettiContainer.appendChild(confetti);
            }

            widget.appendChild(confettiContainer);

            // Clean up confetti after animation
            setTimeout(() => confettiContainer.remove(), 3000);
        }

        function hideEnhanceWidget() {
            const widget = document.getElementById('enhance-progress-widget');
            if (widget) {
                widget.classList.remove('visible', 'complete');
            }
        }

        function applyEnhancement() {
            if (!pendingEnhancedReport) {
                showNotification('No enhancement available to apply.', 'error');
                return;
            }

            // Save original version if this is the first enhancement
            if (!originalVersions[currentArticleKey] && reports[currentArticleKey]) {
                originalVersions[currentArticleKey] = JSON.parse(JSON.stringify(reports[currentArticleKey]));
            }

            // Update the reports object with enhanced version (persists when navigating)
            const enhancedData = pendingEnhancedReport;
            enhancedData._isEnhanced = true;
            enhancedData._enhanceCount = (reports[currentArticleKey]?._enhanceCount || 0) + 1;
            reports[currentArticleKey] = enhancedData;

            // Render the enhanced article
            renderReportData(enhancedData, true);

            // Increment and update enhance count badge
            currentEnhanceCount++;
            updateEnhanceCountBadge(currentEnhanceCount);

            // Show version toggle button
            updateVersionToggle(true);
            isShowingOriginal = false;

            // Clear pending and remove from Research Status panel
            pendingEnhancedReport = null;
            isEnhancing = false;

            // Remove enhance card from Research Status
            if (currentEnhanceGenId) {
                removeGeneration(currentEnhanceGenId);
                currentEnhanceGenId = null;
            }

            // Reset button state
            const btn = document.getElementById('enhance-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i><span class="hidden sm:inline">Enhance</span>';
                lucide.createIcons();
            }

            // Scroll to top of article
            document.getElementById('report-body').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Show success notification
            showNotification(`Article enhanced successfully! (${currentEnhanceCount}x)`, 'success');
        }

        // Update version toggle button visibility
        function updateVersionToggle(hasOriginal) {
            const toggleBtn = document.getElementById('version-toggle-btn');
            if (toggleBtn) {
                if (hasOriginal) {
                    toggleBtn.classList.remove('hidden');
                } else {
                    toggleBtn.classList.add('hidden');
                }
            }
        }

        // Toggle between original and enhanced versions
        function toggleArticleVersion() {
            if (!originalVersions[currentArticleKey]) {
                showNotification('No original version available.', 'info');
                return;
            }

            const toggleBtn = document.getElementById('version-toggle-btn');

            if (isShowingOriginal) {
                // Switch to enhanced version
                renderReportData(reports[currentArticleKey], true);
                isShowingOriginal = false;
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i data-lucide="history" class="w-4 h-4"></i><span class="hidden sm:inline">Original</span>';
                    toggleBtn.title = 'View original version';
                    toggleBtn.classList.remove('showing-original');
                }
                showNotification('Showing enhanced version', 'info');
            } else {
                // Switch to original version
                renderReportData(originalVersions[currentArticleKey], true);
                isShowingOriginal = true;
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i><span class="hidden sm:inline">Enhanced</span>';
                    toggleBtn.title = 'View enhanced version';
                    toggleBtn.classList.add('showing-original');
                }
                showNotification('Showing original version', 'info');
            }
            lucide.createIcons();
        }

        function dismissEnhancement() {
            pendingEnhancedReport = null;
            isEnhancing = false;

            // Remove from Research Status panel
            if (currentEnhanceGenId) {
                removeGeneration(currentEnhanceGenId);
                currentEnhanceGenId = null;
            }

            // Reset button state
            const btn = document.getElementById('enhance-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i><span class="hidden sm:inline">Enhance</span>';
                lucide.createIcons();
            }

            showNotification('Enhancement dismissed.', 'info');
        }

        // Track current enhance generation ID
        let currentEnhanceGenId = null;

        // --- ENHANCE ARTICLE ---
        async function enhanceArticle() {
            console.log('[Enhance] ========== enhanceArticle CALLED ==========');

            // Prevent multiple enhancements at once
            if (isEnhancing) {
                showNotification('Enhancement already in progress. Please wait.', 'info');
                return;
            }

            const title = document.getElementById('report-title').innerText;
            const currentContent = document.getElementById('report-body').innerHTML;
            const btn = document.getElementById('enhance-btn');

            console.log('[Enhance] Title:', title);
            console.log('[Enhance] Content length:', currentContent?.length);

            // Disable button and show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span class="hidden sm:inline">Enhancing...</span>';
                lucide.createIcons();
            }

            isEnhancing = true;
            pendingEnhancedReport = null;

            // Register in Research Status panel (unified with deep dives)
            const shortTitle = title.length > 30 ? title.substring(0, 27) + '...' : title;
            currentEnhanceGenId = registerGeneration(shortTitle, 'enhance');

            // Show the Research Status panel
            const badge = document.getElementById('deep-dive-badge');
            if (badge) {
                badge.classList.add('visible');
                badge.classList.remove('minimized');
            }

            showNotification(`Enhancing: "${shortTitle}"`, 'info');

            try {
                // Extract key content from the article (strip HTML, limit length)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = currentContent;

                // Get section headers
                const headers = Array.from(tempDiv.querySelectorAll('h2')).map(h => h.textContent).join(', ');

                // Get plain text, limited to ~3000 chars for API efficiency
                let plainText = tempDiv.textContent.replace(/\s+/g, ' ').trim();
                if (plainText.length > 3000) {
                    plainText = plainText.substring(0, 3000) + '... [content truncated for processing]';
                }

                // SHORTENED prompt to avoid Vercel timeout - limit context to 1500 chars
                const shortPlainText = plainText.length > 1500 ? plainText.substring(0, 1500) + '...' : plainText;
                const enhancePrompt = `ENHANCE "${title}"

SECTIONS: ${headers}

SUMMARY: ${shortPlainText}

ADD: 1-2 new sections, more living-numbers (<span class="living-number" data-target="X" data-suffix="Y">), citation-spades, fractal-triggers. Keep same title/thesis. Return JSON with content field.`;

                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: enhancePrompt,
                        mode: 'enhance'
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                // Handle SSE streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';
                let articleContent = null;
                let currentEvent = null;  // MUST be outside while loop!

                console.log('[Enhance] Starting to read SSE stream...');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    fullResponse += chunk;
                    buffer += chunk;

                    // Update char count in widget on every chunk for live feedback
                    const statusEl = document.getElementById('enhance-widget-status');
                    if (statusEl && fullResponse.length > 0) {
                        enhanceCharsReceived = fullResponse.length;
                        // Keep current status text, just update char count
                        const currentMsg = statusEl.textContent.split(' (')[0]; // Strip old char count
                        statusEl.textContent = `${currentMsg} (${Math.round(fullResponse.length/1000)}k)`;
                    }

                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                        } else if (line.startsWith('data: ') && currentEvent) {
                            try {
                                const rawData = line.slice(6);
                                const data = JSON.parse(rawData);
                                if (currentEvent === 'progress') {
                                    // Update the Research Status panel
                                    if (currentEnhanceGenId) {
                                        updateGenerationProgress(currentEnhanceGenId, data.percent, data.message);
                                    }
                                } else if (currentEvent === 'content') {
                                    console.log('[Enhance] Received content event, keys:', data ? Object.keys(data) : 'null');
                                    articleContent = data;
                                } else if (currentEvent === 'error') {
                                    console.error('[Enhance] Server error:', data);
                                    throw new Error(data);
                                }
                            } catch (e) {
                                console.log('[Enhance] Parse error for line (length=' + line.length + '):', line.substring(0, 200));
                                // For content events, try to extract from fullResponse later
                            }
                            currentEvent = null;
                        }
                    }
                }

                console.log('[Enhance] ========== STREAM COMPLETE ==========');
                console.log('[Enhance] articleContent:', articleContent ? 'RECEIVED' : 'NULL');
                console.log('[Enhance] articleContent type:', typeof articleContent);
                console.log('[Enhance] Full response length:', fullResponse.length);
                console.log('[Enhance] Full response first 500 chars:', fullResponse.substring(0, 500));

                // Update debug banner
                const banner = document.getElementById('enhance-debug-banner');
                if (banner) {
                    banner.textContent = `Stream done: content=${articleContent ? 'YES' : 'NO'}, response=${fullResponse.length} chars`;
                    banner.style.background = articleContent ? 'green' : 'red';
                }

                // Try to get article content from SSE or fallback to raw response
                let parsed = null;

                if (articleContent) {
                    parsed = typeof articleContent === 'string' ? JSON.parse(articleContent) : articleContent;
                    console.log('[Enhance] Using SSE articleContent directly');
                } else if (fullResponse) {
                    console.log('[Enhance] No SSE content, trying to extract from raw response...');

                    // Look for the content event in the SSE stream
                    const contentEventMatch = fullResponse.match(/event:\s*content\s*\ndata:\s*(\{[\s\S]*?)(?=\n\nevent:|$)/);
                    if (contentEventMatch) {
                        try {
                            parsed = JSON.parse(contentEventMatch[1]);
                            console.log('[Enhance] Extracted content from SSE event match');
                        } catch (e) {
                            console.log('[Enhance] Failed to parse content event match, trying repair...');
                            parsed = repairTruncatedJSON(contentEventMatch[1]);
                        }
                    }

                    // Fallback: try to find any JSON object in the response
                    if (!parsed) {
                        const jsonMatch = fullResponse.match(/data:\s*(\{"key"[\s\S]*?"content"[\s\S]*?\})\s*$/);
                        if (jsonMatch) {
                            try {
                                parsed = JSON.parse(jsonMatch[1]);
                                console.log('[Enhance] Extracted from JSON pattern match');
                            } catch (e2) {
                                console.log('[Enhance] Pattern match failed, using repairTruncatedJSON');
                                parsed = repairTruncatedJSON(jsonMatch[1]);
                            }
                        }
                    }

                    // Last resort: try repairTruncatedJSON on the whole response
                    if (!parsed) {
                        console.log('[Enhance] Last resort: trying repairTruncatedJSON on fullResponse');
                        parsed = repairTruncatedJSON(fullResponse);
                    }
                }

                console.log('[Enhance] ========== PARSE RESULT ==========');
                console.log('[Enhance] Parsed:', parsed ? 'SUCCESS' : 'FAILED');
                console.log('[Enhance] Parsed keys:', parsed ? Object.keys(parsed) : 'null');
                if (parsed) {
                    console.log('[Enhance] Has content:', !!parsed.content, 'Has body:', !!parsed.body);
                    console.log('[Enhance] Content length:', parsed.content?.length || parsed.body?.length || 0);
                }

                // Visual debug
                const banner2 = document.getElementById('enhance-debug-banner');
                if (banner2) {
                    const hasContent = parsed && (parsed.content || parsed.body);
                    banner2.textContent = `Parse: ${parsed ? 'OK' : 'FAIL'}, Content: ${hasContent ? 'YES' : 'NO'}`;
                    banner2.style.background = hasContent ? 'green' : 'orange';
                }

                if (parsed && (parsed.content || parsed.body)) {
                    // Store the enhanced report for user to apply
                    pendingEnhancedReport = {
                        title: parsed.title || title,
                        content: parsed.content || parsed.body,
                        sources: parsed.sources || [],
                        citationDatabase: parsed.citationDatabase || {},
                        chartConfigs: parsed.chartConfigs || {},
                        chartType: 'dynamic'
                    };

                    // Mark as complete in Research Status panel
                    if (currentEnhanceGenId) {
                        updateGenerationProgress(currentEnhanceGenId, 100, 'Ready to apply');
                        // Mark generation complete (this updates the card UI)
                        const gen = activeGenerations.get(currentEnhanceGenId);
                        if (gen) {
                            gen.percent = 100;
                            gen.status = 'Enhancement ready - click Apply';
                        }
                        renderGenerationCards();
                    }
                    showNotification('Enhancement ready! Click Apply in Research Status.', 'success');
                } else {
                    console.error('[Enhance] No valid article content received');
                    console.log('[Enhance] Parsed keys:', parsed ? Object.keys(parsed) : 'null');
                    isEnhancing = false;
                    const errorDetails = parsed ? `Got keys: ${Object.keys(parsed).join(', ')}` : 'Parse failed completely';
                    showNotification(`Enhancement failed - ${errorDetails}`, 'error');

                    // Remove from Research Status panel
                    if (currentEnhanceGenId) {
                        removeGeneration(currentEnhanceGenId);
                        currentEnhanceGenId = null;
                    }

                    // Reset button state
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i><span class="hidden sm:inline">Enhance</span>';
                        lucide.createIcons();
                    }
                }

            } catch (error) {
                console.error('Enhancement failed:', error);
                isEnhancing = false;
                showNotification('Enhancement failed. Please try again.', 'error');

                // Remove from Research Status panel
                if (currentEnhanceGenId) {
                    removeGeneration(currentEnhanceGenId);
                    currentEnhanceGenId = null;
                }

                // Reset button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i><span class="hidden sm:inline">Enhance</span>';
                    lucide.createIcons();
                }
            }
        }

        // Stacking notification helper
        let notificationStack = [];
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification-toast`;

            const colors = {
                success: 'linear-gradient(135deg, #10b981, #34d399)',
                error: 'linear-gradient(135deg, #ef4444, #f87171)',
                warning: 'linear-gradient(135deg, #f59e0b, #fbbf24)',
                info: 'linear-gradient(135deg, #3b82f6, #60a5fa)'
            };

            notification.style.cssText = `
                position: fixed;
                right: 24px;
                padding: 12px 18px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                color: white;
                font-size: 0.9rem;
                font-weight: 500;
                z-index: 10000;
                max-width: 350px;
                background: ${colors[type] || colors.info};
                opacity: 0;
                transform: translateX(100px);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            `;
            notification.innerHTML = message;
            document.body.appendChild(notification);

            // Add to stack and position
            notificationStack.push(notification);
            repositionNotifications();

            // Animate in
            requestAnimationFrame(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            });

            // Auto-remove after delay
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    notification.remove();
                    notificationStack = notificationStack.filter(n => n !== notification);
                    repositionNotifications();
                }, 300);
            }, 4000);
        }

        function repositionNotifications() {
            let bottomOffset = 100; // Start above the badge
            notificationStack.forEach((notification, index) => {
                notification.style.bottom = `${bottomOffset + (index * 60)}px`;
            });
        }

        function toggleBookmark() {
            const bookmarks = getBookmarks();
            const key = currentArticleKey;
            const title = document.getElementById('report-title').innerText;
            const btn = document.getElementById('bookmark-btn');

            const existingIndex = bookmarks.findIndex(b => b.key === key);

            if (existingIndex >= 0) {
                // Remove bookmark
                bookmarks.splice(existingIndex, 1);
                if (btn) {
                    btn.classList.remove('primary');
                    btn.querySelector('span').textContent = 'Save';
                }
            } else {
                // Add bookmark
                bookmarks.push({
                    key: key,
                    title: title,
                    date: new Date().toISOString()
                });
                if (btn) {
                    btn.classList.add('primary');
                    btn.querySelector('span').textContent = 'Saved';
                }
            }

            saveBookmarks(bookmarks);
        }

        function updateBookmarkButton() {
            const bookmarks = getBookmarks();
            const btn = document.getElementById('bookmark-btn');
            const isBookmarked = bookmarks.some(b => b.key === currentArticleKey);

            if (btn) {
                const span = btn.querySelector('span');
                if (isBookmarked) {
                    btn.classList.add('primary');
                    if (span) span.textContent = 'Saved';
                } else {
                    btn.classList.remove('primary');
                    if (span) span.textContent = 'Save';
                }
            }
        }

        // --- PIPELINES (Bookmark Collections) ---
        function getPipelines() {
            const saved = localStorage.getItem('genuverity-pipelines');
            return saved ? JSON.parse(saved) : [
                { id: 'default', name: 'Reading List', bookmarks: [] },
                { id: 'research', name: 'Research Queue', bookmarks: [] }
            ];
        }

        function savePipelines(pipelines) {
            localStorage.setItem('genuverity-pipelines', JSON.stringify(pipelines));
        }

        function toggleBookmarksSidebar() {
            const sidebar = document.getElementById('bookmarks-sidebar');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                renderBookmarksSidebar();
            }
        }

        function renderBookmarksSidebar() {
            const container = document.getElementById('bookmarks-content');
            const pipelines = getPipelines();
            const bookmarks = getBookmarks();

            let html = '';

            // Ungrouped bookmarks (default)
            const ungroupedBookmarks = bookmarks.filter(b => !b.pipelineId);
            if (ungroupedBookmarks.length > 0) {
                html += `
                    <div class="pipeline-section">
                        <div class="pipeline-header">
                            <span style="color: var(--text-main); font-weight: 600;">
                                <i data-lucide="bookmark" class="w-4 h-4 inline mr-2"></i>Saved Articles
                            </span>
                            <span style="color: var(--text-muted); font-size: 0.75rem;">${ungroupedBookmarks.length}</span>
                        </div>
                        <div class="pipeline-items">
                            ${ungroupedBookmarks.map(b => `
                                <div class="bookmark-item" onclick="loadBookmark('${b.key}')">
                                    <i data-lucide="file-text" class="w-4 h-4" style="color: var(--text-muted);"></i>
                                    <span class="bookmark-item-title">${b.title}</span>
                                    <button onclick="event.stopPropagation(); showAddToPipelineMenu('${b.key}')" style="color: var(--text-muted);" title="Add to pipeline">
                                        <i data-lucide="folder-plus" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); removeBookmark('${b.key}')" style="color: var(--text-muted);" title="Remove">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Render each pipeline
            pipelines.forEach(pipeline => {
                const pipelineBookmarks = bookmarks.filter(b => b.pipelineId === pipeline.id);
                html += `
                    <div class="pipeline-section">
                        <div class="pipeline-header" onclick="togglePipelineCollapse('${pipeline.id}')">
                            <span style="color: var(--accent-blue); font-weight: 600;">
                                <i data-lucide="folder" class="w-4 h-4 inline mr-2"></i>${pipeline.name}
                            </span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.75rem;">${pipelineBookmarks.length}</span>
                                <button onclick="event.stopPropagation(); renamePipeline('${pipeline.id}')" style="color: var(--text-muted);" title="Rename">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                </button>
                                ${pipeline.id !== 'default' ? `
                                    <button onclick="event.stopPropagation(); deletePipeline('${pipeline.id}')" style="color: var(--text-muted);" title="Delete">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="pipeline-items" id="pipeline-${pipeline.id}">
                            ${pipelineBookmarks.length === 0 ? `
                                <div style="padding: 0.75rem; color: var(--text-muted); font-size: 0.8rem; font-style: italic;">
                                    No articles in this pipeline yet
                                </div>
                            ` : pipelineBookmarks.map(b => `
                                <div class="bookmark-item" onclick="loadBookmark('${b.key}')">
                                    <i data-lucide="file-text" class="w-4 h-4" style="color: var(--text-muted);"></i>
                                    <span class="bookmark-item-title">${b.title}</span>
                                    <button onclick="event.stopPropagation(); removeFromPipeline('${b.key}', '${pipeline.id}')" style="color: var(--text-muted);" title="Remove from pipeline">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            // Empty state
            if (bookmarks.length === 0 && pipelines.every(p => !bookmarks.some(b => b.pipelineId === p.id))) {
                html = `
                    <div style="padding: 3rem 2rem; text-align: center;">
                        <i data-lucide="bookmark" class="w-12 h-12 mx-auto mb-4" style="color: var(--text-muted); opacity: 0.5;"></i>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">No saved articles yet</p>
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">Press <kbd>B</kbd> while reading to bookmark</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            lucide.createIcons();
        }

        function loadBookmark(key) {
            toggleBookmarksSidebar();
            loadReport(key);
        }

        function removeBookmark(key) {
            let bookmarks = getBookmarks();
            bookmarks = bookmarks.filter(b => b.key !== key);
            saveBookmarks(bookmarks);
            renderBookmarksSidebar();
            updateBookmarkButton();
        }

        function createNewPipeline() {
            const name = prompt('Enter a name for the new pipeline:');
            if (!name) return;

            const pipelines = getPipelines();
            const newPipeline = {
                id: 'pipeline_' + Date.now(),
                name: name,
                bookmarks: []
            };
            pipelines.push(newPipeline);
            savePipelines(pipelines);
            renderBookmarksSidebar();
        }

        function renamePipeline(pipelineId) {
            const pipelines = getPipelines();
            const pipeline = pipelines.find(p => p.id === pipelineId);
            if (!pipeline) return;

            const newName = prompt('Enter new name:', pipeline.name);
            if (!newName) return;

            pipeline.name = newName;
            savePipelines(pipelines);
            renderBookmarksSidebar();
        }

        function deletePipeline(pipelineId) {
            if (!confirm('Delete this pipeline? Articles will be moved back to Saved Articles.')) return;

            let pipelines = getPipelines();
            pipelines = pipelines.filter(p => p.id !== pipelineId);
            savePipelines(pipelines);

            // Move bookmarks back to ungrouped
            let bookmarks = getBookmarks();
            bookmarks = bookmarks.map(b => {
                if (b.pipelineId === pipelineId) {
                    delete b.pipelineId;
                }
                return b;
            });
            saveBookmarks(bookmarks);
            renderBookmarksSidebar();
        }

        function showAddToPipelineMenu(bookmarkKey) {
            const pipelines = getPipelines();
            const pipelineNames = pipelines.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            const choice = prompt(`Add to which pipeline?\n${pipelineNames}\n\nEnter number:`);

            if (!choice) return;
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= pipelines.length) {
                alert('Invalid choice');
                return;
            }

            const bookmarks = getBookmarks();
            const bookmark = bookmarks.find(b => b.key === bookmarkKey);
            if (bookmark) {
                bookmark.pipelineId = pipelines[index].id;
                saveBookmarks(bookmarks);
                renderBookmarksSidebar();
            }
        }

        function removeFromPipeline(bookmarkKey, pipelineId) {
            const bookmarks = getBookmarks();
            const bookmark = bookmarks.find(b => b.key === bookmarkKey);
            if (bookmark) {
                delete bookmark.pipelineId;
                saveBookmarks(bookmarks);
                renderBookmarksSidebar();
            }
        }

        // --- READING PROGRESS ---
        let readTime = 0;

        function initReadingProgress() {
            const content = document.getElementById('report-body');
            if (!content) return;

            const wordCount = content.innerText.split(/\s+/).length;
            readTime = Math.ceil(wordCount / 200);

            updateProgressBar();
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressContainer = document.getElementById('reading-progress');
            const reportView = document.getElementById('view-report');

            if (!progressBar || !reportView) return;

            const isReportView = reportView.classList.contains('active');

            if (!isReportView) {
                progressContainer.classList.remove('visible');
                return;
            }

            const scrollTop = window.scrollY;
            const docHeight = document.body.scrollHeight - window.innerHeight;
            const scrollPercent = docHeight > 0 ? Math.min((scrollTop / docHeight) * 100, 100) : 0;

            progressBar.style.width = scrollPercent + '%';
            if (progressText) {
                progressText.innerText = `${readTime} min read â€¢ ${Math.round(scrollPercent)}% complete`;
            }

            // Show/hide based on scroll position
            if (scrollTop > 100) {
                progressContainer.classList.add('visible');
            } else {
                progressContainer.classList.remove('visible');
            }
        }

        // Throttle scroll handler
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                updateProgressBar();
                scrollTimeout = null;
            }, 50);
        });

        // --- KEYBOARD SHORTCUTS ---
        function toggleShortcutsModal() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) {
                modal.classList.toggle('visible');
            }
        }

        function scrollToNextSection() {
            const sections = document.querySelectorAll('.prose-h2');
            const currentScroll = window.scrollY;

            for (const section of sections) {
                if (section.offsetTop > currentScroll + 150) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }

        function scrollToPrevSection() {
            const sections = Array.from(document.querySelectorAll('.prose-h2'));
            const currentScroll = window.scrollY;

            for (let i = sections.length - 1; i >= 0; i--) {
                if (sections[i].offsetTop < currentScroll - 50) {
                    sections[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Close modal on Escape
            if (e.key === 'Escape') {
                const modal = document.getElementById('shortcuts-modal');
                if (modal && modal.classList.contains('visible')) {
                    modal.classList.remove('visible');
                    return;
                }
                switchView('view-portal');
                return;
            }

            const reportView = document.getElementById('view-report');
            const isReportView = reportView && reportView.classList.contains('active');

            switch(e.key.toLowerCase()) {
                case 'j':
                    if (isReportView) {
                        e.preventDefault();
                        scrollToNextSection();
                    }
                    break;
                case 'k':
                    if (isReportView) {
                        e.preventDefault();
                        scrollToPrevSection();
                    }
                    break;
                case 'b':
                    if (isReportView) {
                        e.preventDefault();
                        toggleBookmark();
                    }
                    break;
                case 'p':
                    if (isReportView) {
                        e.preventDefault();
                        exportToPDF();
                    }
                    break;
                case 'm':
                    if (isReportView) {
                        e.preventDefault();
                        exportToMarkdown();
                    }
                    break;
                case 't':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'l':
                    e.preventDefault();
                    toggleBookmarksSidebar();
                    break;
                case '?':
                    e.preventDefault();
                    toggleShortcutsModal();
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    if (!isReportView) {
                        e.preventDefault();
                        const articles = ['ai_bubble', 'congress_trading', 'political_grift', 'semiconductor_wars'];
                        loadReport(articles[parseInt(e.key) - 1]);
                    }
                    break;
            }
        });

        // Override loadReport to track current article
        const originalLoadReport = loadReport;
        loadReport = function(key) {
            currentArticleKey = key;
            // Reset version toggle state when loading a new article
            isShowingOriginal = false;
            originalLoadReport(key);
            setTimeout(() => {
                initReadingProgress();
                updateBookmarkButton();
                updateDeepDiveBadge();
                // Initialize research dashboard panels
                initDashboard(key);
                // Update version toggle visibility and state
                const hasOriginal = !!originalVersions[key];
                updateVersionToggle(hasOriginal);
                const toggleBtn = document.getElementById('version-toggle-btn');
                if (toggleBtn) {
                    toggleBtn.classList.remove('showing-original');
                    toggleBtn.innerHTML = '<i data-lucide="history" class="w-4 h-4"></i><span class="hidden sm:inline">Original</span>';
                    toggleBtn.title = 'View original version';
                }
                // Also update enhance count if article was previously enhanced
                if (reports[key]?._enhanceCount) {
                    currentEnhanceCount = reports[key]._enhanceCount;
                    updateEnhanceCountBadge(currentEnhanceCount);
                }
                lucide.createIcons();
            }, 100);
        };

        // Initialize theme on load
        initTheme();

        // Restore badge minimized state
        restoreBadgeState();

        // Fetch user usage on page load
        fetchUserUsage();

        // Re-init Lucide icons after dynamic content
        setTimeout(() => lucide.createIcons(), 500);

        // ===== URL ROUTING FOR SHAREABLE LINKS =====
        const ARTICLE_PATH_PREFIX = '/article/';

        // Get article slug from URL path
        function getSlugFromUrl() {
            const path = window.location.pathname;
            if (path.startsWith(ARTICLE_PATH_PREFIX)) {
                return decodeURIComponent(path.slice(ARTICLE_PATH_PREFIX.length));
            }
            return null;
        }

        // Update URL when viewing an article
        function updateUrlForArticle(slug) {
            const newUrl = `${ARTICLE_PATH_PREFIX}${encodeURIComponent(slug)}`;
            if (window.location.pathname !== newUrl) {
                window.history.pushState({ slug, view: 'article' }, '', newUrl);
            }
        }

        // Update URL when returning to portal
        function updateUrlForPortal() {
            if (window.location.pathname !== '/') {
                window.history.pushState({ view: 'portal' }, '', '/');
            }
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.slug) {
                // Load article without pushing new history
                loadReportWithoutPush(event.state.slug);
            } else {
                // Return to portal
                switchView('view-portal');
            }
        });

        // Load report without adding to history (for back/forward)
        function loadReportWithoutPush(key) {
            const data = reports[key];
            if (!data) {
                loadCachedReportWithoutPush(key);
                return;
            }
            if (data._isDynamic && !data.content) {
                loadCachedReportWithoutPush(key);
                return;
            }
            renderReportData(data);
        }

        // Load cached report without pushing to history
        async function loadCachedReportWithoutPush(key) {
            try {
                switchView('view-report');
                document.getElementById('report-title').innerText = 'Loading...';
                document.getElementById('report-body').innerHTML = '<p class="prose-text">Retrieving article...</p>';

                // Use the fast slug endpoint
                const response = await fetch(`/api/article/${encodeURIComponent(key)}`);
                if (response.ok) {
                    const article = await response.json();
                    renderReportData(article, true);
                } else {
                    document.getElementById('report-title').innerText = 'Article Not Found';
                    document.getElementById('report-body').innerHTML = '<p class="prose-text">This article could not be found in the archive.</p>';
                }
            } catch (e) {
                console.error('Failed to load cached report:', e);
                document.getElementById('report-title').innerText = 'Error Loading Article';
                document.getElementById('report-body').innerHTML = '<p class="prose-text">Failed to retrieve the article. Please try again.</p>';
            }
        }

        // Initialize from URL on page load
        (function initFromUrl() {
            const slug = getSlugFromUrl();
            if (slug) {
                // Replace current history entry so back goes to portal
                window.history.replaceState({ slug, view: 'article' }, '', window.location.pathname);
                loadReportWithoutPush(slug);
            }
        })();
    </script>

    <!-- KEYBOARD SHORTCUTS MODAL -->
    <div id="shortcuts-modal">
        <div class="shortcuts-container">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold" style="color: var(--text-main);">Keyboard Shortcuts</h2>
                <button onclick="toggleShortcutsModal()" class="text-gray-500 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-1">
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Next section</span>
                    <kbd>J</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Previous section</span>
                    <kbd>K</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Bookmark article</span>
                    <kbd>B</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Export to PDF</span>
                    <kbd>P</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Export to Markdown</span>
                    <kbd>M</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Toggle theme</span>
                    <kbd>T</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Research library</span>
                    <kbd>L</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Return to portal</span>
                    <kbd>Esc</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Show shortcuts</span>
                    <kbd>?</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Load article 1-4</span>
                    <kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> <kbd>4</kbd>
                </div>
            </div>
        </div>
    </div>
</body>

</html>