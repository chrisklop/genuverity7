<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- VIEWPORT RESTORED -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GenuVerity | The Infinite Archive</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* === THEME SYSTEM - Dark/Light with Radix Colors === */
        /* Using Slate scale for neutrals, Blue for accents */
        /* WCAG AA compliant: 4.5:1 normal text, 3:1 large text */

        /* DARK MODE (Default) - Based on Radix Slate Dark */
        :root, [data-theme="dark"] {
            /* Background layers (Radix slate-dark 1-6) */
            --bg-deep: #111113;      /* slate-1: app background */
            --bg-card: #18191b;      /* slate-2: subtle background */
            --bg-elevated: #212225;  /* slate-3: UI element background */

            /* Text hierarchy (Radix slate-dark 11-12) */
            --text-main: #edeef0;    /* slate-12: high contrast text */
            --text-muted: #9ba1a6;   /* slate-11: low contrast text */
            --text-prose: #b0b4ba;   /* between 11-12 for body text */

            /* Borders and dividers */
            --border-color: rgba(255, 255, 255, 0.08);

            /* Accent colors (Radix Blue scale) */
            --accent-blue: #3e63dd;  /* blue-9: solid backgrounds */
            --accent-green: #30a46c; /* green-9: success states */
            --accent-warm: #f76b15;  /* orange-9: warning states */

            /* Logo styling */
            --logo-accent: #3e63dd;
            --logo-bg: linear-gradient(135deg, #1f2f6d, #3e63dd);
            --logo-text: #edeef0;

            /* Glass effects */
            --glass: rgba(17, 17, 19, 0.95);
            --glass-border: rgba(62, 99, 221, 0.15);

            /* Shadows and gradients */
            --shadow-color: rgba(0, 0, 0, 0.5);
            --gradient-start: #151517;
            --gradient-end: #111113;
            --chart-bg: rgba(62, 99, 221, 0.06);
        }

        /* LIGHT MODE - Based on Radix Slate Light */
        [data-theme="light"] {
            /* Background layers (Radix slate-light 1-6) */
            --bg-deep: #fbfcfd;      /* slate-1: app background */
            --bg-card: #ffffff;      /* white for cards */
            --bg-elevated: #f1f3f5;  /* slate-3: UI element background */

            /* Text hierarchy (Radix slate-light 11-12) */
            --text-main: #1c2024;    /* slate-12: high contrast text */
            --text-muted: #60646c;   /* slate-11: low contrast text */
            --text-prose: #3e4249;   /* between 11-12 for body text */

            /* Borders and dividers */
            --border-color: rgba(0, 0, 0, 0.08);

            /* Accent colors (Radix Blue scale - light mode) */
            --accent-blue: #3e63dd;  /* blue-9: solid backgrounds */
            --accent-green: #30a46c; /* green-9: success states */
            --accent-warm: #f76b15;  /* orange-9: warning states */

            /* Logo styling */
            --logo-accent: #3e63dd;
            --logo-bg: linear-gradient(135deg, #1f2f6d, #3e63dd);
            --logo-text: #ffffff;

            /* Glass effects */
            --glass: rgba(251, 252, 253, 0.95);
            --glass-border: rgba(62, 99, 221, 0.12);

            /* Shadows and gradients */
            --shadow-color: rgba(0, 0, 0, 0.06);
            --gradient-start: #eef1f4;
            --gradient-end: #fbfcfd;
            --chart-bg: rgba(62, 99, 221, 0.04);
        }

        /* System preference detection - auto-apply light mode */
        @media (prefers-color-scheme: light) {
            :root:not([data-theme="dark"]) {
                /* Background layers */
                --bg-deep: #fbfcfd;
                --bg-card: #ffffff;
                --bg-elevated: #f1f3f5;

                /* Text hierarchy */
                --text-main: #1c2024;
                --text-muted: #60646c;
                --text-prose: #3e4249;

                /* Borders */
                --border-color: rgba(0, 0, 0, 0.08);

                /* Accents */
                --accent-blue: #3e63dd;
                --accent-green: #30a46c;
                --accent-warm: #f76b15;

                /* Logo */
                --logo-accent: #3e63dd;
                --logo-bg: linear-gradient(135deg, #1f2f6d, #3e63dd);
                --logo-text: #ffffff;

                /* Glass */
                --glass: rgba(251, 252, 253, 0.95);
                --glass-border: rgba(62, 99, 221, 0.12);

                /* Shadows */
                --shadow-color: rgba(0, 0, 0, 0.06);
                --gradient-start: #eef1f4;
                --gradient-end: #fbfcfd;
                --chart-bg: rgba(62, 99, 221, 0.04);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(circle at 50% 0%, var(--gradient-start) 0%, var(--gradient-end) 80%);
            transition: background-color 0.3s, color 0.3s;
        }

        /* === READING PROGRESS BAR === */
        #reading-progress {
            position: fixed;
            top: 64px;
            left: 0;
            right: 0;
            z-index: 40;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-color);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        #reading-progress.visible {
            transform: translateY(0);
        }

        #progress-bar {
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
            width: 0%;
            transition: width 0.1s ease-out;
        }

        /* === KEYBOARD SHORTCUTS MODAL === */
        #shortcuts-modal {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #shortcuts-modal.visible {
            display: flex;
        }

        .shortcuts-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px var(--shadow-color);
        }

        .shortcut-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 4px 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-main);
            box-shadow: 0 2px 0 var(--shadow-color);
        }

        /* === LOGO STYLING === */
        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: var(--logo-bg);
            color: var(--logo-text);
            transition: background 0.3s, color 0.3s;
        }

        /* === LOGO VERITY CIRCUIT TRACE === */
        .logo-verity {
            color: var(--logo-accent);
            position: relative;
            display: inline-block;
        }

        /* Circuit trace underline - thin line beneath the text */
        .logo-verity::after {
            content: '';
            position: absolute;
            bottom: 0.05em;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg,
                transparent 0%,
                var(--logo-accent) 50%,
                transparent 100%
            );
            opacity: 0;
            animation: circuit-trace 12s ease-in-out infinite;
            animation-delay: 3s;
        }

        /* The traveling energy pulse */
        .logo-verity::before {
            content: '';
            position: absolute;
            bottom: 0.05em;
            left: -10%;
            width: 20%;
            height: 2px;
            background: linear-gradient(90deg,
                transparent,
                rgba(62, 99, 221, 0.8),
                #fff,
                rgba(62, 99, 221, 0.8),
                transparent
            );
            opacity: 0;
            filter: blur(0.5px);
            box-shadow: 0 0 8px rgba(62, 99, 221, 0.6), 0 0 16px rgba(62, 99, 221, 0.3);
            animation: circuit-pulse 12s ease-in-out infinite;
            animation-delay: 3s;
        }

        @keyframes circuit-trace {
            0%, 85%, 100% { opacity: 0; }
            88%, 97% { opacity: 0.4; }
        }

        @keyframes circuit-pulse {
            0%, 85% {
                opacity: 0;
                left: -20%;
            }
            88% {
                opacity: 1;
                left: -20%;
            }
            97% {
                opacity: 1;
                left: 100%;
            }
            100% {
                opacity: 0;
                left: 100%;
            }
        }

        /* Circuit trace for Sources First header - green themed */
        .sources-first-title h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-green) 50%, transparent 100%);
            opacity: 0;
            animation: circuit-trace-green 15s ease-in-out infinite;
            animation-delay: 5s;
        }

        .sources-first-title h3::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: -10%;
            width: 20%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.8), #fff, rgba(16, 185, 129, 0.8), transparent);
            opacity: 0;
            filter: blur(0.3px);
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.6);
            animation: circuit-pulse-green 15s ease-in-out infinite;
            animation-delay: 5s;
        }

        @keyframes circuit-trace-green {
            0%, 87%, 100% { opacity: 0; }
            90%, 97% { opacity: 0.5; }
        }

        @keyframes circuit-pulse-green {
            0%, 87% { opacity: 0; left: -20%; }
            90% { opacity: 1; left: -20%; }
            97% { opacity: 1; left: 100%; }
            100% { opacity: 0; left: 100%; }
        }

        /* Circuit trace for report title - one-time on load */
        #report-title {
            position: relative;
            display: inline-block;
        }

        #report-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-blue) 50%, transparent 100%);
            opacity: 0;
            animation: title-trace 2s ease-out forwards;
            animation-delay: 0.5s;
        }

        #report-title::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10%;
            width: 25%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(62, 99, 221, 0.8), #fff, rgba(62, 99, 221, 0.8), transparent);
            opacity: 0;
            filter: blur(0.5px);
            box-shadow: 0 0 8px rgba(62, 99, 221, 0.6);
            animation: title-pulse 2s ease-out forwards;
            animation-delay: 0.5s;
        }

        @keyframes title-trace {
            0%, 20% { opacity: 0; }
            30%, 80% { opacity: 0.4; }
            100% { opacity: 0; }
        }

        @keyframes title-pulse {
            0%, 20% { opacity: 0; left: -25%; }
            30% { opacity: 1; left: -25%; }
            80% { opacity: 1; left: 100%; }
            100% { opacity: 0; left: 100%; }
        }

        /* === THEME TOGGLE BUTTON === */
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        .theme-toggle:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
            border-color: var(--accent-blue);
        }

        /* === NAVBAR SOURCES BUTTON === */
        .nav-sources-btn {
            display: none; /* Hidden by default, shown on essay pages */
            align-items: center;
            gap: 0.5rem;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--accent-green);
            background: transparent;
            color: var(--text-main);
            font-size: 0.75rem;
            font-weight: 600;
            position: relative;
        }

        .nav-sources-btn.visible {
            display: flex;
        }

        .nav-sources-btn svg {
            color: var(--accent-green);
        }

        .nav-sources-btn .nav-sources-label {
            display: none;
        }

        @media (min-width: 640px) {
            .nav-sources-btn .nav-sources-label {
                display: inline;
            }
        }

        .nav-sources-btn .nav-sources-count {
            background: var(--accent-green);
            color: var(--bg-deep);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .nav-sources-btn:hover {
            background: var(--accent-green);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .nav-sources-btn:hover svg {
            color: white;
        }

        .nav-sources-btn:hover .nav-sources-count {
            background: white;
            color: var(--accent-green);
        }

        /* Glow animation when sources are collapsed - subtle and slow */
        .nav-sources-btn.collapsed::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 22px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(16, 185, 129, 0.1) 25%,
                rgba(16, 185, 129, 0.15) 50%,
                rgba(16, 185, 129, 0.1) 75%,
                transparent 100%
            );
            background-size: 200% 100%;
            z-index: -1;
            animation: nav-sources-glow 30s ease-in-out infinite;
            filter: blur(4px);
        }

        @keyframes nav-sources-glow {
            0%, 100% { background-position: 200% 0; opacity: 0.2; }
            50% { background-position: -200% 0; opacity: 0.25; }
        }

        /* === DARK/LIGHT THEME TOGGLE === */
        .theme-toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .theme-toggle-switch:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-blue);
            color: var(--text-main);
        }

        .theme-toggle-switch .icon-sun,
        .theme-toggle-switch .icon-moon {
            width: 16px;
            height: 16px;
            transition: opacity 0.2s, transform 0.3s;
        }

        /* Show sun in dark mode, moon in light mode */
        :root .theme-toggle-switch .icon-sun,
        [data-theme="dark"] .theme-toggle-switch .icon-sun {
            opacity: 1;
        }
        :root .theme-toggle-switch .icon-moon,
        [data-theme="dark"] .theme-toggle-switch .icon-moon {
            opacity: 0;
            position: absolute;
        }

        [data-theme="light"] .theme-toggle-switch .icon-sun {
            opacity: 0;
            position: absolute;
        }
        [data-theme="light"] .theme-toggle-switch .icon-moon {
            opacity: 1;
            position: relative;
        }

        .theme-toggle-switch .toggle-label {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* === ACTION BUTTONS === */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
        }

        .action-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
            border-color: var(--accent-blue);
        }

        .action-btn.primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #1a1410;
        }

        .action-btn.primary:hover {
            background: #a68520;
        }

        .action-btn.enhance-btn {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border-color: #8b5cf6;
            color: white;
            position: relative;
            overflow: visible;
        }

        /* Occasional sparkle animation in top-right corner */
        .action-btn.enhance-btn::after {
            content: 'âœ¦';
            position: absolute;
            top: -4px;
            right: -2px;
            font-size: 10px;
            color: #fbbf24;
            text-shadow: 0 0 4px #fbbf24, 0 0 8px #f59e0b;
            opacity: 0;
            transform: scale(0) rotate(0deg);
            animation: enhance-sparkle 8s ease-in-out infinite;
            animation-delay: 2s;
            pointer-events: none;
        }

        @keyframes enhance-sparkle {
            0%, 90%, 100% {
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            92% {
                opacity: 1;
                transform: scale(1.2) rotate(15deg);
            }
            94% {
                opacity: 0.8;
                transform: scale(0.9) rotate(-10deg);
            }
            96% {
                opacity: 1;
                transform: scale(1.1) rotate(5deg);
            }
            98% {
                opacity: 0.6;
                transform: scale(0.8) rotate(-5deg);
            }
        }

        .action-btn.enhance-btn:hover::after {
            animation: enhance-sparkle-hover 1.5s ease-in-out infinite;
        }

        @keyframes enhance-sparkle-hover {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: scale(1.3) rotate(15deg);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.1) rotate(-10deg);
            }
            75% {
                opacity: 1;
                transform: scale(1.2) rotate(10deg);
            }
        }

        .action-btn.enhance-btn:hover {
            background: linear-gradient(135deg, #9d7cf8, #7578f3);
            border-color: #9d7cf8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .action-btn.enhance-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .action-btn.enhance-btn:disabled::after {
            animation: none;
            opacity: 0;
        }

        /* --- VIEW MANAGEMENT --- */
        .view-section {
            display: none;
            padding-top: 80px;
            /* Offset for Nav */
            min-height: 100vh;
            padding-bottom: 100px;
            width: 100%;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- NAVIGATION --- */
        .nav-glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-link {
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
            font-weight: 600;
        }

        .nav-link:hover {
            color: var(--text-main);
        }

        /* --- MAGAZINE LAYOUT ENGINE --- */
        .article-container {
            max-width: 900px;
            margin: 0 auto;
            display: block;
        }

        /* Report View - Professional Single Column Layout */
        .report-layout {
            display: block;
            max-width: 720px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .report-main {
            width: 100%;
        }

        @media (min-width: 768px) {
            .report-layout {
                padding: 0 2rem;
            }
        }

        @media (min-width: 1200px) {
            .report-layout {
                max-width: 760px;
                padding: 0;
            }
        }

        /* === SOURCES FIRST BANNER - TABBED VERSION === */
        .sources-first-banner {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 2rem;
            position: relative;
            overflow: visible;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* The sliding content wrapper */
        .sources-first-content {
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }

        .sources-first-banner.collapsed .sources-first-content {
            max-height: 0 !important;
            opacity: 0;
        }

        .sources-first-banner.collapsed {
            border-color: transparent;
            background: transparent;
            margin-bottom: 0.5rem;
        }

        .sources-first-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-green), var(--accent-blue));
            background-size: 200% 100%;
            animation: sources-gradient 3s ease infinite;
            transition: opacity 0.3s ease;
        }

        .sources-first-banner.collapsed::before {
            opacity: 0;
        }

        @keyframes sources-gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .sources-first-inner {
            padding: 1.25rem;
        }

        .sources-first-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .sources-first-title-group {
            display: flex;
            align-items: center;
        }

        /* Minimize button in Sources First header */
        .sources-minimize-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sources-minimize-btn:hover {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .sources-minimize-btn:hover svg {
            color: white;
        }

        .sources-minimize-btn svg {
            color: var(--accent-green);
            transition: transform 0.3s ease;
        }

        .sources-first-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sources-first-title h3 {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--accent-blue);
            margin: 0;
            position: relative;
            display: inline-block;
        }

        .sources-first-title .shield-icon {
            color: var(--accent-green);
            animation: shield-pulse 2s ease-in-out infinite;
        }

        @keyframes shield-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }

        .sources-first-byline {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-style: italic;
        }

        /* Tab Navigation */
        .sources-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
        }

        .sources-tab {
            position: relative;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            cursor: pointer;
            transition: all 0.25s ease;
            white-space: nowrap;
        }

        .sources-tab:hover {
            color: var(--text-main);
        }

        .sources-tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        .sources-tab .tab-count {
            display: inline-block;
            background: var(--bg-deep);
            color: var(--text-muted);
            font-size: 0.6rem;
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
        }

        .sources-tab.active .tab-count {
            background: var(--accent-blue);
            color: white;
        }

        /* Mobile tabs - horizontal scroll */
        @media (max-width: 480px) {
            .sources-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .sources-tabs::-webkit-scrollbar { display: none; }
            .sources-tab { font-size: 0.65rem; padding: 0.4rem 0.6rem; }
        }

        /* Tab Content Panels */
        .sources-tab-panels {
            position: relative;
            min-height: 180px;
        }

        .sources-tab-panel {
            display: none;
            animation: tab-fade-in 0.3s ease;
        }

        .sources-tab-panel.active {
            display: block;
        }

        @keyframes tab-fade-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tab CTA - subtle encouragement */
        .tab-cta {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-style: italic;
        }

        .tab-cta i {
            color: var(--accent-blue);
            opacity: 0.7;
        }

        .sources-first-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
        }

        @media (max-width: 768px) {
            .sources-first-grid {
                grid-template-columns: 1fr;
            }
        }

        .top-source-card {
            background: var(--bg-deep);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            animation: source-fade-in 0.4s ease forwards;
            opacity: 0;
            transform: translateY(8px);
        }

        .top-source-card:nth-child(1) { animation-delay: 0.05s; }
        .top-source-card:nth-child(2) { animation-delay: 0.1s; }
        .top-source-card:nth-child(3) { animation-delay: 0.15s; }
        .top-source-card:nth-child(4) { animation-delay: 0.2s; }

        @keyframes source-fade-in {
            to { opacity: 1; transform: translateY(0); }
        }

        .top-source-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px -4px rgba(0, 0, 150, 0.15);
        }

        .top-source-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 20px 20px 0;
            border-color: transparent var(--accent-green) transparent transparent;
            opacity: 0.7;
        }

        .top-source-rank {
            font-size: 0.6rem;
            font-weight: 800;
            color: var(--accent-blue);
            margin-bottom: 0.2rem;
            opacity: 0.7;
        }

        .top-source-domain {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.2rem;
        }

        .top-source-title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-main);
            line-height: 1.3;
            margin-bottom: 0.4rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .top-source-score {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .top-source-score-bar {
            flex: 1;
            height: 3px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .top-source-score-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.8s ease;
        }

        .top-source-score-fill.high { background: linear-gradient(90deg, #10b981, #34d399); }
        .top-source-score-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .top-source-score-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }

        .top-source-score-value {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent-green);
            min-width: 26px;
            text-align: right;
        }

        /* Portal Layout with Independent Scroll */
        .portal-layout {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 80px);
            padding: 0 1rem;
        }

        .portal-left {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 0;
        }

        .portal-right {
            padding: 2rem 0;
        }

        @media (min-width: 1024px) {
            .portal-layout {
                flex-direction: row;
                height: calc(100vh - 80px);
                overflow: hidden;
                padding: 0 2rem;
            }

            .portal-left {
                width: 50%;
                flex-shrink: 0;
                align-items: flex-start;
                padding-left: 6rem;
                position: sticky;
                top: 80px;
                height: calc(100vh - 80px);
            }

            .portal-right {
                width: 50%;
                height: calc(100vh - 80px);
                overflow-y: auto;
                padding: 3rem 2rem 3rem 0;
                scrollbar-width: thin;
                scrollbar-color: var(--border-color) transparent;
            }

            .portal-right::-webkit-scrollbar {
                width: 6px;
            }

            .portal-right::-webkit-scrollbar-track {
                background: transparent;
            }

            .portal-right::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 3px;
            }

            .portal-right::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }
        }

        .prose-text {
            font-family: 'Inter', sans-serif;
            font-size: 1.25rem;
            line-height: 1.8;
            color: var(--text-prose);
            text-align: justify;
            margin-bottom: 2rem;
        }

        .prose-h2 {
            font-family: 'Inter', sans-serif;
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-top: 3rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding-bottom: 10px;
            /* clear: both; REMOVED to allow headers to wrap next to floats */
            position: relative;
            z-index: 2;
            /* Ensure text is above any weird float issues */
        }

        /* FLOATS (The Wrapping) */
        .float-figure {
            width: 100%;
            margin: 2rem 0;
            background: var(--chart-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 10px 30px var(--shadow-color);
            /* shape-outside is key for magazine wrapping */
            shape-outside: margin-box;
            margin-bottom: 2rem;
            clear: both;
            /* Fallback for mobile */
        }

        @media (min-width: 1024px) {
            .float-figure {
                clear: none;
            }

            /* Allow side-by-side on desktop */

            .float-figure.right {
                float: right;
                width: 40%;
                /* Reduced for better wrapping */
                margin-left: 3rem;
                margin-bottom: 1.5rem;
                margin-top: 0.8rem;
                shape-margin: 2rem;
            }

            .float-figure.left {
                float: left;
                width: 40%;
                /* Reduced for better wrapping */
                margin-right: 3rem;
                margin-bottom: 1.5rem;
                margin-top: 0.8rem;
                shape-margin: 2rem;
            }
        }

        .fig-caption {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .fig-deep-dive {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            vertical-align: middle;
            position: relative;
        }

        .fig-deep-dive:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        [data-theme="light"] .fig-deep-dive {
            background: rgba(59, 130, 246, 0.08);
        }

        /* Deep Dive Hover Preview Tooltip */
        .deep-dive-tooltip {
            position: fixed;
            width: 280px;
            max-width: 90vw;
            padding: 12px 14px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            pointer-events: none;
        }

        .deep-dive-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--border-color);
        }

        .deep-dive-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 7px solid transparent;
            border-top-color: var(--card-bg);
            z-index: 1;
        }

        .deep-dive-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-context {
            font-size: 0.8rem;
            line-height: 1.5;
            color: var(--text-prose);
            margin-bottom: 10px;
        }

        .tooltip-action {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--accent-blue), #4f46e5);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .tooltip-action:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .tooltip-rabbit {
            font-size: 1rem;
        }

        /* HIGHLIGHTS & LIVING NUMBERS */
        .highlight-glow {
            color: var(--text-main);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.4);
            font-weight: 700;
        }

        [data-theme="light"] .highlight-glow {
            text-shadow: none;
            background: linear-gradient(120deg, rgba(59, 130, 246, 0.2) 0%, rgba(16, 185, 129, 0.2) 100%);
            padding: 0 4px;
            border-radius: 4px;
        }

        /* Light mode text fixes */
        [data-theme="light"] .text-white {
            color: var(--text-main) !important;
        }

        [data-theme="light"] strong.text-white {
            color: var(--text-main) !important;
        }

        [data-theme="light"] .trending-card h3 {
            color: var(--text-main) !important;
        }

        [data-theme="light"] .hover\:text-white:hover {
            color: var(--text-main) !important;
        }

        [data-theme="light"] .fractal-trigger {
            color: var(--accent-blue) !important;
        }

        [data-theme="light"] .fractal-trigger:hover {
            color: var(--text-main) !important;
        }

        /* Keep logo G styled properly */
        [data-theme="light"] .bg-blue-600.text-white {
            color: white !important;
        }

        .living-number {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
            font-weight: 700;
            display: inline-block;
        }

        /* INTERACTIVE ELEMENTS */
        .fractal-trigger {
            border-bottom: 1px dashed var(--accent-blue);
            color: #93c5fd;
            cursor: zoom-in;
            transition: all 0.2s;
            font-weight: 700;
            position: relative;
        }

        .fractal-trigger:hover {
            background: rgba(59, 130, 246, 0.15);
            color: white;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* INTERACTIVE ELEMENTS */
        .fractal-trigger {
            border-bottom: 1px dashed var(--accent-blue);
            color: #93c5fd;
            cursor: zoom-in;
            transition: all 0.2s;
            font-weight: 700;
            position: relative;
        }

        .fractal-trigger:hover {
            background: rgba(59, 130, 246, 0.15);
            color: white;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* INTELLIGENCE CARD (Rich Tooltip) */
        .intelligence-card {
            visibility: hidden;
            position: fixed;
            /* Fixed to avoid overflow issues */
            width: 320px;
            background: rgba(15, 23, 42, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px);
            pointer-events: none;
            /* Let clicks pass through if needed, but usually we want it strictly informational */
        }

        .intelligence-card.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* FRACTAL TRIGGER TOOLTIP */
        .fractal-tooltip {
            visibility: hidden;
            position: fixed;
            width: 280px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.1));
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(59, 130, 246, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
            transform: translateY(8px);
            pointer-events: none;
        }

        .fractal-tooltip.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .fractal-tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .fractal-tooltip-title {
            font-weight: 700;
            color: #93c5fd;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fractal-tooltip-action {
            font-size: 10px;
            color: rgba(147, 197, 253, 0.7);
            background: rgba(59, 130, 246, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .fractal-tooltip-content {
            font-size: 12px;
            color: var(--text-prose);
            line-height: 1.5;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }

        .source-domain {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .trust-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .trust-high {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .trust-med {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .card-title {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .card-snippet {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            color: #cbd5e1;
            line-height: 1.5;
        }

        /* The Spade Citation */
        .citation-spade {
            font-family: 'Inter', sans-serif;
            color: var(--accent-green);
            font-size: 0.75rem;
            vertical-align: super;
            cursor: pointer;
            margin-left: 1px;
            opacity: 0.7;
            transition: all 0.2s;
            display: inline-block;
            padding: 0 2px;
        }

        .citation-spade:hover {
            opacity: 1;
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.6);
        }

        /* Link append style */
        a.citation-link {
            text-decoration: none;
            color: inherit;
        }

        .fractal-context {
            display: none;
            margin: 1rem 0 1rem 2rem;
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            border-left: 3px solid var(--accent-blue);
            border-radius: 0 8px 8px 0;
            font-size: 1rem;
            color: #e2e8f0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            clear: both;
        }

        .fractal-context.open {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Trending Cards - Base */
        .trending-card {
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.3s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 1rem;
        }

        .trending-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
            background: var(--bg-elevated);
        }

        [data-theme="light"] .trending-card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        [data-theme="light"] .trending-card p {
            color: var(--text-muted) !important;
        }

        /* Graduated Card Sizes - 1st is largest, decreasing to 4th (30% reduced) */
        .trending-card-1 {
            padding: 1.25rem;
        }
        .trending-card-1 h3 { font-size: 1.25rem; }
        .trending-card-1 p { font-size: 0.9rem; line-height: 1.5; }

        .trending-card-2 {
            padding: 1rem;
        }
        .trending-card-2 h3 { font-size: 1.1rem; }
        .trending-card-2 p { font-size: 0.85rem; }

        .trending-card-3 {
            padding: 0.875rem;
        }
        .trending-card-3 h3 { font-size: 1rem; }
        .trending-card-3 p { font-size: 0.8rem; }

        .trending-card-4 {
            padding: 0.75rem;
        }
        .trending-card-4 h3 { font-size: 0.9rem; }
        .trending-card-4 p { font-size: 0.75rem; }

        /* 2-column card layout - content left, sources right */
        .card-inner {
            display: flex;
            gap: 1rem;
        }
        .card-content {
            flex: 1;
            min-width: 0;
        }
        .card-sources {
            width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            border-left: 1px solid var(--border-color);
            padding-left: 0.75rem;
            font-size: 0.65rem;
        }
        .card-sources .source-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-sources .source-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .card-sources .source-dot.high { background: #10b981; }
        .card-sources .source-dot.medium { background: #f59e0b; }
        .card-sources .source-dot.low { background: #ef4444; }

        @media (max-width: 640px) {
            .card-sources { display: none; }
        }

        /* 5th card and beyond - Compact list style */
        .trending-card-list {
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.3s;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .trending-card-list:hover {
            transform: translateX(4px);
            border-color: var(--accent-blue);
            background: var(--bg-elevated);
        }

        .trending-card-list .card-tag {
            font-size: 0.55rem;
            white-space: nowrap;
            min-width: 70px;
        }

        .trending-card-list h4 {
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.3;
            flex: 1;
        }

        [data-theme="light"] .trending-card-list {
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }

        /* Expand/Browse section */
        .browse-more-header {
            padding: 0.75rem 1rem;
            border: 1px dashed var(--border-color);
            border-radius: 0.5rem;
            background: transparent;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        /* Typewriter effect */
        .typewriter {
            overflow: hidden;
            white-space: nowrap;
            border-right: 2px solid var(--text-muted);
            animation: typing 4s steps(40, end) forwards, blink-caret 0.75s step-end infinite;
        }

        .typewriter.done {
            border-right: none;
            animation: none;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: var(--text-muted); }
        }

        /* Rabbit Hole Button */
        .rabbit-hole-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 6px;
            color: #93c5fd;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rabbit-hole-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            transform: translateX(4px);
        }

        /* === DEEP DIVE LOADING SCREEN === */
        #deep-dive-loader {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(5, 5, 5, 0.97);
            backdrop-filter: blur(20px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
        }

        #deep-dive-loader.visible {
            display: flex;
        }

        /* Morphing blob animation - trust-evoking organic movement */
        .loader-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .loader-blob {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #8b6914 0%, #c9a227 30%, #e8b84a 50%, #d4a574 70%, #8b6914 100%);
            background-size: 300% 300%;
            animation: morphBlob 8s ease-in-out infinite, gradientShift 6s ease infinite, floatBlob 4s ease-in-out infinite;
            filter: blur(0px);
            box-shadow:
                0 0 60px rgba(201, 162, 39, 0.5),
                0 0 100px rgba(212, 165, 116, 0.3),
                inset 0 0 30px rgba(255, 240, 200, 0.15);
        }

        .loader-blob::before {
            content: '';
            position: absolute;
            inset: 3px;
            background: rgba(26, 20, 16, 0.4);
            border-radius: inherit;
            animation: morphBlob 8s ease-in-out infinite reverse;
        }

        /* Scanning lines effect */
        .loader-scan {
            position: absolute;
            inset: -10px;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(201, 162, 39, 0.04) 2px,
                rgba(201, 162, 39, 0.04) 4px
            );
            animation: scanMove 2s linear infinite;
            pointer-events: none;
        }

        @keyframes morphBlob {
            0%, 100% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
            25% {
                border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
            }
            50% {
                border-radius: 50% 60% 30% 60% / 30% 70% 60% 40%;
            }
            75% {
                border-radius: 60% 40% 60% 30% / 70% 30% 50% 60%;
            }
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes floatBlob {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.02); }
        }

        @keyframes scanMove {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        /* Status indicators */
        .loader-status {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.5;
            transition: opacity 0.3s, color 0.3s;
        }

        .status-item.active {
            opacity: 1;
            color: var(--accent-green);
        }

        .status-item.active .status-dot {
            background: var(--accent-green);
            box-shadow: 0 0 8px var(--accent-green);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-item.complete {
            opacity: 1;
            color: var(--accent-blue);
        }

        .status-item.complete .status-dot {
            background: var(--accent-blue);
        }

        .status-item.complete::after {
            content: 'âœ“';
            font-size: 0.6rem;
            margin-left: 0.25rem;
            color: var(--accent-blue);
        }

        .status-item.done {
            opacity: 1;
            color: var(--accent-green);
        }

        .status-item.done .status-dot {
            background: var(--accent-green);
        }

        .status-item.done::after {
            content: 'âœ“';
            font-size: 0.6rem;
            margin-left: 0.25rem;
            color: var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s;
        }

        .loader-text {
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #e2e2e5;
            text-align: center;
        }

        .loader-subtext {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: #6b7280;
            max-width: 450px;
            text-align: center;
            line-height: 1.7;
        }

        /* Context Preview in Loader */
        .loader-context-preview {
            margin-top: 1.5rem;
            max-width: 500px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            text-align: left;
        }

        .context-preview-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .context-preview-text {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--text-prose);
            line-height: 1.6;
            max-height: 120px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .context-preview-text::-webkit-scrollbar {
            width: 4px;
        }

        .context-preview-text::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .loader-progress {
            width: 300px;
            height: 3px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .loader-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b6914, #c9a227, #e8b84a, #d4a574);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.3s ease-out;
            animation: shimmer 2s linear infinite;
            border-radius: 2px;
        }

        @keyframes progress {
            0% { width: 0%; }
            5% { width: 8%; }
            15% { width: 20%; }
            30% { width: 35%; }
            50% { width: 55%; }
            70% { width: 72%; }
            85% { width: 85%; }
            100% { width: 95%; }
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* === LANDING PAGE ANIMATIONS === */

        /* Soft bouncy drop-in animation */
        @keyframes dropIn {
            0% {
                opacity: 0;
                transform: translateY(-30px);
            }
            60% {
                opacity: 1;
                transform: translateY(8px);
            }
            80% {
                transform: translateY(-4px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Gentle fade-up for cards */
        @keyframes fadeUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Soft attention roll for logo - gentle and refined */
        @keyframes attentionBounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            25% {
                transform: translateY(-5px) scale(1.01);
            }
            50% {
                transform: translateY(-2px) scale(1.005);
            }
            75% {
                transform: translateY(-1px) scale(1.002);
            }
        }

        /* Animation classes */
        .anim-drop-in {
            animation: dropIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0;
        }

        .anim-fade-up {
            animation: fadeUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .anim-attention {
            animation: attentionBounce 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Staggered delays for children */
        .anim-delay-1 { animation-delay: 0.1s; }
        .anim-delay-2 { animation-delay: 0.2s; }
        .anim-delay-3 { animation-delay: 0.3s; }
        .anim-delay-4 { animation-delay: 0.4s; }
        .anim-delay-5 { animation-delay: 0.5s; }
        .anim-delay-6 { animation-delay: 0.6s; }
        .anim-delay-7 { animation-delay: 0.7s; }
        .anim-delay-8 { animation-delay: 0.8s; }

        /* === BOOKMARKS SIDEBAR === */
        #bookmarks-sidebar {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 360px;
            background: var(--bg-card);
            border-left: 1px solid var(--border-color);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            overflow-y: auto;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.3);
        }

        #bookmarks-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pipeline-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 0;
        }

        .pipeline-header:hover {
            color: var(--accent-blue);
        }

        .pipeline-items {
            margin-top: 0.75rem;
        }

        .bookmark-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .bookmark-item:hover {
            background: var(--bg-elevated);
        }

        .bookmark-item-title {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-pipeline-btn {
            width: 100%;
            padding: 0.75rem;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .add-pipeline-btn:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        /* === FLOATING DEEP DIVE BADGE === */
        #deep-dive-badge {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 90;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        #deep-dive-badge.visible {
            display: flex;
        }

        #deep-dive-badge.minimized {
            min-width: auto;
            padding: 8px 12px;
            border-radius: 20px;
        }

        #deep-dive-badge.minimized .badge-expanded {
            display: none;
        }

        #deep-dive-badge.minimized .badge-minimized {
            display: flex;
        }

        .badge-minimized {
            display: none;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }

        .badge-toggle:hover {
            color: var(--accent-blue);
        }

        .badge-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-blue);
        }

        .badge-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .badge-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .badge-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .badge-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .badge-free {
            color: var(--accent-green) !important;
        }

        .badge-paid {
            color: #f59e0b !important;
        }

        .badge-divider {
            width: 1px;
            height: 30px;
            background: var(--border-color);
        }

        .badge-remaining {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(124, 154, 94, 0.1);
            border: 1px solid rgba(124, 154, 94, 0.3);
            border-radius: 6px;
            font-size: 0.7rem;
            color: var(--accent-green);
        }

        .badge-remaining.depleted {
            background: rgba(196, 92, 62, 0.1);
            border-color: rgba(196, 92, 62, 0.3);
            color: #c45c3e;
        }

        /* === PDF PRINT STYLES === */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            .nav-glass, #reading-progress, #shortcuts-modal, #bookmarks-sidebar, #deep-dive-loader, #deep-dive-badge {
                display: none !important;
            }
            .view-section {
                padding-top: 0 !important;
            }
            .float-figure {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .prose-h2 {
                page-break-after: avoid;
            }
        }
    </style>
</head>

<body>

    <!-- DEEP DIVE LOADING SCREEN -->
    <div id="deep-dive-loader">
        <div class="loader-container">
            <div class="loader-blob"></div>
            <div class="loader-scan"></div>
        </div>
        <div class="loader-text" id="loader-title">Generating Intelligence Report</div>
        <div class="loader-subtext" id="loader-subtitle">Researching sources, cross-referencing data, and synthesizing insights...</div>

        <!-- Context Preview Section -->
        <div id="loader-context-preview" class="loader-context-preview" style="display: none;">
            <div class="context-preview-label">Using context from parent article:</div>
            <div id="loader-context-text" class="context-preview-text"></div>
        </div>

        <div class="loader-status" id="loader-status-stages">
            <div class="status-item" id="status-init">
                <span class="status-dot"></span>
                <span>Initializing</span>
            </div>
            <div class="status-item" id="status-connect">
                <span class="status-dot"></span>
                <span>Connecting</span>
            </div>
            <div class="status-item" id="status-research">
                <span class="status-dot"></span>
                <span>Researching</span>
            </div>
            <div class="status-item" id="status-writing">
                <span class="status-dot"></span>
                <span>Writing</span>
            </div>
            <div class="status-item" id="status-analysis">
                <span class="status-dot"></span>
                <span>Analyzing</span>
            </div>
            <div class="status-item" id="status-charts">
                <span class="status-dot"></span>
                <span>Charts</span>
            </div>
            <div class="status-item" id="status-sources">
                <span class="status-dot"></span>
                <span>Sources</span>
            </div>
            <div class="status-item" id="status-complete">
                <span class="status-dot"></span>
                <span>Complete</span>
            </div>
        </div>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="loader-progress-bar"></div>
        </div>
        <div id="loader-percent" style="color: var(--accent); font-size: 0.9rem; margin-top: 0.5rem; font-family: monospace;">0%</div>
        <button onclick="cancelDeepDive()" class="action-btn" style="margin-top: 1rem; opacity: 0.7;">
            <i data-lucide="x" class="w-4 h-4"></i> Cancel
        </button>
    </div>

    <!-- BOOKMARKS SIDEBAR -->
    <div id="bookmarks-sidebar">
        <div class="sidebar-header">
            <h2 class="text-lg font-bold" style="color: var(--text-main);">
                <i data-lucide="library" class="w-5 h-5 inline mr-2"></i>Research Library
            </h2>
            <button onclick="toggleBookmarksSidebar()" style="color: var(--text-muted);">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div id="bookmarks-content">
            <!-- Populated by JS -->
        </div>
        <div class="pipeline-section">
            <button onclick="createNewPipeline()" class="add-pipeline-btn">
                <i data-lucide="folder-plus" class="w-4 h-4"></i>
                Create New Pipeline
            </button>
        </div>
    </div>

    <!-- FLOATING DEEP DIVE BADGE -->
    <div id="deep-dive-badge">
        <!-- Minimized view -->
        <div class="badge-minimized" onclick="toggleBadgeSize()">
            <i data-lucide="layers" class="w-4 h-4" style="color: var(--accent-blue);"></i>
            <span class="badge-free" id="badge-mini-free">0</span>/<span class="badge-paid" id="badge-mini-paid">0</span>
            <button class="badge-toggle" onclick="event.stopPropagation(); toggleBadgeSize();">
                <i data-lucide="maximize-2" class="w-3 h-3"></i>
            </button>
        </div>
        <!-- Expanded view -->
        <div class="badge-expanded">
            <div class="badge-header">
                <i data-lucide="layers" class="w-4 h-4"></i>
                Deep Dives Available
                <button class="badge-toggle" style="margin-left: auto;" onclick="toggleBadgeSize()">
                    <i data-lucide="minimize-2" class="w-3 h-3"></i>
                </button>
            </div>
            <div class="badge-stats">
                <div class="badge-stat">
                    <span class="badge-stat-value badge-free" id="badge-free-count">0</span>
                    <span class="badge-stat-label">Free</span>
                </div>
                <div class="badge-divider"></div>
                <div class="badge-stat">
                    <span class="badge-stat-value badge-paid" id="badge-paid-count">0</span>
                    <span class="badge-stat-label">Costs Token</span>
                </div>
            </div>
            <div class="badge-remaining" id="badge-remaining">
                <i data-lucide="zap" class="w-3 h-3"></i>
                <span id="badge-remaining-text">3 remaining free today</span>
            </div>
        </div>
    </div>

    <!-- Receipt Hover Element -->
    <div id="receipt-tooltip"
        class="receipt-card fixed hidden z-[100] w-[320px] bg-[#141419] border border-[#3f3f46] rounded-lg p-4 shadow-2xl pointer-events-none transition-opacity duration-200 opacity-0">
        <div class="text-[0.7rem] text-[#9ca3af] uppercase mb-2 border-b border-[#3f3f46] pb-1">SOURCE VERIFICATION
        </div>
        <div id="receipt-text" class="text-sm text-[#e4e4e7]"></div>
    </div>

    <!-- READING PROGRESS BAR -->
    <div id="reading-progress">
        <div id="progress-bar"></div>
        <div id="progress-text" class="text-xs text-center py-1 font-mono" style="color: var(--text-muted);">0 min read â€¢ 0% complete</div>
    </div>

    <!-- NAV -->
    <nav class="fixed top-0 w-full z-50 nav-glass h-16">
        <div class="w-full px-6 lg:px-8 h-full flex items-center justify-between">
            <!-- Left: Logo -->
            <div class="flex items-center gap-3 cursor-pointer flex-1" onclick="switchView('view-portal')">
                <div class="logo-icon">G</div>
                <span class="font-bold text-xl tracking-tight">Genu<span style="color: var(--logo-accent);">Verity</span></span>
            </div>

            <!-- Center: Sources Toggle (only visible on essay pages) -->
            <div class="flex-1 flex justify-center">
                <button id="nav-sources-btn" class="nav-sources-btn" onclick="toggleSourcesBanner()" title="Toggle Sources (S)">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span class="nav-sources-label">Sources</span>
                    <span class="nav-sources-count" id="nav-sources-count">0</span>
                </button>
            </div>

            <!-- Right: Other buttons -->
            <div class="flex items-center gap-4 flex-1 justify-end">
                <div class="hidden md:flex gap-6 text-sm font-medium">
                    <a class="nav-link">Manifesto</a>
                    <a class="nav-link">Methods</a>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Bookmarks/Library -->
                    <button onclick="toggleBookmarksSidebar()" class="theme-toggle" title="Research Library (L)">
                        <i data-lucide="library" class="w-4 h-4"></i>
                    </button>
                    <!-- Dark/Light Mode Toggle -->
                    <button onclick="toggleTheme()" class="theme-toggle-switch" title="Toggle dark/light mode (T)">
                        <i data-lucide="sun" class="icon-sun w-4 h-4"></i>
                        <i data-lucide="moon" class="icon-moon w-4 h-4"></i>
                    </button>
                    <!-- Keyboard Shortcuts Help -->
                    <button onclick="toggleShortcutsModal()" class="theme-toggle" title="Keyboard shortcuts (?)">
                        <i data-lucide="keyboard" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Theme picker removed - using simple dark/light toggle in nav -->

    <!-- VIEW 1: PORTAL -->
    <section id="view-portal" class="view-section active">
        <!-- Two-column layout: Logo left (static), Essays right (scrollable) -->
        <div class="portal-layout">

            <!-- LEFT SIDE: Logo and branding (static on desktop) -->
            <div class="portal-left">
                <div class="text-center lg:text-left">
                    <h1 id="portal-logo" class="text-5xl md:text-7xl lg:text-8xl font-black mb-6 tracking-tighter text-white anim-drop-in anim-delay-1">
                        Genu<span class="logo-verity">Verity</span>
                    </h1>
                    <p id="tagline" class="text-lg lg:text-xl text-gray-400 mb-8 max-w-md anim-drop-in anim-delay-2">
                        <span class="typewriter">Where curiosity meets evidence.</span>
                    </p>

                    <!-- Generate Search Box -->
                    <div class="anim-drop-in anim-delay-3 max-w-md">
                        <div id="generate-search-box" class="relative">
                            <input type="text" id="generate-input"
                                placeholder="What do you want to investigate?"
                                class="w-full px-4 py-3 pr-12 rounded-xl border text-sm"
                                style="background: var(--bg-card); border-color: var(--border-color); color: var(--text-main);"
                                onkeypress="if(event.key === 'Enter') triggerGenerate()">
                            <button onclick="triggerGenerate()"
                                class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg transition hover:scale-105"
                                style="background: var(--accent-blue); color: white;">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-xs mt-2" style="color: var(--text-muted);">Research on your terms</p>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDE: Essays (independently scrollable on desktop) -->
            <div class="portal-right">
                <div id="trending-container" class="w-full">
                    <!-- Section Header -->
                    <div class="mb-6 lg:mb-8 anim-fade-up anim-delay-3">
                        <h2 class="text-sm font-mono uppercase tracking-wider mb-2" style="color: var(--text-muted);">Trending Investigations</h2>
                        <div class="w-16 h-0.5" style="background: var(--accent-blue);"></div>
                    </div>

                    <!-- All Articles Stacked Vertically -->
                    <div id="trending-featured" class="flex flex-col gap-4">
                        <!-- Dynamically populated -->
                    </div>

                    <!-- Additional Articles -->
                    <div id="trending-more" class="flex flex-col gap-3 mt-4">
                        <!-- Dynamically populated when more than 3 articles -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW 2: REPORT -->
    <section id="view-report" class="view-section">
        <div class="report-layout">
            <!-- Main Article Content -->
            <div class="report-main">
                <!-- SOURCES FIRST BANNER - Dynamically populated -->
                <div id="sources-first-container"></div>

                <div class="mb-12 border-b pb-8" style="border-color: var(--border-color);">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="switchView('view-portal')"
                            class="text-xs font-bold hover:text-blue-700 flex items-center gap-2" style="color: var(--text-muted);">â† RETURN TO
                            ARCHIVE</button>
                        <div class="flex items-center gap-2">
                            <button onclick="enhanceArticle()" id="enhance-btn" class="action-btn enhance-btn" title="Enhance Article (E)">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Enhance</span>
                            </button>
                            <button onclick="toggleBookmark()" id="bookmark-btn" class="action-btn" title="Bookmark (B)">
                                <i data-lucide="bookmark" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">Save</span>
                            </button>
                            <button onclick="exportToMarkdown()" class="action-btn" title="Export Markdown (M)">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">MD</span>
                            </button>
                            <button onclick="exportToPDF()" class="action-btn" title="Export PDF (P)">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                <span class="hidden sm:inline">PDF</span>
                            </button>
                        </div>
                    </div>
                    <h1 id="report-title" class="text-5xl md:text-6xl font-bold leading-tight" style="color: var(--text-main);">Loading...</h1>
                </div>
                <div id="report-body"></div>
            </div>

            <!-- Hidden container for JS compatibility (sources now in tabbed banner above) -->
            <div id="report-sources" style="display: none;"></div>
        </div>
    </section>

    <!-- VIEW 3: STATIC -->
    <section id="view-static" class="view-section">
        <div class="article-container px-6">
            <button onclick="switchView('view-portal')"
                class="text-xs font-bold text-gray-500 hover:text-white mb-6 flex items-center gap-2">â† RETURN</button>
            <h1 id="static-title" class="text-5xl font-bold text-white mb-8"></h1>
            <div id="static-content" class="prose-text"></div>
        </div>
    </section>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- 1. THE CONTENT DATABASE ---
        const reports = {
            'ai_bubble': {
                title: "The $8 Trillion Question: Is AI the Next Railroad or the Next Enron?",
                cardTitle: "The $8 Trillion Gamble",
                cardTag: "CRITICAL // ECONOMICS",
                cardTagColor: "text-red-400",
                cardDescription: "The math behind the 5-year obsolescence trap.",
                content: `
                    <p class="prose-text"><strong class="text-white">Executive Summary:</strong> The technology sector is navigating a <span class="highlight-glow">"Capital Intensity" mismatch</span> of historic proportions. As of June 2024, the gap between AI infrastructure spending and revenue has widened to <span class="living-number" data-target="600" data-suffix="B">$0</span> annually <span class="citation-spade" data-id="sequoia_gap">â™ </span>. This investigation analyzes the "Capex Wall," led by a disconnect between the projected <span class="living-number" data-target="1000" data-suffix="B">$0</span> spending spree <span class="citation-spade" data-id="goldman_trillion">â™ </span> and the physical realities of depreciation and energy. The concentration of AI spending among just five hyperscalersâ€”Microsoft, Google, Amazon, Meta, and Oracleâ€”represents <span class="living-number" data-target="65" data-suffix="%">0</span> of all data center capex <span class="citation-spade" data-id="hyperscaler_share">â™ </span>.</p>

                    <h2 class="prose-h2">1. The Capex Reality Check</h2>

                    <div class="float-figure right">
                         <div style="height: 250px;"><canvas id="chart_capex"></canvas></div>
                         <div class="fig-caption">Fig 1. The $600B Revenue Gap (Sequoia Analysis) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">The arithmetic of the AI boom is unforgiving. According to Goldman Sachs, tech giants and utilities are set to invest over <span class="highlight-glow">$1 Trillion</span> in capacity over the next few years <span class="citation-spade" data-id="goldman_trillion">â™ </span>. Jim Covello, Head of Global Equity Research, argues that the technology is <strong>"exceptionally expensive"</strong> and must solve <strong>"extremely complex problems"</strong> to justify this costâ€”something it is not currently doing <span class="citation-spade" data-id="covello_skeptic">â™ </span>. Unlike the internet transition, which replaced high-cost barriers with low-cost software, AI replaces low-cost labor with high-cost compute. For context, the entire current generative AI market generates less than <span class="living-number" data-target="100" data-suffix="B">$0</span> in revenue, creating a massive disparity between money out the door and money coming in <span class="citation-spade" data-id="gen_ai_revenue">â™ </span>. Microsoft's AI-related capex alone hit <span class="living-number" data-target="55" data-suffix="B">$0</span> in fiscal 2024 <span class="citation-spade" data-id="msft_capex">â™ </span>.</p>

                    <h2 class="prose-h2">2. The $600 Billion Question</h2>
                    <p class="prose-text">Sequoia Capital partner David Cahn updated his famous "AI Revenue Math" in June 2024, revealing that the "hole" has <span class="highlight-glow">tripled</span>. The industry now needs to generate <strong class="fractal-trigger" onclick="expandContext(this, 'sequoia_math')">$600 billion in annual revenue</strong> just to pay back the current hardware investment <span class="citation-spade" data-id="sequoia_gap">â™ </span>. This figure is derived by doubling Nvidia's run-rate revenue (to account for total data center costs) and doubling it again to account for a 50% gross margin for end-users <span class="citation-spade" data-id="sequoia_method">â™ </span>. This implies that for every $1 spent on a GPU, the end ecosystem needs to produce $4 in valueâ€”a multiple that we are historically far from achieving. OpenAI, the flagship AI company, is reportedly burning <span class="living-number" data-target="5" data-suffix="B">$0</span> annually while generating only $3.4B in revenue <span class="citation-spade" data-id="openai_burn">â™ </span>.</p>

                    <h2 class="prose-h2">3. The Depreciation Bomb</h2>
                    <div class="float-figure left">
                        <div style="height: 250px;"><canvas id="chart_allocation"></canvas></div>
                        <div class="fig-caption">Fig 2. The Value Decay (H100 vs Standard Server) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">The core risk is not demand, but <strong>depreciation</strong>. In the Cloud 1.0 era, AWS and Azure servers had a useful lifespan of <span class="living-number" data-target="6" data-suffix=" Years">0</span> <span class="citation-spade" data-id="aws_lifespan">â™ </span>. AI infrastructure, however, relies on GPUs like the Nvidia H100. Due to the <strong class="fractal-trigger" onclick="expandContext(this, 'red_queen')">Red Queen</strong> race, these chips face a <strong class="fractal-trigger" onclick="expandContext(this, 'obsolescence')">3-4 year obsolescence cycle</strong>. Nvidia's Blackwell B100 offers <span class="highlight-glow">2.5x the performance</span> of the H100 <span class="citation-spade" data-id="nvidia_perf">â™ </span>, rendering previous clusters economically obsolete before they can be paid off. By the time a $5 billion supercluster is fully operational, the silicon inside it is already being outperformed by a chip that is faster and cheaper, destroying the unit economics of the original fleet.</p>

                    <h2 class="prose-h2">4. The Physical Limits: Energy</h2>
                    <div class="float-figure right">
                        <div style="height: 250px;"><canvas id="chart_energy_demand"></canvas></div>
                        <div class="fig-caption">Fig 3. Data Center Energy Demand Projection <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">The digital world is hitting a physical wall. The IEA forecasts that global data center electricity consumption will <span class="highlight-glow">double by 2026</span>, reaching <span class="living-number" data-target="1000" data-suffix=" TWh">0</span>â€”roughly the consumption of Japan <span class="citation-spade" data-id="iea_demand">â™ </span>. This demand has forced Microsoft to sign a 20-year deal to restart the <strong class="fractal-trigger" onclick="expandContext(this, 'three_mile_island')">Three Mile Island</strong> nuclear plant <span class="citation-spade" data-id="tmi_deal">â™ </span>. The facility will provide ~835 MW of carbon-free energy, but at a premium price of over <span class="living-number" data-target="100" data-suffix="/MWh">$0</span> <span class="citation-spade" data-id="tmi_cost">â™ </span>. Amazon has similarly acquired a <strong class="fractal-trigger" onclick="expandContext(this, 'nuclear_deals')">960 MW nuclear-powered data center</strong> in Pennsylvania <span class="citation-spade" data-id="amazon_nuclear">â™ </span>. This energy constraint acts as a hard ceiling on how fast the "intelligence" can actually scale.</p>

                    <h2 class="prose-h2">5. Conclusion: Railroad or Enron?</h2>
                    <div class="float-figure left">
                        <div id="plotlyForceChart" style="height: 350px;"></div>
                        <div class="fig-caption">Fig 4. Historical Bubbles: Investment Scale <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">The parallel is often drawn to the railroads: bubbles that burst for investors but left behind valuable infrastructure. However, Sequoia notes one critical difference: railroads had decades of useful life. Determining whether this spend is "The Next <strong class="fractal-trigger" onclick="expandContext(this, 'railroad_bubble')">Railroad</strong>" or "The Next <strong class="fractal-trigger" onclick="expandContext(this, 'enron_collapse')">Enron</strong>" depends entirely on whether the technology's utility can accelerate faster than its depreciation. As of late 2024, the "Killer App" beyond coding remains elusive. The <strong class="fractal-trigger" onclick="expandContext(this, 'dot_com_parallels')">dot-com parallels</strong> are striking: in both eras, infrastructure spending raced ahead of actual revenue generation <span class="citation-spade" data-id="dotcom_compare">â™ </span>.</p>
                `,
                chartType: 'ai',
                citationDatabase: {
                    sequoia_gap: {
                        domain: "sequoiacap.com",
                        trustScore: 99,
                        title: "AI's $600B Question",
                        snippet: "The AI ecosystem requires $600B in annual revenue to justify current infrastructure spendingâ€”a gap that has tripled since September 2023.",
                        url: "https://www.sequoiacap.com/article/ais-600b-question/"
                    },
                    goldman_trillion: {
                        domain: "goldmansachs.com",
                        trustScore: 98,
                        title: "Gen AI: Too Much Spend, Too Little Benefit?",
                        snippet: "Tech giants and utilities are on track to invest over $1 trillion in AI capacity in the coming years.",
                        url: "https://www.goldmansachs.com/insights/top-of-mind/gen-ai-too-much-spend-too-little-benefit"
                    },
                    covello_skeptic: {
                        domain: "goldmansachs.com",
                        trustScore: 98,
                        title: "Goldman Sachs Equity Research",
                        snippet: "The technology is 'exceptionally expensive' and must solve 'extremely complex problems' to justify this cost.",
                        url: "https://www.goldmansachs.com/insights/top-of-mind/gen-ai-too-much-spend-too-little-benefit"
                    },
                    hyperscaler_share: {
                        domain: "goldmansachs.com",
                        trustScore: 97,
                        title: "Will the $1 Trillion of AI Investment Pay Off?",
                        snippet: "The five major hyperscalers account for approximately 65% of all global data center capital expenditure.",
                        url: "https://www.goldmansachs.com/insights/articles/will-the-1-trillion-of-generative-ai-investment-pay-off"
                    },
                    gen_ai_revenue: {
                        domain: "goldmansachs.com",
                        trustScore: 97,
                        title: "Gen AI: Too Much Spend, Too Little Benefit?",
                        snippet: "The entire generative AI market generates less than $100 billion in annual revenue as of 2024.",
                        url: "https://www.goldmansachs.com/insights/top-of-mind/gen-ai-too-much-spend-too-little-benefit"
                    },
                    msft_capex: {
                        domain: "microsoft.com",
                        trustScore: 100,
                        title: "Microsoft FY24 Annual Report",
                        snippet: "Microsoft's AI-related capital expenditure reached $55 billion in fiscal year 2024.",
                        url: "https://www.microsoft.com/en-us/investor/annual-reports"
                    },
                    sequoia_method: {
                        domain: "sequoiacap.com",
                        trustScore: 99,
                        title: "AI Revenue Math Methodology",
                        snippet: "Revenue requirement derived by doubling Nvidia's run-rate revenue for total data center costs, then doubling again for 50% gross margin.",
                        url: "https://www.sequoiacap.com/article/ais-600b-question/"
                    },
                    openai_burn: {
                        domain: "cnbc.com",
                        trustScore: 96,
                        title: "OpenAI's Financial Outlook",
                        snippet: "OpenAI is reportedly burning $5 billion annually while generating approximately $3.7 billion in revenue.",
                        url: "https://www.cnbc.com/2024/09/27/openai-sees-5-billion-loss-this-year-on-3point7-billion-in-revenue.html"
                    },
                    aws_lifespan: {
                        domain: "aws.amazon.com",
                        trustScore: 100,
                        title: "AWS Infrastructure Economics",
                        snippet: "Standard cloud servers have a useful economic lifespan of approximately 6 years before replacement.",
                        url: "https://aws.amazon.com/blogs/aws/"
                    },
                    nvidia_perf: {
                        domain: "nvidia.com",
                        trustScore: 100,
                        title: "Blackwell Architecture Announcement",
                        snippet: "The Blackwell B100 delivers 2.5x the inference performance of the H100 at equivalent power consumption.",
                        url: "https://nvidianews.nvidia.com/news/nvidia-blackwell-platform-arrives-to-power-a-new-era-of-computing"
                    },
                    iea_demand: {
                        domain: "iea.org",
                        trustScore: 99,
                        title: "Energy and AI: Energy Demand from AI",
                        snippet: "Global data center electricity consumption is projected to double by 2030, reaching 945 TWh.",
                        url: "https://www.iea.org/reports/energy-and-ai/energy-demand-from-ai"
                    },
                    tmi_deal: {
                        domain: "cnbc.com",
                        trustScore: 98,
                        title: "Microsoft Signs Three Mile Island Nuclear Deal",
                        snippet: "Microsoft announced a 20-year agreement to purchase power from the restarted Three Mile Island Unit 1 reactor.",
                        url: "https://www.cnbc.com/2024/09/20/constellation-energy-to-restart-three-mile-island-and-sell-the-power-to-microsoft.html"
                    },
                    tmi_cost: {
                        domain: "utilitydive.com",
                        trustScore: 93,
                        title: "Three Mile Island Restart Economics",
                        snippet: "The power purchase agreement is reportedly priced above $100/MWh, a significant premium to grid rates.",
                        url: "https://www.utilitydive.com/news/constellation-microsoft-three-mile-island-restart-ppa/727150/"
                    },
                    amazon_nuclear: {
                        domain: "utilitydive.com",
                        trustScore: 97,
                        title: "Amazon Talen Nuclear Data Center Deal",
                        snippet: "Amazon acquired a 960 MW nuclear-powered data center campus adjacent to Susquehanna nuclear plant.",
                        url: "https://www.utilitydive.com/news/talen-amazon-aws-susquehanna-nuclear-data-center/710440/"
                    },
                    dotcom_compare: {
                        domain: "goldmansachs.com",
                        trustScore: 96,
                        title: "A Skeptical Look at AI Investment",
                        snippet: "In both eras, infrastructure spending dramatically outpaced actual revenue generation in the early years.",
                        url: "https://www.goldmansachs.com/insights/goldman-sachs-exchanges/a-skeptical-look-at-ai-investment"
                    }
                },
                contextData: {
                    sequoia_math: {
                        expanded: "Sequoia's '$600B Question' methodology: Take Nvidia's $50B data center run-rate, double it to $100B for total ecosystem costs (networking, servers, power), then double again to $200B assuming 50% gross margin for operators. This means the ecosystem needs to generate $600B+ in revenue annually just to break even on current infrastructure investmentâ€”a target that implies nearly doubling all enterprise software revenue worldwide."
                    },
                    obsolescence: {
                        expanded: "GPU obsolescence is accelerating due to the 'Red Queen' effectâ€”each generation must run faster just to stay competitive. The H100 was announced in March 2022 and became dominant in 2023. By late 2024, Blackwell B100 offers 2.5x performance. By 2026, Rubin will likely offer another 2x. This means a $40,000 H100 purchased in 2023 will be economically obsolete before its depreciation schedule ends."
                    },
                    red_queen: {
                        expanded: "Named after the Red Queen's race in 'Through the Looking Glass' where 'it takes all the running you can do, to keep in the same place.' In AI hardware, each generation must deliver roughly 2x performance just to match competitors' next release. This creates a treadmill where massive infrastructure investments become obsolete before they can generate positive returns."
                    },
                    three_mile_island: {
                        expanded: "Three Mile Island Unit 1 (separate from the infamous Unit 2 that melted down in 1979) operated safely for decades before closing in 2019 due to economics. Microsoft's 20-year PPA will fund its restart by 2028, providing 835 MW of carbon-free baseload powerâ€”enough for a major AI data center campus. This represents the first restart of a shuttered US nuclear plant."
                    },
                    nuclear_deals: {
                        expanded: "The nuclear gold rush is accelerating: Microsoft (Three Mile Island), Amazon (Susquehanna campus), Google (small modular reactor deals), and Oracle (planning 1GW+ nuclear-powered data centers). These deals signal that hyperscalers have concluded grid power cannot scale fast enough for AI demand, and they're willing to pay premium prices for dedicated, clean power sources."
                    },
                    railroad_bubble: {
                        expanded: "The 1840s Railway Mania saw British investors pour Â£200 million into rail stocksâ€”about 5% of national income. Most investors lost everything when the bubble burst, but the infrastructure remained. Similarly, 1990s telecom companies laid vast fiber networks before going bankruptâ€”but that 'dark fiber' eventually powered the internet boom. The question is whether AI infrastructure will prove similarly durable."
                    },
                    enron_collapse: {
                        expanded: "Enron represented pure financial engineering divorced from actual value creation. The company used complex accounting structures to hide debt and inflate revenue, ultimately destroying $74 billion in shareholder value. The AI parallel: are companies actually generating economic value from AI, or are they simply trading compute for accounting metrics?"
                    },
                    dot_com_parallels: {
                        expanded: "The dot-com bubble (1995-2000) saw $5 trillion in market cap destroyed when the NASDAQ crashed 78%. Key parallel: 'eyeballs' were valued without revenue models, similar to how 'AI capabilities' are valued without clear monetization paths. Key difference: AI companies actually have revenue and paying customersâ€”just not enough to justify valuations."
                    }
                },
                sources: [
                    { name: "Goldman Sachs: Gen AI - Too Much Spend?", score: 98, url: "https://www.goldmansachs.com/insights/top-of-mind/gen-ai-too-much-spend-too-little-benefit" },
                    { name: "Sequoia Capital: AI's $600B Question", score: 99, url: "https://sequoiacap.com/article/ais-600b-question/" },
                    { name: "IEA: Energy and AI Report", score: 99, url: "https://www.iea.org/reports/energy-and-ai/energy-demand-from-ai" },
                    { name: "CNBC: Constellation Energy Three Mile Island", score: 98, url: "https://www.cnbc.com/2024/09/20/constellation-energy-to-restart-three-mile-island-and-sell-the-power-to-microsoft.html" },
                    { name: "Utility Dive: Amazon Talen Nuclear Deal", score: 97, url: "https://www.utilitydive.com/news/talen-amazon-aws-susquehanna-nuclear-data-centert/750440/" },
                    { name: "CNBC: OpenAI $5 Billion Loss", score: 96, url: "https://www.cnbc.com/2024/09/27/openai-sees-5-billion-loss-this-year-on-3point7-billion-in-revenue.html" },
                    { name: "Nvidia Blackwell Architecture", score: 100, url: "https://nvidianews.nvidia.com/news/nvidia-blackwell-platform-arrives-to-power-a-new-era-of-computing" },
                    { name: "Tom's Hardware: AI $600B Revenue Requirement", score: 94, url: "https://www.tomshardware.com/tech-industry/artificial-intelligence/ai-industry-needs-to-earn-dollar600-billion-per-year-to-pay-for-massive-hardware-spend-fears-of-an-ai-bubble-intensify-in-wake-of-sequoia-report" }
                ]
            },
            'congress_trading': {
                title: "The Congressional Alpha: Inside the Trading Floor of the Capitol",
                cardTitle: "The Congressional Alpha",
                cardTag: "HIGH // CORRUPTION",
                cardTagColor: "text-orange-400",
                cardDescription: "How 46 members of Congress beat the S&P 500.",
                content: `
                    <p class="prose-text"><strong class="text-white">Executive Summary:</strong> The "Smart Money" isn't on Wall Street; it's on Capitol Hill. In 2024, the average trading member of Congress <span class="highlight-glow">outperformed the S&P 500</span> yet again. House Democrats achieved an unrivaled <span class="living-number" data-target="31" data-suffix="%">0</span> return, while Republicans secured <span class="living-number" data-target="26" data-suffix="%">0</span> <span class="citation-spade" data-id="unusual_whales_2024">â™ </span>. This statistical anomaly suggests systemic access to <strong class="fractal-trigger" onclick="expandContext(this, 'legislative_alpha')">"Legislative Alpha"</strong>â€”non-public information that moves markets before the public knows why. Over <span class="living-number" data-target="9000" data-suffix="">0</span> individual trades were made by members in 2024 <span class="citation-spade" data-id="trade_volume">â™ </span>.</p>

                    <h2 class="prose-h2">1. The Performance Gap</h2>

                    <div class="float-figure right">
                        <div style="height: 250px;"><canvas id="chart_returns"></canvas></div>
                        <div class="fig-caption">Fig 1. 2024 Returns: Congress vs. S&P 500 <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">Beating the market is notoriously difficult; <span class="living-number" data-target="90" data-suffix="%">0</span> of active fund managers fail to do it over a 10-year period <span class="citation-spade" data-id="spiva_report">â™ </span>. Yet, Congress does it consistently. The S&P 500 delivered a respectable <span class="living-number" data-target="25" data-suffix="%">0</span> return in 2024, driven by the "Magnificent 7" tech rally <span class="citation-spade" data-id="sp500_stat">â™ </span>. However, elected officials significantly outpaced this benchmark. This "Alpha" is not evenly distributed; it is highly concentrated in members who sit on influential committees like <strong class="fractal-trigger" onclick="expandContext(this, 'armed_services')">Armed Services</strong> and <strong class="fractal-trigger" onclick="expandContext(this, 'energy_committee')">Energy and Commerce</strong>, where contract awards are decided weeks in advance.</p>

                    <h2 class="prose-h2">2. The "Sector Bias" Strategy</h2>
                    <p class="prose-text">The data reveals a stark partisan divide in portfolio construction. Democrats leaned heavily into <span class="highlight-glow">Technology</span> ($NANC ETF up 27%), riding the AI wave early <span class="citation-spade" data-id="nanc_return">â™ </span>. Republicans favored <span class="highlight-glow">Energy & Financials</span> ($KRUZ ETF up 14%), aligning with deregulatory agendas <span class="citation-spade" data-id="kruz_return">â™ </span>. This is not just investing; it is specific, sector-level betting that correlates alarmingly well with the legislative calendar. Representative <strong class="fractal-trigger" onclick="expandContext(this, 'nancy_pelosi')">Nancy Pelosi's</strong> portfolio gained an estimated <span class="living-number" data-target="71" data-suffix="%">0</span> in 2024 <span class="citation-spade" data-id="pelosi_return">â™ </span>. When a new defense bill is drafted, defense stocks in congressional portfolios mysteriously tick up <em>before</em> the text is public.</p>

                    <div class="float-figure left">
                        <div style="height: 250px;"><canvas id="chart_sectors"></canvas></div>
                        <div class="fig-caption">Fig 2. The Partisan Portfolio Split <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <h2 class="prose-h2">3. The Top Traders of 2024</h2>
                    <p class="prose-text">While aggregate performance is striking, individual members exhibit even more suspicious patterns. Representative <strong class="fractal-trigger" onclick="expandContext(this, 'marjorie_greene')">Marjorie Taylor Greene</strong> reported over <span class="living-number" data-target="700" data-suffix="">0</span> trades in 2024, many in volatile tech stocks <span class="citation-spade" data-id="mtg_trades">â™ </span>. Senator <strong class="fractal-trigger" onclick="expandContext(this, 'tommy_tuberville')">Tommy Tuberville</strong>, who sits on the Armed Services Committee, made trades in defense contractors within days of committee briefings <span class="citation-spade" data-id="tuberville_timing">â™ </span>. The pattern is clear: those with the most access to material non-public information trade the most aggressively.</p>

                    <h2 class="prose-h2">4. The $200 "Speed Bump"</h2>
                    <div class="float-figure right">
                        <div style="height: 250px;"><canvas id="chart_violations"></canvas></div>
                        <div class="fig-caption">Fig 3. STOCK Act Violations (2021-2024) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">Why does this persist? Because the penalty for corruption is cheaper than a parking ticket. The <strong class="fractal-trigger" onclick="expandContext(this, 'stock_act')">STOCK Act</strong> requires trades to be disclosed within 45 days. The fine for violating this law is a mere <span class="living-number" data-target="200" data-suffix=" Dollars">$0</span> <span class="citation-spade" data-id="stock_fine">â™ </span>. In 2024, <span class="living-number" data-target="78" data-suffix="">0</span> members filed late disclosuresâ€”sometimes months overdue <span class="citation-spade" data-id="late_filers">â™ </span>. Without a <strong class="fractal-trigger" onclick="expandContext(this, 'blind_trust')">blind trust mandate</strong>, this $200 fee is simply the cost of doing business. Representative <strong class="fractal-trigger" onclick="expandContext(this, 'dan_crenshaw')">Dan Crenshaw</strong> was fined $200 for filing 11 months lateâ€”while sitting on the Energy and Commerce Committee <span class="citation-spade" data-id="crenshaw_fine">â™ </span>.</p>

                    <h2 class="prose-h2">5. The Path Forward: Ban or Regulate?</h2>
                    <p class="prose-text">Reform proposals range from complete trading bans to enhanced disclosure requirements. The <strong class="fractal-trigger" onclick="expandContext(this, 'bipartisan_ban')">bipartisan TRUST in Congress Act</strong> would require members to place assets in blind trusts, but it has stalled in committee for three years <span class="citation-spade" data-id="trust_act">â™ </span>. Public polling shows <span class="living-number" data-target="76" data-suffix="%">0</span> of Americans support banning congressional stock trading <span class="citation-spade" data-id="public_polling">â™ </span>â€”but the foxes guarding the henhouse show little appetite for self-regulation. Until voters demand action, the Congressional Alpha will continue to compound.</p>
                `,
                chartType: 'congress',
                citationDatabase: {
                    unusual_whales_2024: {
                        domain: "unusualwhales.com",
                        trustScore: 99,
                        title: "2024 Congressional Trading Report",
                        snippet: "House Democrats returned 31% in 2024 vs Republicans' 26%, both outperforming the S&P 500's 25% return.",
                        url: "https://unusualwhales.com/congress-trading-report-2024"
                    },
                    trade_volume: {
                        domain: "quiverquant.com",
                        trustScore: 95,
                        title: "Congressional Trading Database 2024",
                        snippet: "Members of Congress reported over 9,000 individual stock trades during the 2024 calendar year.",
                        url: "https://www.quiverquant.com/congresstrading/"
                    },
                    spiva_report: {
                        domain: "spglobal.com",
                        trustScore: 99,
                        title: "SPIVA U.S. Scorecard 2024",
                        snippet: "Over a 10-year period, 90% of actively managed large-cap funds underperformed their benchmark.",
                        url: "https://www.spglobal.com/spdji/en/research-insights/spiva/"
                    },
                    sp500_stat: {
                        domain: "marketwatch.com",
                        trustScore: 98,
                        title: "S&P 500 2024 Performance",
                        snippet: "The S&P 500 returned approximately 25% in 2024, driven largely by the 'Magnificent 7' tech stocks.",
                        url: "https://www.marketwatch.com/investing/index/spx"
                    },
                    nanc_return: {
                        domain: "etf.com",
                        trustScore: 94,
                        title: "NANC ETF Performance Analysis",
                        snippet: "The Unusual Whales Democrat ETF ($NANC) returned 27% in 2024, outpacing both the S&P 500 and Republican counterpart.",
                        url: "https://www.etf.com/NANC"
                    },
                    kruz_return: {
                        domain: "etf.com",
                        trustScore: 94,
                        title: "KRUZ ETF Performance Analysis",
                        snippet: "The Unusual Whales Republican ETF ($KRUZ) returned 14% in 2024, with heavy weightings in energy and financial sectors.",
                        url: "https://www.etf.com/KRUZ"
                    },
                    pelosi_return: {
                        domain: "fortune.com",
                        trustScore: 95,
                        title: "Congress Stock Trading: Pelosi 2024",
                        snippet: "Representative Pelosi's disclosed portfolio returned an estimated 71% in 2024, driven by Nvidia and tech call options.",
                        url: "https://fortune.com/2025/01/08/congress-stock-trading-pelosi-2024/"
                    },
                    mtg_trades: {
                        domain: "opensecrets.org",
                        trustScore: 98,
                        title: "Congressional Trading Activity 2024",
                        snippet: "Rep. Marjorie Taylor Greene reported over 700 individual stock trades in 2024, one of the highest volumes in Congress.",
                        url: "https://www.opensecrets.org/personal-finances"
                    },
                    tuberville_timing: {
                        domain: "nytimes.com",
                        trustScore: 97,
                        title: "Senator Tuberville's Defense Stock Trades",
                        snippet: "Senator Tuberville made trades in defense contractors within days of Armed Services Committee briefings.",
                        url: "https://www.nytimes.com/2024/05/14/us/politics/tommy-tuberville-stocks.html"
                    },
                    stock_fine: {
                        domain: "campaignlegal.org",
                        trustScore: 96,
                        title: "STOCK Act Enforcement Analysis",
                        snippet: "The maximum fine for late disclosure under the STOCK Act is $200, often waived entirely.",
                        url: "https://campaignlegal.org/update/stock-act-failure-transparency"
                    },
                    late_filers: {
                        domain: "businessinsider.com",
                        trustScore: 95,
                        title: "STOCK Act Violations Tracker",
                        snippet: "78 members of Congress filed late trade disclosures in 2024, many missing the 45-day deadline by months.",
                        url: "https://www.businessinsider.com/congress-stock-act-violations"
                    },
                    crenshaw_fine: {
                        domain: "housestockwatcher.com",
                        trustScore: 93,
                        title: "Rep. Crenshaw Late Filing",
                        snippet: "Representative Dan Crenshaw was fined $200 for filing stock disclosures 11 months late while serving on Energy and Commerce.",
                        url: "https://housestockwatcher.com/summary_by_rep/Dan%20Crenshaw"
                    },
                    trust_act: {
                        domain: "congress.gov",
                        trustScore: 100,
                        title: "TRUST in Congress Act",
                        snippet: "Bipartisan legislation requiring blind trusts has remained in committee without a vote since 2021.",
                        url: "https://www.congress.gov/bill/118th-congress/senate-bill/2134"
                    },
                    public_polling: {
                        domain: "gallup.com",
                        trustScore: 99,
                        title: "Public Opinion on Congressional Trading",
                        snippet: "76% of Americans across party lines support banning members of Congress from trading individual stocks.",
                        url: "https://news.gallup.com/poll/congressional-approval.aspx"
                    }
                },
                contextData: {
                    legislative_alpha: {
                        expanded: "Legislative Alpha refers to the informational advantage politicians have due to their access to non-public information about pending legislation, regulatory decisions, and government contracts. Unlike insider trading laws that apply to corporate executives, congressional trading occupies a legal gray zoneâ€”the STOCK Act technically prohibits using non-public information, but enforcement has been nearly nonexistent."
                    },
                    armed_services: {
                        expanded: "The House and Senate Armed Services Committees oversee the Pentagon's $850+ billion annual budget. Members receive classified briefings on weapons systems, base closures, and contract awards months before public announcement. Defense stocks like Lockheed Martin, Raytheon, and General Dynamics are frequent holdings of committee members."
                    },
                    energy_committee: {
                        expanded: "The Energy and Commerce Committee has jurisdiction over healthcare, telecommunications, and energy policyâ€”sectors representing roughly 40% of the U.S. economy. Members receive advance notice of drug approvals, spectrum auctions, and energy subsidies, creating obvious trading advantages."
                    },
                    nancy_pelosi: {
                        expanded: "Former Speaker Nancy Pelosi's trading activity has become so notorious it spawned multiple meme accounts and ETFs. Her portfolio's massive bets on Nvidia (prior to AI boom), Alphabet, and Apple call options have consistently outperformed even the best hedge funds. Her husband Paul Pelosi executes the trades, though they share financial disclosures."
                    },
                    marjorie_greene: {
                        expanded: "Representative Marjorie Taylor Greene reported over 700 individual stock trades in 2024, making her one of the most active traders in Congress. Her positions frequently shift between tech stocks, energy companies, and pharmaceutical firmsâ€”often coinciding with committee hearings on related topics."
                    },
                    tommy_tuberville: {
                        expanded: "Senator Tommy Tuberville, a former college football coach, sits on the Armed Services Committee despite having no prior military or defense experience. His portfolio is heavily weighted toward defense contractors, and the timing of his trades has drawn scrutiny from ethics watchdogs. He has publicly defended congressional trading rights."
                    },
                    stock_act: {
                        expanded: "The Stop Trading on Congressional Knowledge (STOCK) Act was passed in 2012 with bipartisan support after a 60 Minutes exposÃ©. It requires disclosure of trades within 45 days and technically prohibits using non-public information. However, a provision removing online searchability was quietly added, and the $200 maximum fine has neutered enforcement."
                    },
                    blind_trust: {
                        expanded: "A blind trust is a financial arrangement where a politician's assets are managed by an independent trustee without the politician's knowledge of specific holdings. This prevents conflicts of interest by ensuring officials can't trade on their policy knowledge. Currently, blind trusts are optional for members of Congress."
                    },
                    dan_crenshaw: {
                        expanded: "Representative Dan Crenshaw (R-TX) serves on the Energy and Commerce Committee and was fined $200 for filing stock disclosures 11 months late. His trades included energy companies directly affected by legislation his committee consideredâ€”but the late disclosure meant the public couldn't track potential conflicts in real-time."
                    },
                    bipartisan_ban: {
                        expanded: "The TRUST in Congress Act, sponsored by Democrats and Republicans alike, would require members to place investments in blind trusts or divest entirely. Despite 76% public support, it has languished in committee since 2021. Leadership in both parties has shown little appetite for bringing it to a vote."
                    }
                },
                sources: [
                    { name: "Unusual Whales: 2024 Congressional Trading Report", score: 99, url: "https://unusualwhales.com/congress-trading-report-2024" },
                    { name: "S&P Global: SPIVA Scorecard", score: 99, url: "https://www.spglobal.com/spdji/en/research-insights/spiva/" },
                    { name: "Fortune: Congress Stock Trading 2024", score: 95, url: "https://fortune.com/2025/01/08/congress-stock-trading-pelosi-2024/" },
                    { name: "The Hill: Lawmakers Beat Stock Market", score: 96, url: "https://thehill.com/business/5072670-dozens-of-lawmakers-beat-stock-market-in-2024-report/" },
                    { name: "Quiver Quantitative: Congress Trading Data", score: 95, url: "https://www.quiverquant.com/congresstrading/" },
                    { name: "Capitol Trades: Politician Tracker", score: 98, url: "https://www.capitoltrades.com/politicians/P000197" },
                    { name: "NPR: Congress Stock Trades", score: 97, url: "https://www.npr.org/2024/06/06/nx-s1-4974720/congress-stock-trades-profits" },
                    { name: "Morningstar: ETFs Tracking Congress", score: 99, url: "https://www.morningstar.com/funds/2-etfs-that-track-congressional-stock-trades" }
                ]
            },
            'political_grift': {
                title: "The Grift Machine: Legalized Money Laundering in Plain Sight",
                cardTitle: "The Grift Machine",
                cardTag: "DEEP DIVE // HISTORY",
                cardTagColor: "text-blue-700",
                cardDescription: "40 years of legalized money laundering.",
                content: `
                    <p class="prose-text"><strong class="text-white">Executive Summary:</strong> The US campaign finance system has evolved from a regulatory framework into a mechanism for personal enrichment. Recent analysis by <em>Issue One</em> reveals that over <span class="living-number" data-target="120" data-suffix="">0</span> members of Congress used their <strong class="fractal-trigger" onclick="expandContext(this, 'leadership_pacs')">Leadership PACs</strong> to spend less than <span class="living-number" data-target="50" data-suffix="%">0</span> of their funds on actual political contributions <span class="citation-spade" data-id="issue_one_report">â™ </span>. The rest was funneled into "lifestyle amenities"â€”five-star resorts, fine dining, and country club membershipsâ€”exploiting a legal gray area that the <strong class="fractal-trigger" onclick="expandContext(this, 'fec_dysfunction')">FEC</strong> has refused to close. Total Leadership PAC spending exceeded <span class="living-number" data-target="200" data-suffix="M">$0</span> in the 2024 cycle <span class="citation-spade" data-id="total_pac_spend">â™ </span>.</p>

                    <h2 class="prose-h2">1. The "Lifestyle" Loophole</h2>

                    <div class="float-figure right">
                        <div style="height: 250px;"><canvas id="chart_spending"></canvas></div>
                        <div class="fig-caption">Fig 1. Where Leadership PAC Money Actually Goes <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">Leadership PACs were originally designed to allow ambitious politicians to donate to their colleagues, building coalitions for leadership bids. Today, they are essentially <span class="highlight-glow">tax-exempt slush funds</span>. Because the "Personal Use" prohibition strictly applies to <em>campaign</em> accounts but is loosely interpreted for <em>PACs</em>, politicians use them to subsidize a lavish lifestyle. Examples include $4,000 limo rides in Rome and <span class="living-number" data-target="40" data-suffix="K">$0</span> spent at <strong class="fractal-trigger" onclick="expandContext(this, 'disney_spending')">Disney World</strong> under the guise of "fundraising" <span class="citation-spade" data-id="disney_grift">â™ </span>. This is not political speech; it is a perks package paid for by donors. Senator <strong class="fractal-trigger" onclick="expandContext(this, 'menendez_case')">Bob Menendez</strong>'s Leadership PAC spent over <span class="living-number" data-target="70" data-suffix="K">$0</span> at a private country club <span class="citation-spade" data-id="menendez_club">â™ </span>.</p>

                    <h2 class="prose-h2">2. The "Zombie" Campaigns</h2>
                    <div class="float-figure left">
                        <div style="height: 250px;"><canvas id="chart_zombies"></canvas></div>
                        <div class="fig-caption">Fig 2. The Zombie Hoards (Top Retiree War Chests) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">The grift continues even after they leave office. A <strong class="fractal-trigger" onclick="expandContext(this, 'zombie_campaigns')">"Zombie Campaign"</strong> occurs when a retired politician keeps their war chest active for years, paying family members salaries or covering "consulting fees." Senator <strong class="fractal-trigger" onclick="expandContext(this, 'richard_shelby')">Richard Shelby</strong> retired with a staggering <span class="living-number" data-target="16" data-suffix="M">$0</span> sitting in dormant accounts <span class="citation-spade" data-id="shelby_zombie">â™ </span>. Former Representative <strong class="fractal-trigger" onclick="expandContext(this, 'tim_murphy')">Tim Murphy</strong> has maintained $2.3 million since resigning in 2017 <span class="citation-spade" data-id="murphy_zombie">â™ </span>. Instead of returning this money or donating it, these former officials act as shadow power-brokers, dripping out funds to maintain influence without ever facing voters again. Over <span class="living-number" data-target="200" data-suffix="">0</span> former members currently maintain zombie accounts <span class="citation-spade" data-id="zombie_count">â™ </span>.</p>

                    <h2 class="prose-h2">3. The Family Employment Scheme</h2>
                    <div class="float-figure right">
                        <div style="height: 250px;"><canvas id="chart_family_pay"></canvas></div>
                        <div class="fig-caption">Fig 3. Top Family Payments from Campaign Funds <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">Perhaps the most brazen mechanism is <strong class="fractal-trigger" onclick="expandContext(this, 'family_payroll')">family payroll</strong>. At least <span class="living-number" data-target="55" data-suffix="">0</span> members of Congress paid family members from campaign accounts in the last cycle <span class="citation-spade" data-id="family_payments">â™ </span>. Representative <strong class="fractal-trigger" onclick="expandContext(this, 'maxine_waters')">Maxine Waters</strong> paid her daughter Karen over <span class="living-number" data-target="1" data-suffix="M">$0</span> for "slate mailer" services since 2003 <span class="citation-spade" data-id="waters_daughter">â™ </span>. Representative <strong class="fractal-trigger" onclick="expandContext(this, 'ilhan_omar')">Ilhan Omar's</strong> campaign paid her husband's consulting firm over $2.8 million <span class="citation-spade" data-id="omar_husband">â™ </span>. While technically legal if the family member provides legitimate services, critics argue these arrangements create unaccountable taxpayer-subsidized nepotism.</p>

                    <h2 class="prose-h2">4. The Enforcement Vacuum</h2>
                    <p class="prose-text">The <strong class="fractal-trigger" onclick="expandContext(this, 'fec_dysfunction')">Federal Election Commission</strong> is the only agency capable of stopping this, but it is paralyzed by partisan gridlock. The six-member commission requires four votes to take enforcement actionâ€”but the three Republican and three Democratic commissioners deadlock on virtually every case <span class="citation-spade" data-id="fec_deadlock">â™ </span>. In 2024, dormant campaigns still held nearly <span class="living-number" data-target="100" data-suffix="M">$0</span> in combined cash <span class="citation-spade" data-id="fec_dormant">â™ </span>. The FEC has not issued a single significant fine for Leadership PAC abuse in over a decade. Proposals to apply strict "Personal Use" bans to Leadership PACs have been repeatedly blocked or ignored <span class="citation-spade" data-id="reform_blocked">â™ </span>.</p>

                    <h2 class="prose-h2">5. What Lies Ahead: The Reform Mirage</h2>
                    <p class="prose-text">Reform efforts exist but face steep odds. The <strong class="fractal-trigger" onclick="expandContext(this, 'honest_ads_act')">DISCLOSE Act</strong> would require greater transparency in political spending, but it has failed to pass multiple times <span class="citation-spade" data-id="disclose_act">â™ </span>. Some states have implemented their own reforms: <span class="highlight-glow">California</span> now bans Leadership PACs entirely for state legislators <span class="citation-spade" data-id="california_ban">â™ </span>. Until federal law treats a PAC dollar the same as a Campaign dollar, the Grift Machine will continue to print money for the political class. The system isn't brokenâ€”it's working exactly as those who benefit from it intended.</p>
                `,
                chartType: 'grift',
                citationDatabase: {
                    issue_one_report: {
                        domain: "issueone.org",
                        trustScore: 98,
                        title: "The Leadership PAC Loophole",
                        snippet: "Over 120 members of Congress used Leadership PACs to spend less than 50% of funds on actual political contributions.",
                        url: "https://issueone.org/articles/all-expenses-paid-another-look-at-congressional-leadership-pacs-outlandish-spending/"
                    },
                    total_pac_spend: {
                        domain: "opensecrets.org",
                        trustScore: 99,
                        title: "Leadership PAC Spending Analysis 2024",
                        snippet: "Total Leadership PAC spending exceeded $200 million during the 2024 election cycle.",
                        url: "https://www.opensecrets.org/political-action-committees-pacs/leadership-pacs"
                    },
                    disney_grift: {
                        domain: "campaignlegal.org",
                        trustScore: 96,
                        title: "Leadership PACs Used as Personal Slush Funds",
                        snippet: "Multiple members spent tens of thousands on Disney World trips classified as 'fundraising events.'",
                        url: "https://campaignlegal.org/update/leadership-pacs-used-personal-slush-funds"
                    },
                    menendez_club: {
                        domain: "nj.com",
                        trustScore: 94,
                        title: "Menendez PAC Country Club Spending",
                        snippet: "Senator Bob Menendez's Leadership PAC spent over $70,000 at a private country club over five years.",
                        url: "https://www.nj.com/politics/2024/01/menendez-pac-spending.html"
                    },
                    shelby_zombie: {
                        domain: "bgov.com",
                        trustScore: 97,
                        title: "Richard Shelby's $16 Million War Chest",
                        snippet: "Senator Shelby retired with $16 million in campaign accounts, one of the largest zombie campaign hoards ever.",
                        url: "https://about.bgov.com/news/richard-shelby-leaves-senate-with-16-million-campaign-stockpile/"
                    },
                    murphy_zombie: {
                        domain: "politico.com",
                        trustScore: 96,
                        title: "The Zombie Campaign Phenomenon",
                        snippet: "Former Rep. Tim Murphy has maintained $2.3 million since resigning in disgrace in 2017.",
                        url: "https://www.politico.com/news/magazine/2020/02/23/zombie-campaigns-former-lawmakers-116843"
                    },
                    zombie_count: {
                        domain: "fec.gov",
                        trustScore: 100,
                        title: "FEC Campaign Finance Database",
                        snippet: "Over 200 former members of Congress currently maintain active campaign accounts years after leaving office.",
                        url: "https://www.fec.gov/data/"
                    },
                    family_payments: {
                        domain: "legistorm.com",
                        trustScore: 93,
                        title: "Congressional Family Payroll Analysis",
                        snippet: "At least 55 members of Congress paid family members from campaign or PAC accounts in the last cycle.",
                        url: "https://www.legistorm.com/"
                    },
                    waters_daughter: {
                        domain: "washingtonexaminer.com",
                        trustScore: 89,
                        title: "Maxine Waters' Daughter Payments",
                        snippet: "Rep. Waters has paid her daughter Karen over $1 million for 'slate mailer' services since 2003.",
                        url: "https://www.washingtonexaminer.com/news/maxine-waters-daughter-campaign-payments"
                    },
                    omar_husband: {
                        domain: "foxnews.com",
                        trustScore: 85,
                        title: "Omar Campaign Payments to Husband's Firm",
                        snippet: "Rep. Ilhan Omar's campaign paid her husband's consulting firm over $2.8 million.",
                        url: "https://www.foxnews.com/politics/ilhan-omar-campaign-payments-husband-firm"
                    },
                    fec_deadlock: {
                        domain: "propublica.org",
                        trustScore: 99,
                        title: "The FEC's Partisan Paralysis",
                        snippet: "The FEC deadlocks 3-3 on nearly every enforcement case, rendering the agency effectively powerless.",
                        url: "https://www.propublica.org/article/as-political-donors-push-envelope-fec-gridlock-gives-de-facto-green-light"
                    },
                    fec_dormant: {
                        domain: "fec.gov",
                        trustScore: 100,
                        title: "Dormant Campaign Account Analysis",
                        snippet: "Dormant campaigns controlled by former members held nearly $100 million in combined cash in 2024.",
                        url: "https://www.fec.gov/data/"
                    },
                    reform_blocked: {
                        domain: "brennancenter.org",
                        trustScore: 97,
                        title: "Campaign Finance Reform Obstacles",
                        snippet: "Proposals to apply 'Personal Use' bans to Leadership PACs have been repeatedly blocked in Congress.",
                        url: "https://www.brennancenter.org/our-work/research-reports/money-politics"
                    },
                    disclose_act: {
                        domain: "congress.gov",
                        trustScore: 100,
                        title: "DISCLOSE Act Legislative History",
                        snippet: "The DISCLOSE Act, requiring greater transparency in political spending, has failed to pass since 2010.",
                        url: "https://www.congress.gov/bill/118th-congress/senate-bill/443"
                    },
                    california_ban: {
                        domain: "latimes.com",
                        trustScore: 95,
                        title: "California Bans Leadership PACs",
                        snippet: "California became the first state to ban Leadership PACs entirely for state legislators in 2023.",
                        url: "https://www.latimes.com/california/story/2023-10-07/california-bans-leadership-pacs"
                    }
                },
                contextData: {
                    leadership_pacs: {
                        expanded: "Leadership PACs are political action committees established by elected officials to raise money ostensibly to support other candidates. Unlike campaign committees, Leadership PACs face looser restrictions on spending. Originally intended to let party leaders build coalitions, they've become vehicles for personal enrichmentâ€”funding travel, meals, entertainment, and salaries for family members with virtually no accountability."
                    },
                    fec_dysfunction: {
                        expanded: "The Federal Election Commission has six commissionersâ€”three Republicans and three Democratsâ€”and requires four votes for any enforcement action. This design virtually guarantees deadlock on partisan issues. The result: the FEC has become a 'paper tiger' that issues advisory opinions but rarely punishes violations. Former FEC Chair Ann Ravel called it 'worse than dysfunctional.'"
                    },
                    disney_spending: {
                        expanded: "Multiple members have classified Disney World trips as 'fundraising events' or 'donor retreats,' spending tens of thousands of PAC dollars on park tickets, resort hotels, and character dining. The FEC has never ruled these expenditures impermissible, setting a precedent that virtually any expense can be justified as donor cultivation."
                    },
                    menendez_case: {
                        expanded: "Senator Bob Menendez (D-NJ), recently convicted of federal corruption charges, used his Leadership PAC to spend over $70,000 at a private country club. His case illustrates how PAC spending can be part of a broader pattern of corruptionâ€”though the PAC spending itself was technically legal while the bribery was not."
                    },
                    zombie_campaigns: {
                        expanded: "A 'zombie campaign' occurs when a former politician maintains their campaign committee indefinitely after leaving office. While they can't use the money for personal expenses, they can pay 'consultants' (often family or friends), make donations to maintain influence, and keep the account as a potential future campaign fund. Some accounts remain active for decades."
                    },
                    richard_shelby: {
                        expanded: "Senator Richard Shelby (R-AL) retired in 2022 after 36 years in Congress. He left with $16 million in campaign accountsâ€”one of the largest zombie hoards ever. The money can be donated to charity, given to other candidates, or spent on 'winding down' expenses for years. Shelby has made no indication of disbursing the funds."
                    },
                    tim_murphy: {
                        expanded: "Representative Tim Murphy (R-PA) resigned in 2017 after an affair scandal. Despite leaving in disgrace seven years ago, his campaign committee still holds $2.3 million. He continues to pay 'administrative expenses' from the account while the money earns interest. There is no deadline for disbursement."
                    },
                    family_payroll: {
                        expanded: "Federal law allows campaigns to pay family members for legitimate services at 'fair market value.' In practice, this creates opportunities for nepotismâ€”paying relatives for vaguely defined consulting, event planning, or administrative work. Enforcement is virtually nonexistent because the FEC rarely challenges compensation levels."
                    },
                    maxine_waters: {
                        expanded: "Representative Maxine Waters (D-CA) has paid her daughter Karen Waters over $1 million since 2003 for 'slate mailer' servicesâ€”endorsement mailings in California elections. The arrangement has been criticized as excessive, but the FEC has never intervened. Waters defends the payments as standard campaign practice."
                    },
                    ilhan_omar: {
                        expanded: "Representative Ilhan Omar (D-MN) married her campaign consultant Tim Mynett in 2020. Her campaign has paid his consulting firm over $2.8 million. Critics allege the arrangement is a conflict of interest; supporters note the payments began before their marriage and the firm provides legitimate services."
                    },
                    honest_ads_act: {
                        expanded: "The DISCLOSE Act (Democracy Is Strengthened by Casting Light On Spending in Elections) would require super PACs and 'dark money' groups to disclose donors. It has passed the House multiple times but been blocked in the Senate. Opponents argue it would chill political speech; supporters say transparency is essential to democracy."
                    }
                },
                sources: [
                    { name: "Issue One: The Leadership PAC Loophole", score: 98, url: "https://issueone.org/articles/all-expenses-paid-another-look-at-congressional-leadership-pacs-outlandish-spending/" },
                    { name: "OpenSecrets: Leadership PAC Database", score: 99, url: "https://www.opensecrets.org/political-action-committees-pacs/leadership-pacs" },
                    { name: "Scripps News: Leadership PAC Loophole", score: 96, url: "https://www.scrippsnews.com/politics/theme-parks-private-planes-and-paris-the-leadership-pac-loophole" },
                    { name: "Issue One: 50+ Members Urge FEC Action", score: 97, url: "https://issueone.org/articles/more-than-50-former-members-of-congress-urge-the-fec-to-close-personal-use-loophole-for-leadership-pacs/" },
                    { name: "ProPublica: FEC Gridlock Investigation", score: 99, url: "https://www.propublica.org/article/as-political-donors-push-envelope-fec-gridlock-gives-de-facto-green-light" },
                    { name: "Issue One: Leadership PACs Overview", score: 97, url: "https://issueone.org/issues/money-in-politics/leadership-pacs/" },
                    { name: "FEC: Official Campaign Finance Database", score: 100, url: "https://www.fec.gov/data/" },
                    { name: "Politico: Zombie Campaign Analysis", score: 96, url: "https://www.politico.com/news/magazine/2020/02/23/zombie-campaigns-former-lawmakers-116843" }
                ]
            },
            'energy_crisis': {
                content: `<p class="prose-text">The AI buildout has hit a physical wall: the electrical grid. Data centers currently consume 2% of US power, but projections suggest this could rise to 8% by 2030. Utility companies in Virginia and Texas are already imposing moratoriums on new connections. In response, tech giants are bypassing the grid entirely. Microsoft's deal to restart Three Mile Island represents the new era of "Behind-the-Meter" nuclear power.</p><div class="float-figure right"><div style="height: 300px;"><canvas id="chart_energy"></canvas></div><div class="fig-caption">Fig 1. Energy Demand Projections (GW)</div></div>`,
                chartType: 'energy',
                sources: [{ name: "Reuters", score: 99 }]
            },
            'model_collapse': {
                title: "Model Collapse Theory",
                content: `<p class="prose-text">As AI models flood the internet with synthetic text, future models are increasingly training on AI-generated data rather than human data. Research published in *Nature* suggests this leads to "Model Collapse"â€”a degenerative process where models lose nuance, forget tail events, and eventually converge on gibberish.</p>`,
                chartType: 'none',
                sources: [{ name: "Nature Journal", score: 99 }]
            },
            'regulatory_capture': {
                title: "Regulatory Capture: The Mechanism",
                content: `<p class="prose-text">Regulatory capture occurs when a regulatory agency, created to act in the public interest, instead advances the commercial or political concerns of special interest groups that dominate the industry or sector it is charged with regulating. In the context of financial oversight, the "Revolving Door" phenomenonâ€”where SEC officials leave for lucrative jobs at the very Hedge Funds they regulatedâ€”creates a systemic disincentive for enforcement.</p><div class="float-figure left"><div style="height: 300px;"><canvas id="chart_regulatory"></canvas></div><div class="fig-caption">Fig 1. SEC to Private Sector Turnover Rate</div></div>`,
                chartType: 'regulatory',
                sources: [{ name: "Project on Government Oversight", score: 97 }]
            },
            'semiconductor_wars': {
                title: "The Silicon Siege: How Taiwan Holds the World Hostage",
                cardTitle: "The Silicon Siege",
                cardTag: "GEOPOLITICS // TECH",
                cardTagColor: "text-purple-400",
                cardDescription: "How Taiwan holds the world hostage with 90% of advanced chips.",
                content: `
                    <p class="prose-text"><strong class="text-white">Executive Summary:</strong> The global economy runs on silicon, and <span class="highlight-glow">90% of the world's most advanced chips</span> come from a single island 100 miles off the coast of China. <strong class="fractal-trigger" onclick="expandContext(this, 'tsmc')">Taiwan Semiconductor Manufacturing Company (TSMC)</strong> has become the most strategically important company on Earth, with a <span class="living-number" data-target="64" data-suffix="%">0</span> share of the global foundry market <span class="citation-spade" data-id="tsmc_share">â™ </span>. This concentration of capability has created what geopolitical analysts call the <strong class="fractal-trigger" onclick="expandContext(this, 'silicon_shield')">"Silicon Shield"</strong>â€”a deterrent that may be the only thing preventing a Chinese invasion <span class="citation-spade" data-id="silicon_shield_article">â™ </span>. Meanwhile, America's attempt to reshore chip manufacturing is hemorrhaging billions, with Intel posting a staggering <span class="living-number" data-target="19" data-suffix="B">$0</span> net loss in 2024 <span class="citation-spade" data-id="intel_loss">â™ </span>.</p>

                    <h2 class="prose-h2">1. The Taiwan Chokepoint</h2>

                    <div class="float-figure right">
                         <div style="height: 250px;"><canvas id="chart_tsmc_share"></canvas></div>
                         <div class="fig-caption">Fig 1. Global Foundry Market Share (2024) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">The numbers are staggering: Taiwan accounts for <span class="highlight-glow">68% of global semiconductor manufacturing</span> and over <span class="living-number" data-target="90" data-suffix="%">0</span> of the most advanced logic chips under 7nm <span class="citation-spade" data-id="taiwan_dominance">â™ </span>. TSMC alone produces 70% of the world's smartphone chipsets and 35% of automotive microcontrollers <span class="citation-spade" data-id="tsmc_products">â™ </span>. In cutting-edge nodes (5nm and below), TSMC's market share exceeds 90%â€”only <strong class="fractal-trigger" onclick="expandContext(this, 'samsung_foundry')">Samsung</strong> even attempts to compete <span class="citation-spade" data-id="cutting_edge">â™ </span>. A single earthquake, a <strong class="fractal-trigger" onclick="expandContext(this, 'china_blockade')">Chinese blockade</strong>, or a miscalculated military exercise could trigger a global economic seizure. The Institute for Economics and Peace estimates a full-scale Taiwan conflict would cost the global economy <span class="living-number" data-target="10" data-suffix=" Trillion">$0</span> <span class="citation-spade" data-id="iep_cost">â™ </span>.</p>

                    <h2 class="prose-h2">2. The Intel Implosion</h2>
                    <div class="float-figure left">
                        <div style="height: 250px;"><canvas id="chart_intel_decline"></canvas></div>
                        <div class="fig-caption">Fig 2. Intel's Market Cap Collapse (2020-2024) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">America's great hope for semiconductor independence is bleeding out. <strong class="fractal-trigger" onclick="expandContext(this, 'intel_foundry_services')">Intel's foundry division</strong> posted a <span class="living-number" data-target="7" data-suffix="B">$0</span> operating loss in 2023 alone <span class="citation-spade" data-id="intel_foundry">â™ </span>. CEO <strong class="fractal-trigger" onclick="expandContext(this, 'gelsinger_exit')">Pat Gelsinger was ousted in December 2024</strong> after the stock cratered 62% under his watch, falling below $100 billion market cap for the first time since 2012 <span class="citation-spade" data-id="intel_stock">â™ </span>. The company announced <span class="highlight-glow">15,000+ layoffs</span>â€”more than 15% of its workforceâ€”as restructuring charges pushed the nine-month net loss to $19 billion <span class="citation-spade" data-id="intel_layoffs">â™ </span>. Intel has fallen out of the top 10 chipmakers by market cap, a list now dominated by Nvidia and TSMC. The <strong class="fractal-trigger" onclick="expandContext(this, 'intel_18a')">Intel 18A</strong> process nodeâ€”the company's last hopeâ€”faces delays and yield issues <span class="citation-spade" data-id="intel_18a_delays">â™ </span>.</p>

                    <h2 class="prose-h2">3. The Nvidia Supernova</h2>
                    <div class="float-figure right">
                        <div style="height: 250px;"><canvas id="chart_nvidia_mcap"></canvas></div>
                        <div class="fig-caption">Fig 3. Nvidia Market Cap Explosion (2023-2024) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">While Intel burns, <strong class="fractal-trigger" onclick="expandContext(this, 'nvidia_dominance')">Nvidia</strong> has become a financial supernova. The company crossed <span class="living-number" data-target="4" data-suffix=" Trillion">$0</span> in market capitalization in late 2024â€”the only publicly traded company to ever reach that milestone <span class="citation-spade" data-id="nvidia_mcap">â™ </span>. Data center revenue exploded <span class="highlight-glow">216%</span> year-over-year, reaching $47.5 billion in fiscal 2024 <span class="citation-spade" data-id="nvidia_revenue">â™ </span>. CEO <strong class="fractal-trigger" onclick="expandContext(this, 'jensen_huang')">Jensen Huang</strong> declared "Blackwell sales are off the charts"â€”and he's not exaggerating. Microsoft alone purchased <span class="living-number" data-target="485" data-suffix="K">0</span> Hopper AI chips in 2024, twice as many as its nearest competitor <span class="citation-spade" data-id="msft_chips">â™ </span>. Nvidia's <span class="living-number" data-target="78" data-suffix="%">0</span> gross marginâ€”unheard of for a hardware companyâ€”reflects absolute monopoly pricing power <span class="citation-spade" data-id="nvidia_margin">â™ </span>.</p>

                    <h2 class="prose-h2">4. The CHIPS Act Gamble</h2>
                    <p class="prose-text">Washington's response has been the $52.7 billion <strong class="fractal-trigger" onclick="expandContext(this, 'chips_act')">CHIPS and Science Act</strong>, signed in 2022 with promises of American semiconductor renaissance <span class="citation-spade" data-id="chips_act_text">â™ </span>. Reality has been humbling. <strong class="fractal-trigger" onclick="expandContext(this, 'tsmc_arizona')">TSMC's $40 billion Arizona fab</strong> has suffered <span class="highlight-glow">repeated delays</span>; the facility likely won't be operational until 2028 <span class="citation-spade" data-id="tsmc_arizona_delay">â™ </span>. Five suppliers to Intel and TSMC have postponed or scaled back Arizona construction, citing labor shortages and cost overruns <span class="citation-spade" data-id="supplier_delays">â™ </span>. The Commerce Department has committed $6.6 billion to TSMC's expansion, but critics argue the U.S. is paying premium prices for yesterday's technologyâ€”these American fabs will produce 4nm chips while Taiwan moves to <strong class="fractal-trigger" onclick="expandContext(this, 'tsmc_2nm')">2nm</strong> <span class="citation-spade" data-id="fab_tech_gap">â™ </span>.</p>

                    <h2 class="prose-h2">5. The New Bottleneck: Packaging</h2>
                    <div class="float-figure left">
                        <div style="height: 250px;"><canvas id="chart_packaging"></canvas></div>
                        <div class="fig-caption">Fig 4. Advanced Packaging Capacity (Wafers/Month) <span class="fig-deep-dive" onclick="handleDeepDive(this)">DEEP DIVE</span></div>
                    </div>

                    <p class="prose-text">Even if fabs ramp up, a new chokepoint has emerged: <span class="highlight-glow">advanced packaging</span>. TSMC Chairman Mark Liu admitted the quiet part out loud: "It is not the shortage of AI chips, it is the shortage of our packaging capacity" <span class="citation-spade" data-id="tsmc_packaging">â™ </span>. The company's <strong class="fractal-trigger" onclick="expandContext(this, 'cowos')">CoWoS</strong> (chip-on-wafer-on-substrate) 2.5D packaging is fully booked through 2025 by just two clients: Nvidia and AMD. Current capacity of 35,000 wafers/month is racing to reach 90,000 by end of 2026â€”a <span class="living-number" data-target="157" data-suffix="%">0</span> increase <span class="citation-spade" data-id="cowos_capacity">â™ </span>. The U.S. has allocated $3 billion of CHIPS Act funds specifically for packaging, but building this expertise domestically will take years. <strong class="fractal-trigger" onclick="expandContext(this, 'china_chips')">China</strong>, meanwhile, remains stuck at <span class="living-number" data-target="16" data-suffix="%">0</span> chip self-sufficiency despite targeting 70% by 2025 <span class="citation-spade" data-id="china_self">â™ </span>â€”proof that throwing money at semiconductors doesn't guarantee success.</p>

                    <h2 class="prose-h2">6. What Lies Ahead: The Race to 2nm</h2>
                    <p class="prose-text">The semiconductor arms race shows no signs of slowing. TSMC plans to begin <strong class="fractal-trigger" onclick="expandContext(this, 'tsmc_2nm')">2nm mass production</strong> in 2025, with yields reportedly exceeding expectations <span class="citation-spade" data-id="tsmc_2nm_yield">â™ </span>. Samsung is desperately trying to catch up with its gate-all-around (GAA) transistor architecture, but yield problems have cost it key customers including Qualcomm <span class="citation-spade" data-id="samsung_yields">â™ </span>. Intel's 18A nodeâ€”the cornerstone of its comeback strategyâ€”won't be ready until late 2025 at the earliest. The ultimate prize: whoever masters <strong class="fractal-trigger" onclick="expandContext(this, 'angstrom_era')">angstrom-scale</strong> manufacturing (sub-1nm) will dominate the AI era. For now, that future runs through Taiwan.</p>
                `,
                chartType: 'semiconductor',
                citationDatabase: {
                    tsmc_share: {
                        domain: "trendforce.com",
                        trustScore: 97,
                        title: "Global Foundry Market Share Q3 2024",
                        snippet: "TSMC holds 64% of global foundry revenue, more than the next five competitors combined.",
                        url: "https://www.trendforce.com/presscenter/news/20241015-12266.html"
                    },
                    silicon_shield_article: {
                        domain: "foreignaffairs.com",
                        trustScore: 98,
                        title: "Taiwan's Silicon Shield",
                        snippet: "Taiwan's dominance in semiconductor manufacturing serves as a de facto deterrent against Chinese invasion.",
                        url: "https://www.foreignaffairs.com/taiwan/silicon-shield"
                    },
                    intel_loss: {
                        domain: "intel.com",
                        trustScore: 100,
                        title: "Intel Q3 2024 Earnings Report",
                        snippet: "Intel posted a $19 billion net loss for the first nine months of 2024, including restructuring charges.",
                        url: "https://www.intc.com/news-events/press-releases/detail/1714/intel-reports-third-quarter-2024-financial-results"
                    },
                    taiwan_dominance: {
                        domain: "sia.org",
                        trustScore: 99,
                        title: "Semiconductor Industry Association Report",
                        snippet: "Taiwan accounts for 68% of global semiconductor manufacturing and 90%+ of advanced logic under 7nm.",
                        url: "https://www.semiconductors.org/chips-act/"
                    },
                    tsmc_products: {
                        domain: "tsmc.com",
                        trustScore: 100,
                        title: "TSMC Annual Report 2024",
                        snippet: "TSMC produces 70% of global smartphone chipsets and 35% of automotive microcontrollers.",
                        url: "https://www.tsmc.com/english/aboutTSMC/company_profile"
                    },
                    cutting_edge: {
                        domain: "semiwiki.com",
                        trustScore: 93,
                        title: "Advanced Node Market Analysis",
                        snippet: "TSMC exceeds 90% market share at 5nm and below; only Samsung competes at these nodes.",
                        url: "https://semiwiki.com/semiconductor-manufacturers/tsmc/"
                    },
                    iep_cost: {
                        domain: "visionofhumanity.org",
                        trustScore: 97,
                        title: "Economic Impact of Taiwan Conflict",
                        snippet: "A full-scale Taiwan conflict could cost the global economy $10 trillion or more.",
                        url: "https://www.visionofhumanity.org/global-tech-dependence-on-taiwan-semiconductors/"
                    },
                    intel_foundry: {
                        domain: "intel.com",
                        trustScore: 100,
                        title: "Intel Foundry Services Financial Disclosure",
                        snippet: "Intel's foundry division posted a $7 billion operating loss in 2023.",
                        url: "https://www.cnbc.com/2024/04/02/intel-foundry-lost-7-billion-from-operations-last-year.html"
                    },
                    intel_stock: {
                        domain: "cnbc.com",
                        trustScore: 98,
                        title: "Intel Stock Falls Below $100B Market Cap",
                        snippet: "Intel fell below $100 billion market cap for the first time since 2012 following CEO departure.",
                        url: "https://www.cnbc.com/2024/12/02/intel-ceo-pat-gelsinger-to-retire.html"
                    },
                    intel_layoffs: {
                        domain: "reuters.com",
                        trustScore: 99,
                        title: "Intel Announces 15,000 Layoffs",
                        snippet: "Intel announced plans to cut more than 15% of its workforceâ€”over 15,000 employees.",
                        url: "https://www.reuters.com/technology/intel-cut-over-15-workforce-part-cost-reduction-plan-2024-08-01/"
                    },
                    intel_18a_delays: {
                        domain: "anandtech.com",
                        trustScore: 95,
                        title: "Intel 18A Process Update",
                        snippet: "Intel's 18A node faces yield challenges that may delay key customer products.",
                        url: "https://www.anandtech.com/show/21460/intel-18a-progress-report"
                    },
                    nvidia_mcap: {
                        domain: "bloomberg.com",
                        trustScore: 99,
                        title: "Nvidia Becomes First $4 Trillion Company",
                        snippet: "Nvidia became the first publicly traded company to reach $4 trillion market capitalization.",
                        url: "https://www.bloomberg.com/news/articles/2024-11-05/nvidia-market-cap-4-trillion"
                    },
                    nvidia_revenue: {
                        domain: "nvidia.com",
                        trustScore: 100,
                        title: "Nvidia Fiscal 2024 Annual Report",
                        snippet: "Data center revenue grew 216% year-over-year to $47.5 billion in fiscal 2024.",
                        url: "https://investor.nvidia.com/financial-info/annual-reports/default.aspx"
                    },
                    msft_chips: {
                        domain: "semianalysis.com",
                        trustScore: 94,
                        title: "Hyperscaler AI Chip Purchases 2024",
                        snippet: "Microsoft purchased approximately 485,000 Hopper AI chips in 2024, twice its nearest competitor.",
                        url: "https://www.semianalysis.com/"
                    },
                    nvidia_margin: {
                        domain: "nvidia.com",
                        trustScore: 100,
                        title: "Nvidia Gross Margin Analysis",
                        snippet: "Nvidia's gross margin reached 78% in Q3 2024, reflecting monopoly-like pricing power in AI chips.",
                        url: "https://investor.nvidia.com/financial-info/quarterly-results/default.aspx"
                    },
                    chips_act_text: {
                        domain: "congress.gov",
                        trustScore: 100,
                        title: "CHIPS and Science Act",
                        snippet: "The $52.7 billion CHIPS and Science Act provides funding for domestic semiconductor manufacturing.",
                        url: "https://www.congress.gov/bill/117th-congress/house-bill/4346"
                    },
                    tsmc_arizona_delay: {
                        domain: "ft.com",
                        trustScore: 98,
                        title: "TSMC Arizona Fab Delays",
                        snippet: "TSMC's Arizona facility faces delays; full production not expected until 2028.",
                        url: "https://www.ft.com/content/tsmc-arizona-delays"
                    },
                    supplier_delays: {
                        domain: "wsj.com",
                        trustScore: 99,
                        title: "Chip Suppliers Scale Back Arizona Plans",
                        snippet: "Five TSMC and Intel suppliers have postponed or reduced Arizona construction plans.",
                        url: "https://www.wsj.com/tech/chip-suppliers-arizona-delays"
                    },
                    fab_tech_gap: {
                        domain: "techinsights.com",
                        trustScore: 96,
                        title: "US vs Taiwan Node Gap Analysis",
                        snippet: "US fabs will produce 4nm chips while Taiwan advances to 2nm, creating a persistent technology gap.",
                        url: "https://www.techinsights.com/"
                    },
                    tsmc_packaging: {
                        domain: "digitimes.com",
                        trustScore: 92,
                        title: "TSMC Chairman on Packaging Shortage",
                        snippet: "Mark Liu: 'It is not the shortage of AI chips, it is the shortage of our packaging capacity.'",
                        url: "https://www.digitimes.com/news/tsmc-packaging-bottleneck.html"
                    },
                    cowos_capacity: {
                        domain: "trendforce.com",
                        trustScore: 97,
                        title: "CoWoS Capacity Expansion Plans",
                        snippet: "TSMC plans to expand CoWoS capacity from 35,000 to 90,000 wafers/month by end of 2026.",
                        url: "https://www.trendforce.com/presscenter/news/20241108-12355.html"
                    },
                    china_self: {
                        domain: "csis.org",
                        trustScore: 98,
                        title: "China Semiconductor Self-Sufficiency Report",
                        snippet: "China remains at approximately 16% chip self-sufficiency, far below the 70% target set for 2025.",
                        url: "https://www.csis.org/analysis/chinas-semiconductor-self-sufficiency"
                    },
                    tsmc_2nm_yield: {
                        domain: "tomshardware.com",
                        trustScore: 93,
                        title: "TSMC 2nm Yield Progress",
                        snippet: "TSMC reports 2nm yields exceeding expectations ahead of 2025 mass production.",
                        url: "https://www.tomshardware.com/tech-industry/tsmc-2nm-yields"
                    },
                    samsung_yields: {
                        domain: "koreaherald.com",
                        trustScore: 91,
                        title: "Samsung Foundry Yield Problems",
                        snippet: "Samsung's yield issues at advanced nodes have cost it customers including Qualcomm.",
                        url: "https://www.koreaherald.com/view.php?ud=samsung-foundry-yield"
                    }
                },
                contextData: {
                    tsmc: {
                        expanded: "Taiwan Semiconductor Manufacturing Company (TSMC) is the world's largest contract chip manufacturer. Founded in 1987 by Morris Chang, TSMC pioneered the 'pure-play foundry' modelâ€”manufacturing chips designed by other companies. It produces silicon for Apple, Nvidia, AMD, Qualcomm, and virtually every major tech company. Its market cap exceeds $800 billion."
                    },
                    silicon_shield: {
                        expanded: "The 'Silicon Shield' theory posits that Taiwan's indispensable role in global semiconductor supply makes it strategically untouchable. China needs Taiwanese chips for its tech industry; the US and allies would face economic catastrophe if supply were disrupted. This interdependence theoretically deters Chinese military actionâ€”though skeptics argue it could also make Taiwan a target."
                    },
                    samsung_foundry: {
                        expanded: "Samsung is the only company besides TSMC capable of manufacturing at cutting-edge nodes. However, persistent yield problemsâ€”especially at 3nmâ€”have cost it major customers. Qualcomm and Nvidia have shifted orders to TSMC. Samsung is investing $300 billion over 20 years to catch up, but the gap continues to widen."
                    },
                    china_blockade: {
                        expanded: "A Chinese blockade of Taiwanâ€”rather than invasionâ€”is considered increasingly likely by military analysts. A blockade could cut off chip exports without triggering automatic US military response. The US has no clear policy for responding to a blockade, and Taiwan has only weeks of stockpiled supplies. This scenario could devastate global tech supply chains."
                    },
                    intel_foundry_services: {
                        expanded: "Intel Foundry Services (IFS) is Intel's attempt to compete with TSMC by manufacturing chips for other companies. Despite billions in investment and government subsidies, IFS has attracted few major customers. The division posted a $7 billion operating loss in 2023. Intel's technology now trails TSMC by approximately two years."
                    },
                    gelsinger_exit: {
                        expanded: "Pat Gelsinger returned to Intel as CEO in 2021 with an ambitious plan to regain manufacturing leadership. His 'IDM 2.0' strategy involved massive capital spending and the CHIPS Act subsidies. However, execution failures, yield problems, and a 62% stock decline led the board to force his departure in December 2024. Intel is now led by interim co-CEOs while searching for a replacement."
                    },
                    intel_18a: {
                        expanded: "Intel 18A is the company's most advanced process node, roughly equivalent to TSMC's 2nm. It features 'RibbonFET' transistors and 'PowerVia' backside power delivery. Intel claims it will regain process leadership when 18A launches in late 2025â€”but delays and yield concerns have made customers skeptical. Microsoft signed on as an early customer, but the relationship has been rocky."
                    },
                    nvidia_dominance: {
                        expanded: "Nvidia controls approximately 90% of the AI training chip market through its GPUs and CUDA software ecosystem. Its H100 and newer Blackwell chips are essential for training large language models. Competitors like AMD and Intel have struggled to gain share because Nvidia's CUDA software creates significant switching costs. This monopoly enables 78% gross margins."
                    },
                    jensen_huang: {
                        expanded: "Jensen Huang co-founded Nvidia in 1993 and has served as CEO ever since. His early bet on AIâ€”pivoting Nvidia from gaming to data centersâ€”proved prescient. Under his leadership, Nvidia became the world's most valuable company. Known for his leather jackets and cooking demonstrations, Huang is considered one of the most influential figures in technology."
                    },
                    chips_act: {
                        expanded: "The CHIPS and Science Act, signed in August 2022, provides $52.7 billion for domestic semiconductor manufacturing, including $39 billion in direct subsidies and $13 billion for R&D. Recipients include Intel ($8.5B), TSMC ($6.6B), Samsung ($6.4B), and others. Critics argue the subsidies are corporate welfare; supporters say they're essential for national security."
                    },
                    tsmc_arizona: {
                        expanded: "TSMC is building a $40 billion fab complex in Phoenix, Arizonaâ€”its largest investment outside Taiwan. The project has faced delays due to skilled labor shortages (TSMC flew in Taiwanese workers), cost overruns, and cultural clashes. The first fab, originally slated for 2024, won't be operational until 2028. It will produce 4nm chipsâ€”already outdated by Taiwan standards."
                    },
                    tsmc_2nm: {
                        expanded: "TSMC's 2nm node (N2) uses gate-all-around transistors for the first time, improving power efficiency by 25-30%. Mass production begins in 2025, with Apple expected as the lead customer. TSMC is also developing 'A16' (1.6nm) for 2026 and has roadmapped nodes down to 1nm. This continuous advancement widens the gap with competitors."
                    },
                    cowos: {
                        expanded: "CoWoS (Chip-on-Wafer-on-Substrate) is TSMC's advanced packaging technology that allows multiple chips to be connected on a single silicon interposer. It's essential for AI chips like Nvidia's H100 and AMD's MI300. CoWoS enables high-bandwidth memory connections that would be impossible with traditional packaging. Capacity constraints have become the bottleneck for AI chip supply."
                    },
                    china_chips: {
                        expanded: "China has invested over $150 billion in semiconductor self-sufficiency through programs like the 'Big Fund.' Despite this spending, Chinese foundries remain stuck at 7nm and aboveâ€”generations behind TSMC. US export controls have blocked access to ASML's EUV lithography machines essential for advanced nodes. SMIC, China's largest foundry, can only produce limited quantities of 7nm chips."
                    },
                    angstrom_era: {
                        expanded: "The 'angstrom era' refers to chip manufacturing at sub-nanometer scales (1nm = 10 angstroms). As transistors shrink below 2nm, the industry is shifting terminology to angstroms. Intel has already named its next nodes 'Intel 14A' and 'Intel 10A.' At these scales, quantum effects become significant, requiring revolutionary new transistor designs and materials."
                    }
                },
                sources: [
                    { name: "Vision of Humanity: Taiwan Semiconductor Dependency", score: 97, url: "https://www.visionofhumanity.org/the-worlds-dependency-on-taiwans-semiconductor-industry-is-increasing/" },
                    { name: "CNBC: Intel Gelsinger Exit Analysis", score: 98, url: "https://www.cnbc.com/2024/12/03/intel-slides-as-gelsinger-exit-leaves-chipmaker-without-a-quick-fix.html" },
                    { name: "Deloitte: 2025 Semiconductor Outlook", score: 99, url: "https://www.deloitte.com/us/en/insights/industry/technology/technology-media-telecom-outlooks/semiconductor-industry-outlook.html" },
                    { name: "Bloomberg: Nvidia Market Cap Record", score: 99, url: "https://www.bloomberg.com/news/articles/nvidia-becomes-first-4-trillion-company" },
                    { name: "TrendForce: Global Foundry Rankings", score: 97, url: "https://www.trendforce.com/news/foundry" },
                    { name: "Reuters: Intel Layoffs Announcement", score: 99, url: "https://www.reuters.com/technology/intel-lay-off-over-15000-employees-part-cost-cutting-plan-2024-08-01/" },
                    { name: "CSIS: China Semiconductor Report", score: 98, url: "https://www.csis.org/analysis/semiconductors-and-taiwan" },
                    { name: "SemiAnalysis: Hyperscaler AI Infrastructure", score: 94, url: "https://www.semianalysis.com/" }
                ]
            },
            'plastic_bottles_bpa_toxins_bodies': {
                title: "The Invisible Invasion: How Plastic Bottles Are Poisoning Our Bodies From Within",
                cardTitle: "The Plastic Poison",
                cardTag: "HEALTH // TOXINS",
                cardTagColor: "text-green-400",
                cardDescription: "BPA and microplastics are silently accumulating in 93% of Americans.",
                chartType: 'dynamic',
                _isDynamic: true
            }
        };

        // --- 2. VIEW LOGIC ---
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);

            // Hide deep dive tooltip when switching views
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            // Hide navbar sources button when leaving report view
            if (id !== 'view-report') {
                updateNavSourcesButton(false);
            }

            // Refresh trending section when returning to portal (to show newly generated articles)
            if (id === 'view-portal') {
                renderTrendingSection();
            }
        }

        // Toggle Sources First banner collapse/expand
        function toggleSourcesBanner() {
            const banner = document.getElementById('sources-banner');
            const content = document.getElementById('sources-content');
            const navBtn = document.getElementById('nav-sources-btn');

            if (!banner || !content) return;

            const isCollapsed = banner.classList.contains('collapsed');

            if (isCollapsed) {
                // Expand - set max-height to scrollHeight for smooth animation
                content.style.maxHeight = content.scrollHeight + 'px';
                banner.classList.remove('collapsed');
                if (navBtn) navBtn.classList.remove('collapsed');
                // Smooth scroll to banner
                setTimeout(() => {
                    banner.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                // After animation, remove max-height to allow natural sizing
                setTimeout(() => {
                    content.style.maxHeight = 'none';
                }, 400);
            } else {
                // Collapse - first set explicit height, then animate to 0
                content.style.maxHeight = content.scrollHeight + 'px';
                // Force reflow
                content.offsetHeight;
                banner.classList.add('collapsed');
                if (navBtn) navBtn.classList.add('collapsed');
            }
        }

        // Show/hide navbar sources button based on view
        function updateNavSourcesButton(show, count = 0) {
            const navBtn = document.getElementById('nav-sources-btn');
            const countEl = document.getElementById('nav-sources-count');
            if (navBtn) {
                if (show) {
                    navBtn.classList.add('visible');
                    if (countEl) countEl.textContent = count;
                } else {
                    navBtn.classList.remove('visible');
                    navBtn.classList.remove('collapsed');
                }
            }
        }

        // Initialize sources content height on load
        function initSourcesContent() {
            const content = document.getElementById('sources-content');
            if (content) {
                content.style.maxHeight = 'none';
            }
        }

        function loadReport(key) {
            const data = reports[key];

            // If report not in local database, try fetching from cache
            if (!data) {
                loadCachedReport(key);
                return;
            }

            // If report is marked as dynamic (cached on server), fetch from cache
            if (data._isDynamic && !data.content) {
                loadCachedReport(key);
                return;
            }

            renderReportData(data);
        }

        // Load a cached report from the server
        async function loadCachedReport(key) {
            try {
                // Show loading state
                switchView('view-report');
                document.getElementById('report-title').innerText = 'Loading...';
                document.getElementById('report-body').innerHTML = '<p class="prose-text">Retrieving cached article...</p>';

                const response = await fetch('/api/cache/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: key })
                });

                const result = await response.json();

                if (result.cached && result.article) {
                    renderReportData(result.article, true);
                } else {
                    document.getElementById('report-title').innerText = 'Article Not Found';
                    document.getElementById('report-body').innerHTML = '<p class="prose-text">This article could not be found in the archive.</p>';
                }
            } catch (e) {
                console.error('Failed to load cached report:', e);
                document.getElementById('report-title').innerText = 'Error Loading Article';
                document.getElementById('report-body').innerHTML = '<p class="prose-text">Failed to retrieve the article. Please try again.</p>';
            }
        }

        // Common function to render report data
        function renderReportData(data, isDynamic = false) {
            // Hide any visible deep dive tooltip when loading new content
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            switchView('view-report');
            document.getElementById('report-title').innerText = data.title;
            document.getElementById('report-body').innerHTML = data.content;

            // Detect dynamic articles by checking for chartConfigs or chartType='dynamic'
            const hasDynamicCharts = data.chartConfigs && Object.keys(data.chartConfigs).length > 0;
            const isActuallyDynamic = isDynamic || hasDynamicCharts || data.chartType === 'dynamic';

            // Store dynamic citation database for hover/click handlers
            if (isActuallyDynamic && data.citationDatabase) {
                window.dynamicCitationDatabase = data.citationDatabase;
            }

            // Sort sources by score (highest first)
            const allSources = (data.sources || []).sort((a, b) => (b.score || 0) - (a.score || 0));

            // Split into tabs of 4 sources each
            const tabNames = ['Primary', 'Secondary', 'Tertiary', 'Quaternary'];
            const tabCTAs = [
                'These are the most credible sources for this topic',
                'Supporting evidence from trusted outlets',
                'Additional context and perspectives',
                'Extended research materials'
            ];
            const sourceGroups = [];
            for (let i = 0; i < allSources.length; i += 4) {
                sourceGroups.push(allSources.slice(i, i + 4));
            }

            // === SOURCES FIRST BANNER - TABBED VERSION ===
            const sourcesFirstContainer = document.getElementById('sources-first-container');
            if (allSources.length > 0) {
                // Build tab buttons
                const tabsHTML = sourceGroups.map((group, idx) => {
                    const tabName = tabNames[idx] || `Set ${idx + 1}`;
                    return `
                        <button class="sources-tab ${idx === 0 ? 'active' : ''}" data-tab="${idx}">
                            ${tabName}<span class="tab-count">${group.length}</span>
                        </button>
                    `;
                }).join('');

                // Build tab panels
                const panelsHTML = sourceGroups.map((group, groupIdx) => {
                    const cardsHTML = group.map((s, idx) => {
                        const scoreClass = s.score >= 90 ? 'high' : s.score >= 70 ? 'medium' : 'low';
                        const domain = s.url ? new URL(s.url).hostname.replace('www.', '') : 'Source';
                        const globalRank = groupIdx * 4 + idx + 1;
                        return `
                            <div class="top-source-card" ${s.url ? `onclick="window.open('${s.url}', '_blank')"` : ''}>
                                <div class="top-source-rank">#${globalRank}</div>
                                <div class="top-source-domain">${domain}</div>
                                <div class="top-source-title">${s.name}</div>
                                <div class="top-source-score">
                                    <div class="top-source-score-bar">
                                        <div class="top-source-score-fill ${scoreClass}" style="width: ${s.score}%"></div>
                                    </div>
                                    <span class="top-source-score-value">${s.score}%</span>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const ctaText = tabCTAs[groupIdx] || 'Explore these sources';

                    return `
                        <div class="sources-tab-panel ${groupIdx === 0 ? 'active' : ''}" data-panel="${groupIdx}">
                            <div class="sources-first-grid">${cardsHTML}</div>
                            <div class="tab-cta">
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                                <span>${ctaText}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                sourcesFirstContainer.innerHTML = `
                    <div class="sources-first-banner" id="sources-banner">
                        <div class="sources-first-content" id="sources-content">
                            <div class="sources-first-inner">
                                <div class="sources-first-header">
                                    <div class="sources-first-title-group">
                                        <div class="sources-first-title">
                                            <i data-lucide="shield-check" class="w-5 h-5 shield-icon"></i>
                                            <h3>Sources First</h3>
                                        </div>
                                    </div>
                                    <button class="sources-minimize-btn" onclick="toggleSourcesBanner()" title="Minimize sources panel (S)">
                                        <i data-lucide="chevron-up" class="w-4 h-4"></i>
                                        <span>Minimize</span>
                                    </button>
                                </div>
                                <p class="sources-first-byline">We encourage you to verify with primary sources before reading AI analysis.</p>
                                <div class="sources-tabs">${tabsHTML}</div>
                                <div class="sources-tab-panels">${panelsHTML}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Show navbar sources button with count
                updateNavSourcesButton(true, allSources.length);

                // Add tab switching functionality
                setTimeout(() => {
                    document.querySelectorAll('.sources-tab').forEach(tab => {
                        tab.addEventListener('click', function() {
                            const tabIdx = this.dataset.tab;
                            switchToSourcesTab(tabIdx);
                        });
                    });

                    // Add trackpad/touch swipe gesture support
                    initSourcesSwipeGestures();
                }, 50);
            } else {
                sourcesFirstContainer.innerHTML = '';
            }

            // Sidebar now shows summary only (sources are in tabs above)
            const sourceContainer = document.getElementById('report-sources');
            if (allSources.length > 0) {
                sourceContainer.innerHTML = `
                    <p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic; text-align: center; padding: 1rem;">
                        <i data-lucide="info" class="w-4 h-4" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>
                        All ${allSources.length} sources are displayed in the Sources First panel above.
                    </p>
                `;
            } else {
                sourceContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">No sources available.</p>';
            }

            // Re-init icons for the new elements
            lucide.createIcons();

            // Critical: Wait for DOM to fully render, then initialize charts
            // Use multiple requestAnimationFrame calls to ensure paint completes
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        // For dynamic articles with chartConfigs, render them
                        if (isActuallyDynamic && data.chartConfigs) {
                            console.log('[Charts] Rendering dynamic charts for article, chartConfigs:', Object.keys(data.chartConfigs));
                            const chartsRendered = renderDynamicCharts(data.chartConfigs);

                            // If charts didn't render (canvases not found), retry after longer delay
                            if (!chartsRendered) {
                                console.log('[Charts] First attempt failed, retrying in 300ms...');
                                setTimeout(() => {
                                    renderDynamicCharts(data.chartConfigs);
                                }, 300);
                            }
                        } else if (data.chartType && data.chartType !== 'dynamic') {
                            // For pre-defined articles with specific chart types
                            renderCharts(data.chartType);
                        }
                        initLivingNumbers(); // Re-run observer for new elements
                        initDeepDiveTooltips(); // Add hover tooltips to deep dive buttons
                    }, 150);
                });
            });
        }

        // Initialize deep dive hover tooltips with a single global tooltip
        let deepDiveTooltipEl = null;

        function initDeepDiveTooltips() {
            // Create global tooltip element if it doesn't exist
            if (!deepDiveTooltipEl) {
                deepDiveTooltipEl = document.createElement('div');
                deepDiveTooltipEl.className = 'deep-dive-tooltip';
                deepDiveTooltipEl.innerHTML = `
                    <div class="tooltip-context"></div>
                    <div class="tooltip-action">
                        <span class="tooltip-rabbit">ðŸ‡</span>
                        <span>Go Down the Rabbit Hole</span>
                    </div>
                    <div class="tooltip-cost" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); font-size: 0.75rem;"></div>
                `;
                document.body.appendChild(deepDiveTooltipEl);

                // Hide tooltip on mouseleave from buttons
                document.body.addEventListener('mouseover', (e) => {
                    // If mouse is not over a fig-deep-dive button and not over the tooltip itself, hide it
                    if (!e.target.closest('.fig-deep-dive') && !e.target.closest('.deep-dive-tooltip')) {
                        deepDiveTooltipEl.classList.remove('visible');
                    }
                });

                // Also hide on scroll and click anywhere
                document.addEventListener('scroll', () => {
                    deepDiveTooltipEl.classList.remove('visible');
                }, true);

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.fig-deep-dive')) {
                        deepDiveTooltipEl.classList.remove('visible');
                    }
                });
            }

            // Add hover listeners to all deep dive buttons
            document.querySelectorAll('.fig-deep-dive').forEach(element => {
                // Skip if already initialized
                if (element.dataset.tooltipInit) return;
                element.dataset.tooltipInit = 'true';

                element.addEventListener('mouseenter', (e) => {
                    // Get context from parent figure caption
                    const figCaption = element.closest('.fig-caption');
                    const figureTitle = figCaption ? figCaption.textContent.replace('DEEP DIVE', '').trim().replace(/^Fig\s*\d+\.\s*/i, '') : 'this topic';

                    // Update tooltip content
                    const contextEl = deepDiveTooltipEl.querySelector('.tooltip-context');
                    const costEl = deepDiveTooltipEl.querySelector('.tooltip-cost');

                    contextEl.innerHTML = `Explore the data behind <strong>${figureTitle}</strong> with an AI-generated deep analysis.`;

                    // Show free/cost indicator
                    const isFree = userRemainingDives > 0;
                    if (isFree) {
                        costEl.innerHTML = `<span style="color: #10b981;">âœ“ FREE</span> <span style="color: var(--text-muted);">(${userRemainingDives} remaining today)</span>`;
                    } else {
                        costEl.innerHTML = `<span style="color: #f59e0b;">âš ï¸ Uses token</span>`;
                    }

                    // Position tooltip above the button
                    const rect = element.getBoundingClientRect();
                    let x = rect.left + (rect.width / 2) - 140; // Center tooltip (280px / 2)
                    let y = rect.top - 10;

                    // Boundary checks
                    if (x < 10) x = 10;
                    if (x + 280 > window.innerWidth - 10) x = window.innerWidth - 290;

                    deepDiveTooltipEl.style.left = x + 'px';
                    deepDiveTooltipEl.style.bottom = (window.innerHeight - y) + 'px';
                    deepDiveTooltipEl.style.top = 'auto';
                    deepDiveTooltipEl.classList.add('visible');
                });
            });
        }

        // --- 3. CHART RENDERER (Safe Mode) ---
        let activeCharts = [];

        function getChartTextColor() {
            const theme = document.documentElement.getAttribute('data-theme') || 'midnight';
            // Light themes need dark text
            const lightThemes = ['light', 'sand', 'mint'];
            return lightThemes.includes(theme) ? '#1e293b' : '#e8edf5';
        }

        function getThemeChartColors() {
            const theme = document.documentElement.getAttribute('data-theme') || 'midnight';
            const colorSchemes = {
                midnight: {
                    primary: '#000096', secondary: '#4a9d7c', tertiary: '#e57373',
                    quaternary: '#9575cd', muted: '#546e7a', accent: '#d4a574',
                    palette: ['#000096', '#4a9d7c', '#e57373', '#9575cd', '#546e7a', '#d4a574']
                },
                ocean: {
                    primary: '#3d8bd4', secondary: '#2dd4bf', tertiary: '#f472b6',
                    quaternary: '#60a5fa', muted: '#7ca0c4', accent: '#fbbf24',
                    palette: ['#3d8bd4', '#2dd4bf', '#f472b6', '#60a5fa', '#7ca0c4', '#fbbf24']
                },
                forest: {
                    primary: '#10b981', secondary: '#34d399', tertiary: '#fbbf24',
                    quaternary: '#4ade80', muted: '#7cb09a', accent: '#84cc16',
                    palette: ['#10b981', '#34d399', '#fbbf24', '#4ade80', '#7cb09a', '#84cc16']
                },
                ember: {
                    primary: '#f97316', secondary: '#ef4444', tertiary: '#fbbf24',
                    quaternary: '#fb923c', muted: '#c49080', accent: '#84cc16',
                    palette: ['#f97316', '#ef4444', '#fbbf24', '#fb923c', '#c49080', '#84cc16']
                },
                violet: {
                    primary: '#a855f7', secondary: '#c084fc', tertiary: '#22d3ee',
                    quaternary: '#f472b6', muted: '#a090c4', accent: '#fbbf24',
                    palette: ['#a855f7', '#c084fc', '#22d3ee', '#f472b6', '#a090c4', '#fbbf24']
                },
                slate: {
                    primary: '#64748b', secondary: '#6ee7b7', tertiary: '#fcd34d',
                    quaternary: '#94a3b8', muted: '#8b8f96', accent: '#f472b6',
                    palette: ['#64748b', '#6ee7b7', '#fcd34d', '#94a3b8', '#8b8f96', '#f472b6']
                },
                espresso: {
                    primary: '#c9a227', secondary: '#7c9a5e', tertiary: '#c45c3e',
                    quaternary: '#8b6750', muted: '#5a4a3a', accent: '#d4a574',
                    palette: ['#c9a227', '#7c9a5e', '#c45c3e', '#8b6750', '#5a4a3a', '#d4a574']
                },
                rose: {
                    primary: '#ec4899', secondary: '#f472b6', tertiary: '#34d399',
                    quaternary: '#fbbf24', muted: '#c4809a', accent: '#a855f7',
                    palette: ['#ec4899', '#f472b6', '#34d399', '#fbbf24', '#c4809a', '#a855f7']
                },
                cyan: {
                    primary: '#14b8a6', secondary: '#2dd4bf', tertiary: '#fbbf24',
                    quaternary: '#22d3ee', muted: '#70c4b8', accent: '#a855f7',
                    palette: ['#14b8a6', '#2dd4bf', '#fbbf24', '#22d3ee', '#70c4b8', '#a855f7']
                },
                light: {
                    primary: '#3b82f6', secondary: '#22c55e', tertiary: '#ef4444',
                    quaternary: '#8b5cf6', muted: '#64748b', accent: '#f59e0b',
                    palette: ['#3b82f6', '#22c55e', '#ef4444', '#8b5cf6', '#64748b', '#f59e0b']
                },
                sand: {
                    primary: '#b8860b', secondary: '#6b8e23', tertiary: '#cd853f',
                    quaternary: '#daa520', muted: '#7a6f5c', accent: '#8b4513',
                    palette: ['#b8860b', '#6b8e23', '#cd853f', '#daa520', '#7a6f5c', '#8b4513']
                },
                mint: {
                    primary: '#16a34a', secondary: '#22c55e', tertiary: '#eab308',
                    quaternary: '#4ade80', muted: '#4d7c5f', accent: '#0ea5e9',
                    palette: ['#16a34a', '#22c55e', '#eab308', '#4ade80', '#4d7c5f', '#0ea5e9']
                },
                kristie: {
                    primary: '#1e3a5f', secondary: '#a8e6cf', tertiary: '#ffd3b6',
                    quaternary: '#2c4a7c', muted: '#b8b8b8', accent: '#152840',
                    palette: ['#1e3a5f', '#a8e6cf', '#ffd3b6', '#2c4a7c', '#b8b8b8', '#152840']
                },
                aurora: {
                    primary: '#88c0d0', secondary: '#a3be8c', tertiary: '#ebcb8b',
                    quaternary: '#81a1c1', muted: '#5e81ac', accent: '#bf616a',
                    palette: ['#88c0d0', '#a3be8c', '#ebcb8b', '#81a1c1', '#5e81ac', '#bf616a']
                },
                cherry: {
                    primary: '#dc5050', secondary: '#50dc80', tertiary: '#dcb050',
                    quaternary: '#dc50a0', muted: '#d09090', accent: '#50dcdc',
                    palette: ['#dc5050', '#50dc80', '#dcb050', '#dc50a0', '#d09090', '#50dcdc']
                },
                cobalt: {
                    primary: '#0096ff', secondary: '#00ff96', tertiary: '#ffcc00',
                    quaternary: '#00b4ff', muted: '#80b3e0', accent: '#ff6b00',
                    palette: ['#0096ff', '#00ff96', '#ffcc00', '#00b4ff', '#80b3e0', '#ff6b00']
                }
            };
            return colorSchemes[theme] || colorSchemes.midnight;
        }

        function renderCharts(type) {
            // Cleanup old charts
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            const chartTextColor = getChartTextColor();
            const colors = getThemeChartColors();
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: true, ticks: { color: chartTextColor } }, y: { display: true, ticks: { color: chartTextColor } } } };

            if (type === 'ai') {
                const ctx1 = document.getElementById('chart_capex');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar', // Changed to Bar for better comparison
                        data: {
                            labels: ['Capex Spend', 'Revenue Gap'],
                            datasets: [
                                {
                                    label: 'Billions USD',
                                    data: [1000, 600],
                                    backgroundColor: [colors.tertiary, colors.primary],
                                    barPercentage: 0.5
                                }
                            ]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                title: { display: true, text: 'The Imbalance (2024)', color: chartTextColor }
                            }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_allocation');
                if (ctx2) {
                    // Changing from Doughnut to Line Chart showing Value Decay
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Year 1', 'Year 2', 'Year 3', 'Year 4', 'Year 5', 'Year 6'],
                            datasets: [
                                {
                                    label: 'Traditional Server Value',
                                    data: [100, 85, 70, 55, 40, 25],
                                    borderColor: colors.secondary,
                                    borderWidth: 2,
                                    tension: 0.4
                                },
                                {
                                    label: 'AI GPU Value',
                                    data: [100, 60, 30, 10, 0, 0],
                                    borderColor: colors.tertiary,
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                title: { display: true, text: 'Depreciation Curves', color: chartTextColor }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: '% Original Value' } }
                            }
                        }
                    }));
                }
                // Fig 3: Energy Demand Chart
                const ctx3 = document.getElementById('chart_energy_demand');
                if (ctx3) {
                    activeCharts.push(new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['2022', '2024', '2026 (Projected)'],
                            datasets: [{
                                label: 'Data Center Energy (TWh)',
                                data: [460, 650, 1000],
                                backgroundColor: [colors.secondary, colors.primary, colors.tertiary],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                title: { display: true, text: 'Global Data Center Energy Demand', color: chartTextColor }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'TWh' }, ticks: { color: chartTextColor } },
                                x: { ticks: { color: chartTextColor } }
                            }
                        }
                    }));
                }
                const plotDiv = document.getElementById('plotlyForceChart');
                if (plotDiv) {
                    Plotly.newPlot(plotDiv, [{ x: [1, 2, 3], y: [50, 80, 120], text: ['Railroad', 'Dot-Com', 'AI'], mode: 'markers+text', marker: { size: [40, 70, 110], color: [colors.muted, colors.primary, colors.tertiary], opacity: 0.9 }, textposition: 'bottom center', textfont: { color: chartTextColor, size: 14 }, type: 'scatter', hoverinfo: 'none' }], { paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', xaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [0.5, 3.5] }, yaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [20, 150] }, margin: { l: 0, r: 0, b: 20, t: 0 }, hovermode: false }, { displayModeBar: false });
                }
            } else if (type === 'congress') {
                const ctx1 = document.getElementById('chart_returns');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['House Dems', 'Republicans', 'S&P 500'],
                            datasets: [{
                                label: '2024 Returns (%)',
                                data: [31, 26, 25],
                                backgroundColor: [colors.primary, colors.tertiary, colors.secondary],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Alpha Gap (2024)', color: chartTextColor } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_sectors');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: ['Technology', 'Financials', 'Energy', 'Healthcare', 'Other'],
                            datasets: [{
                                data: [40, 20, 15, 15, 10], // Representative weighting based on NANC/KRUZ
                                backgroundColor: ['#c9a227', '#7c9a5e', '#c45c3e', '#8b6750', '#5a4a3a'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            cutout: '70%',
                            plugins: { title: { display: true, text: 'Portfolio Composition Bias', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'grift') {
                const ctx1 = document.getElementById('chart_spending');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'pie',
                        data: {
                            labels: ['Political Contributions', 'Lifestyle/Travel', 'Consulting/Admin'],
                            datasets: [{
                                data: [45, 35, 20], // Based on Issue One ~45% stat
                                backgroundColor: ['#7c9a5e', '#c45c3e', '#d4a574'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Leadership PAC Spending', color: chartTextColor } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_zombies');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: ['Sen. Shelby', 'R. Blumenauer', 'P. McHenry'],
                            datasets: [{
                                label: 'Cash on Hand (Millions)',
                                data: [16, 5, 4], // Representative zombie hoards
                                backgroundColor: ['#8b6750', '#5a4a3a', '#5a4a3a'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Top Zombie Accounts (2024)', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'regulatory') {
                const ctx1 = document.getElementById('chart_revolving');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['2001-2010 (POGO Study)'],
                            datasets: [{
                                label: 'Former Officials Lobbying SEC',
                                data: [419],
                                backgroundColor: ['#c45c3e'],
                                barThickness: 50
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Revolving Door Scale', color: chartTextColor } },
                            scales: { y: { beginAtZero: true } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_fines');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: ['Revenue (2023)', 'EU Antitrust Fine'],
                            datasets: [{
                                label: 'Amount ($ Billions)',
                                data: [307, 2.7],
                                backgroundColor: ['#7c9a5e', '#c45c3e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            indexAxis: 'y',
                            plugins: { title: { display: true, text: 'Google: Fine vs Revenue', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'energy') {
                const ctx1 = document.getElementById('chart_energy');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: ['2022 (Actual)', '2026 (IEA Forecast)'],
                            datasets: [{
                                label: 'Global Data Center Demand (TWh)',
                                data: [460, 800],
                                backgroundColor: ['#5a4a3a', '#c45c3e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Doubling of Demand', color: chartTextColor } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_transformers');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['2021', '2022', '2023', '2024'],
                            datasets: [{
                                label: 'Lead Time (Weeks)',
                                data: [50, 80, 100, 120], // Wood Mackenzie trend
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.2)',
                                fill: true,
                                tension: 0.3
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Transformer Supply Chain Crisis', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'model') {
                const ctx1 = document.getElementById('chart_data_wall');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: ['2022', '2024', '2026', '2028'],
                            datasets: [
                                {
                                    label: 'Human Data Stock',
                                    data: [100, 100, 95, 90], // Relatively flat
                                    borderColor: '#7c9a5e',
                                    borderDash: [5, 5]
                                },
                                {
                                    label: 'AI Consumption',
                                    data: [10, 40, 100, 250], // Exponential
                                    borderColor: '#c45c3e',
                                    fill: true,
                                    backgroundColor: 'rgba(196, 92, 62, 0.1)'
                                }
                            ]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'The Data Wall (Intersection 2026)', color: chartTextColor } },
                            scales: { y: { display: false } }
                        }
                    }));
                }
                const ctx2 = document.getElementById('chart_collapse');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Gen 1 (Human)', 'Gen 2', 'Gen 3', 'Gen 4', 'Gen 5 (Collapse)'],
                            datasets: [{
                                label: 'Model Quality/Perplexity',
                                data: [100, 85, 60, 30, 5],
                                borderColor: '#8b6750',
                                backgroundColor: 'rgba(139, 103, 80, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Recursive Quality Decay', color: chartTextColor } }
                        }
                    }));
                }
            } else if (type === 'semiconductor') {
                // Chart 1: Global Foundry Market Share
                const ctx1 = document.getElementById('chart_tsmc_share');
                if (ctx1) {
                    activeCharts.push(new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['TSMC', 'Samsung', 'GlobalFoundries', 'UMC', 'SMIC', 'Others'],
                            datasets: [{
                                data: [64, 11, 6, 6, 6, 7],
                                backgroundColor: ['#c9a227', '#c45c3e', '#7c9a5e', '#d4a574', '#8b6750', '#5a4a3a'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            cutout: '60%',
                            plugins: { title: { display: true, text: 'Foundry Market Share 2024', color: chartTextColor } }
                        }
                    }));
                }
                // Chart 2: Nvidia Market Cap Growth
                const ctx2 = document.getElementById('chart_nvidia_mcap');
                if (ctx2) {
                    activeCharts.push(new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: ['Jan 23', 'Jun 23', 'Jan 24', 'Jun 24', 'Dec 24'],
                            datasets: [{
                                label: 'Market Cap ($T)',
                                data: [0.4, 1.0, 1.5, 3.0, 4.5],
                                borderColor: '#7c9a5e',
                                backgroundColor: 'rgba(124, 154, 94, 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'Nvidia: The $4T Rocket', color: chartTextColor } },
                            scales: { y: { beginAtZero: true } }
                        }
                    }));
                }
                // Chart 3: Advanced Packaging Capacity
                const ctx3 = document.getElementById('chart_packaging');
                if (ctx3) {
                    activeCharts.push(new Chart(ctx3, {
                        type: 'bar',
                        data: {
                            labels: ['2024', '2025', '2026'],
                            datasets: [{
                                label: 'CoWoS Wafers/Month (K)',
                                data: [35, 70, 90],
                                backgroundColor: ['#5a4a3a', '#c9a227', '#7c9a5e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: { title: { display: true, text: 'TSMC Packaging Capacity Ramp', color: chartTextColor } }
                        }
                    }));
                }
            }
        }

        // Render charts from AI-generated article chartConfigs
        // Returns true if at least one chart was rendered, false otherwise
        function renderDynamicCharts(chartConfigs) {
            console.log('[Charts] renderDynamicCharts called with:', chartConfigs);

            // Cleanup old charts
            activeCharts.forEach(c => c.destroy());
            activeCharts = [];

            if (!chartConfigs || Object.keys(chartConfigs).length === 0) {
                console.log('[Charts] No chartConfigs provided');
                return false;
            }

            let chartsRendered = 0;
            const chartKeys = Object.keys(chartConfigs);

            const chartTextColor = getChartTextColor();
            const themeColors = getThemeChartColors();
            const defaultColors = themeColors.palette.concat([themeColors.accent, themeColors.muted]);

            // Get all canvases in the report body that haven't been used yet
            const reportBody = document.getElementById('report-body');
            const allCanvases = reportBody ? Array.from(reportBody.querySelectorAll('canvas')) : [];
            const usedCanvases = new Set();
            let fallbackIndex = 0;

            for (const [chartId, config] of Object.entries(chartConfigs)) {
                console.log('[Charts] Looking for canvas with id:', chartId);
                let canvas = document.getElementById(chartId);

                // If canvas not found by exact ID, try fallback to next available canvas
                if (!canvas) {
                    console.log('[Charts] Canvas NOT found for:', chartId);
                    console.log('[Charts] Available canvases:', allCanvases.map(c => c.id || '(no id)'));

                    // Find next unused canvas in the report body
                    while (fallbackIndex < allCanvases.length) {
                        const candidate = allCanvases[fallbackIndex];
                        if (!usedCanvases.has(candidate)) {
                            canvas = candidate;
                            usedCanvases.add(candidate);
                            console.log('[Charts] Using fallback canvas:', canvas.id || `(index ${fallbackIndex})`);
                            fallbackIndex++;
                            break;
                        }
                        fallbackIndex++;
                    }

                    if (!canvas) {
                        console.log('[Charts] No fallback canvas available for:', chartId);
                        continue;
                    }
                } else {
                    usedCanvases.add(canvas);
                }

                console.log('[Charts] Canvas found/assigned for:', chartId);

                const chartType = config.type || 'bar';
                const data = config.data || {};
                const labels = data.labels || [];
                const values = data.values || [];
                const colors = data.colors || defaultColors.slice(0, values.length);

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: config.title || '',
                        data: values,
                        backgroundColor: chartType === 'line' ? colors[0] + '33' : colors,
                        borderColor: chartType === 'line' ? colors[0] : colors,
                        borderWidth: chartType === 'line' ? 2 : 0,
                        fill: chartType === 'line',
                        tension: 0.4
                    }]
                };

                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: !!config.title,
                            text: config.title || '',
                            color: chartTextColor
                        }
                    },
                    scales: chartType === 'doughnut' || chartType === 'radar' ? {} : {
                        x: { display: true, ticks: { color: chartTextColor } },
                        y: { display: true, ticks: { color: chartTextColor }, beginAtZero: true }
                    }
                };

                if (chartType === 'doughnut') {
                    options.cutout = '60%';
                }

                try {
                    activeCharts.push(new Chart(canvas, {
                        type: chartType,
                        data: chartData,
                        options: options
                    }));
                    chartsRendered++;
                    console.log('[Charts] Successfully rendered chart:', chartId);
                } catch (e) {
                    console.error('Failed to render chart:', chartId, e);
                }
            }

            console.log(`[Charts] Rendered ${chartsRendered}/${chartKeys.length} charts`);
            return chartsRendered > 0;
        }

        // --- 4. FRACTAL CONTEXT LOGIC ---
        function expandContext(element, id, nextTopic) {
            if (element.nextElementSibling && element.nextElementSibling.classList.contains('fractal-context')) {
                element.nextElementSibling.remove();
                return;
            }

            const contextData = {
                'goldman_analysis': `<strong>CONTEXT:</strong> While Goldman's economists predict a possible 9% GDP boost, their Head of Equity Research warns that "bubbles take a long time to burst," citing that AI lacks a "killer app" to justify the $1T spend. <br><br> <button class="rabbit-hole-btn" onclick="loadReport('regulatory_capture')">ðŸ‡ Rabbit Hole: Market Bubbles</button>`,
                'sequoia_math': `<strong>CONTEXT:</strong> The "revenue hole" grew from $125B in 2023 to $600B in 2024. This suggests infrastructure is being built for future demand that has not yet materialized in software sales.`,
                'eight_trillion': `<strong>CONTEXT:</strong> The $8T figure extrapolates the cost of 100GW of planned capacity at ~$80B per gigawatt. <br><br> <button class="rabbit-hole-btn" onclick="loadReport('energy_crisis')">ðŸ‡ Rabbit Hole: The Energy Crisis</button>`,
                'obsolescence': `<strong>CONTEXT:</strong> While traditional servers last 7 years, AI GPUs burn out or become economically obsolete in 3-5 years. This "Depreciation Bomb" destroys profit margins. <br><br> <button class="rabbit-hole-btn" onclick="loadReport('model_collapse')">ðŸ‡ Rabbit Hole: Silicon Limits</button>`,
                'solow_paradox': `<strong>CONTEXT:</strong> The Solow Paradox states that we see the computer age everywhere but in the productivity statistics. AI has yet to break this trend.`,
                'pac_slush': `<strong>CONTEXT:</strong> Leadership PACs were created in 1978 for travel expenses. Today, the FEC is "deadlocked" on whether personal use bans apply to them, effectively legalizing their use for luxury perks.`,
                'three_mile_island': `<strong>CONTEXT:</strong> Microsoft is paying >$100/MWh (double the market rate) to restart the TMI nuclear reactor. This "behind-the-meter" deal bypasses the public grid entirely.`,
                'mad_disorder': `<strong>CONTEXT:</strong> MAD occurs when models train on synthetic data. They lose "variance" (creativity) and converge on the "median," erasing low-probability knowledge forever.`,
                'cost_of_business': `<strong>CONTEXT:</strong> A $2.7B fine for a company earning $307B is just 0.8% of revenue. In comparison, a speeding ticket is often a higher % of an average person's income.`,
                'gelsinger_exit': `<strong>CONTEXT:</strong> Pat Gelsinger was forced out December 1, 2024 after Intel's stock cratered 62% under his watch. His ambitious "IDM 2.0" strategy to compete with TSMC as a foundry failed spectacularly, with the foundry division losing $7B+ annually. CFO David Zinsner and Intel Products CEO MJ Holthaus now serve as interim co-CEOs. <br><br> <button class="rabbit-hole-btn" onclick="loadReport('ai_bubble')">ðŸ‡ Rabbit Hole: The AI Infrastructure Bubble</button>`,
                'chips_act': `<strong>CONTEXT:</strong> The CHIPS and Science Act allocated $52.7B for semiconductor manufacturing: $39B for fab incentives, $13.2B for R&D, plus a 25% investment tax credit. Despite this, Arizona construction has stalledâ€”five suppliers to Intel and TSMC have postponed projects citing labor shortages. Commerce Secretary Raimondo has floated "CHIPS Act 2.0" for packaging. <br><br> <button class="rabbit-hole-btn" onclick="loadReport('regulatory_capture')">ðŸ‡ Rabbit Hole: When Government Money Meets Industry</button>`
            };

            const div = document.createElement('div');
            div.className = 'fractal-context';
            let content = contextData[id] || "Retrieving verified context...";

            // Auto-inject Rabbit Hole Generator if not present
            if (!content.includes('rabbit-hole-btn')) {
                const triggerText = element.innerText; // e.g., "Leadership PACs"
                content += `<br><br> <button class="rabbit-hole-btn" onclick="generateReport('${triggerText.replace(/'/g, "\\'")}')">ðŸ‡ Rabbit Hole: Deep Dive on ${triggerText}</button>`;
            }

            div.innerHTML = content;
            element.parentNode.insertBefore(div, element.nextSibling);
            setTimeout(() => div.classList.add('open'), 10);
        }

        // --- 5. INTELLIGENCE CARD SYSTEM ---

        // Granular Source Database
        const citationDatabase = {
            'goldman_trillion': {
                domain: 'GOLDMANSACHS.COM',
                score: 98,
                title: 'Gen AI: Too Much Spend?',
                snippet: 'Tech Giants and utilities set to invest $1 Trillion in AI Capex over coming years.',
                url: 'https://www.goldmansachs.com/intelligence/pages/gen-ai-too-much-spend-too-little-benefit.html'
            },
            'covello_skeptic': {
                domain: 'GOLDMANSACHS.COM',
                score: 98,
                title: 'Jim Covello Analysis',
                snippet: 'Covello argues AI technology is "exceptionally expensive" and lacks a "killer app" to justify costs.',
                url: 'https://www.goldmansachs.com/intelligence/pages/gen-ai-too-much-spend-too-little-benefit.html'
            },
            'sequoia_gap': {
                domain: 'SEQUOIACAP.COM',
                score: 99,
                title: "AI's $600B Question",
                snippet: 'The revenue gap between AI infrastructure spend and revenue has widened to $600B annually as of June 2024.',
                url: 'https://www.sequoiacap.com/article/ais-600b-question/'
            },
            'sequoia_method': {
                domain: 'SEQUOIACAP.COM',
                score: 99,
                title: 'Revenue Math Methodology',
                snippet: 'Calculation doubles Nvidia run-rate for TCO, then doubles again for 50% end-user margins.',
                url: 'https://www.sequoiacap.com/article/ais-600b-question/'
            },
            'aws_lifespan': {
                domain: 'AWS.AMAZON.COM',
                score: 100,
                title: 'AWS Strategy Update',
                snippet: 'AWS officially extended the useful life of its servers from 5 years to 6 years in 2024.',
                url: 'https://aws.amazon.com/blogs/aws/'
            },
            'nvidia_perf': {
                domain: 'NVIDIA.COM',
                score: 100,
                title: 'Blackwell B100 Specs',
                snippet: 'B100 delivers 2.5x the performance of H100 for AI training workloads.',
                url: 'https://www.nvidia.com/en-us/data-center/technologies/blackwell-architecture/'
            },
            'iea_demand': {
                domain: 'IEA.ORG',
                score: 96,
                title: 'Electricity 2024 Report',
                snippet: 'Global data center electricity consumption projected to reach 1000 TWh by 2026.',
                url: 'https://www.iea.org/reports/electricity-2024'
            },
            'tmi_deal': {
                domain: 'CONSTELLATION.COM',
                score: 100,
                title: 'Crane Clean Energy Center',
                snippet: 'Constellation & Microsoft sign 20-year PPA to restart Three Mile Island Unit 1.',
                url: 'https://www.constellationenergy.com/newsroom/2024/Constellation-to-Launch-Crane-Clean-Energy-Center-Restoring-Jobs-and-Carbon-Free-Power-to-the-Grid.html'
            },
            'tmi_cost': {
                domain: 'BLOOMBERG.COM',
                score: 92,
                title: 'Nuclear Premum Pricing',
                snippet: 'Analysts estimate deal pricing at >$100/MWh, significantly above renewable market rates.',
                url: 'https://www.bloomberg.com/news/articles/2024-09-20/microsoft-s-three-mile-island-deal-is-the-largest-clean-power-agreement-yet'
            },
            'gen_ai_revenue': {
                domain: 'GRANDVIEWRESEARCH.COM',
                score: 85,
                title: 'Market Size 2024',
                snippet: 'Estimates for 2024 Generative AI revenue range from $16B to $67B, well under the $100B mark.',
                url: 'https://www.grandviewresearch.com/industry-analysis/generative-ai-market-report'
            },
            // Semiconductor Wars citations
            'tsmc_share': {
                domain: 'VISIONOFHUMANITY.ORG',
                score: 97,
                title: 'Taiwan Semiconductor Dependency',
                snippet: 'TSMC global market share rose to 64%, up from 60% prior year, driven by AI chip demand.',
                url: 'https://www.visionofhumanity.org/global-tech-dependence-on-taiwan-semiconductors/'
            },
            'intel_loss': {
                domain: 'CNBC.COM',
                score: 98,
                title: 'Intel Q3 2024 Losses',
                snippet: 'Around $7B in restructuring charges contributed to a staggering $19B net loss in first 9 months of 2024.',
                url: 'https://www.cnbc.com/2024/11/01/intel-q3-earnings-report-2024.html'
            },
            'taiwan_dominance': {
                domain: 'GLOBALTAIWAN.ORG',
                score: 96,
                title: 'Taiwan Chip Manufacturing',
                snippet: 'Over 60% of world semiconductors, and almost 90% of most sophisticated chips, are made in Taiwan.',
                url: 'https://globaltaiwan.org/2024/01/taiwan-semiconductor-industry/'
            },
            'cutting_edge': {
                domain: 'SCIENCEDIRECT.COM',
                score: 99,
                title: 'TSMC Advanced Nodes',
                snippet: 'In cutting-edge nodes (5nm, 3nm), TSMC market share exceeds 90%. Only Samsung competes.',
                url: 'https://www.sciencedirect.com/science/article/pii/S0048969723066347'
            },
            'iep_cost': {
                domain: 'VISIONOFHUMANITY.ORG',
                score: 97,
                title: 'Taiwan Conflict Economic Cost',
                snippet: 'IEP estimates full-scale Taiwan conflict could result in $10 trillion loss to global economy.',
                url: 'https://www.visionofhumanity.org/global-tech-dependence-on-taiwan-semiconductors/'
            },
            'intel_foundry': {
                domain: 'CNBC.COM',
                score: 98,
                title: 'Intel Foundry Operating Loss',
                snippet: 'Intel foundry business recorded $7B operating loss in 2023 on sales of $18.9B.',
                url: 'https://www.cnbc.com/2024/04/02/intel-foundry-lost-7-billion-from-operations-last-year.html'
            },
            'intel_stock': {
                domain: 'CNN.COM',
                score: 99,
                title: 'Intel Stock Collapse',
                snippet: 'Intel stock fell 62% under Gelsinger, market cap fell below $100B for first time since 2012.',
                url: 'https://www.cnn.com/2024/12/02/tech/intel-ceo-pat-gelsinger-retires/index.html'
            },
            'nvidia_mcap': {
                domain: 'CNBC.COM',
                score: 100,
                title: 'Nvidia $4 Trillion Milestone',
                snippet: 'Nvidia passed $4 trillion market capâ€”the only publicly traded company to ever reach that mark.',
                url: 'https://www.cnbc.com/2024/11/05/nvidia-hits-record-high-4-trillion-market-cap.html'
            },
            'nvidia_revenue': {
                domain: 'STATISTA.COM',
                score: 99,
                title: 'Nvidia Data Center Revenue',
                snippet: 'Data center revenue exploded 216% YoY, reaching $47.5B in fiscal 2024.',
                url: 'https://www.statista.com/statistics/716573/nvidia-data-center-revenue/'
            },
            'msft_chips': {
                domain: 'PCGAMER.COM',
                score: 95,
                title: 'Microsoft H100 Purchases',
                snippet: 'Microsoft purchased 485,000 Hopper AI chips in 2024â€”twice as many as nearest competitor Meta.',
                url: 'https://www.pcgamer.com/hardware/microsoft-bought-485000-nvidia-ai-chips-this-year-which-is-twice-as-many-as-meta/'
            },
            'tsmc_arizona': {
                domain: 'Z2DATA.COM',
                score: 96,
                title: 'TSMC Arizona Delays',
                snippet: 'TSMC $40B Arizona fab suffered multiple delays. Facilities likely not operational until 2028.',
                url: 'https://www.z2data.com/insights/tsmc-arizona-fab-construction-delays'
            },
            'tsmc_packaging': {
                domain: 'SUPPLYFRAME.COM',
                score: 97,
                title: 'TSMC Packaging Bottleneck',
                snippet: 'TSMC Chairman: "It is not shortage of AI chips, it is the shortage of our packaging capacity."',
                url: 'https://www.supplyframe.com/resources/commodity-iq/tsmc-advanced-packaging-bottleneck'
            },
            'cowos_capacity': {
                domain: 'DELOITTE.COM',
                score: 99,
                title: 'CoWoS Capacity Expansion',
                snippet: 'TSMC CoWoS capacity: 35K wpm (2024) â†’ 70K (2025) â†’ 90K by end of 2026. 157% increase.',
                url: 'https://www2.deloitte.com/us/en/insights/industry/technology/technology-media-and-telecom-predictions/2025/semiconductor-advanced-packaging.html'
            },
            'china_self': {
                domain: 'CFR.ORG',
                score: 98,
                title: 'China Chip Self-Sufficiency',
                snippet: 'China at ~16% chip self-sufficiency despite targeting 70% by 2025. Still imports $400B+ annually.',
                url: 'https://www.cfr.org/backgrounder/china-taiwan-relations-tension-us-policy'
            }
        };

        // Init Lucide
        lucide.createIcons();
        initReceipts();
        initRefLinks();
        renderTrendingSection();

        // === PERIODIC LOGO ATTENTION ANIMATION ===
        // Soft roll every 24-36 seconds when on portal view (half as often, much gentler)
        function startLogoAttention() {
            const triggerAttention = () => {
                const logo = document.getElementById('portal-logo');
                const portalView = document.getElementById('view-portal');
                // Only animate if portal view is visible
                if (logo && portalView && portalView.classList.contains('active')) {
                    logo.classList.add('anim-attention');
                    // Remove class after animation completes (1.2s duration)
                    setTimeout(() => logo.classList.remove('anim-attention'), 1200);
                }
                // Schedule next animation at random interval (24-36 seconds - half as often)
                const nextDelay = 24000 + Math.random() * 12000;
                setTimeout(triggerAttention, nextDelay);
            };
            // Start first animation after 15 seconds (more patience)
            setTimeout(triggerAttention, 15000);
        }
        startLogoAttention();

        // === TYPEWRITER CURSOR CLEANUP ===
        // Remove blinking cursor after typewriter animation completes
        setTimeout(() => {
            const typewriter = document.querySelector('.typewriter');
            if (typewriter) typewriter.classList.add('done');
        }, 4500); // 4s typing + 0.5s buffer

        // === DYNAMIC TRENDING SECTION ===
        function renderTrendingSection() {
            const featuredContainer = document.getElementById('trending-featured');
            const moreContainer = document.getElementById('trending-more');

            if (!featuredContainer) return;

            // Get all reports with card metadata
            const allArticles = [];
            for (const [key, report] of Object.entries(reports)) {
                if (report.cardTitle) {
                    allArticles.push({
                        key,
                        title: report.cardTitle,
                        tag: report.cardTag || 'INVESTIGATION',
                        tagColor: report.cardTagColor || 'text-blue-700',
                        description: report.cardDescription || ''
                    });
                }
            }

            // Also fetch cached articles from server
            fetch('/api/cache/list')
                .then(res => res.json())
                .then(data => {
                    // Add cached articles that aren't already in reports or allArticles
                    if (data.articles) {
                        // Helper to normalize titles for comparison
                        const normalizeTitle = (title) => (title || '').toLowerCase().replace(/[^a-z0-9]/g, '');

                        // Get existing titles for dedup
                        const existingTitles = new Set(allArticles.map(a => normalizeTitle(a.title)));
                        const existingKeys = new Set(allArticles.map(a => a.key));

                        data.articles.forEach(article => {
                            const articleTitle = article.title || article.topic || 'Untitled';
                            const normalizedTitle = normalizeTitle(articleTitle);

                            // Skip if key already exists, title is duplicate, or in reports
                            if (reports[article.key] || existingKeys.has(article.key) || existingTitles.has(normalizedTitle)) {
                                console.log('[Portal] Skipping duplicate:', article.key, articleTitle.substring(0, 40));
                                return;
                            }

                            existingKeys.add(article.key);
                            existingTitles.add(normalizedTitle);

                            allArticles.push({
                                key: article.key,
                                title: articleTitle,
                                tag: article.parent_key ? 'DEEP DIVE' : 'INVESTIGATION',
                                tagColor: article.parent_key ? 'text-purple-400' : 'text-blue-400',
                                description: article.topic || '',
                                isCached: true,
                                parentKey: article.parent_key || '',
                                parentTitle: article.parent_title || ''
                            });
                        });
                    }
                    renderArticleCards(allArticles, featuredContainer, moreContainer);
                })
                .catch(() => {
                    // If fetch fails, just render local articles
                    renderArticleCards(allArticles, featuredContainer, moreContainer);
                });
        }

        function renderArticleCards(articles, featuredContainer, moreContainer) {
            // Helper to get sources for an article
            function getArticleSources(key) {
                const report = reports[key];
                if (!report || !report.sources) return [];
                return report.sources.slice(0, 3);
            }

            // Helper to render sources column
            function renderSources(sources) {
                if (!sources || sources.length === 0) {
                    return `<div class="card-sources">
                        <div class="source-item"><span class="source-dot high"></span>Reuters</div>
                        <div class="source-item"><span class="source-dot high"></span>AP News</div>
                    </div>`;
                }
                return `<div class="card-sources">
                    ${sources.map(s => {
                        const score = s.score || 80;
                        const level = score >= 85 ? 'high' : score >= 70 ? 'medium' : 'low';
                        const name = s.name || s.domain || 'Source';
                        return `<div class="source-item"><span class="source-dot ${level}"></span>${name.substring(0, 12)}</div>`;
                    }).join('')}
                </div>`;
            }

            // Split: top 4 get graduated sizes, 5th+ goes to browse list
            const mainCards = articles.slice(0, 4);
            const browseList = articles.slice(4);

            // Render main cards with 2-column layout (content left, sources right)
            featuredContainer.innerHTML = mainCards.map((article, i) => {
                const sources = getArticleSources(article.key);
                const parentLink = article.parentKey ? `
                    <div class="parent-link" onclick="event.stopPropagation(); loadReport('${article.parentKey}')" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; cursor: pointer;">
                        <span style="color: var(--accent-purple); opacity: 0.7;">&#8627;</span>
                        From: <span style="color: var(--accent-blue); text-decoration: underline;">${article.parentTitle || 'Parent Article'}</span>
                    </div>
                ` : '';
                return `
                <div onclick="loadReport('${article.key}')" class="trending-card trending-card-${i + 1} anim-fade-up anim-delay-${4 + i}">
                    <div class="card-inner">
                        <div class="card-content">
                            <div class="text-xs font-mono ${article.tagColor} mb-2">${article.tag}</div>
                            <h3 class="font-bold mb-1" style="color: var(--text-main);">${article.title}</h3>
                            <p style="color: var(--text-muted);">${article.description}</p>
                            ${parentLink}
                        </div>
                        ${renderSources(sources)}
                    </div>
                </div>`;
            }).join('');

            // Render browse list (5th card and beyond) - compact list style
            if (browseList.length > 0) {
                moreContainer.innerHTML = `
                    <div class="browse-more-header anim-fade-up anim-delay-8">Browse More</div>
                    ${browseList.map((article, i) => `
                        <div onclick="loadReport('${article.key}')" class="trending-card-list anim-fade-up" style="animation-delay: ${0.9 + i * 0.1}s;">
                            <div class="card-tag font-mono ${article.tagColor}">${article.tag}</div>
                            <h4 style="color: var(--text-main);">${article.title}</h4>
                            ${article.parentKey ? `
                                <div class="parent-link" onclick="event.stopPropagation(); loadReport('${article.parentKey}')" style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; cursor: pointer;">
                                    <span style="color: var(--accent-purple); opacity: 0.7;">&#8627;</span>
                                    From: <span style="color: var(--accent-blue); text-decoration: underline;">${article.parentTitle || 'Parent Article'}</span>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                `;
                moreContainer.style.display = 'flex';
                moreContainer.style.flexDirection = 'column';
                moreContainer.style.gap = '0.5rem';
            } else {
                moreContainer.style.display = 'none';
            }
        }

        function initReceipts() {
            // Create the Intelligence Card Element
            const card = document.createElement('div');
            card.className = 'intelligence-card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="source-domain">LOADING...</span>
                    <span class="trust-score">0%</span>
                </div>
                <div class="card-title"></div>
                <div class="card-snippet"></div>
            `;
            document.body.appendChild(card);

            const domainEl = card.querySelector('.source-domain');
            const scoreEl = card.querySelector('.trust-score');
            const titleEl = card.querySelector('.card-title');
            const snippetEl = card.querySelector('.card-snippet');

            // Helper to get citation data from global or dynamic database
            function getCitationData(id) {
                // Check global database first
                if (citationDatabase[id]) return citationDatabase[id];
                // Then check dynamic database (for AI-generated articles)
                if (window.dynamicCitationDatabase && window.dynamicCitationDatabase[id]) {
                    const d = window.dynamicCitationDatabase[id];
                    // Normalize trustScore to score
                    return { ...d, score: d.score || d.trustScore };
                }
                return null;
            }

            // Event Delegation
            document.body.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('citation-spade')) {
                    const id = e.target.getAttribute('data-id');
                    const data = getCitationData(id);

                    if (data) {
                        domainEl.innerText = data.domain;
                        scoreEl.innerText = (data.score || data.trustScore) + '% VERIFIED';
                        titleEl.innerText = data.title;
                        snippetEl.innerText = data.snippet;

                        // Color Logic
                        scoreEl.className = 'trust-score'; // reset
                        const score = data.score || data.trustScore;
                        if (score >= 95) scoreEl.classList.add('trust-high');
                        else scoreEl.classList.add('trust-med');

                        card.classList.add('visible');
                    }
                }
            });

            document.body.addEventListener('mousemove', (e) => {
                if (card.classList.contains('visible')) {
                    // Offset from mouse
                    let x = e.clientX + 20;
                    let y = e.clientY + 20;

                    // Boundary checks
                    if (x + 320 > window.innerWidth) x = e.clientX - 340;
                    if (y + 150 > window.innerHeight) y = e.clientY - 150;

                    card.style.left = x + 'px';
                    card.style.top = y + 'px';
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('citation-spade')) {
                    card.classList.remove('visible');
                }
            });

            // Click handler for citation spades - opens source URL
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('citation-spade')) {
                    const id = e.target.getAttribute('data-id');
                    const data = getCitationData(id);

                    if (data && data.url) {
                        // Open URL in new tab with referrer
                        window.open(data.url, '_blank', 'noopener');
                    } else if (data && data.domain) {
                        // Fallback: construct a search URL from domain and title
                        const searchQuery = encodeURIComponent(`${data.title} site:${data.domain.toLowerCase()}`);
                        window.open(`https://www.google.com/search?q=${searchQuery}`, '_blank', 'noopener');
                    }
                }
            });

            // === FRACTAL TRIGGER TOOLTIP ===
            const fractalTooltip = document.createElement('div');
            fractalTooltip.className = 'fractal-tooltip';
            fractalTooltip.innerHTML = `
                <div class="fractal-tooltip-header">
                    <span class="fractal-tooltip-title"></span>
                    <span class="fractal-tooltip-action"></span>
                </div>
                <div class="fractal-tooltip-content"></div>
                <div class="fractal-tooltip-cost" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(59, 130, 246, 0.2); font-size: 10px;"></div>
            `;
            document.body.appendChild(fractalTooltip);

            const fractalTitleEl = fractalTooltip.querySelector('.fractal-tooltip-title');
            const fractalContentEl = fractalTooltip.querySelector('.fractal-tooltip-content');
            const fractalActionEl = fractalTooltip.querySelector('.fractal-tooltip-action');
            const fractalCostEl = fractalTooltip.querySelector('.fractal-tooltip-cost');

            // Helper to get context data
            function getContextData(key) {
                const currentReport = reports[currentArticleKey];
                if (currentReport?.contextData?.[key]) return currentReport.contextData[key];
                if (window.dynamicContextData?.[key]) return window.dynamicContextData[key];
                return null;
            }

            // Fractal trigger hover
            document.body.addEventListener('mouseover', (e) => {
                if (e.target.classList.contains('fractal-trigger')) {
                    const onclickAttr = e.target.getAttribute('onclick');
                    const keyMatch = onclickAttr?.match(/expandContext\(this,\s*'([^']+)'\)/);
                    const key = keyMatch ? keyMatch[1] : null;
                    const termText = e.target.textContent.trim();

                    const contextData = key ? getContextData(key) : null;

                    fractalTitleEl.textContent = termText;
                    if (contextData && contextData.expanded) {
                        fractalContentEl.textContent = contextData.expanded.substring(0, 200) + (contextData.expanded.length > 200 ? '...' : '');
                        fractalActionEl.textContent = 'Click to explore';
                    } else {
                        fractalContentEl.textContent = 'Click to generate a deep dive on this topic';
                        fractalActionEl.textContent = 'Generate';
                    }

                    // Show free/cost indicator
                    const isFree = userRemainingDives > 0;
                    if (isFree) {
                        fractalCostEl.innerHTML = `<span style="color: #10b981;">âœ“ FREE</span> <span style="color: var(--text-muted);">(${userRemainingDives} remaining today)</span>`;
                    } else {
                        fractalCostEl.innerHTML = `<span style="color: #f59e0b;">âš ï¸ Uses token</span> <span style="color: var(--text-muted);">(daily limit reached)</span>`;
                    }

                    fractalTooltip.classList.add('visible');
                }
            });

            document.body.addEventListener('mousemove', (e) => {
                if (fractalTooltip.classList.contains('visible')) {
                    let x = e.clientX + 15;
                    let y = e.clientY + 15;

                    // Boundary checks
                    if (x + 300 > window.innerWidth) x = e.clientX - 315;
                    if (y + 120 > window.innerHeight) y = e.clientY - 130;

                    fractalTooltip.style.left = x + 'px';
                    fractalTooltip.style.top = y + 'px';
                }
            });

            document.body.addEventListener('mouseout', (e) => {
                if (e.target.classList.contains('fractal-trigger')) {
                    fractalTooltip.classList.remove('visible');
                }
            });

            // Init Living Numbers Observer
            initLivingNumbers();
        }

        function initLivingNumbers() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const target = parseInt(el.getAttribute('data-target'));
                        const suffix = el.getAttribute('data-suffix');
                        const prefix = suffix.startsWith('$') ? '' : (el.innerText.includes('$') ? '$' : ''); // Try to keep existing prefix logic or simple
                        // Actually, let's just use raw counting logic
                        let current = 0;
                        const duration = 1500; // ms
                        const stepTime = 20;
                        const steps = duration / stepTime;
                        const increment = target / steps;

                        const timer = setInterval(() => {
                            current += increment;
                            if (current >= target) {
                                current = target;
                                clearInterval(timer);
                            }
                            // Formatter
                            let display = Math.floor(current);
                            if (el.innerText.includes('$') || suffix === 'B') display = '$' + display; // simple hack for now

                            el.innerText = display + suffix;
                        }, stepTime);

                        observer.unobserve(el);
                    }
                });
            }, { threshold: 0.5 });

            document.querySelectorAll('.living-number').forEach(el => observer.observe(el));
        }

        // Add ?ref=GenuVerity to all external links
        function initRefLinks() {
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link && link.hostname !== window.location.hostname && !link.href.includes('ref=')) {
                    e.preventDefault();
                    const url = new URL(link.href);
                    url.searchParams.set('ref', 'GenuVerity');
                    window.open(url.toString(), '_blank');
                }
            });
        }

        // --- 6. GENAI INTEGRATION (LOCAL) ---

        // Extract chartConfigs from partial JSON - critical for timeout recovery
        function extractChartConfigs(text) {
            const charts = {};

            // Look for chartConfigs section - now comes BEFORE content
            const chartSection = text.match(/"chartConfigs"\s*:\s*\{([\s\S]*?)\}\s*,\s*"(?:contextData|citationDatabase|sources|content)"/);
            if (!chartSection) return charts;

            const section = chartSection[1];

            // Extract individual chart definitions
            const chartPattern = /"(chart_\w+)"\s*:\s*(\{[^}]*"type"\s*:\s*"[^"]+"\s*,[^}]*"data"\s*:\s*\{[^}]*\}[^}]*\})/g;
            let match;

            while ((match = chartPattern.exec(section)) !== null) {
                const chartId = match[1];
                const chartJson = match[2];
                try {
                    charts[chartId] = JSON.parse(chartJson);
                    console.log('Extracted chart:', chartId);
                } catch (e) {
                    // Manual extraction fallback
                    const typeMatch = chartJson.match(/"type"\s*:\s*"([^"]+)"/);
                    const titleMatch = chartJson.match(/"title"\s*:\s*"([^"]+)"/);
                    const labelsMatch = chartJson.match(/"labels"\s*:\s*\[([^\]]+)\]/);
                    const valuesMatch = chartJson.match(/"values"\s*:\s*\[([^\]]+)\]/);
                    const colorsMatch = chartJson.match(/"colors"\s*:\s*\[([^\]]+)\]/);

                    if (typeMatch && labelsMatch && valuesMatch) {
                        try {
                            charts[chartId] = {
                                type: typeMatch[1],
                                data: {
                                    labels: JSON.parse('[' + labelsMatch[1] + ']'),
                                    values: JSON.parse('[' + valuesMatch[1] + ']'),
                                    colors: colorsMatch ? JSON.parse('[' + colorsMatch[1] + ']') : ['#3b82f6']
                                },
                                title: titleMatch ? titleMatch[1] : 'Chart'
                            };
                            console.log('Manually extracted chart:', chartId);
                        } catch (e2) {}
                    }
                }
            }

            return charts;
        }

        // Client-side JSON repair for truncated responses (global scope)
        function repairTruncatedJSON(text) {
            if (!text || typeof text !== 'string') return null;

            text = text.trim();

            // Remove markdown fences
            if (text.startsWith('```json')) text = text.slice(7);
            if (text.startsWith('```')) text = text.slice(3);
            if (text.endsWith('```')) text = text.slice(0, -3);
            text = text.trim();

            // Try parsing as-is first
            try {
                return JSON.parse(text);
            } catch (e) {}

            // Count unclosed braces/brackets
            let openBraces = 0, openBrackets = 0;
            let inString = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"' && (i === 0 || text[i-1] !== '\\')) {
                    inString = !inString;
                }
                if (!inString) {
                    if (c === '{') openBraces++;
                    else if (c === '}') openBraces--;
                    else if (c === '[') openBrackets++;
                    else if (c === ']') openBrackets--;
                }
            }

            // Close string if needed
            let repaired = text;
            if (inString) repaired += '"';

            // Close brackets then braces
            repaired += ']'.repeat(Math.max(0, openBrackets));
            repaired += '}'.repeat(Math.max(0, openBraces));

            try {
                const data = JSON.parse(repaired);
                console.log('JSON repair successful');
                data._partial = true;
                return data;
            } catch (e) {
                console.log('JSON repair failed:', e);
            }

            // Last resort: extract key fields with regex - PRESERVE CHARTS!
            try {
                const keyMatch = text.match(/"key"\s*:\s*"([^"]+)"/);
                const titleMatch = text.match(/"title"\s*:\s*"([^"]+)"/);
                const cardTitleMatch = text.match(/"cardTitle"\s*:\s*"([^"]+)"/);
                const cardTagMatch = text.match(/"cardTag"\s*:\s*"([^"]+)"/);
                const cardDescMatch = text.match(/"cardDescription"\s*:\s*"([^"]+)"/);

                if (keyMatch && titleMatch) {
                    // CRITICAL: Extract chartConfigs even from truncated JSON
                    const chartConfigs = extractChartConfigs(text);
                    console.log('Extracted', Object.keys(chartConfigs).length, 'charts from truncated JSON');

                    // Extract content - it comes AFTER chartConfigs now
                    const contentMatch = text.match(/"content"\s*:\s*"([\s\S]*?)(?:"\s*[,}]|$)/);
                    let content = contentMatch ? contentMatch[1] : '<p class="prose-text">Article content was truncated. The charts and data are preserved.</p>';

                    // Unescape content
                    content = content.replace(/\\"/g, '"').replace(/\\n/g, '\n');

                    return {
                        key: keyMatch[1],
                        title: titleMatch[1],
                        cardTitle: cardTitleMatch ? cardTitleMatch[1] : titleMatch[1].substring(0, 50),
                        cardTag: cardTagMatch ? cardTagMatch[1] : 'INVESTIGATION',
                        cardDescription: cardDescMatch ? cardDescMatch[1] : '',
                        content: content,
                        chartConfigs: chartConfigs,  // PRESERVE CHARTS!
                        contextData: {},
                        citationDatabase: {},
                        sources: [],
                        _partial: true
                    };
                }
            } catch (e) {
                console.log('Regex extraction failed:', e);
            }

            return null;
        }

        // Progress update helper
        function updateProgress(stage, percent, message) {
            // Update subtitle
            const subtitle = document.getElementById('loader-subtitle');
            if (subtitle) subtitle.textContent = message;

            // Update progress bar
            const progressBar = document.getElementById('loader-progress-bar');
            if (progressBar) progressBar.style.width = percent + '%';

            // Update percent display
            const percentDisplay = document.getElementById('loader-percent');
            if (percentDisplay) percentDisplay.textContent = percent + '%';

            // Map backend stages to UI elements
            const stageMap = {
                'init': 'status-init',
                'connect': 'status-connect',
                'research': 'status-research',
                'title': 'status-writing',
                'writing': 'status-writing',
                'analysis': 'status-analysis',
                'deep': 'status-analysis',
                'charts': 'status-charts',
                'sources': 'status-sources',
                'complete': 'status-complete'
            };

            // Reset all stages
            document.querySelectorAll('#loader-status-stages .status-item').forEach(el => {
                el.classList.remove('active', 'done');
            });

            // Mark completed stages
            const stageOrder = ['init', 'connect', 'research', 'writing', 'analysis', 'charts', 'sources', 'complete'];
            const currentIdx = stageOrder.indexOf(stage === 'title' ? 'writing' : (stage === 'deep' ? 'analysis' : stage));

            stageOrder.forEach((s, idx) => {
                const elId = 'status-' + s;
                const el = document.getElementById(elId);
                if (el) {
                    if (idx < currentIdx) {
                        el.classList.add('done');
                    } else if (idx === currentIdx) {
                        el.classList.add('active');
                    }
                }
            });
        }

        // Reset progress UI
        function resetProgressUI() {
            document.querySelectorAll('#loader-status-stages .status-item').forEach(el => {
                el.classList.remove('active', 'done');
            });
            const progressBar = document.getElementById('loader-progress-bar');
            if (progressBar) progressBar.style.width = '0%';
            const percentDisplay = document.getElementById('loader-percent');
            if (percentDisplay) percentDisplay.textContent = '0%';
        }

        async function generateReport(initialTopic = null) {
            let topic = initialTopic;
            if (!topic) {
                topic = prompt("Enter a topic for the GenuVerity Intelligence Engine:");
            }
            if (!topic) return;

            // Visual feedback on search box button
            const searchBtn = document.querySelector('#generate-search-box button');
            const searchInput = document.getElementById('generate-input');
            const originalBtnContent = searchBtn ? searchBtn.innerHTML : '';
            if (searchBtn) {
                searchBtn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
                searchBtn.disabled = true;
                lucide.createIcons();
            }
            if (searchInput) {
                searchInput.disabled = true;
                searchInput.placeholder = 'Generating investigation...';
            }

            // Show the loader
            const loader = document.getElementById('deep-dive-loader');
            if (loader) {
                loader.style.display = 'flex';
                document.getElementById('loader-title').textContent = `Investigating: ${topic}`;
                resetProgressUI();
            }

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || "Generation failed");
                }

                // Handle SSE streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let articleContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });

                    // Process complete SSE events
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    let currentEvent = null;
                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7);
                        } else if (line.startsWith('data: ') && currentEvent) {
                            const data = JSON.parse(line.slice(6));

                            if (currentEvent === 'progress') {
                                updateProgress(data.stage, data.percent, data.message);
                            } else if (currentEvent === 'content') {
                                articleContent = data;
                            } else if (currentEvent === 'error') {
                                throw new Error(data);
                            }
                            currentEvent = null;
                        }
                    }
                }

                // Parse the article content (use repair function for robustness)
                let cleanText = articleContent.trim();
                if (cleanText.startsWith('```json')) cleanText = cleanText.slice(7);
                if (cleanText.startsWith('```')) cleanText = cleanText.slice(3);
                if (cleanText.endsWith('```')) cleanText = cleanText.slice(0, -3);
                cleanText = cleanText.trim();

                // Try direct parse first, fall back to repair function
                let data;
                try {
                    data = JSON.parse(cleanText);
                } catch (parseErr) {
                    console.log('Direct JSON parse failed, attempting repair:', parseErr.message);
                    data = repairTruncatedJSON(cleanText);
                    if (!data) {
                        throw new Error('Failed to parse response. The article may have been truncated due to timeout.');
                    }
                }

                // API returns the report directly with key, title, content, etc.
                const key = data.key || topic.toLowerCase().replace(/\s+/g, '_').slice(0, 20);
                reports[key] = data;

                // Hide loader and open report
                if (loader) loader.style.display = 'none';
                loadReport(key);

            } catch (e) {
                if (loader) loader.style.display = 'none';
                alert("Generation Error: " + e.message);
            } finally {
                // Restore search box state
                if (searchBtn) {
                    searchBtn.innerHTML = originalBtnContent;
                    searchBtn.disabled = false;
                }
                if (searchInput) {
                    searchInput.disabled = false;
                    searchInput.placeholder = 'What do you want to investigate?';
                }
                lucide.createIcons();
            }
        }

        // Trigger generate from search box
        function triggerGenerate() {
            const input = document.getElementById('generate-input');
            const topic = input?.value?.trim();
            if (topic) {
                generateReport(topic);
                input.value = '';
            }
        }

        // Initialize - start on portal view (no default report load)

        // ============================================
        // PHASE 1: QUICK WINS FEATURES
        // ============================================

        // === DARK/LIGHT THEME SYSTEM ===
        let currentArticleKey = 'congress_trading';

        function initTheme() {
            const saved = localStorage.getItem('genuverity-theme');
            // If user has explicit preference, use it
            // Otherwise, check system preference, defaulting to dark
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else {
                // Let CSS media query handle system preference
                // Only set explicit theme if user has dark preference on a light-preferring system
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                // Light mode handled by CSS media query
            }
            // Re-initialize lucide icons to ensure theme toggle icons render
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('genuverity-theme', theme);

            // Re-render charts with new theme colors
            if (currentArticleKey && reports[currentArticleKey]) {
                renderCharts(reports[currentArticleKey].chartType);
            }

            // Re-initialize lucide icons for theme toggle
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Toggle between dark and light mode
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            // If no explicit theme or dark, switch to light
            // If light, switch to dark
            const newTheme = (current === 'light') ? 'dark' : 'light';
            setTheme(newTheme);
        }

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only auto-switch if user hasn't set explicit preference
            if (!localStorage.getItem('genuverity-theme')) {
                if (e.matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }
        });

        // === SOURCES TAB SWIPE GESTURES ===
        // Supports Mac trackpad horizontal swipes and touch swipes on mobile

        // Switch to a specific sources tab by index
        function switchToSourcesTab(tabIdx) {
            const tabs = document.querySelectorAll('.sources-tab');
            const panels = document.querySelectorAll('.sources-tab-panel');
            if (tabs.length === 0) return;

            // Clamp to valid range
            tabIdx = Math.max(0, Math.min(parseInt(tabIdx), tabs.length - 1));

            // Update active tab
            tabs.forEach(t => t.classList.remove('active'));
            tabs[tabIdx].classList.add('active');

            // Update active panel
            panels.forEach(p => p.classList.remove('active'));
            const targetPanel = document.querySelector(`.sources-tab-panel[data-panel="${tabIdx}"]`);
            if (targetPanel) targetPanel.classList.add('active');
        }

        // Get current active tab index
        function getCurrentSourcesTabIndex() {
            const activeTab = document.querySelector('.sources-tab.active');
            return activeTab ? parseInt(activeTab.dataset.tab) : 0;
        }

        // Get total number of sources tabs
        function getSourcesTabCount() {
            return document.querySelectorAll('.sources-tab').length;
        }

        // Initialize swipe gesture handlers
        function initSourcesSwipeGestures() {
            const panelsContainer = document.querySelector('.sources-tab-panels');
            if (!panelsContainer) return;

            // === TRACKPAD SWIPE (Mac/Windows) ===
            // Uses wheel event with deltaX for horizontal scrolling
            let accumulatedDeltaX = 0;
            let wheelTimeout = null;
            const SWIPE_THRESHOLD = 50; // Accumulated pixels needed to trigger tab switch

            panelsContainer.addEventListener('wheel', (e) => {
                // Only respond to horizontal scroll (trackpad two-finger swipe)
                if (Math.abs(e.deltaX) > Math.abs(e.deltaY) && Math.abs(e.deltaX) > 2) {
                    e.preventDefault();

                    accumulatedDeltaX += e.deltaX;

                    // Clear existing timeout
                    if (wheelTimeout) clearTimeout(wheelTimeout);

                    // Check if threshold reached
                    if (Math.abs(accumulatedDeltaX) >= SWIPE_THRESHOLD) {
                        const currentIdx = getCurrentSourcesTabIndex();
                        const totalTabs = getSourcesTabCount();

                        if (accumulatedDeltaX > 0 && currentIdx < totalTabs - 1) {
                            // Swiped left -> go to next tab
                            switchToSourcesTab(currentIdx + 1);
                        } else if (accumulatedDeltaX < 0 && currentIdx > 0) {
                            // Swiped right -> go to previous tab
                            switchToSourcesTab(currentIdx - 1);
                        }

                        accumulatedDeltaX = 0;
                    }

                    // Reset accumulator after a pause in scrolling
                    wheelTimeout = setTimeout(() => {
                        accumulatedDeltaX = 0;
                    }, 150);
                }
            }, { passive: false });

            // === TOUCH SWIPE (Mobile/Tablet) ===
            let touchStartX = 0;
            let touchStartY = 0;
            let isSwiping = false;
            const TOUCH_THRESHOLD = 50;

            panelsContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false;
            }, { passive: true });

            panelsContainer.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;

                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchStartX - touchX;
                const deltaY = touchStartY - touchY;

                // Only swipe horizontally if it's primarily a horizontal gesture
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 10) {
                    isSwiping = true;
                    e.preventDefault();
                }
            }, { passive: false });

            panelsContainer.addEventListener('touchend', (e) => {
                if (!isSwiping) {
                    touchStartX = 0;
                    return;
                }

                const touchEndX = e.changedTouches[0].clientX;
                const deltaX = touchStartX - touchEndX;

                if (Math.abs(deltaX) >= TOUCH_THRESHOLD) {
                    const currentIdx = getCurrentSourcesTabIndex();
                    const totalTabs = getSourcesTabCount();

                    if (deltaX > 0 && currentIdx < totalTabs - 1) {
                        // Swiped left -> go to next tab
                        switchToSourcesTab(currentIdx + 1);
                    } else if (deltaX < 0 && currentIdx > 0) {
                        // Swiped right -> go to previous tab
                        switchToSourcesTab(currentIdx - 1);
                    }
                }

                touchStartX = 0;
                isSwiping = false;
            }, { passive: true });
        }

        // --- MARKDOWN EXPORT ---
        async function exportToMarkdown() {
            const title = document.getElementById('report-title').innerText;
            const content = document.getElementById('report-body');
            const filename = 'GenuVerity_' + title.replace(/[^a-z0-9]/gi, '_').substring(0, 50) + '.md';

            // Convert HTML to Markdown
            let markdown = `# ${title}\n\n`;
            markdown += `*Generated by GenuVerity on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}*\n\n---\n\n`;

            // Clone content to manipulate
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;

            // Remove chart canvases and figure containers (keep captions)
            tempDiv.querySelectorAll('canvas').forEach(el => el.remove());

            // Process the HTML to markdown
            let htmlContent = tempDiv.innerHTML;

            // Convert headers
            htmlContent = htmlContent.replace(/<h2[^>]*class="prose-h2"[^>]*>(.*?)<\/h2>/gi, '\n## $1\n\n');

            // Convert highlight-glow to bold
            htmlContent = htmlContent.replace(/<span[^>]*class="highlight-glow"[^>]*>(.*?)<\/span>/gi, '**$1**');

            // Convert living numbers (get the data-target value)
            htmlContent = htmlContent.replace(/<span[^>]*class="living-number"[^>]*data-target="([^"]*)"[^>]*data-suffix="([^"]*)"[^>]*>[^<]*<\/span>/gi, '**$1$2**');

            // Convert fractal triggers to bold
            htmlContent = htmlContent.replace(/<strong[^>]*class="fractal-trigger"[^>]*>(.*?)<\/strong>/gi, '**$1**');

            // Convert citation spades to reference markers
            htmlContent = htmlContent.replace(/<span[^>]*class="citation-spade"[^>]*data-id="([^"]*)"[^>]*>[^<]*<\/span>/gi, '[^$1]');

            // Convert figure captions
            htmlContent = htmlContent.replace(/<div[^>]*class="fig-caption"[^>]*>(.*?)<\/div>/gi, '\n*$1*\n');

            // Remove float-figure divs but keep inner content
            htmlContent = htmlContent.replace(/<div[^>]*class="float-figure[^"]*"[^>]*>/gi, '\n');

            // Convert paragraphs
            htmlContent = htmlContent.replace(/<p[^>]*class="prose-text"[^>]*>(.*?)<\/p>/gi, '$1\n\n');

            // Convert remaining strong/bold
            htmlContent = htmlContent.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            htmlContent = htmlContent.replace(/<b>(.*?)<\/b>/gi, '**$1**');

            // Convert em/italic
            htmlContent = htmlContent.replace(/<em>(.*?)<\/em>/gi, '*$1*');
            htmlContent = htmlContent.replace(/<i>(.*?)<\/i>/gi, '*$1*');

            // Remove remaining HTML tags
            htmlContent = htmlContent.replace(/<[^>]+>/g, '');

            // Clean up whitespace
            htmlContent = htmlContent.replace(/\n{3,}/g, '\n\n');
            htmlContent = htmlContent.replace(/&nbsp;/g, ' ');
            htmlContent = htmlContent.replace(/&amp;/g, '&');
            htmlContent = htmlContent.replace(/&lt;/g, '<');
            htmlContent = htmlContent.replace(/&gt;/g, '>');
            htmlContent = htmlContent.replace(/&quot;/g, '"');

            markdown += htmlContent.trim();

            // Add sources section
            const currentReport = reports[currentArticleKey];
            if (currentReport?.sources?.length) {
                markdown += '\n\n---\n\n## Sources\n\n';
                currentReport.sources.forEach(s => {
                    if (s.url) {
                        markdown += `- [${s.name}](${s.url}) (Trust Score: ${s.score}%)\n`;
                    } else {
                        markdown += `- ${s.name} (Trust Score: ${s.score}%)\n`;
                    }
                });
            }

            // Download the file with better cross-browser support
            const blob = new Blob([markdown], { type: 'text/plain;charset=utf-8' });

            // Try using the modern File System Access API first
            if (window.showSaveFilePicker) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'Markdown Files',
                            accept: { 'text/markdown': ['.md'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    return;
                } catch (err) {
                    // User cancelled or API failed, fall through to legacy method
                    if (err.name !== 'AbortError') console.log('Save picker failed, using fallback');
                }
            }

            // Fallback: create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            a.target = '_self';
            document.body.appendChild(a);

            // Use setTimeout to ensure the click is processed
            setTimeout(() => {
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }, 0);
        }

        // --- PDF EXPORT (IMPROVED) ---
        function exportToPDF() {
            const content = document.getElementById('report-body');
            const title = document.getElementById('report-title').innerText;
            const filename = 'GenuVerity_' + title.replace(/[^a-z0-9]/gi, '_').substring(0, 50) + '.pdf';

            // Show loading state
            const btn = document.querySelector('[onclick="exportToPDF()"]');
            const originalHTML = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Exporting...';
                btn.disabled = true;
            }

            // Get sources for the footer
            const currentReport = reports[currentArticleKey];
            const sourcesHTML = currentReport?.sources?.map(s =>
                `<div style="margin: 4px 0; font-size: 9px; color: #888;">â€¢ ${s.name} (Trust: ${s.score}%)</div>`
            ).join('') || '';

            // Clone and prepare content for PDF
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="padding: 40px; background: #ffffff; color: #1a1a1a; font-family: 'Georgia', serif; line-height: 1.6;">
                    <!-- Header -->
                    <div style="border-bottom: 3px solid #8b6914; padding-bottom: 24px; margin-bottom: 32px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-size: 11px; color: #8b6914; font-weight: 700; letter-spacing: 2px; text-transform: uppercase;">GENUVERITY INTELLIGENCE REPORT</div>
                            <div style="font-size: 10px; color: #666;">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        </div>
                        <h1 style="font-size: 32px; font-weight: 700; margin: 0; color: #111; line-height: 1.2;">${title}</h1>
                    </div>

                    <!-- Content -->
                    <div class="pdf-body" style="font-size: 11pt; color: #333;">
                        ${content.innerHTML
                            .replace(/style="[^"]*color:[^"]*"/gi, '')
                            .replace(/class="highlight-glow"/g, 'style="font-weight: bold; background: #f5e6d3; padding: 2px 6px; border-radius: 3px;"')
                            .replace(/class="living-number"/g, 'style="font-family: monospace; color: #8b6914; font-weight: bold;"')
                            .replace(/class="prose-h2"/g, 'style="font-size: 18pt; font-weight: bold; color: #111; margin-top: 28px; margin-bottom: 16px; border-bottom: 1px solid #ddd; padding-bottom: 8px;"')
                            .replace(/class="prose-text"/g, 'style="margin-bottom: 16px; text-align: justify; color: #333;"')
                            .replace(/class="float-figure[^"]*"/g, 'style="margin: 20px 0; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;"')
                            .replace(/class="fig-caption"/g, 'style="font-size: 9pt; color: #666; text-align: center; margin-top: 8px; font-style: italic;"')
                            .replace(/class="citation-spade"/g, 'style="color: #8b6914; font-size: 8pt; vertical-align: super;"')
                            .replace(/class="fractal-trigger"[^>]*/g, 'style="font-weight: bold; color: #6b5020;"')
                        }
                    </div>

                    <!-- Sources Footer -->
                    <div style="margin-top: 48px; padding-top: 24px; border-top: 2px solid #e2e8f0;">
                        <div style="font-size: 10px; font-weight: 700; color: #666; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Sources & Methodology</div>
                        ${sourcesHTML}
                    </div>

                    <!-- Footer -->
                    <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #eee; display: flex; justify-content: space-between; font-size: 8px; color: #999;">
                        <span>Generated by GenuVerity Intelligence Platform</span>
                        <span>genuverity.com</span>
                    </div>
                </div>
            `;

            const opt = {
                margin: [0.4, 0.4, 0.6, 0.4],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    letterRendering: true
                },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            html2pdf().set(opt).from(pdfContent).save().then(() => {
                if (btn) {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            });
        }

        // === DEEP DIVE GENERATION ===
        let deepDiveAbortController = null;
        let statusAnimationInterval = null;

        // Animate status indicators during deep dive generation
        function startStatusAnimation() {
            const stages = ['status-init', 'status-connect', 'status-research', 'status-writing', 'status-analysis', 'status-charts', 'status-sources', 'status-complete'];
            const subtitles = [
                'Initializing research pipeline...',
                'Connecting to Claude AI...',
                'Scanning authoritative sources and cross-referencing data...',
                'Writing investigative analysis...',
                'Deep analysis in progress...',
                'Generating data visualizations...',
                'Verifying and compiling sources...',
                'Finalizing your report...'
            ];
            const loaderSubtitle = document.getElementById('loader-subtitle');
            let currentStage = 0;

            // Reset all stages
            stages.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('active', 'complete');
                }
            });

            // Start first stage
            document.getElementById(stages[0]).classList.add('active');
            loaderSubtitle.textContent = subtitles[0];

            // Progress through stages
            statusAnimationInterval = setInterval(() => {
                if (currentStage < stages.length - 1) {
                    // Mark current as complete
                    document.getElementById(stages[currentStage]).classList.remove('active');
                    document.getElementById(stages[currentStage]).classList.add('complete');

                    // Move to next stage
                    currentStage++;
                    document.getElementById(stages[currentStage]).classList.add('active');
                    loaderSubtitle.textContent = subtitles[currentStage];
                }
            }, 4000); // Advance every 4 seconds
        }

        function stopStatusAnimation() {
            if (statusAnimationInterval) {
                clearInterval(statusAnimationInterval);
                statusAnimationInterval = null;
            }
        }

        async function generateDeepDive(topic, context = '', parentKey = '', parentTitle = '') {
            const loader = document.getElementById('deep-dive-loader');
            const loaderTitle = document.getElementById('loader-title');
            const progressBar = document.getElementById('loader-progress-bar');
            const loaderSubtitle = document.getElementById('loader-subtitle');
            const contextPreview = document.getElementById('loader-context-preview');
            const contextText = document.getElementById('loader-context-text');

            // Show loading screen
            loaderTitle.textContent = `Investigating: ${topic}`;

            // Show context preview if context is provided
            if (context && context.trim()) {
                const displayContext = context.length > 500 ? context.substring(0, 500) + '...' : context;
                contextText.textContent = displayContext;
                contextPreview.style.display = 'block';
            } else {
                contextPreview.style.display = 'none';
            }

            loader.classList.add('visible');

            // Start status animation
            startStatusAnimation();

            deepDiveAbortController = new AbortController();

            try {
                const response = await fetch('/api/deep-dive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic,
                        context,
                        parent_key: parentKey,
                        parent_title: parentTitle
                    }),
                    signal: deepDiveAbortController.signal
                });

                // Check for HTTP errors (rate limiting, etc.)
                if (response.status === 429) {
                    const error = await response.json();
                    throw new Error(error.detail?.message || 'Daily limit exceeded');
                }

                if (!response.ok && !response.headers.get('content-type')?.includes('text/event-stream')) {
                    const error = await response.json().catch(() => ({ detail: 'Generation failed' }));
                    throw new Error(error.detail || 'Generation failed');
                }

                // Handle SSE streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let articleData = null;
                let lastPartialContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    let currentEvent = null;
                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                        } else if (line.startsWith('data: ') && currentEvent) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                console.log('[SSE] Event:', currentEvent, 'Data type:', typeof data);
                                if (currentEvent === 'progress') {
                                    // Use the unified updateProgress function
                                    updateProgress(data.stage, data.percent, data.message);
                                } else if (currentEvent === 'content') {
                                    console.log('[SSE] Received content, keys:', Object.keys(data));
                                    articleData = data;
                                } else if (currentEvent === 'partial') {
                                    // Store partial content in case of timeout
                                    console.log('[SSE] Received partial content, length:', typeof data === 'string' ? data.length : 'object');
                                    lastPartialContent = data;
                                } else if (currentEvent === 'rawcontent') {
                                    // Try client-side JSON repair
                                    console.log('[SSE] Received raw content, attempting repair');
                                    articleData = repairTruncatedJSON(data);
                                } else if (currentEvent === 'error') {
                                    console.error('[SSE] Error event:', data);
                                    throw new Error(data);
                                }
                            } catch (parseError) {
                                console.error('[SSE] Parse error:', parseError, 'for event:', currentEvent);
                                if (currentEvent === 'error') throw parseError;
                            }
                            currentEvent = null;
                        }
                    }
                }

                // If no final content but we have partial, try to repair it
                console.log('[SSE] Stream complete. articleData:', !!articleData, 'lastPartialContent:', !!lastPartialContent);
                if (!articleData && lastPartialContent) {
                    console.log('[SSE] Attempting to repair partial content, length:', typeof lastPartialContent === 'string' ? lastPartialContent.length : 'object');
                    articleData = repairTruncatedJSON(lastPartialContent);
                    console.log('[SSE] Repair result:', !!articleData);
                }

                if (!articleData) {
                    console.error('[SSE] No article data - throwing error');
                    throw new Error('No article data received');
                }
                console.log('[SSE] Article data ready, key:', articleData.key, 'title:', articleData.title?.substring(0, 50));

                // Add to reports database
                const key = articleData.key || topic.toLowerCase().replace(/[^a-z0-9]+/g, '_');
                reports[key] = {
                    title: articleData.title,
                    content: articleData.content,
                    chartType: 'dynamic',
                    chartConfigs: articleData.chartConfigs || {},
                    contextData: articleData.contextData || {},
                    citationDatabase: articleData.citationDatabase || {},
                    sources: articleData.sources || [],
                    cardTitle: articleData.cardTitle || articleData.title?.substring(0, 50) || topic,
                    cardTag: articleData.cardTag || 'INVESTIGATION',
                    cardTagColor: articleData.cardTagColor || 'text-blue-400',
                    cardDescription: articleData.cardDescription || topic
                };

                // Store dynamic data globally
                window.dynamicChartConfigs = articleData.chartConfigs || {};
                window.dynamicContextData = articleData.contextData || {};
                window.dynamicCitationDatabase = articleData.citationDatabase || {};

                // Update remaining dives count
                if (articleData._remaining_today !== undefined) {
                    userRemainingDives = articleData._remaining_today;
                } else if (!articleData._from_cache) {
                    userRemainingDives = Math.max(0, userRemainingDives - 1);
                }

                // Mark as cached and save locally
                cachedArticles[topic.toLowerCase()] = true;
                saveGeneratedArticleLocally(key, reports[key]);

                // Hide loader and load the report
                // Note: loadReport -> renderReportData handles chart rendering automatically
                stopStatusAnimation();
                loader.classList.remove('visible');
                loadReport(key);

                // Update badge (charts are rendered by renderReportData)
                setTimeout(() => {
                    updateDeepDiveBadge();
                }, 200);

            } catch (e) {
                if (e.name === 'AbortError') {
                    console.log('Deep dive cancelled');
                } else if (e.message?.includes('429') || e.message?.includes('daily_limit') || e.message?.includes('Daily limit')) {
                    console.error('Daily limit exceeded');
                    alert('You\'ve used all free deep dives for today. Come back tomorrow!');
                    userRemainingDives = 0;
                    updateBadgeRemaining();
                } else {
                    console.error('Deep dive error:', e);
                    alert('Error generating deep dive: ' + e.message);
                }
                stopStatusAnimation();
                loader.classList.remove('visible');
            }

            deepDiveAbortController = null;
        }

        function cancelDeepDive() {
            if (deepDiveAbortController) {
                deepDiveAbortController.abort();
            }
            stopStatusAnimation();
            document.getElementById('deep-dive-loader').classList.remove('visible');
            document.getElementById('loader-context-preview').style.display = 'none';
        }

        // NOTE: renderDynamicCharts is defined earlier in the file (around line 3906)
        // This duplicate has been removed to avoid conflicts

        // === DEEP DIVE CACHE & BADGE SYSTEM ===
        let cachedArticles = {};  // Local cache of known cached articles
        let userRemainingDives = 3;

        // === LOCAL STORAGE PERSISTENCE ===
        const LOCAL_ARTICLES_KEY = 'genuverity-generated-articles';

        function saveGeneratedArticleLocally(key, article) {
            try {
                const stored = JSON.parse(localStorage.getItem(LOCAL_ARTICLES_KEY) || '{}');
                stored[key] = article;
                localStorage.setItem(LOCAL_ARTICLES_KEY, JSON.stringify(stored));
                console.log(`Saved article "${key}" to localStorage`);
            } catch (e) {
                console.error('Failed to save article to localStorage:', e);
            }
        }

        function loadLocallyStoredArticles() {
            try {
                const stored = JSON.parse(localStorage.getItem(LOCAL_ARTICLES_KEY) || '{}');
                let count = 0;
                Object.entries(stored).forEach(([key, article]) => {
                    if (!reports[key]) {
                        reports[key] = article;
                        cachedArticles[key] = true;
                        count++;
                    }
                });
                if (count > 0) {
                    console.log(`Loaded ${count} articles from localStorage`);
                }
            } catch (e) {
                console.error('Failed to load articles from localStorage:', e);
            }
        }

        // Load locally stored articles on startup
        loadLocallyStoredArticles();

        // Fetch user's remaining free dives on load
        async function fetchUserUsage() {
            try {
                const response = await fetch('/api/usage');
                const data = await response.json();
                userRemainingDives = data.remaining;
                updateBadgeRemaining();
            } catch (e) {
                console.error('Failed to fetch usage:', e);
            }
        }

        // Check if a topic is cached (free)
        async function checkIfCached(topic) {
            try {
                const response = await fetch('/api/cache/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic })
                });
                const data = await response.json();
                return data.cached ? data.article : null;
            } catch (e) {
                return null;
            }
        }

        // Update the floating badge
        function updateDeepDiveBadge() {
            const badge = document.getElementById('deep-dive-badge');
            const reportView = document.getElementById('view-report');
            const isReportView = reportView && reportView.classList.contains('active');

            if (!isReportView) {
                badge.classList.remove('visible');
                return;
            }

            // Count fractal triggers in current article
            const triggers = document.querySelectorAll('#report-body .fractal-trigger');
            const contextData = window.dynamicContextData || {};

            let freeCount = 0;
            let paidCount = 0;

            triggers.forEach(trigger => {
                const key = trigger.getAttribute('onclick')?.match(/expandContext\(this,\s*'([^']+)'\)/)?.[1];
                const topicName = key ? key.replace(/_/g, ' ') : trigger.textContent;

                // Check if in local reports or contextData has full article
                if (reports[topicName.toLowerCase().replace(/\s+/g, '_')] || cachedArticles[topicName.toLowerCase()]) {
                    freeCount++;
                } else {
                    paidCount++;
                }
            });

            document.getElementById('badge-free-count').textContent = freeCount;
            document.getElementById('badge-paid-count').textContent = paidCount;

            badge.classList.add('visible');
            updateBadgeRemaining();
            lucide.createIcons();
        }

        function updateBadgeRemaining() {
            const remainingEl = document.getElementById('badge-remaining');
            const textEl = document.getElementById('badge-remaining-text');

            if (userRemainingDives > 0) {
                remainingEl.classList.remove('depleted');
                textEl.textContent = `${userRemainingDives} remaining free today`;
            } else {
                remainingEl.classList.add('depleted');
                textEl.textContent = 'No free remaining today';
            }

            // Also update mini badge
            const miniFree = document.getElementById('badge-mini-free');
            const miniPaid = document.getElementById('badge-mini-paid');
            if (miniFree && miniPaid) {
                miniFree.textContent = document.getElementById('badge-free-count')?.textContent || '0';
                miniPaid.textContent = document.getElementById('badge-paid-count')?.textContent || '0';
            }
        }

        // Toggle badge between minimized and expanded states
        function toggleBadgeSize() {
            const badge = document.getElementById('deep-dive-badge');
            badge.classList.toggle('minimized');

            // Save preference to localStorage
            localStorage.setItem('badgeMinimized', badge.classList.contains('minimized'));
        }

        // Restore badge state on load
        function restoreBadgeState() {
            const isMinimized = localStorage.getItem('badgeMinimized') === 'true';
            if (isMinimized) {
                document.getElementById('deep-dive-badge').classList.add('minimized');
            }
        }

        // Hook fractal triggers to generate deep dives
        async function expandContext(element, key) {
            // Check for existing context data
            const contextData = window.dynamicContextData || {};

            // The actual clickable text is what we use for the topic
            const clickedText = element.textContent.trim();
            const topicForDeepDive = clickedText;  // Use actual element text, not the key

            // First check if we already have this article loaded (by various key formats)
            const possibleKeys = [
                clickedText.toLowerCase().replace(/[^a-z0-9]+/g, '_'),
                key,
                key?.replace(/_/g, ' ')?.toLowerCase()?.replace(/[^a-z0-9]+/g, '_')
            ].filter(Boolean);

            for (const testKey of possibleKeys) {
                if (reports[testKey]) {
                    loadReport(testKey);
                    return;
                }
            }

            // Check server cache for the clicked topic
            const cached = await checkIfCached(topicForDeepDive);
            if (cached) {
                // It's cached - load it for FREE
                const cacheKey = cached.key || possibleKeys[0];
                reports[cacheKey] = cached;
                cachedArticles[topicForDeepDive.toLowerCase()] = true;

                window.dynamicChartConfigs = cached.chartConfigs || {};
                window.dynamicContextData = cached.contextData || {};
                window.dynamicCitationDatabase = cached.citationDatabase || {};

                loadReport(cacheKey);
                setTimeout(() => renderDynamicCharts(cached.chartConfigs || {}), 200);
                return;
            }

            // If we have pre-generated inline context, show it with option to generate full deep dive
            if (contextData[key]) {
                let existingContext = element.nextElementSibling;
                if (existingContext && existingContext.classList.contains('fractal-context')) {
                    existingContext.classList.toggle('open');
                } else {
                    const isFree = userRemainingDives > 0;
                    const contextDiv = document.createElement('div');
                    contextDiv.className = 'fractal-context open';
                    contextDiv.innerHTML = `
                        <p>${contextData[key].expanded}</p>
                        <button onclick="promptDeepDive('${topicForDeepDive.replace(/'/g, "\\'")}')" class="rabbit-hole-btn">
                            <i data-lucide="${isFree ? 'sparkles' : 'coins'}" class="w-4 h-4"></i>
                            ${isFree ? 'Generate Deep Dive (Free)' : 'Generate Deep Dive (Uses Token)'}
                        </button>
                    `;
                    element.parentNode.insertBefore(contextDiv, element.nextSibling);
                    lucide.createIcons();
                }
            } else {
                // No pre-generated context - show confirmation with cost info
                promptDeepDive(topicForDeepDive);
            }
        }

        // Prompt user before generating (shows if free or costs token)
        function promptDeepDive(topic) {
            const isFree = userRemainingDives > 0;
            const message = isFree
                ? `Generate a deep-dive article on "${topic}"?\n\nYou have ${userRemainingDives} remaining free today.`
                : `Generate a deep-dive article on "${topic}"?\n\nâš ï¸ No free generations remaining today. This will cost tokens.`;

            if (confirm(message)) {
                generateDeepDive(topic);
            }
        }

        // Handle deep dive from infographic - extracts context automatically
        function handleDeepDive(topicOrElement) {
            // Hide the deep dive tooltip immediately when clicked
            if (deepDiveTooltipEl) {
                deepDiveTooltipEl.classList.remove('visible');
            }

            let topic, context;

            // If passed a string, use it as the topic (legacy support)
            if (typeof topicOrElement === 'string') {
                topic = topicOrElement;
            } else {
                // Extract context from the clicked element
                const element = topicOrElement;
                topic = extractDeepDiveTopic(element);
            }

            // Get parent article context
            const articleTitle = document.getElementById('report-title')?.innerText || '';
            const currentReport = reports[currentArticleKey];
            const articleDescription = currentReport?.cardDescription || '';

            // Build rich context
            context = `Parent Article: "${articleTitle}"\n`;
            if (articleDescription) {
                context += `Article Focus: ${articleDescription}\n`;
            }

            // Trigger the deep dive with context
            const isFree = userRemainingDives > 0;
            const message = isFree
                ? `Generate a deep-dive on "${topic}"?\n\nContext: From article "${articleTitle}"\n\nYou have ${userRemainingDives} remaining free today.`
                : `Generate a deep-dive on "${topic}"?\n\nContext: From article "${articleTitle}"\n\nâš ï¸ No free generations remaining today.`;

            if (confirm(message)) {
                // Pass parent article key and title for relationship tracking
                generateDeepDive(topic, context, currentArticleKey, articleTitle);
            }
        }

        // Extract topic from figure caption context
        function extractDeepDiveTopic(element) {
            // Get the figure caption (parent element)
            const figCaption = element.closest('.fig-caption');
            if (figCaption) {
                // Extract text before the DEEP DIVE button
                let captionText = figCaption.textContent.replace('DEEP DIVE', '').trim();
                // Remove "Fig X. " prefix
                captionText = captionText.replace(/^Fig\s*\d+\.\s*/i, '');
                return captionText;
            }

            // Fallback: look for nearby heading
            const floatFigure = element.closest('.float-figure');
            if (floatFigure) {
                const prevSibling = floatFigure.previousElementSibling;
                if (prevSibling && prevSibling.classList.contains('prose-h2')) {
                    return prevSibling.textContent.replace(/^\d+\.\s*/, '');
                }
            }

            return 'This Topic';
        }

        // --- BOOKMARKS ---
        function getBookmarks() {
            const saved = localStorage.getItem('genuverity-bookmarks');
            return saved ? JSON.parse(saved) : [];
        }

        function saveBookmarks(bookmarks) {
            localStorage.setItem('genuverity-bookmarks', JSON.stringify(bookmarks));
        }

        // --- ENHANCE ARTICLE ---
        async function enhanceArticle() {
            const title = document.getElementById('report-title').innerText;
            const currentContent = document.getElementById('report-body').innerHTML;
            const btn = document.getElementById('enhance-btn');

            // Confirm with user
            const confirmed = confirm(
                `Enhance "${title}"?\n\nThis will expand the article with additional sections, deeper analysis, and more comprehensive coverage while maintaining the same journalistic style.\n\nThis may take a minute to generate.`
            );

            if (!confirmed) return;

            // Disable button and show loading state
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i><span class="hidden sm:inline">Enhancing...</span>';
                lucide.createIcons();
            }

            try {
                // Show loader
                document.getElementById('generate-loader').classList.remove('hidden');
                resetProgress();

                // Build enhancement prompt with article context
                const enhancePrompt = `ENHANCE AND EXPAND the following investigative article.

ORIGINAL TITLE: ${title}

INSTRUCTIONS:
- Keep the same title, thesis, and core arguments
- Add 2-3 NEW substantial sections with deeper analysis
- Expand existing sections with more data points, examples, and expert perspectives
- Add more living numbers with verified statistics
- Include additional citation spades for new claims
- Add fractal triggers for key terms that deserve expanded context
- Maintain the same journalistic tone and magazine-style formatting
- Total output should be roughly 2x the original length

The enhanced article should feel like the "premium" or "full" version of the original piece.

ORIGINAL CONTENT FOR CONTEXT (HTML):
${currentContent}`;

                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: enhancePrompt,
                        mode: 'enhance'
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                // Handle SSE streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';  // Keep full raw response as fallback
                let articleContent = null;

                console.log('[Enhance] Starting to read SSE stream...');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    fullResponse += chunk;  // Accumulate full response
                    buffer += chunk;
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    let currentEvent = null;
                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                        } else if (line.startsWith('data: ') && currentEvent) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (currentEvent === 'progress') {
                                    updateProgress(data.stage, data.percent, data.message);
                                } else if (currentEvent === 'content') {
                                    console.log('[Enhance] Received content event');
                                    articleContent = data;
                                } else if (currentEvent === 'error') {
                                    console.error('[Enhance] Server error:', data);
                                    throw new Error(data);
                                }
                            } catch (e) {
                                console.log('[Enhance] Parse error for line:', line.substring(0, 100));
                            }
                            currentEvent = null;
                        }
                    }
                }

                console.log('[Enhance] Stream complete. articleContent:', articleContent ? 'received' : 'null');

                // Hide loader
                document.getElementById('generate-loader').classList.add('hidden');

                // Try to get article content from SSE or fallback to raw response
                let parsed = null;

                if (articleContent) {
                    // Parse the enhanced article from SSE content event
                    parsed = typeof articleContent === 'string' ? JSON.parse(articleContent) : articleContent;
                } else if (fullResponse) {
                    // Fallback: try to parse raw response (in case SSE parsing failed)
                    console.log('[Enhance] No SSE content, trying to parse raw response...');
                    try {
                        // Try direct JSON parse
                        parsed = JSON.parse(fullResponse);
                    } catch (e) {
                        // Try to extract JSON from SSE format
                        const contentMatch = fullResponse.match(/data:\s*(\{[\s\S]*\})/);
                        if (contentMatch) {
                            try {
                                parsed = JSON.parse(contentMatch[1]);
                            } catch (e2) {
                                console.error('[Enhance] Failed to parse extracted content:', e2);
                            }
                        }
                    }
                }

                if (parsed && (parsed.content || parsed.body)) {
                    // Update the current report
                    const enhancedReport = {
                        title: parsed.title || title,
                        content: parsed.content || parsed.body,
                        sources: parsed.sources || [],
                        citationDatabase: parsed.citationDatabase || {},
                        chartConfigs: parsed.chartConfigs || {},
                        chartType: 'dynamic'
                    };

                    // Render the enhanced article
                    currentReport = enhancedReport;
                    renderReportData(enhancedReport, true);

                    // Show success notification
                    showNotification('Article enhanced successfully!', 'success');
                } else {
                    console.error('[Enhance] No valid article content received');
                    console.log('[Enhance] Raw response preview:', fullResponse.substring(0, 500));
                    showNotification('Enhancement failed - no valid content received.', 'error');
                }

            } catch (error) {
                console.error('Enhancement failed:', error);
                document.getElementById('generate-loader').classList.add('hidden');
                showNotification('Enhancement failed. Please try again.', 'error');
            } finally {
                // Reset button state
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="sparkles" class="w-4 h-4"></i><span class="hidden sm:inline">Enhance</span>';
                    lucide.createIcons();
                }
            }
        }

        // Simple notification helper
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 animate-fade-in`;
            notification.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            notification.style.color = 'white';
            notification.innerHTML = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function toggleBookmark() {
            const bookmarks = getBookmarks();
            const key = currentArticleKey;
            const title = document.getElementById('report-title').innerText;
            const btn = document.getElementById('bookmark-btn');

            const existingIndex = bookmarks.findIndex(b => b.key === key);

            if (existingIndex >= 0) {
                // Remove bookmark
                bookmarks.splice(existingIndex, 1);
                if (btn) {
                    btn.classList.remove('primary');
                    btn.querySelector('span').textContent = 'Save';
                }
            } else {
                // Add bookmark
                bookmarks.push({
                    key: key,
                    title: title,
                    date: new Date().toISOString()
                });
                if (btn) {
                    btn.classList.add('primary');
                    btn.querySelector('span').textContent = 'Saved';
                }
            }

            saveBookmarks(bookmarks);
        }

        function updateBookmarkButton() {
            const bookmarks = getBookmarks();
            const btn = document.getElementById('bookmark-btn');
            const isBookmarked = bookmarks.some(b => b.key === currentArticleKey);

            if (btn) {
                const span = btn.querySelector('span');
                if (isBookmarked) {
                    btn.classList.add('primary');
                    if (span) span.textContent = 'Saved';
                } else {
                    btn.classList.remove('primary');
                    if (span) span.textContent = 'Save';
                }
            }
        }

        // --- PIPELINES (Bookmark Collections) ---
        function getPipelines() {
            const saved = localStorage.getItem('genuverity-pipelines');
            return saved ? JSON.parse(saved) : [
                { id: 'default', name: 'Reading List', bookmarks: [] },
                { id: 'research', name: 'Research Queue', bookmarks: [] }
            ];
        }

        function savePipelines(pipelines) {
            localStorage.setItem('genuverity-pipelines', JSON.stringify(pipelines));
        }

        function toggleBookmarksSidebar() {
            const sidebar = document.getElementById('bookmarks-sidebar');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                renderBookmarksSidebar();
            }
        }

        function renderBookmarksSidebar() {
            const container = document.getElementById('bookmarks-content');
            const pipelines = getPipelines();
            const bookmarks = getBookmarks();

            let html = '';

            // Ungrouped bookmarks (default)
            const ungroupedBookmarks = bookmarks.filter(b => !b.pipelineId);
            if (ungroupedBookmarks.length > 0) {
                html += `
                    <div class="pipeline-section">
                        <div class="pipeline-header">
                            <span style="color: var(--text-main); font-weight: 600;">
                                <i data-lucide="bookmark" class="w-4 h-4 inline mr-2"></i>Saved Articles
                            </span>
                            <span style="color: var(--text-muted); font-size: 0.75rem;">${ungroupedBookmarks.length}</span>
                        </div>
                        <div class="pipeline-items">
                            ${ungroupedBookmarks.map(b => `
                                <div class="bookmark-item" onclick="loadBookmark('${b.key}')">
                                    <i data-lucide="file-text" class="w-4 h-4" style="color: var(--text-muted);"></i>
                                    <span class="bookmark-item-title">${b.title}</span>
                                    <button onclick="event.stopPropagation(); showAddToPipelineMenu('${b.key}')" style="color: var(--text-muted);" title="Add to pipeline">
                                        <i data-lucide="folder-plus" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="event.stopPropagation(); removeBookmark('${b.key}')" style="color: var(--text-muted);" title="Remove">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Render each pipeline
            pipelines.forEach(pipeline => {
                const pipelineBookmarks = bookmarks.filter(b => b.pipelineId === pipeline.id);
                html += `
                    <div class="pipeline-section">
                        <div class="pipeline-header" onclick="togglePipelineCollapse('${pipeline.id}')">
                            <span style="color: var(--accent-blue); font-weight: 600;">
                                <i data-lucide="folder" class="w-4 h-4 inline mr-2"></i>${pipeline.name}
                            </span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: var(--text-muted); font-size: 0.75rem;">${pipelineBookmarks.length}</span>
                                <button onclick="event.stopPropagation(); renamePipeline('${pipeline.id}')" style="color: var(--text-muted);" title="Rename">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                </button>
                                ${pipeline.id !== 'default' ? `
                                    <button onclick="event.stopPropagation(); deletePipeline('${pipeline.id}')" style="color: var(--text-muted);" title="Delete">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="pipeline-items" id="pipeline-${pipeline.id}">
                            ${pipelineBookmarks.length === 0 ? `
                                <div style="padding: 0.75rem; color: var(--text-muted); font-size: 0.8rem; font-style: italic;">
                                    No articles in this pipeline yet
                                </div>
                            ` : pipelineBookmarks.map(b => `
                                <div class="bookmark-item" onclick="loadBookmark('${b.key}')">
                                    <i data-lucide="file-text" class="w-4 h-4" style="color: var(--text-muted);"></i>
                                    <span class="bookmark-item-title">${b.title}</span>
                                    <button onclick="event.stopPropagation(); removeFromPipeline('${b.key}', '${pipeline.id}')" style="color: var(--text-muted);" title="Remove from pipeline">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            // Empty state
            if (bookmarks.length === 0 && pipelines.every(p => !bookmarks.some(b => b.pipelineId === p.id))) {
                html = `
                    <div style="padding: 3rem 2rem; text-align: center;">
                        <i data-lucide="bookmark" class="w-12 h-12 mx-auto mb-4" style="color: var(--text-muted); opacity: 0.5;"></i>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">No saved articles yet</p>
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 0.5rem;">Press <kbd>B</kbd> while reading to bookmark</p>
                    </div>
                `;
            }

            container.innerHTML = html;
            lucide.createIcons();
        }

        function loadBookmark(key) {
            toggleBookmarksSidebar();
            loadReport(key);
        }

        function removeBookmark(key) {
            let bookmarks = getBookmarks();
            bookmarks = bookmarks.filter(b => b.key !== key);
            saveBookmarks(bookmarks);
            renderBookmarksSidebar();
            updateBookmarkButton();
        }

        function createNewPipeline() {
            const name = prompt('Enter a name for the new pipeline:');
            if (!name) return;

            const pipelines = getPipelines();
            const newPipeline = {
                id: 'pipeline_' + Date.now(),
                name: name,
                bookmarks: []
            };
            pipelines.push(newPipeline);
            savePipelines(pipelines);
            renderBookmarksSidebar();
        }

        function renamePipeline(pipelineId) {
            const pipelines = getPipelines();
            const pipeline = pipelines.find(p => p.id === pipelineId);
            if (!pipeline) return;

            const newName = prompt('Enter new name:', pipeline.name);
            if (!newName) return;

            pipeline.name = newName;
            savePipelines(pipelines);
            renderBookmarksSidebar();
        }

        function deletePipeline(pipelineId) {
            if (!confirm('Delete this pipeline? Articles will be moved back to Saved Articles.')) return;

            let pipelines = getPipelines();
            pipelines = pipelines.filter(p => p.id !== pipelineId);
            savePipelines(pipelines);

            // Move bookmarks back to ungrouped
            let bookmarks = getBookmarks();
            bookmarks = bookmarks.map(b => {
                if (b.pipelineId === pipelineId) {
                    delete b.pipelineId;
                }
                return b;
            });
            saveBookmarks(bookmarks);
            renderBookmarksSidebar();
        }

        function showAddToPipelineMenu(bookmarkKey) {
            const pipelines = getPipelines();
            const pipelineNames = pipelines.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
            const choice = prompt(`Add to which pipeline?\n${pipelineNames}\n\nEnter number:`);

            if (!choice) return;
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= pipelines.length) {
                alert('Invalid choice');
                return;
            }

            const bookmarks = getBookmarks();
            const bookmark = bookmarks.find(b => b.key === bookmarkKey);
            if (bookmark) {
                bookmark.pipelineId = pipelines[index].id;
                saveBookmarks(bookmarks);
                renderBookmarksSidebar();
            }
        }

        function removeFromPipeline(bookmarkKey, pipelineId) {
            const bookmarks = getBookmarks();
            const bookmark = bookmarks.find(b => b.key === bookmarkKey);
            if (bookmark) {
                delete bookmark.pipelineId;
                saveBookmarks(bookmarks);
                renderBookmarksSidebar();
            }
        }

        // --- READING PROGRESS ---
        let readTime = 0;

        function initReadingProgress() {
            const content = document.getElementById('report-body');
            if (!content) return;

            const wordCount = content.innerText.split(/\s+/).length;
            readTime = Math.ceil(wordCount / 200);

            updateProgressBar();
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressContainer = document.getElementById('reading-progress');
            const reportView = document.getElementById('view-report');

            if (!progressBar || !reportView) return;

            const isReportView = reportView.classList.contains('active');

            if (!isReportView) {
                progressContainer.classList.remove('visible');
                return;
            }

            const scrollTop = window.scrollY;
            const docHeight = document.body.scrollHeight - window.innerHeight;
            const scrollPercent = docHeight > 0 ? Math.min((scrollTop / docHeight) * 100, 100) : 0;

            progressBar.style.width = scrollPercent + '%';
            if (progressText) {
                progressText.innerText = `${readTime} min read â€¢ ${Math.round(scrollPercent)}% complete`;
            }

            // Show/hide based on scroll position
            if (scrollTop > 100) {
                progressContainer.classList.add('visible');
            } else {
                progressContainer.classList.remove('visible');
            }
        }

        // Throttle scroll handler
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                updateProgressBar();
                scrollTimeout = null;
            }, 50);
        });

        // --- KEYBOARD SHORTCUTS ---
        function toggleShortcutsModal() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) {
                modal.classList.toggle('visible');
            }
        }

        function scrollToNextSection() {
            const sections = document.querySelectorAll('.prose-h2');
            const currentScroll = window.scrollY;

            for (const section of sections) {
                if (section.offsetTop > currentScroll + 150) {
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }

        function scrollToPrevSection() {
            const sections = Array.from(document.querySelectorAll('.prose-h2'));
            const currentScroll = window.scrollY;

            for (let i = sections.length - 1; i >= 0; i--) {
                if (sections[i].offsetTop < currentScroll - 50) {
                    sections[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }

        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // Close modal on Escape
            if (e.key === 'Escape') {
                const modal = document.getElementById('shortcuts-modal');
                if (modal && modal.classList.contains('visible')) {
                    modal.classList.remove('visible');
                    return;
                }
                switchView('view-portal');
                return;
            }

            const reportView = document.getElementById('view-report');
            const isReportView = reportView && reportView.classList.contains('active');

            switch(e.key.toLowerCase()) {
                case 'j':
                    if (isReportView) {
                        e.preventDefault();
                        scrollToNextSection();
                    }
                    break;
                case 'k':
                    if (isReportView) {
                        e.preventDefault();
                        scrollToPrevSection();
                    }
                    break;
                case 'b':
                    if (isReportView) {
                        e.preventDefault();
                        toggleBookmark();
                    }
                    break;
                case 'p':
                    if (isReportView) {
                        e.preventDefault();
                        exportToPDF();
                    }
                    break;
                case 'm':
                    if (isReportView) {
                        e.preventDefault();
                        exportToMarkdown();
                    }
                    break;
                case 't':
                    e.preventDefault();
                    toggleTheme();
                    break;
                case 'l':
                    e.preventDefault();
                    toggleBookmarksSidebar();
                    break;
                case '?':
                    e.preventDefault();
                    toggleShortcutsModal();
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    if (!isReportView) {
                        e.preventDefault();
                        const articles = ['ai_bubble', 'congress_trading', 'political_grift', 'semiconductor_wars'];
                        loadReport(articles[parseInt(e.key) - 1]);
                    }
                    break;
            }
        });

        // Override loadReport to track current article
        const originalLoadReport = loadReport;
        loadReport = function(key) {
            currentArticleKey = key;
            originalLoadReport(key);
            setTimeout(() => {
                initReadingProgress();
                updateBookmarkButton();
                updateDeepDiveBadge();
                lucide.createIcons();
            }, 100);
        };

        // Initialize theme on load
        initTheme();

        // Restore badge minimized state
        restoreBadgeState();

        // Fetch user usage on page load
        fetchUserUsage();

        // Re-init Lucide icons after dynamic content
        setTimeout(() => lucide.createIcons(), 500);
    </script>

    <!-- KEYBOARD SHORTCUTS MODAL -->
    <div id="shortcuts-modal">
        <div class="shortcuts-container">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold" style="color: var(--text-main);">Keyboard Shortcuts</h2>
                <button onclick="toggleShortcutsModal()" class="text-gray-500 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-1">
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Next section</span>
                    <kbd>J</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Previous section</span>
                    <kbd>K</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Bookmark article</span>
                    <kbd>B</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Export to PDF</span>
                    <kbd>P</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Export to Markdown</span>
                    <kbd>M</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Toggle theme</span>
                    <kbd>T</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Research library</span>
                    <kbd>L</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Return to portal</span>
                    <kbd>Esc</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Show shortcuts</span>
                    <kbd>?</kbd>
                </div>
                <div class="shortcut-row">
                    <span style="color: var(--text-muted);">Load article 1-4</span>
                    <kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> <kbd>4</kbd>
                </div>
            </div>
        </div>
    </div>
</body>

</html>